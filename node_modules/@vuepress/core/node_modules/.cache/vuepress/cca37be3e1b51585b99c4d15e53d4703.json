{"remainingRequest":"/Users/mengyu/vuepress-starter/vuepress-starter/node_modules/babel-loader/lib/index.js??ref--3-1!/Users/mengyu/vuepress-starter/vuepress-starter/node_modules/vue/dist/vue.runtime.esm.js","dependencies":[{"path":"/Users/mengyu/vuepress-starter/vuepress-starter/node_modules/vue/dist/vue.runtime.esm.js","mtime":1661658709610},{"path":"/Users/mengyu/vuepress-starter/vuepress-starter/node_modules/cache-loader/dist/cjs.js","mtime":1661658709451},{"path":"/Users/mengyu/vuepress-starter/vuepress-starter/node_modules/babel-loader/lib/index.js","mtime":1661658709446}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMucmVmbGVjdC50by1zdHJpbmctdGFnLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkucmVkdWNlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvd2ViLmltbWVkaWF0ZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmVycm9yLmNhdXNlLmpzIjsKCi8qIQogKiBWdWUuanMgdjIuNy4xMAogKiAoYykgMjAxNC0yMDIyIEV2YW4gWW91CiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4KICovCnZhciBlbXB0eU9iamVjdCA9IE9iamVjdC5mcmVlemUoe30pOwp2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7IC8vIFRoZXNlIGhlbHBlcnMgcHJvZHVjZSBiZXR0ZXIgVk0gY29kZSBpbiBKUyBlbmdpbmVzIGR1ZSB0byB0aGVpcgovLyBleHBsaWNpdG5lc3MgYW5kIGZ1bmN0aW9uIGlubGluaW5nLgoKZnVuY3Rpb24gaXNVbmRlZih2KSB7CiAgcmV0dXJuIHYgPT09IHVuZGVmaW5lZCB8fCB2ID09PSBudWxsOwp9CgpmdW5jdGlvbiBpc0RlZih2KSB7CiAgcmV0dXJuIHYgIT09IHVuZGVmaW5lZCAmJiB2ICE9PSBudWxsOwp9CgpmdW5jdGlvbiBpc1RydWUodikgewogIHJldHVybiB2ID09PSB0cnVlOwp9CgpmdW5jdGlvbiBpc0ZhbHNlKHYpIHsKICByZXR1cm4gdiA9PT0gZmFsc2U7Cn0KLyoqDQogKiBDaGVjayBpZiB2YWx1ZSBpcyBwcmltaXRpdmUuDQogKi8KCgpmdW5jdGlvbiBpc1ByaW1pdGl2ZSh2YWx1ZSkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgfHwgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgdHlwZW9mIHZhbHVlID09PSAnc3ltYm9sJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJzsKfQoKZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbic7Cn0KLyoqDQogKiBRdWljayBvYmplY3QgY2hlY2sgLSB0aGlzIGlzIHByaW1hcmlseSB1c2VkIHRvIHRlbGwNCiAqIG9iamVjdHMgZnJvbSBwcmltaXRpdmUgdmFsdWVzIHdoZW4gd2Uga25vdyB0aGUgdmFsdWUNCiAqIGlzIGEgSlNPTi1jb21wbGlhbnQgdHlwZS4NCiAqLwoKCmZ1bmN0aW9uIGlzT2JqZWN0KG9iaikgewogIHJldHVybiBvYmogIT09IG51bGwgJiYgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCc7Cn0KLyoqDQogKiBHZXQgdGhlIHJhdyB0eXBlIHN0cmluZyBvZiBhIHZhbHVlLCBlLmcuLCBbb2JqZWN0IE9iamVjdF0uDQogKi8KCgp2YXIgX3RvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCmZ1bmN0aW9uIHRvUmF3VHlwZSh2YWx1ZSkgewogIHJldHVybiBfdG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpOwp9Ci8qKg0KICogU3RyaWN0IG9iamVjdCB0eXBlIGNoZWNrLiBPbmx5IHJldHVybnMgdHJ1ZQ0KICogZm9yIHBsYWluIEphdmFTY3JpcHQgb2JqZWN0cy4NCiAqLwoKCmZ1bmN0aW9uIGlzUGxhaW5PYmplY3Qob2JqKSB7CiAgcmV0dXJuIF90b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IE9iamVjdF0nOwp9CgpmdW5jdGlvbiBpc1JlZ0V4cCh2KSB7CiAgcmV0dXJuIF90b1N0cmluZy5jYWxsKHYpID09PSAnW29iamVjdCBSZWdFeHBdJzsKfQovKioNCiAqIENoZWNrIGlmIHZhbCBpcyBhIHZhbGlkIGFycmF5IGluZGV4Lg0KICovCgoKZnVuY3Rpb24gaXNWYWxpZEFycmF5SW5kZXgodmFsKSB7CiAgdmFyIG4gPSBwYXJzZUZsb2F0KFN0cmluZyh2YWwpKTsKICByZXR1cm4gbiA+PSAwICYmIE1hdGguZmxvb3IobikgPT09IG4gJiYgaXNGaW5pdGUodmFsKTsKfQoKZnVuY3Rpb24gaXNQcm9taXNlKHZhbCkgewogIHJldHVybiBpc0RlZih2YWwpICYmIHR5cGVvZiB2YWwudGhlbiA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgdmFsLmNhdGNoID09PSAnZnVuY3Rpb24nOwp9Ci8qKg0KICogQ29udmVydCBhIHZhbHVlIHRvIGEgc3RyaW5nIHRoYXQgaXMgYWN0dWFsbHkgcmVuZGVyZWQuDQogKi8KCgpmdW5jdGlvbiB0b1N0cmluZyh2YWwpIHsKICByZXR1cm4gdmFsID09IG51bGwgPyAnJyA6IEFycmF5LmlzQXJyYXkodmFsKSB8fCBpc1BsYWluT2JqZWN0KHZhbCkgJiYgdmFsLnRvU3RyaW5nID09PSBfdG9TdHJpbmcgPyBKU09OLnN0cmluZ2lmeSh2YWwsIG51bGwsIDIpIDogU3RyaW5nKHZhbCk7Cn0KLyoqDQogKiBDb252ZXJ0IGFuIGlucHV0IHZhbHVlIHRvIGEgbnVtYmVyIGZvciBwZXJzaXN0ZW5jZS4NCiAqIElmIHRoZSBjb252ZXJzaW9uIGZhaWxzLCByZXR1cm4gb3JpZ2luYWwgc3RyaW5nLg0KICovCgoKZnVuY3Rpb24gdG9OdW1iZXIodmFsKSB7CiAgdmFyIG4gPSBwYXJzZUZsb2F0KHZhbCk7CiAgcmV0dXJuIGlzTmFOKG4pID8gdmFsIDogbjsKfQovKioNCiAqIE1ha2UgYSBtYXAgYW5kIHJldHVybiBhIGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhIGtleQ0KICogaXMgaW4gdGhhdCBtYXAuDQogKi8KCgpmdW5jdGlvbiBtYWtlTWFwKHN0ciwgZXhwZWN0c0xvd2VyQ2FzZSkgewogIHZhciBtYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIHZhciBsaXN0ID0gc3RyLnNwbGl0KCcsJyk7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgbWFwW2xpc3RbaV1dID0gdHJ1ZTsKICB9CgogIHJldHVybiBleHBlY3RzTG93ZXJDYXNlID8gZnVuY3Rpb24gKHZhbCkgewogICAgcmV0dXJuIG1hcFt2YWwudG9Mb3dlckNhc2UoKV07CiAgfSA6IGZ1bmN0aW9uICh2YWwpIHsKICAgIHJldHVybiBtYXBbdmFsXTsKICB9Owp9Ci8qKg0KICogQ2hlY2sgaWYgYSB0YWcgaXMgYSBidWlsdC1pbiB0YWcuDQogKi8KCgp2YXIgaXNCdWlsdEluVGFnID0gbWFrZU1hcCgnc2xvdCxjb21wb25lbnQnLCB0cnVlKTsKLyoqDQogKiBDaGVjayBpZiBhbiBhdHRyaWJ1dGUgaXMgYSByZXNlcnZlZCBhdHRyaWJ1dGUuDQogKi8KCnZhciBpc1Jlc2VydmVkQXR0cmlidXRlID0gbWFrZU1hcCgna2V5LHJlZixzbG90LHNsb3Qtc2NvcGUsaXMnKTsKLyoqDQogKiBSZW1vdmUgYW4gaXRlbSBmcm9tIGFuIGFycmF5Lg0KICovCgpmdW5jdGlvbiByZW1vdmUkMihhcnIsIGl0ZW0pIHsKICBpZiAoYXJyLmxlbmd0aCkgewogICAgdmFyIGluZGV4ID0gYXJyLmluZGV4T2YoaXRlbSk7CgogICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgcmV0dXJuIGFyci5zcGxpY2UoaW5kZXgsIDEpOwogICAgfQogIH0KfQovKioNCiAqIENoZWNrIHdoZXRoZXIgYW4gb2JqZWN0IGhhcyB0aGUgcHJvcGVydHkuDQogKi8KCgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKZnVuY3Rpb24gaGFzT3duKG9iaiwga2V5KSB7CiAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwp9Ci8qKg0KICogQ3JlYXRlIGEgY2FjaGVkIHZlcnNpb24gb2YgYSBwdXJlIGZ1bmN0aW9uLg0KICovCgoKZnVuY3Rpb24gY2FjaGVkKGZuKSB7CiAgdmFyIGNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICByZXR1cm4gZnVuY3Rpb24gY2FjaGVkRm4oc3RyKSB7CiAgICB2YXIgaGl0ID0gY2FjaGVbc3RyXTsKICAgIHJldHVybiBoaXQgfHwgKGNhY2hlW3N0cl0gPSBmbihzdHIpKTsKICB9Owp9Ci8qKg0KICogQ2FtZWxpemUgYSBoeXBoZW4tZGVsaW1pdGVkIHN0cmluZy4NCiAqLwoKCnZhciBjYW1lbGl6ZVJFID0gLy0oXHcpL2c7CnZhciBjYW1lbGl6ZSA9IGNhY2hlZChmdW5jdGlvbiAoc3RyKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKGNhbWVsaXplUkUsIGZ1bmN0aW9uIChfLCBjKSB7CiAgICByZXR1cm4gYyA/IGMudG9VcHBlckNhc2UoKSA6ICcnOwogIH0pOwp9KTsKLyoqDQogKiBDYXBpdGFsaXplIGEgc3RyaW5nLg0KICovCgp2YXIgY2FwaXRhbGl6ZSA9IGNhY2hlZChmdW5jdGlvbiAoc3RyKSB7CiAgcmV0dXJuIHN0ci5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0ci5zbGljZSgxKTsKfSk7Ci8qKg0KICogSHlwaGVuYXRlIGEgY2FtZWxDYXNlIHN0cmluZy4NCiAqLwoKdmFyIGh5cGhlbmF0ZVJFID0gL1xCKFtBLVpdKS9nOwp2YXIgaHlwaGVuYXRlID0gY2FjaGVkKGZ1bmN0aW9uIChzdHIpIHsKICByZXR1cm4gc3RyLnJlcGxhY2UoaHlwaGVuYXRlUkUsICctJDEnKS50b0xvd2VyQ2FzZSgpOwp9KTsKLyoqDQogKiBTaW1wbGUgYmluZCBwb2x5ZmlsbCBmb3IgZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IHN1cHBvcnQgaXQsDQogKiBlLmcuLCBQaGFudG9tSlMgMS54LiBUZWNobmljYWxseSwgd2UgZG9uJ3QgbmVlZCB0aGlzIGFueW1vcmUNCiAqIHNpbmNlIG5hdGl2ZSBiaW5kIGlzIG5vdyBwZXJmb3JtYW50IGVub3VnaCBpbiBtb3N0IGJyb3dzZXJzLg0KICogQnV0IHJlbW92aW5nIGl0IHdvdWxkIG1lYW4gYnJlYWtpbmcgY29kZSB0aGF0IHdhcyBhYmxlIHRvIHJ1biBpbg0KICogUGhhbnRvbUpTIDEueCwgc28gdGhpcyBtdXN0IGJlIGtlcHQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkuDQogKi8KCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgpmdW5jdGlvbiBwb2x5ZmlsbEJpbmQoZm4sIGN0eCkgewogIGZ1bmN0aW9uIGJvdW5kRm4oYSkgewogICAgdmFyIGwgPSBhcmd1bWVudHMubGVuZ3RoOwogICAgcmV0dXJuIGwgPyBsID4gMSA/IGZuLmFwcGx5KGN0eCwgYXJndW1lbnRzKSA6IGZuLmNhbGwoY3R4LCBhKSA6IGZuLmNhbGwoY3R4KTsKICB9CgogIGJvdW5kRm4uX2xlbmd0aCA9IGZuLmxlbmd0aDsKICByZXR1cm4gYm91bmRGbjsKfQoKZnVuY3Rpb24gbmF0aXZlQmluZChmbiwgY3R4KSB7CiAgcmV0dXJuIGZuLmJpbmQoY3R4KTsKfSAvLyBAdHMtZXhwZWN0LWVycm9yIGJpbmQgY2Fubm90IGJlIGB1bmRlZmluZWRgCgoKdmFyIGJpbmQgPSBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA/IG5hdGl2ZUJpbmQgOiBwb2x5ZmlsbEJpbmQ7Ci8qKg0KICogQ29udmVydCBhbiBBcnJheS1saWtlIG9iamVjdCB0byBhIHJlYWwgQXJyYXkuDQogKi8KCmZ1bmN0aW9uIHRvQXJyYXkobGlzdCwgc3RhcnQpIHsKICBzdGFydCA9IHN0YXJ0IHx8IDA7CiAgdmFyIGkgPSBsaXN0Lmxlbmd0aCAtIHN0YXJ0OwogIHZhciByZXQgPSBuZXcgQXJyYXkoaSk7CgogIHdoaWxlIChpLS0pIHsKICAgIHJldFtpXSA9IGxpc3RbaSArIHN0YXJ0XTsKICB9CgogIHJldHVybiByZXQ7Cn0KLyoqDQogKiBNaXggcHJvcGVydGllcyBpbnRvIHRhcmdldCBvYmplY3QuDQogKi8KCgpmdW5jdGlvbiBleHRlbmQodG8sIF9mcm9tKSB7CiAgZm9yICh2YXIga2V5IGluIF9mcm9tKSB7CiAgICB0b1trZXldID0gX2Zyb21ba2V5XTsKICB9CgogIHJldHVybiB0bzsKfQovKioNCiAqIE1lcmdlIGFuIEFycmF5IG9mIE9iamVjdHMgaW50byBhIHNpbmdsZSBPYmplY3QuDQogKi8KCgpmdW5jdGlvbiB0b09iamVjdChhcnIpIHsKICB2YXIgcmVzID0ge307CgogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoYXJyW2ldKSB7CiAgICAgIGV4dGVuZChyZXMsIGFycltpXSk7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9Ci8qIGVzbGludC1kaXNhYmxlIG5vLXVudXNlZC12YXJzICovCgovKioNCiAqIFBlcmZvcm0gbm8gb3BlcmF0aW9uLg0KICogU3R1YmJpbmcgYXJncyB0byBtYWtlIEZsb3cgaGFwcHkgd2l0aG91dCBsZWF2aW5nIHVzZWxlc3MgdHJhbnNwaWxlZCBjb2RlDQogKiB3aXRoIC4uLnJlc3QgKGh0dHBzOi8vZmxvdy5vcmcvYmxvZy8yMDE3LzA1LzA3L1N0cmljdC1GdW5jdGlvbi1DYWxsLUFyaXR5LykuDQogKi8KCgpmdW5jdGlvbiBub29wKGEsIGIsIGMpIHt9Ci8qKg0KICogQWx3YXlzIHJldHVybiBmYWxzZS4NCiAqLwoKCnZhciBubyA9IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgcmV0dXJuIGZhbHNlOwp9OwovKiBlc2xpbnQtZW5hYmxlIG5vLXVudXNlZC12YXJzICovCgovKioNCiAqIFJldHVybiB0aGUgc2FtZSB2YWx1ZS4NCiAqLwoKCnZhciBpZGVudGl0eSA9IGZ1bmN0aW9uIChfKSB7CiAgcmV0dXJuIF87Cn07Ci8qKg0KICogQ2hlY2sgaWYgdHdvIHZhbHVlcyBhcmUgbG9vc2VseSBlcXVhbCAtIHRoYXQgaXMsDQogKiBpZiB0aGV5IGFyZSBwbGFpbiBvYmplY3RzLCBkbyB0aGV5IGhhdmUgdGhlIHNhbWUgc2hhcGU/DQogKi8KCgpmdW5jdGlvbiBsb29zZUVxdWFsKGEsIGIpIHsKICBpZiAoYSA9PT0gYikgcmV0dXJuIHRydWU7CiAgdmFyIGlzT2JqZWN0QSA9IGlzT2JqZWN0KGEpOwogIHZhciBpc09iamVjdEIgPSBpc09iamVjdChiKTsKCiAgaWYgKGlzT2JqZWN0QSAmJiBpc09iamVjdEIpIHsKICAgIHRyeSB7CiAgICAgIHZhciBpc0FycmF5QSA9IEFycmF5LmlzQXJyYXkoYSk7CiAgICAgIHZhciBpc0FycmF5QiA9IEFycmF5LmlzQXJyYXkoYik7CgogICAgICBpZiAoaXNBcnJheUEgJiYgaXNBcnJheUIpIHsKICAgICAgICByZXR1cm4gYS5sZW5ndGggPT09IGIubGVuZ3RoICYmIGEuZXZlcnkoZnVuY3Rpb24gKGUsIGkpIHsKICAgICAgICAgIHJldHVybiBsb29zZUVxdWFsKGUsIGJbaV0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGEgaW5zdGFuY2VvZiBEYXRlICYmIGIgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgcmV0dXJuIGEuZ2V0VGltZSgpID09PSBiLmdldFRpbWUoKTsKICAgICAgfSBlbHNlIGlmICghaXNBcnJheUEgJiYgIWlzQXJyYXlCKSB7CiAgICAgICAgdmFyIGtleXNBID0gT2JqZWN0LmtleXMoYSk7CiAgICAgICAgdmFyIGtleXNCID0gT2JqZWN0LmtleXMoYik7CiAgICAgICAgcmV0dXJuIGtleXNBLmxlbmd0aCA9PT0ga2V5c0IubGVuZ3RoICYmIGtleXNBLmV2ZXJ5KGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHJldHVybiBsb29zZUVxdWFsKGFba2V5XSwgYltrZXldKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSBlbHNlIGlmICghaXNPYmplY3RBICYmICFpc09iamVjdEIpIHsKICAgIHJldHVybiBTdHJpbmcoYSkgPT09IFN0cmluZyhiKTsKICB9IGVsc2UgewogICAgcmV0dXJuIGZhbHNlOwogIH0KfQovKioNCiAqIFJldHVybiB0aGUgZmlyc3QgaW5kZXggYXQgd2hpY2ggYSBsb29zZWx5IGVxdWFsIHZhbHVlIGNhbiBiZQ0KICogZm91bmQgaW4gdGhlIGFycmF5IChpZiB2YWx1ZSBpcyBhIHBsYWluIG9iamVjdCwgdGhlIGFycmF5IG11c3QNCiAqIGNvbnRhaW4gYW4gb2JqZWN0IG9mIHRoZSBzYW1lIHNoYXBlKSwgb3IgLTEgaWYgaXQgaXMgbm90IHByZXNlbnQuDQogKi8KCgpmdW5jdGlvbiBsb29zZUluZGV4T2YoYXJyLCB2YWwpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgaWYgKGxvb3NlRXF1YWwoYXJyW2ldLCB2YWwpKSByZXR1cm4gaTsKICB9CgogIHJldHVybiAtMTsKfQovKioNCiAqIEVuc3VyZSBhIGZ1bmN0aW9uIGlzIGNhbGxlZCBvbmx5IG9uY2UuDQogKi8KCgpmdW5jdGlvbiBvbmNlKGZuKSB7CiAgdmFyIGNhbGxlZCA9IGZhbHNlOwogIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNhbGxlZCkgewogICAgICBjYWxsZWQgPSB0cnVlOwogICAgICBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH07Cn0gLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvT2JqZWN0L2lzI3BvbHlmaWxsCgoKZnVuY3Rpb24gaGFzQ2hhbmdlZCh4LCB5KSB7CiAgaWYgKHggPT09IHkpIHsKICAgIHJldHVybiB4ID09PSAwICYmIDEgLyB4ICE9PSAxIC8geTsKICB9IGVsc2UgewogICAgcmV0dXJuIHggPT09IHggfHwgeSA9PT0geTsKICB9Cn0KCnZhciBTU1JfQVRUUiA9ICdkYXRhLXNlcnZlci1yZW5kZXJlZCc7CnZhciBBU1NFVF9UWVBFUyA9IFsnY29tcG9uZW50JywgJ2RpcmVjdGl2ZScsICdmaWx0ZXInXTsKdmFyIExJRkVDWUNMRV9IT09LUyA9IFsnYmVmb3JlQ3JlYXRlJywgJ2NyZWF0ZWQnLCAnYmVmb3JlTW91bnQnLCAnbW91bnRlZCcsICdiZWZvcmVVcGRhdGUnLCAndXBkYXRlZCcsICdiZWZvcmVEZXN0cm95JywgJ2Rlc3Ryb3llZCcsICdhY3RpdmF0ZWQnLCAnZGVhY3RpdmF0ZWQnLCAnZXJyb3JDYXB0dXJlZCcsICdzZXJ2ZXJQcmVmZXRjaCcsICdyZW5kZXJUcmFja2VkJywgJ3JlbmRlclRyaWdnZXJlZCddOwp2YXIgY29uZmlnID0gewogIC8qKg0KICAgKiBPcHRpb24gbWVyZ2Ugc3RyYXRlZ2llcyAodXNlZCBpbiBjb3JlL3V0aWwvb3B0aW9ucykNCiAgICovCiAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgb3B0aW9uTWVyZ2VTdHJhdGVnaWVzOiBPYmplY3QuY3JlYXRlKG51bGwpLAoKICAvKioNCiAgICogV2hldGhlciB0byBzdXBwcmVzcyB3YXJuaW5ncy4NCiAgICovCiAgc2lsZW50OiBmYWxzZSwKCiAgLyoqDQogICAqIFNob3cgcHJvZHVjdGlvbiBtb2RlIHRpcCBtZXNzYWdlIG9uIGJvb3Q/DQogICAqLwogIHByb2R1Y3Rpb25UaXA6IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicsCgogIC8qKg0KICAgKiBXaGV0aGVyIHRvIGVuYWJsZSBkZXZ0b29scw0KICAgKi8KICBkZXZ0b29sczogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJywKCiAgLyoqDQogICAqIFdoZXRoZXIgdG8gcmVjb3JkIHBlcmYNCiAgICovCiAgcGVyZm9ybWFuY2U6IGZhbHNlLAoKICAvKioNCiAgICogRXJyb3IgaGFuZGxlciBmb3Igd2F0Y2hlciBlcnJvcnMNCiAgICovCiAgZXJyb3JIYW5kbGVyOiBudWxsLAoKICAvKioNCiAgICogV2FybiBoYW5kbGVyIGZvciB3YXRjaGVyIHdhcm5zDQogICAqLwogIHdhcm5IYW5kbGVyOiBudWxsLAoKICAvKioNCiAgICogSWdub3JlIGNlcnRhaW4gY3VzdG9tIGVsZW1lbnRzDQogICAqLwogIGlnbm9yZWRFbGVtZW50czogW10sCgogIC8qKg0KICAgKiBDdXN0b20gdXNlciBrZXkgYWxpYXNlcyBmb3Igdi1vbg0KICAgKi8KICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICBrZXlDb2RlczogT2JqZWN0LmNyZWF0ZShudWxsKSwKCiAgLyoqDQogICAqIENoZWNrIGlmIGEgdGFnIGlzIHJlc2VydmVkIHNvIHRoYXQgaXQgY2Fubm90IGJlIHJlZ2lzdGVyZWQgYXMgYQ0KICAgKiBjb21wb25lbnQuIFRoaXMgaXMgcGxhdGZvcm0tZGVwZW5kZW50IGFuZCBtYXkgYmUgb3ZlcndyaXR0ZW4uDQogICAqLwogIGlzUmVzZXJ2ZWRUYWc6IG5vLAoKICAvKioNCiAgICogQ2hlY2sgaWYgYW4gYXR0cmlidXRlIGlzIHJlc2VydmVkIHNvIHRoYXQgaXQgY2Fubm90IGJlIHVzZWQgYXMgYSBjb21wb25lbnQNCiAgICogcHJvcC4gVGhpcyBpcyBwbGF0Zm9ybS1kZXBlbmRlbnQgYW5kIG1heSBiZSBvdmVyd3JpdHRlbi4NCiAgICovCiAgaXNSZXNlcnZlZEF0dHI6IG5vLAoKICAvKioNCiAgICogQ2hlY2sgaWYgYSB0YWcgaXMgYW4gdW5rbm93biBlbGVtZW50Lg0KICAgKiBQbGF0Zm9ybS1kZXBlbmRlbnQuDQogICAqLwogIGlzVW5rbm93bkVsZW1lbnQ6IG5vLAoKICAvKioNCiAgICogR2V0IHRoZSBuYW1lc3BhY2Ugb2YgYW4gZWxlbWVudA0KICAgKi8KICBnZXRUYWdOYW1lc3BhY2U6IG5vb3AsCgogIC8qKg0KICAgKiBQYXJzZSB0aGUgcmVhbCB0YWcgbmFtZSBmb3IgdGhlIHNwZWNpZmljIHBsYXRmb3JtLg0KICAgKi8KICBwYXJzZVBsYXRmb3JtVGFnTmFtZTogaWRlbnRpdHksCgogIC8qKg0KICAgKiBDaGVjayBpZiBhbiBhdHRyaWJ1dGUgbXVzdCBiZSBib3VuZCB1c2luZyBwcm9wZXJ0eSwgZS5nLiB2YWx1ZQ0KICAgKiBQbGF0Zm9ybS1kZXBlbmRlbnQuDQogICAqLwogIG11c3RVc2VQcm9wOiBubywKCiAgLyoqDQogICAqIFBlcmZvcm0gdXBkYXRlcyBhc3luY2hyb25vdXNseS4gSW50ZW5kZWQgdG8gYmUgdXNlZCBieSBWdWUgVGVzdCBVdGlscw0KICAgKiBUaGlzIHdpbGwgc2lnbmlmaWNhbnRseSByZWR1Y2UgcGVyZm9ybWFuY2UgaWYgc2V0IHRvIGZhbHNlLg0KICAgKi8KICBhc3luYzogdHJ1ZSwKCiAgLyoqDQogICAqIEV4cG9zZWQgZm9yIGxlZ2FjeSByZWFzb25zDQogICAqLwogIF9saWZlY3ljbGVIb29rczogTElGRUNZQ0xFX0hPT0tTCn07Ci8qKg0KICogdW5pY29kZSBsZXR0ZXJzIHVzZWQgZm9yIHBhcnNpbmcgaHRtbCB0YWdzLCBjb21wb25lbnQgbmFtZXMgYW5kIHByb3BlcnR5IHBhdGhzLg0KICogdXNpbmcgaHR0cHM6Ly93d3cudzMub3JnL1RSL2h0bWw1My9zZW1hbnRpY3Mtc2NyaXB0aW5nLmh0bWwjcG90ZW50aWFsY3VzdG9tZWxlbWVudG5hbWUNCiAqIHNraXBwaW5nIFx1MTAwMDAtXHVFRkZGRiBkdWUgdG8gaXQgZnJlZXppbmcgdXAgUGhhbnRvbUpTDQogKi8KCnZhciB1bmljb2RlUmVnRXhwID0gL2EtekEtWlx1MDBCN1x1MDBDMC1cdTAwRDZcdTAwRDgtXHUwMEY2XHUwMEY4LVx1MDM3RFx1MDM3Ri1cdTFGRkZcdTIwMEMtXHUyMDBEXHUyMDNGLVx1MjA0MFx1MjA3MC1cdTIxOEZcdTJDMDAtXHUyRkVGXHUzMDAxLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkZELzsKLyoqDQogKiBDaGVjayBpZiBhIHN0cmluZyBzdGFydHMgd2l0aCAkIG9yIF8NCiAqLwoKZnVuY3Rpb24gaXNSZXNlcnZlZChzdHIpIHsKICB2YXIgYyA9IChzdHIgKyAnJykuY2hhckNvZGVBdCgwKTsKICByZXR1cm4gYyA9PT0gMHgyNCB8fCBjID09PSAweDVmOwp9Ci8qKg0KICogRGVmaW5lIGEgcHJvcGVydHkuDQogKi8KCgpmdW5jdGlvbiBkZWYob2JqLCBrZXksIHZhbCwgZW51bWVyYWJsZSkgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgdmFsdWU6IHZhbCwKICAgIGVudW1lcmFibGU6ICEhZW51bWVyYWJsZSwKICAgIHdyaXRhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSk7Cn0KLyoqDQogKiBQYXJzZSBzaW1wbGUgcGF0aC4NCiAqLwoKCnZhciBiYWlsUkUgPSBuZXcgUmVnRXhwKCJbXiIuY29uY2F0KHVuaWNvZGVSZWdFeHAuc291cmNlLCAiLiRfXFxkXSIpKTsKCmZ1bmN0aW9uIHBhcnNlUGF0aChwYXRoKSB7CiAgaWYgKGJhaWxSRS50ZXN0KHBhdGgpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgcmV0dXJuIGZ1bmN0aW9uIChvYmopIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VnbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCFvYmopIHJldHVybjsKICAgICAgb2JqID0gb2JqW3NlZ21lbnRzW2ldXTsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0gLy8gY2FuIHdlIHVzZSBfX3Byb3RvX18/CgoKdmFyIGhhc1Byb3RvID0gKCdfX3Byb3RvX18nIGluIHt9KTsgLy8gQnJvd3NlciBlbnZpcm9ubWVudCBzbmlmZmluZwoKdmFyIGluQnJvd3NlciA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnOwp2YXIgVUEgPSBpbkJyb3dzZXIgJiYgd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTsKdmFyIGlzSUUgPSBVQSAmJiAvbXNpZXx0cmlkZW50Ly50ZXN0KFVBKTsKdmFyIGlzSUU5ID0gVUEgJiYgVUEuaW5kZXhPZignbXNpZSA5LjAnKSA+IDA7CnZhciBpc0VkZ2UgPSBVQSAmJiBVQS5pbmRleE9mKCdlZGdlLycpID4gMDsKVUEgJiYgVUEuaW5kZXhPZignYW5kcm9pZCcpID4gMDsKdmFyIGlzSU9TID0gVUEgJiYgL2lwaG9uZXxpcGFkfGlwb2R8aW9zLy50ZXN0KFVBKTsKVUEgJiYgL2Nocm9tZVwvXGQrLy50ZXN0KFVBKSAmJiAhaXNFZGdlOwpVQSAmJiAvcGhhbnRvbWpzLy50ZXN0KFVBKTsKdmFyIGlzRkYgPSBVQSAmJiBVQS5tYXRjaCgvZmlyZWZveFwvKFxkKykvKTsgLy8gRmlyZWZveCBoYXMgYSAid2F0Y2giIGZ1bmN0aW9uIG9uIE9iamVjdC5wcm90b3R5cGUuLi4KLy8gQHRzLWV4cGVjdC1lcnJvciBmaXJlYm94IHN1cHBvcnQKCnZhciBuYXRpdmVXYXRjaCA9IHt9LndhdGNoOwp2YXIgc3VwcG9ydHNQYXNzaXZlID0gZmFsc2U7CgppZiAoaW5Ccm93c2VyKSB7CiAgdHJ5IHsKICAgIHZhciBvcHRzID0ge307CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3B0cywgJ3Bhc3NpdmUnLCB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAgc3VwcG9ydHNQYXNzaXZlID0gdHJ1ZTsKICAgICAgfQogICAgfSk7IC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9mbG93L2lzc3Vlcy8yODUKCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndGVzdC1wYXNzaXZlJywgbnVsbCwgb3B0cyk7CiAgfSBjYXRjaCAoZSkge30KfSAvLyB0aGlzIG5lZWRzIHRvIGJlIGxhenktZXZhbGVkIGJlY2F1c2UgdnVlIG1heSBiZSByZXF1aXJlZCBiZWZvcmUKLy8gdnVlLXNlcnZlci1yZW5kZXJlciBjYW4gc2V0IFZVRV9FTlYKCgp2YXIgX2lzU2VydmVyOwoKdmFyIGlzU2VydmVyUmVuZGVyaW5nID0gZnVuY3Rpb24gKCkgewogIGlmIChfaXNTZXJ2ZXIgPT09IHVuZGVmaW5lZCkgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoIWluQnJvd3NlciAmJiB0eXBlb2YgZ2xvYmFsICE9PSAndW5kZWZpbmVkJykgewogICAgICAvLyBkZXRlY3QgcHJlc2VuY2Ugb2YgdnVlLXNlcnZlci1yZW5kZXJlciBhbmQgYXZvaWQKICAgICAgLy8gV2VicGFjayBzaGltbWluZyB0aGUgcHJvY2VzcwogICAgICBfaXNTZXJ2ZXIgPSBnbG9iYWxbJ3Byb2Nlc3MnXSAmJiBnbG9iYWxbJ3Byb2Nlc3MnXS5lbnYuVlVFX0VOViA9PT0gJ3NlcnZlcic7CiAgICB9IGVsc2UgewogICAgICBfaXNTZXJ2ZXIgPSBmYWxzZTsKICAgIH0KICB9CgogIHJldHVybiBfaXNTZXJ2ZXI7Cn07IC8vIGRldGVjdCBkZXZ0b29scwoKCnZhciBkZXZ0b29scyA9IGluQnJvd3NlciAmJiB3aW5kb3cuX19WVUVfREVWVE9PTFNfR0xPQkFMX0hPT0tfXzsKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCmZ1bmN0aW9uIGlzTmF0aXZlKEN0b3IpIHsKICByZXR1cm4gdHlwZW9mIEN0b3IgPT09ICdmdW5jdGlvbicgJiYgL25hdGl2ZSBjb2RlLy50ZXN0KEN0b3IudG9TdHJpbmcoKSk7Cn0KCnZhciBoYXNTeW1ib2wgPSB0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShTeW1ib2wpICYmIHR5cGVvZiBSZWZsZWN0ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShSZWZsZWN0Lm93bktleXMpOwoKdmFyIF9TZXQ7IC8vICRmbG93LWRpc2FibGUtbGluZQoKLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKaWYgKHR5cGVvZiBTZXQgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFNldCkpIHsKICAvLyB1c2UgbmF0aXZlIFNldCB3aGVuIGF2YWlsYWJsZS4KICBfU2V0ID0gU2V0Owp9IGVsc2UgewogIC8vIGEgbm9uLXN0YW5kYXJkIFNldCBwb2x5ZmlsbCB0aGF0IG9ubHkgd29ya3Mgd2l0aCBwcmltaXRpdmUga2V5cy4KICBfU2V0ID0KICAvKiogQGNsYXNzICovCiAgZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gU2V0KCkgewogICAgICB0aGlzLnNldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9CgogICAgU2V0LnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLnNldFtrZXldID09PSB0cnVlOwogICAgfTsKCiAgICBTZXQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgdGhpcy5zZXRba2V5XSA9IHRydWU7CiAgICB9OwoKICAgIFNldC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuc2V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH07CgogICAgcmV0dXJuIFNldDsKICB9KCk7Cn0KCnZhciBjdXJyZW50SW5zdGFuY2UgPSBudWxsOwovKioNCiAqIFRoaXMgaXMgZXhwb3NlZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIHYzIChlLmcuIHNvbWUgZnVuY3Rpb25zIGluIFZ1ZVVzZQ0KICogcmVsaWVzIG9uIGl0KS4gRG8gbm90IHVzZSB0aGlzIGludGVybmFsbHksIGp1c3QgdXNlIGBjdXJyZW50SW5zdGFuY2VgLg0KICoNCiAqIEBpbnRlcm5hbCB0aGlzIGZ1bmN0aW9uIG5lZWRzIG1hbnVhbCB0eXBlIGRlY2xhcmF0aW9uIGJlY2F1c2UgaXQgcmVsaWVzDQogKiBvbiBwcmV2aW91c2x5IG1hbnVhbGx5IGF1dGhvcmVkIHR5cGVzIGZyb20gVnVlIDINCiAqLwoKZnVuY3Rpb24gZ2V0Q3VycmVudEluc3RhbmNlKCkgewogIHJldHVybiBjdXJyZW50SW5zdGFuY2UgJiYgewogICAgcHJveHk6IGN1cnJlbnRJbnN0YW5jZQogIH07Cn0KLyoqDQogKiBAaW50ZXJuYWwNCiAqLwoKCmZ1bmN0aW9uIHNldEN1cnJlbnRJbnN0YW5jZSh2bSkgewogIGlmICh2bSA9PT0gdm9pZCAwKSB7CiAgICB2bSA9IG51bGw7CiAgfQoKICBpZiAoIXZtKSBjdXJyZW50SW5zdGFuY2UgJiYgY3VycmVudEluc3RhbmNlLl9zY29wZS5vZmYoKTsKICBjdXJyZW50SW5zdGFuY2UgPSB2bTsKICB2bSAmJiB2bS5fc2NvcGUub24oKTsKfQovKioNCiAqIEBpbnRlcm5hbA0KICovCgoKdmFyIFZOb2RlID0KLyoqIEBjbGFzcyAqLwpmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gVk5vZGUodGFnLCBkYXRhLCBjaGlsZHJlbiwgdGV4dCwgZWxtLCBjb250ZXh0LCBjb21wb25lbnRPcHRpb25zLCBhc3luY0ZhY3RvcnkpIHsKICAgIHRoaXMudGFnID0gdGFnOwogICAgdGhpcy5kYXRhID0gZGF0YTsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICB0aGlzLmVsbSA9IGVsbTsKICAgIHRoaXMubnMgPSB1bmRlZmluZWQ7CiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgdGhpcy5mbkNvbnRleHQgPSB1bmRlZmluZWQ7CiAgICB0aGlzLmZuT3B0aW9ucyA9IHVuZGVmaW5lZDsKICAgIHRoaXMuZm5TY29wZUlkID0gdW5kZWZpbmVkOwogICAgdGhpcy5rZXkgPSBkYXRhICYmIGRhdGEua2V5OwogICAgdGhpcy5jb21wb25lbnRPcHRpb25zID0gY29tcG9uZW50T3B0aW9uczsKICAgIHRoaXMuY29tcG9uZW50SW5zdGFuY2UgPSB1bmRlZmluZWQ7CiAgICB0aGlzLnBhcmVudCA9IHVuZGVmaW5lZDsKICAgIHRoaXMucmF3ID0gZmFsc2U7CiAgICB0aGlzLmlzU3RhdGljID0gZmFsc2U7CiAgICB0aGlzLmlzUm9vdEluc2VydCA9IHRydWU7CiAgICB0aGlzLmlzQ29tbWVudCA9IGZhbHNlOwogICAgdGhpcy5pc0Nsb25lZCA9IGZhbHNlOwogICAgdGhpcy5pc09uY2UgPSBmYWxzZTsKICAgIHRoaXMuYXN5bmNGYWN0b3J5ID0gYXN5bmNGYWN0b3J5OwogICAgdGhpcy5hc3luY01ldGEgPSB1bmRlZmluZWQ7CiAgICB0aGlzLmlzQXN5bmNQbGFjZWhvbGRlciA9IGZhbHNlOwogIH0KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZOb2RlLnByb3RvdHlwZSwgImNoaWxkIiwgewogICAgLy8gREVQUkVDQVRFRDogYWxpYXMgZm9yIGNvbXBvbmVudEluc3RhbmNlIGZvciBiYWNrd2FyZHMgY29tcGF0LgoKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuY29tcG9uZW50SW5zdGFuY2U7CiAgICB9LAogICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICBjb25maWd1cmFibGU6IHRydWUKICB9KTsKICByZXR1cm4gVk5vZGU7Cn0oKTsKCnZhciBjcmVhdGVFbXB0eVZOb2RlID0gZnVuY3Rpb24gKHRleHQpIHsKICBpZiAodGV4dCA9PT0gdm9pZCAwKSB7CiAgICB0ZXh0ID0gJyc7CiAgfQoKICB2YXIgbm9kZSA9IG5ldyBWTm9kZSgpOwogIG5vZGUudGV4dCA9IHRleHQ7CiAgbm9kZS5pc0NvbW1lbnQgPSB0cnVlOwogIHJldHVybiBub2RlOwp9OwoKZnVuY3Rpb24gY3JlYXRlVGV4dFZOb2RlKHZhbCkgewogIHJldHVybiBuZXcgVk5vZGUodW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgU3RyaW5nKHZhbCkpOwp9IC8vIG9wdGltaXplZCBzaGFsbG93IGNsb25lCi8vIHVzZWQgZm9yIHN0YXRpYyBub2RlcyBhbmQgc2xvdCBub2RlcyBiZWNhdXNlIHRoZXkgbWF5IGJlIHJldXNlZCBhY3Jvc3MKLy8gbXVsdGlwbGUgcmVuZGVycywgY2xvbmluZyB0aGVtIGF2b2lkcyBlcnJvcnMgd2hlbiBET00gbWFuaXB1bGF0aW9ucyByZWx5Ci8vIG9uIHRoZWlyIGVsbSByZWZlcmVuY2UuCgoKZnVuY3Rpb24gY2xvbmVWTm9kZSh2bm9kZSkgewogIHZhciBjbG9uZWQgPSBuZXcgVk5vZGUodm5vZGUudGFnLCB2bm9kZS5kYXRhLCAvLyAjNzk3NQogIC8vIGNsb25lIGNoaWxkcmVuIGFycmF5IHRvIGF2b2lkIG11dGF0aW5nIG9yaWdpbmFsIGluIGNhc2Ugb2YgY2xvbmluZwogIC8vIGEgY2hpbGQuCiAgdm5vZGUuY2hpbGRyZW4gJiYgdm5vZGUuY2hpbGRyZW4uc2xpY2UoKSwgdm5vZGUudGV4dCwgdm5vZGUuZWxtLCB2bm9kZS5jb250ZXh0LCB2bm9kZS5jb21wb25lbnRPcHRpb25zLCB2bm9kZS5hc3luY0ZhY3RvcnkpOwogIGNsb25lZC5ucyA9IHZub2RlLm5zOwogIGNsb25lZC5pc1N0YXRpYyA9IHZub2RlLmlzU3RhdGljOwogIGNsb25lZC5rZXkgPSB2bm9kZS5rZXk7CiAgY2xvbmVkLmlzQ29tbWVudCA9IHZub2RlLmlzQ29tbWVudDsKICBjbG9uZWQuZm5Db250ZXh0ID0gdm5vZGUuZm5Db250ZXh0OwogIGNsb25lZC5mbk9wdGlvbnMgPSB2bm9kZS5mbk9wdGlvbnM7CiAgY2xvbmVkLmZuU2NvcGVJZCA9IHZub2RlLmZuU2NvcGVJZDsKICBjbG9uZWQuYXN5bmNNZXRhID0gdm5vZGUuYXN5bmNNZXRhOwogIGNsb25lZC5pc0Nsb25lZCA9IHRydWU7CiAgcmV0dXJuIGNsb25lZDsKfQovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqDQpDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4NCg0KUGVybWlzc2lvbiB0byB1c2UsIGNvcHksIG1vZGlmeSwgYW5kL29yIGRpc3RyaWJ1dGUgdGhpcyBzb2Z0d2FyZSBmb3IgYW55DQpwdXJwb3NlIHdpdGggb3Igd2l0aG91dCBmZWUgaXMgaGVyZWJ5IGdyYW50ZWQuDQoNClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiIEFORCBUSEUgQVVUSE9SIERJU0NMQUlNUyBBTEwgV0FSUkFOVElFUyBXSVRIDQpSRUdBUkQgVE8gVEhJUyBTT0ZUV0FSRSBJTkNMVURJTkcgQUxMIElNUExJRUQgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkNCkFORCBGSVRORVNTLiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SIEJFIExJQUJMRSBGT1IgQU5ZIFNQRUNJQUwsIERJUkVDVCwNCklORElSRUNULCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgT1IgQU5ZIERBTUFHRVMgV0hBVFNPRVZFUiBSRVNVTFRJTkcgRlJPTQ0KTE9TUyBPRiBVU0UsIERBVEEgT1IgUFJPRklUUywgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIE5FR0xJR0VOQ0UgT1INCk9USEVSIFRPUlRJT1VTIEFDVElPTiwgQVJJU0lORyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBVU0UgT1INClBFUkZPUk1BTkNFIE9GIFRISVMgU09GVFdBUkUuDQoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiAqLwoKCnZhciBfX2Fzc2lnbiA9IGZ1bmN0aW9uICgpIHsKICBfX2Fzc2lnbiA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24gX19hc3NpZ24odCkgewogICAgZm9yICh2YXIgcywgaSA9IDEsIG4gPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIHMgPSBhcmd1bWVudHNbaV07CgogICAgICBmb3IgKHZhciBwIGluIHMpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocywgcCkpIHRbcF0gPSBzW3BdOwogICAgfQoKICAgIHJldHVybiB0OwogIH07CgogIHJldHVybiBfX2Fzc2lnbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKdmFyIHVpZCQyID0gMDsKLyoqDQogKiBBIGRlcCBpcyBhbiBvYnNlcnZhYmxlIHRoYXQgY2FuIGhhdmUgbXVsdGlwbGUNCiAqIGRpcmVjdGl2ZXMgc3Vic2NyaWJpbmcgdG8gaXQuDQogKiBAaW50ZXJuYWwNCiAqLwoKdmFyIERlcCA9Ci8qKiBAY2xhc3MgKi8KZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIERlcCgpIHsKICAgIHRoaXMuaWQgPSB1aWQkMisrOwogICAgdGhpcy5zdWJzID0gW107CiAgfQoKICBEZXAucHJvdG90eXBlLmFkZFN1YiA9IGZ1bmN0aW9uIChzdWIpIHsKICAgIHRoaXMuc3Vicy5wdXNoKHN1Yik7CiAgfTsKCiAgRGVwLnByb3RvdHlwZS5yZW1vdmVTdWIgPSBmdW5jdGlvbiAoc3ViKSB7CiAgICByZW1vdmUkMih0aGlzLnN1YnMsIHN1Yik7CiAgfTsKCiAgRGVwLnByb3RvdHlwZS5kZXBlbmQgPSBmdW5jdGlvbiAoaW5mbykgewogICAgaWYgKERlcC50YXJnZXQpIHsKICAgICAgRGVwLnRhcmdldC5hZGREZXAodGhpcyk7CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBpbmZvICYmIERlcC50YXJnZXQub25UcmFjaykgewogICAgICAgIERlcC50YXJnZXQub25UcmFjayhfX2Fzc2lnbih7CiAgICAgICAgICBlZmZlY3Q6IERlcC50YXJnZXQKICAgICAgICB9LCBpbmZvKSk7CiAgICAgIH0KICAgIH0KICB9OwoKICBEZXAucHJvdG90eXBlLm5vdGlmeSA9IGZ1bmN0aW9uIChpbmZvKSB7CiAgICAvLyBzdGFiaWxpemUgdGhlIHN1YnNjcmliZXIgbGlzdCBmaXJzdAogICAgdmFyIHN1YnMgPSB0aGlzLnN1YnMuc2xpY2UoKTsKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhY29uZmlnLmFzeW5jKSB7CiAgICAgIC8vIHN1YnMgYXJlbid0IHNvcnRlZCBpbiBzY2hlZHVsZXIgaWYgbm90IHJ1bm5pbmcgYXN5bmMKICAgICAgLy8gd2UgbmVlZCB0byBzb3J0IHRoZW0gbm93IHRvIG1ha2Ugc3VyZSB0aGV5IGZpcmUgaW4gY29ycmVjdAogICAgICAvLyBvcmRlcgogICAgICBzdWJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYS5pZCAtIGIuaWQ7CiAgICAgIH0pOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwLCBsID0gc3Vicy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaW5mbykgewogICAgICAgIHZhciBzdWIgPSBzdWJzW2ldOwogICAgICAgIHN1Yi5vblRyaWdnZXIgJiYgc3ViLm9uVHJpZ2dlcihfX2Fzc2lnbih7CiAgICAgICAgICBlZmZlY3Q6IHN1YnNbaV0KICAgICAgICB9LCBpbmZvKSk7CiAgICAgIH0KCiAgICAgIHN1YnNbaV0udXBkYXRlKCk7CiAgICB9CiAgfTsKCiAgcmV0dXJuIERlcDsKfSgpOyAvLyBUaGUgY3VycmVudCB0YXJnZXQgd2F0Y2hlciBiZWluZyBldmFsdWF0ZWQuCi8vIFRoaXMgaXMgZ2xvYmFsbHkgdW5pcXVlIGJlY2F1c2Ugb25seSBvbmUgd2F0Y2hlcgovLyBjYW4gYmUgZXZhbHVhdGVkIGF0IGEgdGltZS4KCgpEZXAudGFyZ2V0ID0gbnVsbDsKdmFyIHRhcmdldFN0YWNrID0gW107CgpmdW5jdGlvbiBwdXNoVGFyZ2V0KHRhcmdldCkgewogIHRhcmdldFN0YWNrLnB1c2godGFyZ2V0KTsKICBEZXAudGFyZ2V0ID0gdGFyZ2V0Owp9CgpmdW5jdGlvbiBwb3BUYXJnZXQoKSB7CiAgdGFyZ2V0U3RhY2sucG9wKCk7CiAgRGVwLnRhcmdldCA9IHRhcmdldFN0YWNrW3RhcmdldFN0YWNrLmxlbmd0aCAtIDFdOwp9Ci8qDQogKiBub3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgcGxheSB3ZWxsIHdpdGgNCiAqIGR5bmFtaWNhbGx5IGFjY2Vzc2luZyBtZXRob2RzIG9uIEFycmF5IHByb3RvdHlwZQ0KICovCgoKdmFyIGFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGU7CnZhciBhcnJheU1ldGhvZHMgPSBPYmplY3QuY3JlYXRlKGFycmF5UHJvdG8pOwp2YXIgbWV0aG9kc1RvUGF0Y2ggPSBbJ3B1c2gnLCAncG9wJywgJ3NoaWZ0JywgJ3Vuc2hpZnQnLCAnc3BsaWNlJywgJ3NvcnQnLCAncmV2ZXJzZSddOwovKioNCiAqIEludGVyY2VwdCBtdXRhdGluZyBtZXRob2RzIGFuZCBlbWl0IGV2ZW50cw0KICovCgptZXRob2RzVG9QYXRjaC5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2QpIHsKICAvLyBjYWNoZSBvcmlnaW5hbCBtZXRob2QKICB2YXIgb3JpZ2luYWwgPSBhcnJheVByb3RvW21ldGhvZF07CiAgZGVmKGFycmF5TWV0aG9kcywgbWV0aG9kLCBmdW5jdGlvbiBtdXRhdG9yKCkgewogICAgdmFyIGFyZ3MgPSBbXTsKCiAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgewogICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07CiAgICB9CgogICAgdmFyIHJlc3VsdCA9IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgdmFyIG9iID0gdGhpcy5fX29iX187CiAgICB2YXIgaW5zZXJ0ZWQ7CgogICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgY2FzZSAncHVzaCc6CiAgICAgIGNhc2UgJ3Vuc2hpZnQnOgogICAgICAgIGluc2VydGVkID0gYXJnczsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3NwbGljZSc6CiAgICAgICAgaW5zZXJ0ZWQgPSBhcmdzLnNsaWNlKDIpOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIGlmIChpbnNlcnRlZCkgb2Iub2JzZXJ2ZUFycmF5KGluc2VydGVkKTsgLy8gbm90aWZ5IGNoYW5nZQoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIG9iLmRlcC5ub3RpZnkoewogICAgICAgIHR5cGU6ICJhcnJheSBtdXRhdGlvbiIKICAgICAgICAvKiBUcmlnZ2VyT3BUeXBlcy5BUlJBWV9NVVRBVElPTiAqLwogICAgICAgICwKICAgICAgICB0YXJnZXQ6IHRoaXMsCiAgICAgICAga2V5OiBtZXRob2QKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBvYi5kZXAubm90aWZ5KCk7CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9KTsKfSk7CnZhciBhcnJheUtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhhcnJheU1ldGhvZHMpOwp2YXIgTk9fSU5JSVRJQUxfVkFMVUUgPSB7fTsKLyoqDQogKiBJbiBzb21lIGNhc2VzIHdlIG1heSB3YW50IHRvIGRpc2FibGUgb2JzZXJ2YXRpb24gaW5zaWRlIGEgY29tcG9uZW50J3MNCiAqIHVwZGF0ZSBjb21wdXRhdGlvbi4NCiAqLwoKdmFyIHNob3VsZE9ic2VydmUgPSB0cnVlOwoKZnVuY3Rpb24gdG9nZ2xlT2JzZXJ2aW5nKHZhbHVlKSB7CiAgc2hvdWxkT2JzZXJ2ZSA9IHZhbHVlOwp9IC8vIHNzciBtb2NrIGRlcAoKCnZhciBtb2NrRGVwID0gewogIG5vdGlmeTogbm9vcCwKICBkZXBlbmQ6IG5vb3AsCiAgYWRkU3ViOiBub29wLAogIHJlbW92ZVN1Yjogbm9vcAp9OwovKioNCiAqIE9ic2VydmVyIGNsYXNzIHRoYXQgaXMgYXR0YWNoZWQgdG8gZWFjaCBvYnNlcnZlZA0KICogb2JqZWN0LiBPbmNlIGF0dGFjaGVkLCB0aGUgb2JzZXJ2ZXIgY29udmVydHMgdGhlIHRhcmdldA0KICogb2JqZWN0J3MgcHJvcGVydHkga2V5cyBpbnRvIGdldHRlci9zZXR0ZXJzIHRoYXQNCiAqIGNvbGxlY3QgZGVwZW5kZW5jaWVzIGFuZCBkaXNwYXRjaCB1cGRhdGVzLg0KICovCgp2YXIgT2JzZXJ2ZXIgPQovKiogQGNsYXNzICovCmZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBPYnNlcnZlcih2YWx1ZSwgc2hhbGxvdywgbW9jaykgewogICAgaWYgKHNoYWxsb3cgPT09IHZvaWQgMCkgewogICAgICBzaGFsbG93ID0gZmFsc2U7CiAgICB9CgogICAgaWYgKG1vY2sgPT09IHZvaWQgMCkgewogICAgICBtb2NrID0gZmFsc2U7CiAgICB9CgogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgdGhpcy5zaGFsbG93ID0gc2hhbGxvdzsKICAgIHRoaXMubW9jayA9IG1vY2s7IC8vIHRoaXMudmFsdWUgPSB2YWx1ZQoKICAgIHRoaXMuZGVwID0gbW9jayA/IG1vY2tEZXAgOiBuZXcgRGVwKCk7CiAgICB0aGlzLnZtQ291bnQgPSAwOwogICAgZGVmKHZhbHVlLCAnX19vYl9fJywgdGhpcyk7CgogICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGlmICghbW9jaykgewogICAgICAgIGlmIChoYXNQcm90bykgewogICAgICAgICAgdmFsdWUuX19wcm90b19fID0gYXJyYXlNZXRob2RzOwogICAgICAgICAgLyogZXNsaW50LWVuYWJsZSBuby1wcm90byAqLwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5S2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtleSA9IGFycmF5S2V5c1tpXTsKICAgICAgICAgICAgZGVmKHZhbHVlLCBrZXksIGFycmF5TWV0aG9kc1trZXldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghc2hhbGxvdykgewogICAgICAgIHRoaXMub2JzZXJ2ZUFycmF5KHZhbHVlKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLyoqDQogICAgICAgKiBXYWxrIHRocm91Z2ggYWxsIHByb3BlcnRpZXMgYW5kIGNvbnZlcnQgdGhlbSBpbnRvDQogICAgICAgKiBnZXR0ZXIvc2V0dGVycy4gVGhpcyBtZXRob2Qgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIHdoZW4NCiAgICAgICAqIHZhbHVlIHR5cGUgaXMgT2JqZWN0Lg0KICAgICAgICovCiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModmFsdWUpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgZGVmaW5lUmVhY3RpdmUodmFsdWUsIGtleSwgTk9fSU5JSVRJQUxfVkFMVUUsIHVuZGVmaW5lZCwgc2hhbGxvdywgbW9jayk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqDQogICAqIE9ic2VydmUgYSBsaXN0IG9mIEFycmF5IGl0ZW1zLg0KICAgKi8KCgogIE9ic2VydmVyLnByb3RvdHlwZS5vYnNlcnZlQXJyYXkgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gdmFsdWUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIG9ic2VydmUodmFsdWVbaV0sIGZhbHNlLCB0aGlzLm1vY2spOwogICAgfQogIH07CgogIHJldHVybiBPYnNlcnZlcjsKfSgpOyAvLyBoZWxwZXJzCgovKioNCiAqIEF0dGVtcHQgdG8gY3JlYXRlIGFuIG9ic2VydmVyIGluc3RhbmNlIGZvciBhIHZhbHVlLA0KICogcmV0dXJucyB0aGUgbmV3IG9ic2VydmVyIGlmIHN1Y2Nlc3NmdWxseSBvYnNlcnZlZCwNCiAqIG9yIHRoZSBleGlzdGluZyBvYnNlcnZlciBpZiB0aGUgdmFsdWUgYWxyZWFkeSBoYXMgb25lLg0KICovCgoKZnVuY3Rpb24gb2JzZXJ2ZSh2YWx1ZSwgc2hhbGxvdywgc3NyTW9ja1JlYWN0aXZpdHkpIHsKICBpZiAoIWlzT2JqZWN0KHZhbHVlKSB8fCBpc1JlZih2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBWTm9kZSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIG9iOwoKICBpZiAoaGFzT3duKHZhbHVlLCAnX19vYl9fJykgJiYgdmFsdWUuX19vYl9fIGluc3RhbmNlb2YgT2JzZXJ2ZXIpIHsKICAgIG9iID0gdmFsdWUuX19vYl9fOwogIH0gZWxzZSBpZiAoc2hvdWxkT2JzZXJ2ZSAmJiAoc3NyTW9ja1JlYWN0aXZpdHkgfHwgIWlzU2VydmVyUmVuZGVyaW5nKCkpICYmIChpc0FycmF5KHZhbHVlKSB8fCBpc1BsYWluT2JqZWN0KHZhbHVlKSkgJiYgT2JqZWN0LmlzRXh0ZW5zaWJsZSh2YWx1ZSkgJiYgIXZhbHVlLl9fdl9za2lwCiAgLyogUmVhY3RpdmVGbGFncy5TS0lQICovCiAgKSB7CiAgICBvYiA9IG5ldyBPYnNlcnZlcih2YWx1ZSwgc2hhbGxvdywgc3NyTW9ja1JlYWN0aXZpdHkpOwogIH0KCiAgcmV0dXJuIG9iOwp9Ci8qKg0KICogRGVmaW5lIGEgcmVhY3RpdmUgcHJvcGVydHkgb24gYW4gT2JqZWN0Lg0KICovCgoKZnVuY3Rpb24gZGVmaW5lUmVhY3RpdmUob2JqLCBrZXksIHZhbCwgY3VzdG9tU2V0dGVyLCBzaGFsbG93LCBtb2NrKSB7CiAgdmFyIGRlcCA9IG5ldyBEZXAoKTsKICB2YXIgcHJvcGVydHkgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KTsKCiAgaWYgKHByb3BlcnR5ICYmIHByb3BlcnR5LmNvbmZpZ3VyYWJsZSA9PT0gZmFsc2UpIHsKICAgIHJldHVybjsKICB9IC8vIGNhdGVyIGZvciBwcmUtZGVmaW5lZCBnZXR0ZXIvc2V0dGVycwoKCiAgdmFyIGdldHRlciA9IHByb3BlcnR5ICYmIHByb3BlcnR5LmdldDsKICB2YXIgc2V0dGVyID0gcHJvcGVydHkgJiYgcHJvcGVydHkuc2V0OwoKICBpZiAoKCFnZXR0ZXIgfHwgc2V0dGVyKSAmJiAodmFsID09PSBOT19JTklJVElBTF9WQUxVRSB8fCBhcmd1bWVudHMubGVuZ3RoID09PSAyKSkgewogICAgdmFsID0gb2JqW2tleV07CiAgfQoKICB2YXIgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUodmFsLCBmYWxzZSwgbW9jayk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiByZWFjdGl2ZUdldHRlcigpIHsKICAgICAgdmFyIHZhbHVlID0gZ2V0dGVyID8gZ2V0dGVyLmNhbGwob2JqKSA6IHZhbDsKCiAgICAgIGlmIChEZXAudGFyZ2V0KSB7CiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIGRlcC5kZXBlbmQoewogICAgICAgICAgICB0YXJnZXQ6IG9iaiwKICAgICAgICAgICAgdHlwZTogImdldCIKICAgICAgICAgICAgLyogVHJhY2tPcFR5cGVzLkdFVCAqLwogICAgICAgICAgICAsCiAgICAgICAgICAgIGtleToga2V5CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVwLmRlcGVuZCgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNoaWxkT2IpIHsKICAgICAgICAgIGNoaWxkT2IuZGVwLmRlcGVuZCgpOwoKICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICBkZXBlbmRBcnJheSh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaXNSZWYodmFsdWUpICYmICFzaGFsbG93ID8gdmFsdWUudmFsdWUgOiB2YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHJlYWN0aXZlU2V0dGVyKG5ld1ZhbCkgewogICAgICB2YXIgdmFsdWUgPSBnZXR0ZXIgPyBnZXR0ZXIuY2FsbChvYmopIDogdmFsOwoKICAgICAgaWYgKCFoYXNDaGFuZ2VkKHZhbHVlLCBuZXdWYWwpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjdXN0b21TZXR0ZXIpIHsKICAgICAgICBjdXN0b21TZXR0ZXIoKTsKICAgICAgfQoKICAgICAgaWYgKHNldHRlcikgewogICAgICAgIHNldHRlci5jYWxsKG9iaiwgbmV3VmFsKTsKICAgICAgfSBlbHNlIGlmIChnZXR0ZXIpIHsKICAgICAgICAvLyAjNzk4MTogZm9yIGFjY2Vzc29yIHByb3BlcnRpZXMgd2l0aG91dCBzZXR0ZXIKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAoIXNoYWxsb3cgJiYgaXNSZWYodmFsdWUpICYmICFpc1JlZihuZXdWYWwpKSB7CiAgICAgICAgdmFsdWUudmFsdWUgPSBuZXdWYWw7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbCA9IG5ld1ZhbDsKICAgICAgfQoKICAgICAgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUobmV3VmFsLCBmYWxzZSwgbW9jayk7CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGRlcC5ub3RpZnkoewogICAgICAgICAgdHlwZTogInNldCIKICAgICAgICAgIC8qIFRyaWdnZXJPcFR5cGVzLlNFVCAqLwogICAgICAgICAgLAogICAgICAgICAgdGFyZ2V0OiBvYmosCiAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgIG5ld1ZhbHVlOiBuZXdWYWwsCiAgICAgICAgICBvbGRWYWx1ZTogdmFsdWUKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZXAubm90aWZ5KCk7CiAgICAgIH0KICAgIH0KICB9KTsKICByZXR1cm4gZGVwOwp9CgpmdW5jdGlvbiBzZXQodGFyZ2V0LCBrZXksIHZhbCkgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIChpc1VuZGVmKHRhcmdldCkgfHwgaXNQcmltaXRpdmUodGFyZ2V0KSkpIHsKICAgIHdhcm4oIkNhbm5vdCBzZXQgcmVhY3RpdmUgcHJvcGVydHkgb24gdW5kZWZpbmVkLCBudWxsLCBvciBwcmltaXRpdmUgdmFsdWU6ICIuY29uY2F0KHRhcmdldCkpOwogIH0KCiAgaWYgKGlzUmVhZG9ubHkodGFyZ2V0KSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJTZXQgb3BlcmF0aW9uIG9uIGtleSBcIiIuY29uY2F0KGtleSwgIlwiIGZhaWxlZDogdGFyZ2V0IGlzIHJlYWRvbmx5LiIpKTsKICAgIHJldHVybjsKICB9CgogIHZhciBvYiA9IHRhcmdldC5fX29iX187CgogIGlmIChpc0FycmF5KHRhcmdldCkgJiYgaXNWYWxpZEFycmF5SW5kZXgoa2V5KSkgewogICAgdGFyZ2V0Lmxlbmd0aCA9IE1hdGgubWF4KHRhcmdldC5sZW5ndGgsIGtleSk7CiAgICB0YXJnZXQuc3BsaWNlKGtleSwgMSwgdmFsKTsgLy8gd2hlbiBtb2NraW5nIGZvciBTU1IsIGFycmF5IG1ldGhvZHMgYXJlIG5vdCBoaWphY2tlZAoKICAgIGlmIChvYiAmJiAhb2Iuc2hhbGxvdyAmJiBvYi5tb2NrKSB7CiAgICAgIG9ic2VydmUodmFsLCBmYWxzZSwgdHJ1ZSk7CiAgICB9CgogICAgcmV0dXJuIHZhbDsKICB9CgogIGlmIChrZXkgaW4gdGFyZ2V0ICYmICEoa2V5IGluIE9iamVjdC5wcm90b3R5cGUpKSB7CiAgICB0YXJnZXRba2V5XSA9IHZhbDsKICAgIHJldHVybiB2YWw7CiAgfQoKICBpZiAodGFyZ2V0Ll9pc1Z1ZSB8fCBvYiAmJiBvYi52bUNvdW50KSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ0F2b2lkIGFkZGluZyByZWFjdGl2ZSBwcm9wZXJ0aWVzIHRvIGEgVnVlIGluc3RhbmNlIG9yIGl0cyByb290ICRkYXRhICcgKyAnYXQgcnVudGltZSAtIGRlY2xhcmUgaXQgdXBmcm9udCBpbiB0aGUgZGF0YSBvcHRpb24uJyk7CiAgICByZXR1cm4gdmFsOwogIH0KCiAgaWYgKCFvYikgewogICAgdGFyZ2V0W2tleV0gPSB2YWw7CiAgICByZXR1cm4gdmFsOwogIH0KCiAgZGVmaW5lUmVhY3RpdmUob2IudmFsdWUsIGtleSwgdmFsLCB1bmRlZmluZWQsIG9iLnNoYWxsb3csIG9iLm1vY2spOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgb2IuZGVwLm5vdGlmeSh7CiAgICAgIHR5cGU6ICJhZGQiCiAgICAgIC8qIFRyaWdnZXJPcFR5cGVzLkFERCAqLwogICAgICAsCiAgICAgIHRhcmdldDogdGFyZ2V0LAogICAgICBrZXk6IGtleSwKICAgICAgbmV3VmFsdWU6IHZhbCwKICAgICAgb2xkVmFsdWU6IHVuZGVmaW5lZAogICAgfSk7CiAgfSBlbHNlIHsKICAgIG9iLmRlcC5ub3RpZnkoKTsKICB9CgogIHJldHVybiB2YWw7Cn0KCmZ1bmN0aW9uIGRlbCh0YXJnZXQsIGtleSkgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIChpc1VuZGVmKHRhcmdldCkgfHwgaXNQcmltaXRpdmUodGFyZ2V0KSkpIHsKICAgIHdhcm4oIkNhbm5vdCBkZWxldGUgcmVhY3RpdmUgcHJvcGVydHkgb24gdW5kZWZpbmVkLCBudWxsLCBvciBwcmltaXRpdmUgdmFsdWU6ICIuY29uY2F0KHRhcmdldCkpOwogIH0KCiAgaWYgKGlzQXJyYXkodGFyZ2V0KSAmJiBpc1ZhbGlkQXJyYXlJbmRleChrZXkpKSB7CiAgICB0YXJnZXQuc3BsaWNlKGtleSwgMSk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgb2IgPSB0YXJnZXQuX19vYl9fOwoKICBpZiAodGFyZ2V0Ll9pc1Z1ZSB8fCBvYiAmJiBvYi52bUNvdW50KSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ0F2b2lkIGRlbGV0aW5nIHByb3BlcnRpZXMgb24gYSBWdWUgaW5zdGFuY2Ugb3IgaXRzIHJvb3QgJGRhdGEgJyArICctIGp1c3Qgc2V0IGl0IHRvIG51bGwuJyk7CiAgICByZXR1cm47CiAgfQoKICBpZiAoaXNSZWFkb25seSh0YXJnZXQpKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkRlbGV0ZSBvcGVyYXRpb24gb24ga2V5IFwiIi5jb25jYXQoa2V5LCAiXCIgZmFpbGVkOiB0YXJnZXQgaXMgcmVhZG9ubHkuIikpOwogICAgcmV0dXJuOwogIH0KCiAgaWYgKCFoYXNPd24odGFyZ2V0LCBrZXkpKSB7CiAgICByZXR1cm47CiAgfQoKICBkZWxldGUgdGFyZ2V0W2tleV07CgogIGlmICghb2IpIHsKICAgIHJldHVybjsKICB9CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBvYi5kZXAubm90aWZ5KHsKICAgICAgdHlwZTogImRlbGV0ZSIKICAgICAgLyogVHJpZ2dlck9wVHlwZXMuREVMRVRFICovCiAgICAgICwKICAgICAgdGFyZ2V0OiB0YXJnZXQsCiAgICAgIGtleToga2V5CiAgICB9KTsKICB9IGVsc2UgewogICAgb2IuZGVwLm5vdGlmeSgpOwogIH0KfQovKioNCiAqIENvbGxlY3QgZGVwZW5kZW5jaWVzIG9uIGFycmF5IGVsZW1lbnRzIHdoZW4gdGhlIGFycmF5IGlzIHRvdWNoZWQsIHNpbmNlDQogKiB3ZSBjYW5ub3QgaW50ZXJjZXB0IGFycmF5IGVsZW1lbnQgYWNjZXNzIGxpa2UgcHJvcGVydHkgZ2V0dGVycy4NCiAqLwoKCmZ1bmN0aW9uIGRlcGVuZEFycmF5KHZhbHVlKSB7CiAgZm9yICh2YXIgZSA9IHZvaWQgMCwgaSA9IDAsIGwgPSB2YWx1ZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIGUgPSB2YWx1ZVtpXTsKCiAgICBpZiAoZSAmJiBlLl9fb2JfXykgewogICAgICBlLl9fb2JfXy5kZXAuZGVwZW5kKCk7CiAgICB9CgogICAgaWYgKGlzQXJyYXkoZSkpIHsKICAgICAgZGVwZW5kQXJyYXkoZSk7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiByZWFjdGl2ZSh0YXJnZXQpIHsKICBtYWtlUmVhY3RpdmUodGFyZ2V0LCBmYWxzZSk7CiAgcmV0dXJuIHRhcmdldDsKfQovKioNCiAqIFJldHVybiBhIHNoYWxsb3dseS1yZWFjdGl2ZSBjb3B5IG9mIHRoZSBvcmlnaW5hbCBvYmplY3QsIHdoZXJlIG9ubHkgdGhlIHJvb3QNCiAqIGxldmVsIHByb3BlcnRpZXMgYXJlIHJlYWN0aXZlLiBJdCBhbHNvIGRvZXMgbm90IGF1dG8tdW53cmFwIHJlZnMgKGV2ZW4gYXQgdGhlDQogKiByb290IGxldmVsKS4NCiAqLwoKCmZ1bmN0aW9uIHNoYWxsb3dSZWFjdGl2ZSh0YXJnZXQpIHsKICBtYWtlUmVhY3RpdmUodGFyZ2V0LCB0cnVlKTsKICBkZWYodGFyZ2V0LCAiX192X2lzU2hhbGxvdyIKICAvKiBSZWFjdGl2ZUZsYWdzLklTX1NIQUxMT1cgKi8KICAsIHRydWUpOwogIHJldHVybiB0YXJnZXQ7Cn0KCmZ1bmN0aW9uIG1ha2VSZWFjdGl2ZSh0YXJnZXQsIHNoYWxsb3cpIHsKICAvLyBpZiB0cnlpbmcgdG8gb2JzZXJ2ZSBhIHJlYWRvbmx5IHByb3h5LCByZXR1cm4gdGhlIHJlYWRvbmx5IHZlcnNpb24uCiAgaWYgKCFpc1JlYWRvbmx5KHRhcmdldCkpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmIChpc0FycmF5KHRhcmdldCkpIHsKICAgICAgICB3YXJuKCJBdm9pZCB1c2luZyBBcnJheSBhcyByb290IHZhbHVlIGZvciAiLmNvbmNhdChzaGFsbG93ID8gInNoYWxsb3dSZWFjdGl2ZSgpIiA6ICJyZWFjdGl2ZSgpIiwgIiBhcyBpdCBjYW5ub3QgYmUgdHJhY2tlZCBpbiB3YXRjaCgpIG9yIHdhdGNoRWZmZWN0KCkuIFVzZSAiKS5jb25jYXQoc2hhbGxvdyA/ICJzaGFsbG93UmVmKCkiIDogInJlZigpIiwgIiBpbnN0ZWFkLiBUaGlzIGlzIGEgVnVlLTItb25seSBsaW1pdGF0aW9uLiIpKTsKICAgICAgfQoKICAgICAgdmFyIGV4aXN0aW5nT2IgPSB0YXJnZXQgJiYgdGFyZ2V0Ll9fb2JfXzsKCiAgICAgIGlmIChleGlzdGluZ09iICYmIGV4aXN0aW5nT2Iuc2hhbGxvdyAhPT0gc2hhbGxvdykgewogICAgICAgIHdhcm4oIlRhcmdldCBpcyBhbHJlYWR5IGEgIi5jb25jYXQoZXhpc3RpbmdPYi5zaGFsbG93ID8gIiIgOiAibm9uLSIsICJzaGFsbG93IHJlYWN0aXZlIG9iamVjdCwgYW5kIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gIikuY29uY2F0KHNoYWxsb3cgPyAiIiA6ICJub24tIiwgInNoYWxsb3cuIikpOwogICAgICB9CiAgICB9CgogICAgdmFyIG9iID0gb2JzZXJ2ZSh0YXJnZXQsIHNoYWxsb3csIGlzU2VydmVyUmVuZGVyaW5nKCkKICAgIC8qIHNzciBtb2NrIHJlYWN0aXZpdHkgKi8KICAgICk7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIW9iKSB7CiAgICAgIGlmICh0YXJnZXQgPT0gbnVsbCB8fCBpc1ByaW1pdGl2ZSh0YXJnZXQpKSB7CiAgICAgICAgd2FybigidmFsdWUgY2Fubm90IGJlIG1hZGUgcmVhY3RpdmU6ICIuY29uY2F0KFN0cmluZyh0YXJnZXQpKSk7CiAgICAgIH0KCiAgICAgIGlmIChpc0NvbGxlY3Rpb25UeXBlKHRhcmdldCkpIHsKICAgICAgICB3YXJuKCJWdWUgMiBkb2VzIG5vdCBzdXBwb3J0IHJlYWN0aXZlIGNvbGxlY3Rpb24gdHlwZXMgc3VjaCBhcyBNYXAgb3IgU2V0LiIpOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBpc1JlYWN0aXZlKHZhbHVlKSB7CiAgaWYgKGlzUmVhZG9ubHkodmFsdWUpKSB7CiAgICByZXR1cm4gaXNSZWFjdGl2ZSh2YWx1ZVsiX192X3JhdyIKICAgIC8qIFJlYWN0aXZlRmxhZ3MuUkFXICovCiAgICBdKTsKICB9CgogIHJldHVybiAhISh2YWx1ZSAmJiB2YWx1ZS5fX29iX18pOwp9CgpmdW5jdGlvbiBpc1NoYWxsb3codmFsdWUpIHsKICByZXR1cm4gISEodmFsdWUgJiYgdmFsdWUuX192X2lzU2hhbGxvdyk7Cn0KCmZ1bmN0aW9uIGlzUmVhZG9ubHkodmFsdWUpIHsKICByZXR1cm4gISEodmFsdWUgJiYgdmFsdWUuX192X2lzUmVhZG9ubHkpOwp9CgpmdW5jdGlvbiBpc1Byb3h5KHZhbHVlKSB7CiAgcmV0dXJuIGlzUmVhY3RpdmUodmFsdWUpIHx8IGlzUmVhZG9ubHkodmFsdWUpOwp9CgpmdW5jdGlvbiB0b1JhdyhvYnNlcnZlZCkgewogIHZhciByYXcgPSBvYnNlcnZlZCAmJiBvYnNlcnZlZFsiX192X3JhdyIKICAvKiBSZWFjdGl2ZUZsYWdzLlJBVyAqLwogIF07CiAgcmV0dXJuIHJhdyA/IHRvUmF3KHJhdykgOiBvYnNlcnZlZDsKfQoKZnVuY3Rpb24gbWFya1Jhdyh2YWx1ZSkgewogIGRlZih2YWx1ZSwgIl9fdl9za2lwIgogIC8qIFJlYWN0aXZlRmxhZ3MuU0tJUCAqLwogICwgdHJ1ZSk7CiAgcmV0dXJuIHZhbHVlOwp9Ci8qKg0KICogQGludGVybmFsDQogKi8KCgpmdW5jdGlvbiBpc0NvbGxlY3Rpb25UeXBlKHZhbHVlKSB7CiAgdmFyIHR5cGUgPSB0b1Jhd1R5cGUodmFsdWUpOwogIHJldHVybiB0eXBlID09PSAnTWFwJyB8fCB0eXBlID09PSAnV2Vha01hcCcgfHwgdHlwZSA9PT0gJ1NldCcgfHwgdHlwZSA9PT0gJ1dlYWtTZXQnOwp9Ci8qKg0KICogQGludGVybmFsDQogKi8KCgp2YXIgUmVmRmxhZyA9ICJfX3ZfaXNSZWYiOwoKZnVuY3Rpb24gaXNSZWYocikgewogIHJldHVybiAhIShyICYmIHIuX192X2lzUmVmID09PSB0cnVlKTsKfQoKZnVuY3Rpb24gcmVmJDEodmFsdWUpIHsKICByZXR1cm4gY3JlYXRlUmVmKHZhbHVlLCBmYWxzZSk7Cn0KCmZ1bmN0aW9uIHNoYWxsb3dSZWYodmFsdWUpIHsKICByZXR1cm4gY3JlYXRlUmVmKHZhbHVlLCB0cnVlKTsKfQoKZnVuY3Rpb24gY3JlYXRlUmVmKHJhd1ZhbHVlLCBzaGFsbG93KSB7CiAgaWYgKGlzUmVmKHJhd1ZhbHVlKSkgewogICAgcmV0dXJuIHJhd1ZhbHVlOwogIH0KCiAgdmFyIHJlZiA9IHt9OwogIGRlZihyZWYsIFJlZkZsYWcsIHRydWUpOwogIGRlZihyZWYsICJfX3ZfaXNTaGFsbG93IgogIC8qIFJlYWN0aXZlRmxhZ3MuSVNfU0hBTExPVyAqLwogICwgc2hhbGxvdyk7CiAgZGVmKHJlZiwgJ2RlcCcsIGRlZmluZVJlYWN0aXZlKHJlZiwgJ3ZhbHVlJywgcmF3VmFsdWUsIG51bGwsIHNoYWxsb3csIGlzU2VydmVyUmVuZGVyaW5nKCkpKTsKICByZXR1cm4gcmVmOwp9CgpmdW5jdGlvbiB0cmlnZ2VyUmVmKHJlZikgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFyZWYuZGVwKSB7CiAgICB3YXJuKCJyZWNlaXZlZCBvYmplY3QgaXMgbm90IGEgdHJpZ2dlcmFibGUgcmVmLiIpOwogIH0KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHJlZi5kZXAgJiYgcmVmLmRlcC5ub3RpZnkoewogICAgICB0eXBlOiAic2V0IgogICAgICAvKiBUcmlnZ2VyT3BUeXBlcy5TRVQgKi8KICAgICAgLAogICAgICB0YXJnZXQ6IHJlZiwKICAgICAga2V5OiAndmFsdWUnCiAgICB9KTsKICB9IGVsc2UgewogICAgcmVmLmRlcCAmJiByZWYuZGVwLm5vdGlmeSgpOwogIH0KfQoKZnVuY3Rpb24gdW5yZWYocmVmKSB7CiAgcmV0dXJuIGlzUmVmKHJlZikgPyByZWYudmFsdWUgOiByZWY7Cn0KCmZ1bmN0aW9uIHByb3h5UmVmcyhvYmplY3RXaXRoUmVmcykgewogIGlmIChpc1JlYWN0aXZlKG9iamVjdFdpdGhSZWZzKSkgewogICAgcmV0dXJuIG9iamVjdFdpdGhSZWZzOwogIH0KCiAgdmFyIHByb3h5ID0ge307CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmplY3RXaXRoUmVmcyk7CgogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgcHJveHlXaXRoUmVmVW53cmFwKHByb3h5LCBvYmplY3RXaXRoUmVmcywga2V5c1tpXSk7CiAgfQoKICByZXR1cm4gcHJveHk7Cn0KCmZ1bmN0aW9uIHByb3h5V2l0aFJlZlVud3JhcCh0YXJnZXQsIHNvdXJjZSwga2V5KSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB2YWwgPSBzb3VyY2Vba2V5XTsKCiAgICAgIGlmIChpc1JlZih2YWwpKSB7CiAgICAgICAgcmV0dXJuIHZhbC52YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgb2IgPSB2YWwgJiYgdmFsLl9fb2JfXzsKICAgICAgICBpZiAob2IpIG9iLmRlcC5kZXBlbmQoKTsKICAgICAgICByZXR1cm4gdmFsOwogICAgICB9CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIG9sZFZhbHVlID0gc291cmNlW2tleV07CgogICAgICBpZiAoaXNSZWYob2xkVmFsdWUpICYmICFpc1JlZih2YWx1ZSkpIHsKICAgICAgICBvbGRWYWx1ZS52YWx1ZSA9IHZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHNvdXJjZVtrZXldID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gY3VzdG9tUmVmKGZhY3RvcnkpIHsKICB2YXIgZGVwID0gbmV3IERlcCgpOwoKICB2YXIgX2EgPSBmYWN0b3J5KGZ1bmN0aW9uICgpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGRlcC5kZXBlbmQoewogICAgICAgIHRhcmdldDogcmVmLAogICAgICAgIHR5cGU6ICJnZXQiCiAgICAgICAgLyogVHJhY2tPcFR5cGVzLkdFVCAqLwogICAgICAgICwKICAgICAgICBrZXk6ICd2YWx1ZScKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBkZXAuZGVwZW5kKCk7CiAgICB9CiAgfSwgZnVuY3Rpb24gKCkgewogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgZGVwLm5vdGlmeSh7CiAgICAgICAgdGFyZ2V0OiByZWYsCiAgICAgICAgdHlwZTogInNldCIKICAgICAgICAvKiBUcmlnZ2VyT3BUeXBlcy5TRVQgKi8KICAgICAgICAsCiAgICAgICAga2V5OiAndmFsdWUnCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZGVwLm5vdGlmeSgpOwogICAgfQogIH0pLAogICAgICBnZXQgPSBfYS5nZXQsCiAgICAgIHNldCA9IF9hLnNldDsKCiAgdmFyIHJlZiA9IHsKICAgIGdldCB2YWx1ZSgpIHsKICAgICAgcmV0dXJuIGdldCgpOwogICAgfSwKCiAgICBzZXQgdmFsdWUobmV3VmFsKSB7CiAgICAgIHNldChuZXdWYWwpOwogICAgfQoKICB9OwogIGRlZihyZWYsIFJlZkZsYWcsIHRydWUpOwogIHJldHVybiByZWY7Cn0KCmZ1bmN0aW9uIHRvUmVmcyhvYmplY3QpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhaXNSZWFjdGl2ZShvYmplY3QpKSB7CiAgICB3YXJuKCJ0b1JlZnMoKSBleHBlY3RzIGEgcmVhY3RpdmUgb2JqZWN0IGJ1dCByZWNlaXZlZCBhIHBsYWluIG9uZS4iKTsKICB9CgogIHZhciByZXQgPSBpc0FycmF5KG9iamVjdCkgPyBuZXcgQXJyYXkob2JqZWN0Lmxlbmd0aCkgOiB7fTsKCiAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgcmV0W2tleV0gPSB0b1JlZihvYmplY3QsIGtleSk7CiAgfQoKICByZXR1cm4gcmV0Owp9CgpmdW5jdGlvbiB0b1JlZihvYmplY3QsIGtleSwgZGVmYXVsdFZhbHVlKSB7CiAgdmFyIHZhbCA9IG9iamVjdFtrZXldOwoKICBpZiAoaXNSZWYodmFsKSkgewogICAgcmV0dXJuIHZhbDsKICB9CgogIHZhciByZWYgPSB7CiAgICBnZXQgdmFsdWUoKSB7CiAgICAgIHZhciB2YWwgPSBvYmplY3Rba2V5XTsKICAgICAgcmV0dXJuIHZhbCA9PT0gdW5kZWZpbmVkID8gZGVmYXVsdFZhbHVlIDogdmFsOwogICAgfSwKCiAgICBzZXQgdmFsdWUobmV3VmFsKSB7CiAgICAgIG9iamVjdFtrZXldID0gbmV3VmFsOwogICAgfQoKICB9OwogIGRlZihyZWYsIFJlZkZsYWcsIHRydWUpOwogIHJldHVybiByZWY7Cn0KCnZhciByYXdUb1JlYWRvbmx5RmxhZyA9ICJfX3ZfcmF3VG9SZWFkb25seSI7CnZhciByYXdUb1NoYWxsb3dSZWFkb25seUZsYWcgPSAiX192X3Jhd1RvU2hhbGxvd1JlYWRvbmx5IjsKCmZ1bmN0aW9uIHJlYWRvbmx5KHRhcmdldCkgewogIHJldHVybiBjcmVhdGVSZWFkb25seSh0YXJnZXQsIGZhbHNlKTsKfQoKZnVuY3Rpb24gY3JlYXRlUmVhZG9ubHkodGFyZ2V0LCBzaGFsbG93KSB7CiAgaWYgKCFpc1BsYWluT2JqZWN0KHRhcmdldCkpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmIChpc0FycmF5KHRhcmdldCkpIHsKICAgICAgICB3YXJuKCJWdWUgMiBkb2VzIG5vdCBzdXBwb3J0IHJlYWRvbmx5IGFycmF5cy4iKTsKICAgICAgfSBlbHNlIGlmIChpc0NvbGxlY3Rpb25UeXBlKHRhcmdldCkpIHsKICAgICAgICB3YXJuKCJWdWUgMiBkb2VzIG5vdCBzdXBwb3J0IHJlYWRvbmx5IGNvbGxlY3Rpb24gdHlwZXMgc3VjaCBhcyBNYXAgb3IgU2V0LiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHdhcm4oInZhbHVlIGNhbm5vdCBiZSBtYWRlIHJlYWRvbmx5OiAiLmNvbmNhdCh0eXBlb2YgdGFyZ2V0KSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGFyZ2V0OwogIH0gLy8gYWxyZWFkeSBhIHJlYWRvbmx5IG9iamVjdAoKCiAgaWYgKGlzUmVhZG9ubHkodGFyZ2V0KSkgewogICAgcmV0dXJuIHRhcmdldDsKICB9IC8vIGFscmVhZHkgaGFzIGEgcmVhZG9ubHkgcHJveHkKCgogIHZhciBleGlzdGluZ0ZsYWcgPSBzaGFsbG93ID8gcmF3VG9TaGFsbG93UmVhZG9ubHlGbGFnIDogcmF3VG9SZWFkb25seUZsYWc7CiAgdmFyIGV4aXN0aW5nUHJveHkgPSB0YXJnZXRbZXhpc3RpbmdGbGFnXTsKCiAgaWYgKGV4aXN0aW5nUHJveHkpIHsKICAgIHJldHVybiBleGlzdGluZ1Byb3h5OwogIH0KCiAgdmFyIHByb3h5ID0gT2JqZWN0LmNyZWF0ZShPYmplY3QuZ2V0UHJvdG90eXBlT2YodGFyZ2V0KSk7CiAgZGVmKHRhcmdldCwgZXhpc3RpbmdGbGFnLCBwcm94eSk7CiAgZGVmKHByb3h5LCAiX192X2lzUmVhZG9ubHkiCiAgLyogUmVhY3RpdmVGbGFncy5JU19SRUFET05MWSAqLwogICwgdHJ1ZSk7CiAgZGVmKHByb3h5LCAiX192X3JhdyIKICAvKiBSZWFjdGl2ZUZsYWdzLlJBVyAqLwogICwgdGFyZ2V0KTsKCiAgaWYgKGlzUmVmKHRhcmdldCkpIHsKICAgIGRlZihwcm94eSwgUmVmRmxhZywgdHJ1ZSk7CiAgfQoKICBpZiAoc2hhbGxvdyB8fCBpc1NoYWxsb3codGFyZ2V0KSkgewogICAgZGVmKHByb3h5LCAiX192X2lzU2hhbGxvdyIKICAgIC8qIFJlYWN0aXZlRmxhZ3MuSVNfU0hBTExPVyAqLwogICAgLCB0cnVlKTsKICB9CgogIHZhciBrZXlzID0gT2JqZWN0LmtleXModGFyZ2V0KTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBkZWZpbmVSZWFkb25seVByb3BlcnR5KHByb3h5LCB0YXJnZXQsIGtleXNbaV0sIHNoYWxsb3cpOwogIH0KCiAgcmV0dXJuIHByb3h5Owp9CgpmdW5jdGlvbiBkZWZpbmVSZWFkb25seVByb3BlcnR5KHByb3h5LCB0YXJnZXQsIGtleSwgc2hhbGxvdykgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm94eSwga2V5LCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB2YWwgPSB0YXJnZXRba2V5XTsKICAgICAgcmV0dXJuIHNoYWxsb3cgfHwgIWlzUGxhaW5PYmplY3QodmFsKSA/IHZhbCA6IHJlYWRvbmx5KHZhbCk7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiU2V0IG9wZXJhdGlvbiBvbiBrZXkgXCIiLmNvbmNhdChrZXksICJcIiBmYWlsZWQ6IHRhcmdldCBpcyByZWFkb25seS4iKSk7CiAgICB9CiAgfSk7Cn0KLyoqDQogKiBSZXR1cm5zIGEgcmVhY3RpdmUtY29weSBvZiB0aGUgb3JpZ2luYWwgb2JqZWN0LCB3aGVyZSBvbmx5IHRoZSByb290IGxldmVsDQogKiBwcm9wZXJ0aWVzIGFyZSByZWFkb25seSwgYW5kIGRvZXMgTk9UIHVud3JhcCByZWZzIG5vciByZWN1cnNpdmVseSBjb252ZXJ0DQogKiByZXR1cm5lZCBwcm9wZXJ0aWVzLg0KICogVGhpcyBpcyB1c2VkIGZvciBjcmVhdGluZyB0aGUgcHJvcHMgcHJveHkgb2JqZWN0IGZvciBzdGF0ZWZ1bCBjb21wb25lbnRzLg0KICovCgoKZnVuY3Rpb24gc2hhbGxvd1JlYWRvbmx5KHRhcmdldCkgewogIHJldHVybiBjcmVhdGVSZWFkb25seSh0YXJnZXQsIHRydWUpOwp9CgpmdW5jdGlvbiBjb21wdXRlZChnZXR0ZXJPck9wdGlvbnMsIGRlYnVnT3B0aW9ucykgewogIHZhciBnZXR0ZXI7CiAgdmFyIHNldHRlcjsKICB2YXIgb25seUdldHRlciA9IGlzRnVuY3Rpb24oZ2V0dGVyT3JPcHRpb25zKTsKCiAgaWYgKG9ubHlHZXR0ZXIpIHsKICAgIGdldHRlciA9IGdldHRlck9yT3B0aW9uczsKICAgIHNldHRlciA9IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgPyBmdW5jdGlvbiAoKSB7CiAgICAgIHdhcm4oJ1dyaXRlIG9wZXJhdGlvbiBmYWlsZWQ6IGNvbXB1dGVkIHZhbHVlIGlzIHJlYWRvbmx5Jyk7CiAgICB9IDogbm9vcDsKICB9IGVsc2UgewogICAgZ2V0dGVyID0gZ2V0dGVyT3JPcHRpb25zLmdldDsKICAgIHNldHRlciA9IGdldHRlck9yT3B0aW9ucy5zZXQ7CiAgfQoKICB2YXIgd2F0Y2hlciA9IGlzU2VydmVyUmVuZGVyaW5nKCkgPyBudWxsIDogbmV3IFdhdGNoZXIoY3VycmVudEluc3RhbmNlLCBnZXR0ZXIsIG5vb3AsIHsKICAgIGxhenk6IHRydWUKICB9KTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2F0Y2hlciAmJiBkZWJ1Z09wdGlvbnMpIHsKICAgIHdhdGNoZXIub25UcmFjayA9IGRlYnVnT3B0aW9ucy5vblRyYWNrOwogICAgd2F0Y2hlci5vblRyaWdnZXIgPSBkZWJ1Z09wdGlvbnMub25UcmlnZ2VyOwogIH0KCiAgdmFyIHJlZiA9IHsKICAgIC8vIHNvbWUgbGlicyByZWx5IG9uIHRoZSBwcmVzZW5jZSBlZmZlY3QgZm9yIGNoZWNraW5nIGNvbXB1dGVkIHJlZnMKICAgIC8vIGZyb20gbm9ybWFsIHJlZnMsIGJ1dCB0aGUgaW1wbGVtZW50YXRpb24gZG9lc24ndCBtYXR0ZXIKICAgIGVmZmVjdDogd2F0Y2hlciwKCiAgICBnZXQgdmFsdWUoKSB7CiAgICAgIGlmICh3YXRjaGVyKSB7CiAgICAgICAgaWYgKHdhdGNoZXIuZGlydHkpIHsKICAgICAgICAgIHdhdGNoZXIuZXZhbHVhdGUoKTsKICAgICAgICB9CgogICAgICAgIGlmIChEZXAudGFyZ2V0KSB7CiAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBEZXAudGFyZ2V0Lm9uVHJhY2spIHsKICAgICAgICAgICAgRGVwLnRhcmdldC5vblRyYWNrKHsKICAgICAgICAgICAgICBlZmZlY3Q6IERlcC50YXJnZXQsCiAgICAgICAgICAgICAgdGFyZ2V0OiByZWYsCiAgICAgICAgICAgICAgdHlwZTogImdldCIKICAgICAgICAgICAgICAvKiBUcmFja09wVHlwZXMuR0VUICovCiAgICAgICAgICAgICAgLAogICAgICAgICAgICAgIGtleTogJ3ZhbHVlJwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICB3YXRjaGVyLmRlcGVuZCgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHdhdGNoZXIudmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGdldHRlcigpOwogICAgICB9CiAgICB9LAoKICAgIHNldCB2YWx1ZShuZXdWYWwpIHsKICAgICAgc2V0dGVyKG5ld1ZhbCk7CiAgICB9CgogIH07CiAgZGVmKHJlZiwgUmVmRmxhZywgdHJ1ZSk7CiAgZGVmKHJlZiwgIl9fdl9pc1JlYWRvbmx5IgogIC8qIFJlYWN0aXZlRmxhZ3MuSVNfUkVBRE9OTFkgKi8KICAsIG9ubHlHZXR0ZXIpOwogIHJldHVybiByZWY7Cn0KCnZhciBXQVRDSEVSID0gIndhdGNoZXIiOwp2YXIgV0FUQ0hFUl9DQiA9ICIiLmNvbmNhdChXQVRDSEVSLCAiIGNhbGxiYWNrIik7CnZhciBXQVRDSEVSX0dFVFRFUiA9ICIiLmNvbmNhdChXQVRDSEVSLCAiIGdldHRlciIpOwp2YXIgV0FUQ0hFUl9DTEVBTlVQID0gIiIuY29uY2F0KFdBVENIRVIsICIgY2xlYW51cCIpOyAvLyBTaW1wbGUgZWZmZWN0LgoKZnVuY3Rpb24gd2F0Y2hFZmZlY3QoZWZmZWN0LCBvcHRpb25zKSB7CiAgcmV0dXJuIGRvV2F0Y2goZWZmZWN0LCBudWxsLCBvcHRpb25zKTsKfQoKZnVuY3Rpb24gd2F0Y2hQb3N0RWZmZWN0KGVmZmVjdCwgb3B0aW9ucykgewogIHJldHVybiBkb1dhdGNoKGVmZmVjdCwgbnVsbCwgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IF9fYXNzaWduKF9fYXNzaWduKHt9LCBvcHRpb25zKSwgewogICAgZmx1c2g6ICdwb3N0JwogIH0pIDogewogICAgZmx1c2g6ICdwb3N0JwogIH0pOwp9CgpmdW5jdGlvbiB3YXRjaFN5bmNFZmZlY3QoZWZmZWN0LCBvcHRpb25zKSB7CiAgcmV0dXJuIGRvV2F0Y2goZWZmZWN0LCBudWxsLCBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gX19hc3NpZ24oX19hc3NpZ24oe30sIG9wdGlvbnMpLCB7CiAgICBmbHVzaDogJ3N5bmMnCiAgfSkgOiB7CiAgICBmbHVzaDogJ3N5bmMnCiAgfSk7Cn0gLy8gaW5pdGlhbCB2YWx1ZSBmb3Igd2F0Y2hlcnMgdG8gdHJpZ2dlciBvbiB1bmRlZmluZWQgaW5pdGlhbCB2YWx1ZXMKCgp2YXIgSU5JVElBTF9XQVRDSEVSX1ZBTFVFID0ge307IC8vIGltcGxlbWVudGF0aW9uCgpmdW5jdGlvbiB3YXRjaChzb3VyY2UsIGNiLCBvcHRpb25zKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgdHlwZW9mIGNiICE9PSAnZnVuY3Rpb24nKSB7CiAgICB3YXJuKCJgd2F0Y2goZm4sIG9wdGlvbnM/KWAgc2lnbmF0dXJlIGhhcyBiZWVuIG1vdmVkIHRvIGEgc2VwYXJhdGUgQVBJLiAiICsgIlVzZSBgd2F0Y2hFZmZlY3QoZm4sIG9wdGlvbnM/KWAgaW5zdGVhZC4gYHdhdGNoYCBub3cgb25seSAiICsgInN1cHBvcnRzIGB3YXRjaChzb3VyY2UsIGNiLCBvcHRpb25zPykgc2lnbmF0dXJlLiIpOwogIH0KCiAgcmV0dXJuIGRvV2F0Y2goc291cmNlLCBjYiwgb3B0aW9ucyk7Cn0KCmZ1bmN0aW9uIGRvV2F0Y2goc291cmNlLCBjYiwgX2EpIHsKICB2YXIgX2IgPSBfYSA9PT0gdm9pZCAwID8gZW1wdHlPYmplY3QgOiBfYSwKICAgICAgaW1tZWRpYXRlID0gX2IuaW1tZWRpYXRlLAogICAgICBkZWVwID0gX2IuZGVlcCwKICAgICAgX2MgPSBfYi5mbHVzaCwKICAgICAgZmx1c2ggPSBfYyA9PT0gdm9pZCAwID8gJ3ByZScgOiBfYywKICAgICAgb25UcmFjayA9IF9iLm9uVHJhY2ssCiAgICAgIG9uVHJpZ2dlciA9IF9iLm9uVHJpZ2dlcjsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIWNiKSB7CiAgICBpZiAoaW1tZWRpYXRlICE9PSB1bmRlZmluZWQpIHsKICAgICAgd2Fybigid2F0Y2goKSBcImltbWVkaWF0ZVwiIG9wdGlvbiBpcyBvbmx5IHJlc3BlY3RlZCB3aGVuIHVzaW5nIHRoZSAiICsgIndhdGNoKHNvdXJjZSwgY2FsbGJhY2ssIG9wdGlvbnM/KSBzaWduYXR1cmUuIik7CiAgICB9CgogICAgaWYgKGRlZXAgIT09IHVuZGVmaW5lZCkgewogICAgICB3YXJuKCJ3YXRjaCgpIFwiZGVlcFwiIG9wdGlvbiBpcyBvbmx5IHJlc3BlY3RlZCB3aGVuIHVzaW5nIHRoZSAiICsgIndhdGNoKHNvdXJjZSwgY2FsbGJhY2ssIG9wdGlvbnM/KSBzaWduYXR1cmUuIik7CiAgICB9CiAgfQoKICB2YXIgd2FybkludmFsaWRTb3VyY2UgPSBmdW5jdGlvbiAocykgewogICAgd2FybigiSW52YWxpZCB3YXRjaCBzb3VyY2U6ICIuY29uY2F0KHMsICIuIEEgd2F0Y2ggc291cmNlIGNhbiBvbmx5IGJlIGEgZ2V0dGVyL2VmZmVjdCAiKSArICJmdW5jdGlvbiwgYSByZWYsIGEgcmVhY3RpdmUgb2JqZWN0LCBvciBhbiBhcnJheSBvZiB0aGVzZSB0eXBlcy4iKTsKICB9OwoKICB2YXIgaW5zdGFuY2UgPSBjdXJyZW50SW5zdGFuY2U7CgogIHZhciBjYWxsID0gZnVuY3Rpb24gKGZuLCB0eXBlLCBhcmdzKSB7CiAgICBpZiAoYXJncyA9PT0gdm9pZCAwKSB7CiAgICAgIGFyZ3MgPSBudWxsOwogICAgfQoKICAgIHJldHVybiBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhmbiwgbnVsbCwgYXJncywgaW5zdGFuY2UsIHR5cGUpOwogIH07CgogIHZhciBnZXR0ZXI7CiAgdmFyIGZvcmNlVHJpZ2dlciA9IGZhbHNlOwogIHZhciBpc011bHRpU291cmNlID0gZmFsc2U7CgogIGlmIChpc1JlZihzb3VyY2UpKSB7CiAgICBnZXR0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzb3VyY2UudmFsdWU7CiAgICB9OwoKICAgIGZvcmNlVHJpZ2dlciA9IGlzU2hhbGxvdyhzb3VyY2UpOwogIH0gZWxzZSBpZiAoaXNSZWFjdGl2ZShzb3VyY2UpKSB7CiAgICBnZXR0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHNvdXJjZS5fX29iX18uZGVwLmRlcGVuZCgpOwoKICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH07CgogICAgZGVlcCA9IHRydWU7CiAgfSBlbHNlIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgIGlzTXVsdGlTb3VyY2UgPSB0cnVlOwogICAgZm9yY2VUcmlnZ2VyID0gc291cmNlLnNvbWUoZnVuY3Rpb24gKHMpIHsKICAgICAgcmV0dXJuIGlzUmVhY3RpdmUocykgfHwgaXNTaGFsbG93KHMpOwogICAgfSk7CgogICAgZ2V0dGVyID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc291cmNlLm1hcChmdW5jdGlvbiAocykgewogICAgICAgIGlmIChpc1JlZihzKSkgewogICAgICAgICAgcmV0dXJuIHMudmFsdWU7CiAgICAgICAgfSBlbHNlIGlmIChpc1JlYWN0aXZlKHMpKSB7CiAgICAgICAgICByZXR1cm4gdHJhdmVyc2Uocyk7CiAgICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHMpKSB7CiAgICAgICAgICByZXR1cm4gY2FsbChzLCBXQVRDSEVSX0dFVFRFUik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybkludmFsaWRTb3VyY2Uocyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHNvdXJjZSkpIHsKICAgIGlmIChjYikgewogICAgICAvLyBnZXR0ZXIgd2l0aCBjYgogICAgICBnZXR0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGwoc291cmNlLCBXQVRDSEVSX0dFVFRFUik7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAvLyBubyBjYiAtPiBzaW1wbGUgZWZmZWN0CiAgICAgIGdldHRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX2lzRGVzdHJveWVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoY2xlYW51cCkgewogICAgICAgICAgY2xlYW51cCgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNhbGwoc291cmNlLCBXQVRDSEVSLCBbb25DbGVhbnVwXSk7CiAgICAgIH07CiAgICB9CiAgfSBlbHNlIHsKICAgIGdldHRlciA9IG5vb3A7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm5JbnZhbGlkU291cmNlKHNvdXJjZSk7CiAgfQoKICBpZiAoY2IgJiYgZGVlcCkgewogICAgdmFyIGJhc2VHZXR0ZXJfMSA9IGdldHRlcjsKCiAgICBnZXR0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0cmF2ZXJzZShiYXNlR2V0dGVyXzEoKSk7CiAgICB9OwogIH0KCiAgdmFyIGNsZWFudXA7CgogIHZhciBvbkNsZWFudXAgPSBmdW5jdGlvbiAoZm4pIHsKICAgIGNsZWFudXAgPSB3YXRjaGVyLm9uU3RvcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgY2FsbChmbiwgV0FUQ0hFUl9DTEVBTlVQKTsKICAgIH07CiAgfTsgLy8gaW4gU1NSIHRoZXJlIGlzIG5vIG5lZWQgdG8gc2V0dXAgYW4gYWN0dWFsIGVmZmVjdCwgYW5kIGl0IHNob3VsZCBiZSBub29wCiAgLy8gdW5sZXNzIGl0J3MgZWFnZXIKCgogIGlmIChpc1NlcnZlclJlbmRlcmluZygpKSB7CiAgICAvLyB3ZSB3aWxsIGFsc28gbm90IGNhbGwgdGhlIGludmFsaWRhdGUgY2FsbGJhY2sgKCsgcnVubmVyIGlzIG5vdCBzZXQgdXApCiAgICBvbkNsZWFudXAgPSBub29wOwoKICAgIGlmICghY2IpIHsKICAgICAgZ2V0dGVyKCk7CiAgICB9IGVsc2UgaWYgKGltbWVkaWF0ZSkgewogICAgICBjYWxsKGNiLCBXQVRDSEVSX0NCLCBbZ2V0dGVyKCksIGlzTXVsdGlTb3VyY2UgPyBbXSA6IHVuZGVmaW5lZCwgb25DbGVhbnVwXSk7CiAgICB9CgogICAgcmV0dXJuIG5vb3A7CiAgfQoKICB2YXIgd2F0Y2hlciA9IG5ldyBXYXRjaGVyKGN1cnJlbnRJbnN0YW5jZSwgZ2V0dGVyLCBub29wLCB7CiAgICBsYXp5OiB0cnVlCiAgfSk7CiAgd2F0Y2hlci5ub1JlY3Vyc2UgPSAhY2I7CiAgdmFyIG9sZFZhbHVlID0gaXNNdWx0aVNvdXJjZSA/IFtdIDogSU5JVElBTF9XQVRDSEVSX1ZBTFVFOyAvLyBvdmVyd3JpdGUgZGVmYXVsdCBydW4KCiAgd2F0Y2hlci5ydW4gPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIXdhdGNoZXIuYWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoY2IpIHsKICAgICAgLy8gd2F0Y2goc291cmNlLCBjYikKICAgICAgdmFyIG5ld1ZhbHVlID0gd2F0Y2hlci5nZXQoKTsKCiAgICAgIGlmIChkZWVwIHx8IGZvcmNlVHJpZ2dlciB8fCAoaXNNdWx0aVNvdXJjZSA/IG5ld1ZhbHVlLnNvbWUoZnVuY3Rpb24gKHYsIGkpIHsKICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZCh2LCBvbGRWYWx1ZVtpXSk7CiAgICAgIH0pIDogaGFzQ2hhbmdlZChuZXdWYWx1ZSwgb2xkVmFsdWUpKSkgewogICAgICAgIC8vIGNsZWFudXAgYmVmb3JlIHJ1bm5pbmcgY2IgYWdhaW4KICAgICAgICBpZiAoY2xlYW51cCkgewogICAgICAgICAgY2xlYW51cCgpOwogICAgICAgIH0KCiAgICAgICAgY2FsbChjYiwgV0FUQ0hFUl9DQiwgW25ld1ZhbHVlLCAvLyBwYXNzIHVuZGVmaW5lZCBhcyB0aGUgb2xkIHZhbHVlIHdoZW4gaXQncyBjaGFuZ2VkIGZvciB0aGUgZmlyc3QgdGltZQogICAgICAgIG9sZFZhbHVlID09PSBJTklUSUFMX1dBVENIRVJfVkFMVUUgPyB1bmRlZmluZWQgOiBvbGRWYWx1ZSwgb25DbGVhbnVwXSk7CiAgICAgICAgb2xkVmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gd2F0Y2hFZmZlY3QKICAgICAgd2F0Y2hlci5nZXQoKTsKICAgIH0KICB9OwoKICBpZiAoZmx1c2ggPT09ICdzeW5jJykgewogICAgd2F0Y2hlci51cGRhdGUgPSB3YXRjaGVyLnJ1bjsKICB9IGVsc2UgaWYgKGZsdXNoID09PSAncG9zdCcpIHsKICAgIHdhdGNoZXIucG9zdCA9IHRydWU7CgogICAgd2F0Y2hlci51cGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBxdWV1ZVdhdGNoZXIod2F0Y2hlcik7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBwcmUKICAgIHdhdGNoZXIudXBkYXRlID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UgPT09IGN1cnJlbnRJbnN0YW5jZSAmJiAhaW5zdGFuY2UuX2lzTW91bnRlZCkgewogICAgICAgIC8vIHByZS13YXRjaGVyIHRyaWdnZXJlZCBiZWZvcmUKICAgICAgICB2YXIgYnVmZmVyID0gaW5zdGFuY2UuX3ByZVdhdGNoZXJzIHx8IChpbnN0YW5jZS5fcHJlV2F0Y2hlcnMgPSBbXSk7CiAgICAgICAgaWYgKGJ1ZmZlci5pbmRleE9mKHdhdGNoZXIpIDwgMCkgYnVmZmVyLnB1c2god2F0Y2hlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcXVldWVXYXRjaGVyKHdhdGNoZXIpOwogICAgICB9CiAgICB9OwogIH0KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhdGNoZXIub25UcmFjayA9IG9uVHJhY2s7CiAgICB3YXRjaGVyLm9uVHJpZ2dlciA9IG9uVHJpZ2dlcjsKICB9IC8vIGluaXRpYWwgcnVuCgoKICBpZiAoY2IpIHsKICAgIGlmIChpbW1lZGlhdGUpIHsKICAgICAgd2F0Y2hlci5ydW4oKTsKICAgIH0gZWxzZSB7CiAgICAgIG9sZFZhbHVlID0gd2F0Y2hlci5nZXQoKTsKICAgIH0KICB9IGVsc2UgaWYgKGZsdXNoID09PSAncG9zdCcgJiYgaW5zdGFuY2UpIHsKICAgIGluc3RhbmNlLiRvbmNlKCdob29rOm1vdW50ZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB3YXRjaGVyLmdldCgpOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIHdhdGNoZXIuZ2V0KCk7CiAgfQoKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgd2F0Y2hlci50ZWFyZG93bigpOwogIH07Cn0KCnZhciBhY3RpdmVFZmZlY3RTY29wZTsKCnZhciBFZmZlY3RTY29wZSA9Ci8qKiBAY2xhc3MgKi8KZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIEVmZmVjdFNjb3BlKGRldGFjaGVkKSB7CiAgICBpZiAoZGV0YWNoZWQgPT09IHZvaWQgMCkgewogICAgICBkZXRhY2hlZCA9IGZhbHNlOwogICAgfQogICAgLyoqDQogICAgICogQGludGVybmFsDQogICAgICovCgoKICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgIC8qKg0KICAgICAqIEBpbnRlcm5hbA0KICAgICAqLwoKICAgIHRoaXMuZWZmZWN0cyA9IFtdOwogICAgLyoqDQogICAgICogQGludGVybmFsDQogICAgICovCgogICAgdGhpcy5jbGVhbnVwcyA9IFtdOwoKICAgIGlmICghZGV0YWNoZWQgJiYgYWN0aXZlRWZmZWN0U2NvcGUpIHsKICAgICAgdGhpcy5wYXJlbnQgPSBhY3RpdmVFZmZlY3RTY29wZTsKICAgICAgdGhpcy5pbmRleCA9IChhY3RpdmVFZmZlY3RTY29wZS5zY29wZXMgfHwgKGFjdGl2ZUVmZmVjdFNjb3BlLnNjb3BlcyA9IFtdKSkucHVzaCh0aGlzKSAtIDE7CiAgICB9CiAgfQoKICBFZmZlY3RTY29wZS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKGZuKSB7CiAgICBpZiAodGhpcy5hY3RpdmUpIHsKICAgICAgdmFyIGN1cnJlbnRFZmZlY3RTY29wZSA9IGFjdGl2ZUVmZmVjdFNjb3BlOwoKICAgICAgdHJ5IHsKICAgICAgICBhY3RpdmVFZmZlY3RTY29wZSA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgYWN0aXZlRWZmZWN0U2NvcGUgPSBjdXJyZW50RWZmZWN0U2NvcGU7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB3YXJuKCJjYW5ub3QgcnVuIGFuIGluYWN0aXZlIGVmZmVjdCBzY29wZS4iKTsKICAgIH0KICB9OwogIC8qKg0KICAgKiBUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBub24tZGV0YWNoZWQgc2NvcGVzDQogICAqIEBpbnRlcm5hbA0KICAgKi8KCgogIEVmZmVjdFNjb3BlLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uICgpIHsKICAgIGFjdGl2ZUVmZmVjdFNjb3BlID0gdGhpczsKICB9OwogIC8qKg0KICAgKiBUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBub24tZGV0YWNoZWQgc2NvcGVzDQogICAqIEBpbnRlcm5hbA0KICAgKi8KCgogIEVmZmVjdFNjb3BlLnByb3RvdHlwZS5vZmYgPSBmdW5jdGlvbiAoKSB7CiAgICBhY3RpdmVFZmZlY3RTY29wZSA9IHRoaXMucGFyZW50OwogIH07CgogIEVmZmVjdFNjb3BlLnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKGZyb21QYXJlbnQpIHsKICAgIGlmICh0aGlzLmFjdGl2ZSkgewogICAgICB2YXIgaSA9IHZvaWQgMCwKICAgICAgICAgIGwgPSB2b2lkIDA7CgogICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5lZmZlY3RzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHRoaXMuZWZmZWN0c1tpXS50ZWFyZG93bigpOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5jbGVhbnVwcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLmNsZWFudXBzW2ldKCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNjb3BlcykgewogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLnNjb3Blcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMuc2NvcGVzW2ldLnN0b3AodHJ1ZSk7CiAgICAgICAgfQogICAgICB9IC8vIG5lc3RlZCBzY29wZSwgZGVyZWZlcmVuY2UgZnJvbSBwYXJlbnQgdG8gYXZvaWQgbWVtb3J5IGxlYWtzCgoKICAgICAgaWYgKHRoaXMucGFyZW50ICYmICFmcm9tUGFyZW50KSB7CiAgICAgICAgLy8gb3B0aW1pemVkIE8oMSkgcmVtb3ZhbAogICAgICAgIHZhciBsYXN0ID0gdGhpcy5wYXJlbnQuc2NvcGVzLnBvcCgpOwoKICAgICAgICBpZiAobGFzdCAmJiBsYXN0ICE9PSB0aGlzKSB7CiAgICAgICAgICB0aGlzLnBhcmVudC5zY29wZXNbdGhpcy5pbmRleF0gPSBsYXN0OwogICAgICAgICAgbGFzdC5pbmRleCA9IHRoaXMuaW5kZXg7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgfQogIH07CgogIHJldHVybiBFZmZlY3RTY29wZTsKfSgpOwoKZnVuY3Rpb24gZWZmZWN0U2NvcGUoZGV0YWNoZWQpIHsKICByZXR1cm4gbmV3IEVmZmVjdFNjb3BlKGRldGFjaGVkKTsKfQovKioNCiAqIEBpbnRlcm5hbA0KICovCgoKZnVuY3Rpb24gcmVjb3JkRWZmZWN0U2NvcGUoZWZmZWN0LCBzY29wZSkgewogIGlmIChzY29wZSA9PT0gdm9pZCAwKSB7CiAgICBzY29wZSA9IGFjdGl2ZUVmZmVjdFNjb3BlOwogIH0KCiAgaWYgKHNjb3BlICYmIHNjb3BlLmFjdGl2ZSkgewogICAgc2NvcGUuZWZmZWN0cy5wdXNoKGVmZmVjdCk7CiAgfQp9CgpmdW5jdGlvbiBnZXRDdXJyZW50U2NvcGUoKSB7CiAgcmV0dXJuIGFjdGl2ZUVmZmVjdFNjb3BlOwp9CgpmdW5jdGlvbiBvblNjb3BlRGlzcG9zZShmbikgewogIGlmIChhY3RpdmVFZmZlY3RTY29wZSkgewogICAgYWN0aXZlRWZmZWN0U2NvcGUuY2xlYW51cHMucHVzaChmbik7CiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXJuKCJvblNjb3BlRGlzcG9zZSgpIGlzIGNhbGxlZCB3aGVuIHRoZXJlIGlzIG5vIGFjdGl2ZSBlZmZlY3Qgc2NvcGUiICsgIiB0byBiZSBhc3NvY2lhdGVkIHdpdGguIik7CiAgfQp9CgpmdW5jdGlvbiBwcm92aWRlKGtleSwgdmFsdWUpIHsKICBpZiAoIWN1cnJlbnRJbnN0YW5jZSkgewogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgd2FybigicHJvdmlkZSgpIGNhbiBvbmx5IGJlIHVzZWQgaW5zaWRlIHNldHVwKCkuIik7CiAgICB9CiAgfSBlbHNlIHsKICAgIC8vIFRTIGRvZXNuJ3QgYWxsb3cgc3ltYm9sIGFzIGluZGV4IHR5cGUKICAgIHJlc29sdmVQcm92aWRlZChjdXJyZW50SW5zdGFuY2UpW2tleV0gPSB2YWx1ZTsKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVQcm92aWRlZCh2bSkgewogIC8vIGJ5IGRlZmF1bHQgYW4gaW5zdGFuY2UgaW5oZXJpdHMgaXRzIHBhcmVudCdzIHByb3ZpZGVzIG9iamVjdAogIC8vIGJ1dCB3aGVuIGl0IG5lZWRzIHRvIHByb3ZpZGUgdmFsdWVzIG9mIGl0cyBvd24sIGl0IGNyZWF0ZXMgaXRzCiAgLy8gb3duIHByb3ZpZGVzIG9iamVjdCB1c2luZyBwYXJlbnQgcHJvdmlkZXMgb2JqZWN0IGFzIHByb3RvdHlwZS4KICAvLyB0aGlzIHdheSBpbiBgaW5qZWN0YCB3ZSBjYW4gc2ltcGx5IGxvb2sgdXAgaW5qZWN0aW9ucyBmcm9tIGRpcmVjdAogIC8vIHBhcmVudCBhbmQgbGV0IHRoZSBwcm90b3R5cGUgY2hhaW4gZG8gdGhlIHdvcmsuCiAgdmFyIGV4aXN0aW5nID0gdm0uX3Byb3ZpZGVkOwogIHZhciBwYXJlbnRQcm92aWRlcyA9IHZtLiRwYXJlbnQgJiYgdm0uJHBhcmVudC5fcHJvdmlkZWQ7CgogIGlmIChwYXJlbnRQcm92aWRlcyA9PT0gZXhpc3RpbmcpIHsKICAgIHJldHVybiB2bS5fcHJvdmlkZWQgPSBPYmplY3QuY3JlYXRlKHBhcmVudFByb3ZpZGVzKTsKICB9IGVsc2UgewogICAgcmV0dXJuIGV4aXN0aW5nOwogIH0KfQoKZnVuY3Rpb24gaW5qZWN0KGtleSwgZGVmYXVsdFZhbHVlLCB0cmVhdERlZmF1bHRBc0ZhY3RvcnkpIHsKICBpZiAodHJlYXREZWZhdWx0QXNGYWN0b3J5ID09PSB2b2lkIDApIHsKICAgIHRyZWF0RGVmYXVsdEFzRmFjdG9yeSA9IGZhbHNlOwogIH0gLy8gZmFsbGJhY2sgdG8gYGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZWAgc28gdGhhdCB0aGlzIGNhbiBiZSBjYWxsZWQgaW4KICAvLyBhIGZ1bmN0aW9uYWwgY29tcG9uZW50CgoKICB2YXIgaW5zdGFuY2UgPSBjdXJyZW50SW5zdGFuY2U7CgogIGlmIChpbnN0YW5jZSkgewogICAgLy8gIzI0MDAKICAgIC8vIHRvIHN1cHBvcnQgYGFwcC51c2VgIHBsdWdpbnMsCiAgICAvLyBmYWxsYmFjayB0byBhcHBDb250ZXh0J3MgYHByb3ZpZGVzYCBpZiB0aGUgaW5zdGFuY2UgaXMgYXQgcm9vdAogICAgdmFyIHByb3ZpZGVzID0gaW5zdGFuY2UuJHBhcmVudCAmJiBpbnN0YW5jZS4kcGFyZW50Ll9wcm92aWRlZDsKCiAgICBpZiAocHJvdmlkZXMgJiYga2V5IGluIHByb3ZpZGVzKSB7CiAgICAgIC8vIFRTIGRvZXNuJ3QgYWxsb3cgc3ltYm9sIGFzIGluZGV4IHR5cGUKICAgICAgcmV0dXJuIHByb3ZpZGVzW2tleV07CiAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgIHJldHVybiB0cmVhdERlZmF1bHRBc0ZhY3RvcnkgJiYgaXNGdW5jdGlvbihkZWZhdWx0VmFsdWUpID8gZGVmYXVsdFZhbHVlLmNhbGwoaW5zdGFuY2UpIDogZGVmYXVsdFZhbHVlOwogICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHdhcm4oImluamVjdGlvbiBcIiIuY29uY2F0KFN0cmluZyhrZXkpLCAiXCIgbm90IGZvdW5kLiIpKTsKICAgIH0KICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oImluamVjdCgpIGNhbiBvbmx5IGJlIHVzZWQgaW5zaWRlIHNldHVwKCkgb3IgZnVuY3Rpb25hbCBjb21wb25lbnRzLiIpOwogIH0KfQoKdmFyIG5vcm1hbGl6ZUV2ZW50ID0gY2FjaGVkKGZ1bmN0aW9uIChuYW1lKSB7CiAgdmFyIHBhc3NpdmUgPSBuYW1lLmNoYXJBdCgwKSA9PT0gJyYnOwogIG5hbWUgPSBwYXNzaXZlID8gbmFtZS5zbGljZSgxKSA6IG5hbWU7CiAgdmFyIG9uY2UgPSBuYW1lLmNoYXJBdCgwKSA9PT0gJ34nOyAvLyBQcmVmaXhlZCBsYXN0LCBjaGVja2VkIGZpcnN0CgogIG5hbWUgPSBvbmNlID8gbmFtZS5zbGljZSgxKSA6IG5hbWU7CiAgdmFyIGNhcHR1cmUgPSBuYW1lLmNoYXJBdCgwKSA9PT0gJyEnOwogIG5hbWUgPSBjYXB0dXJlID8gbmFtZS5zbGljZSgxKSA6IG5hbWU7CiAgcmV0dXJuIHsKICAgIG5hbWU6IG5hbWUsCiAgICBvbmNlOiBvbmNlLAogICAgY2FwdHVyZTogY2FwdHVyZSwKICAgIHBhc3NpdmU6IHBhc3NpdmUKICB9Owp9KTsKCmZ1bmN0aW9uIGNyZWF0ZUZuSW52b2tlcihmbnMsIHZtKSB7CiAgZnVuY3Rpb24gaW52b2tlcigpIHsKICAgIHZhciBmbnMgPSBpbnZva2VyLmZuczsKCiAgICBpZiAoaXNBcnJheShmbnMpKSB7CiAgICAgIHZhciBjbG9uZWQgPSBmbnMuc2xpY2UoKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2xvbmVkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoY2xvbmVkW2ldLCBudWxsLCBhcmd1bWVudHMsIHZtLCAidi1vbiBoYW5kbGVyIik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIHJldHVybiBoYW5kbGVyIHJldHVybiB2YWx1ZSBmb3Igc2luZ2xlIGhhbmRsZXJzCiAgICAgIHJldHVybiBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhmbnMsIG51bGwsIGFyZ3VtZW50cywgdm0sICJ2LW9uIGhhbmRsZXIiKTsKICAgIH0KICB9CgogIGludm9rZXIuZm5zID0gZm5zOwogIHJldHVybiBpbnZva2VyOwp9CgpmdW5jdGlvbiB1cGRhdGVMaXN0ZW5lcnMob24sIG9sZE9uLCBhZGQsIHJlbW92ZSwgY3JlYXRlT25jZUhhbmRsZXIsIHZtKSB7CiAgdmFyIG5hbWUsIGN1ciwgb2xkLCBldmVudDsKCiAgZm9yIChuYW1lIGluIG9uKSB7CiAgICBjdXIgPSBvbltuYW1lXTsKICAgIG9sZCA9IG9sZE9uW25hbWVdOwogICAgZXZlbnQgPSBub3JtYWxpemVFdmVudChuYW1lKTsKCiAgICBpZiAoaXNVbmRlZihjdXIpKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiSW52YWxpZCBoYW5kbGVyIGZvciBldmVudCBcIiIuY29uY2F0KGV2ZW50Lm5hbWUsICJcIjogZ290ICIpICsgU3RyaW5nKGN1ciksIHZtKTsKICAgIH0gZWxzZSBpZiAoaXNVbmRlZihvbGQpKSB7CiAgICAgIGlmIChpc1VuZGVmKGN1ci5mbnMpKSB7CiAgICAgICAgY3VyID0gb25bbmFtZV0gPSBjcmVhdGVGbkludm9rZXIoY3VyLCB2bSk7CiAgICAgIH0KCiAgICAgIGlmIChpc1RydWUoZXZlbnQub25jZSkpIHsKICAgICAgICBjdXIgPSBvbltuYW1lXSA9IGNyZWF0ZU9uY2VIYW5kbGVyKGV2ZW50Lm5hbWUsIGN1ciwgZXZlbnQuY2FwdHVyZSk7CiAgICAgIH0KCiAgICAgIGFkZChldmVudC5uYW1lLCBjdXIsIGV2ZW50LmNhcHR1cmUsIGV2ZW50LnBhc3NpdmUsIGV2ZW50LnBhcmFtcyk7CiAgICB9IGVsc2UgaWYgKGN1ciAhPT0gb2xkKSB7CiAgICAgIG9sZC5mbnMgPSBjdXI7CiAgICAgIG9uW25hbWVdID0gb2xkOwogICAgfQogIH0KCiAgZm9yIChuYW1lIGluIG9sZE9uKSB7CiAgICBpZiAoaXNVbmRlZihvbltuYW1lXSkpIHsKICAgICAgZXZlbnQgPSBub3JtYWxpemVFdmVudChuYW1lKTsKICAgICAgcmVtb3ZlKGV2ZW50Lm5hbWUsIG9sZE9uW25hbWVdLCBldmVudC5jYXB0dXJlKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIG1lcmdlVk5vZGVIb29rKGRlZiwgaG9va0tleSwgaG9vaykgewogIGlmIChkZWYgaW5zdGFuY2VvZiBWTm9kZSkgewogICAgZGVmID0gZGVmLmRhdGEuaG9vayB8fCAoZGVmLmRhdGEuaG9vayA9IHt9KTsKICB9CgogIHZhciBpbnZva2VyOwogIHZhciBvbGRIb29rID0gZGVmW2hvb2tLZXldOwoKICBmdW5jdGlvbiB3cmFwcGVkSG9vaygpIHsKICAgIGhvb2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsgLy8gaW1wb3J0YW50OiByZW1vdmUgbWVyZ2VkIGhvb2sgdG8gZW5zdXJlIGl0J3MgY2FsbGVkIG9ubHkgb25jZQogICAgLy8gYW5kIHByZXZlbnQgbWVtb3J5IGxlYWsKCiAgICByZW1vdmUkMihpbnZva2VyLmZucywgd3JhcHBlZEhvb2spOwogIH0KCiAgaWYgKGlzVW5kZWYob2xkSG9vaykpIHsKICAgIC8vIG5vIGV4aXN0aW5nIGhvb2sKICAgIGludm9rZXIgPSBjcmVhdGVGbkludm9rZXIoW3dyYXBwZWRIb29rXSk7CiAgfSBlbHNlIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzRGVmKG9sZEhvb2suZm5zKSAmJiBpc1RydWUob2xkSG9vay5tZXJnZWQpKSB7CiAgICAgIC8vIGFscmVhZHkgYSBtZXJnZWQgaW52b2tlcgogICAgICBpbnZva2VyID0gb2xkSG9vazsKICAgICAgaW52b2tlci5mbnMucHVzaCh3cmFwcGVkSG9vayk7CiAgICB9IGVsc2UgewogICAgICAvLyBleGlzdGluZyBwbGFpbiBob29rCiAgICAgIGludm9rZXIgPSBjcmVhdGVGbkludm9rZXIoW29sZEhvb2ssIHdyYXBwZWRIb29rXSk7CiAgICB9CiAgfQoKICBpbnZva2VyLm1lcmdlZCA9IHRydWU7CiAgZGVmW2hvb2tLZXldID0gaW52b2tlcjsKfQoKZnVuY3Rpb24gZXh0cmFjdFByb3BzRnJvbVZOb2RlRGF0YShkYXRhLCBDdG9yLCB0YWcpIHsKICAvLyB3ZSBhcmUgb25seSBleHRyYWN0aW5nIHJhdyB2YWx1ZXMgaGVyZS4KICAvLyB2YWxpZGF0aW9uIGFuZCBkZWZhdWx0IHZhbHVlcyBhcmUgaGFuZGxlZCBpbiB0aGUgY2hpbGQKICAvLyBjb21wb25lbnQgaXRzZWxmLgogIHZhciBwcm9wT3B0aW9ucyA9IEN0b3Iub3B0aW9ucy5wcm9wczsKCiAgaWYgKGlzVW5kZWYocHJvcE9wdGlvbnMpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgcmVzID0ge307CiAgdmFyIGF0dHJzID0gZGF0YS5hdHRycywKICAgICAgcHJvcHMgPSBkYXRhLnByb3BzOwoKICBpZiAoaXNEZWYoYXR0cnMpIHx8IGlzRGVmKHByb3BzKSkgewogICAgZm9yICh2YXIga2V5IGluIHByb3BPcHRpb25zKSB7CiAgICAgIHZhciBhbHRLZXkgPSBoeXBoZW5hdGUoa2V5KTsKCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgdmFyIGtleUluTG93ZXJDYXNlID0ga2V5LnRvTG93ZXJDYXNlKCk7CgogICAgICAgIGlmIChrZXkgIT09IGtleUluTG93ZXJDYXNlICYmIGF0dHJzICYmIGhhc093bihhdHRycywga2V5SW5Mb3dlckNhc2UpKSB7CiAgICAgICAgICB0aXAoIlByb3AgXCIiLmNvbmNhdChrZXlJbkxvd2VyQ2FzZSwgIlwiIGlzIHBhc3NlZCB0byBjb21wb25lbnQgIikgKyAiIi5jb25jYXQoZm9ybWF0Q29tcG9uZW50TmFtZSggLy8gQHRzLWV4cGVjdC1lcnJvciB0YWcgaXMgc3RyaW5nCiAgICAgICAgICB0YWcgfHwgQ3RvciksICIsIGJ1dCB0aGUgZGVjbGFyZWQgcHJvcCBuYW1lIGlzIikgKyAiIFwiIi5jb25jYXQoa2V5LCAiXCIuICIpICsgIk5vdGUgdGhhdCBIVE1MIGF0dHJpYnV0ZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUgYW5kIGNhbWVsQ2FzZWQgIiArICJwcm9wcyBuZWVkIHRvIHVzZSB0aGVpciBrZWJhYi1jYXNlIGVxdWl2YWxlbnRzIHdoZW4gdXNpbmcgaW4tRE9NICIgKyAidGVtcGxhdGVzLiBZb3Ugc2hvdWxkIHByb2JhYmx5IHVzZSBcIiIuY29uY2F0KGFsdEtleSwgIlwiIGluc3RlYWQgb2YgXCIiKS5jb25jYXQoa2V5LCAiXCIuIikpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY2hlY2tQcm9wKHJlcywgcHJvcHMsIGtleSwgYWx0S2V5LCB0cnVlKSB8fCBjaGVja1Byb3AocmVzLCBhdHRycywga2V5LCBhbHRLZXksIGZhbHNlKTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIGNoZWNrUHJvcChyZXMsIGhhc2gsIGtleSwgYWx0S2V5LCBwcmVzZXJ2ZSkgewogIGlmIChpc0RlZihoYXNoKSkgewogICAgaWYgKGhhc093bihoYXNoLCBrZXkpKSB7CiAgICAgIHJlc1trZXldID0gaGFzaFtrZXldOwoKICAgICAgaWYgKCFwcmVzZXJ2ZSkgewogICAgICAgIGRlbGV0ZSBoYXNoW2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIGlmIChoYXNPd24oaGFzaCwgYWx0S2V5KSkgewogICAgICByZXNba2V5XSA9IGhhc2hbYWx0S2V5XTsKCiAgICAgIGlmICghcHJlc2VydmUpIHsKICAgICAgICBkZWxldGUgaGFzaFthbHRLZXldOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CgogIHJldHVybiBmYWxzZTsKfSAvLyBUaGUgdGVtcGxhdGUgY29tcGlsZXIgYXR0ZW1wdHMgdG8gbWluaW1pemUgdGhlIG5lZWQgZm9yIG5vcm1hbGl6YXRpb24gYnkKLy8gc3RhdGljYWxseSBhbmFseXppbmcgdGhlIHRlbXBsYXRlIGF0IGNvbXBpbGUgdGltZS4KLy8KLy8gRm9yIHBsYWluIEhUTUwgbWFya3VwLCBub3JtYWxpemF0aW9uIGNhbiBiZSBjb21wbGV0ZWx5IHNraXBwZWQgYmVjYXVzZSB0aGUKLy8gZ2VuZXJhdGVkIHJlbmRlciBmdW5jdGlvbiBpcyBndWFyYW50ZWVkIHRvIHJldHVybiBBcnJheTxWTm9kZT4uIFRoZXJlIGFyZQovLyB0d28gY2FzZXMgd2hlcmUgZXh0cmEgbm9ybWFsaXphdGlvbiBpcyBuZWVkZWQ6Ci8vIDEuIFdoZW4gdGhlIGNoaWxkcmVuIGNvbnRhaW5zIGNvbXBvbmVudHMgLSBiZWNhdXNlIGEgZnVuY3Rpb25hbCBjb21wb25lbnQKLy8gbWF5IHJldHVybiBhbiBBcnJheSBpbnN0ZWFkIG9mIGEgc2luZ2xlIHJvb3QuIEluIHRoaXMgY2FzZSwganVzdCBhIHNpbXBsZQovLyBub3JtYWxpemF0aW9uIGlzIG5lZWRlZCAtIGlmIGFueSBjaGlsZCBpcyBhbiBBcnJheSwgd2UgZmxhdHRlbiB0aGUgd2hvbGUKLy8gdGhpbmcgd2l0aCBBcnJheS5wcm90b3R5cGUuY29uY2F0LiBJdCBpcyBndWFyYW50ZWVkIHRvIGJlIG9ubHkgMS1sZXZlbCBkZWVwCi8vIGJlY2F1c2UgZnVuY3Rpb25hbCBjb21wb25lbnRzIGFscmVhZHkgbm9ybWFsaXplIHRoZWlyIG93biBjaGlsZHJlbi4KCgpmdW5jdGlvbiBzaW1wbGVOb3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbikgewogIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIGlmIChpc0FycmF5KGNoaWxkcmVuW2ldKSkgewogICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseShbXSwgY2hpbGRyZW4pOwogICAgfQogIH0KCiAgcmV0dXJuIGNoaWxkcmVuOwp9IC8vIDIuIFdoZW4gdGhlIGNoaWxkcmVuIGNvbnRhaW5zIGNvbnN0cnVjdHMgdGhhdCBhbHdheXMgZ2VuZXJhdGVkIG5lc3RlZCBBcnJheXMsCi8vIGUuZy4gPHRlbXBsYXRlPiwgPHNsb3Q+LCB2LWZvciwgb3Igd2hlbiB0aGUgY2hpbGRyZW4gaXMgcHJvdmlkZWQgYnkgdXNlcgovLyB3aXRoIGhhbmQtd3JpdHRlbiByZW5kZXIgZnVuY3Rpb25zIC8gSlNYLiBJbiBzdWNoIGNhc2VzIGEgZnVsbCBub3JtYWxpemF0aW9uCi8vIGlzIG5lZWRlZCB0byBjYXRlciB0byBhbGwgcG9zc2libGUgdHlwZXMgb2YgY2hpbGRyZW4gdmFsdWVzLgoKCmZ1bmN0aW9uIG5vcm1hbGl6ZUNoaWxkcmVuKGNoaWxkcmVuKSB7CiAgcmV0dXJuIGlzUHJpbWl0aXZlKGNoaWxkcmVuKSA/IFtjcmVhdGVUZXh0Vk5vZGUoY2hpbGRyZW4pXSA6IGlzQXJyYXkoY2hpbGRyZW4pID8gbm9ybWFsaXplQXJyYXlDaGlsZHJlbihjaGlsZHJlbikgOiB1bmRlZmluZWQ7Cn0KCmZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgewogIHJldHVybiBpc0RlZihub2RlKSAmJiBpc0RlZihub2RlLnRleHQpICYmIGlzRmFsc2Uobm9kZS5pc0NvbW1lbnQpOwp9CgpmdW5jdGlvbiBub3JtYWxpemVBcnJheUNoaWxkcmVuKGNoaWxkcmVuLCBuZXN0ZWRJbmRleCkgewogIHZhciByZXMgPSBbXTsKICB2YXIgaSwgYywgbGFzdEluZGV4LCBsYXN0OwoKICBmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIGMgPSBjaGlsZHJlbltpXTsKICAgIGlmIChpc1VuZGVmKGMpIHx8IHR5cGVvZiBjID09PSAnYm9vbGVhbicpIGNvbnRpbnVlOwogICAgbGFzdEluZGV4ID0gcmVzLmxlbmd0aCAtIDE7CiAgICBsYXN0ID0gcmVzW2xhc3RJbmRleF07IC8vICBuZXN0ZWQKCiAgICBpZiAoaXNBcnJheShjKSkgewogICAgICBpZiAoYy5sZW5ndGggPiAwKSB7CiAgICAgICAgYyA9IG5vcm1hbGl6ZUFycmF5Q2hpbGRyZW4oYywgIiIuY29uY2F0KG5lc3RlZEluZGV4IHx8ICcnLCAiXyIpLmNvbmNhdChpKSk7IC8vIG1lcmdlIGFkamFjZW50IHRleHQgbm9kZXMKCiAgICAgICAgaWYgKGlzVGV4dE5vZGUoY1swXSkgJiYgaXNUZXh0Tm9kZShsYXN0KSkgewogICAgICAgICAgcmVzW2xhc3RJbmRleF0gPSBjcmVhdGVUZXh0Vk5vZGUobGFzdC50ZXh0ICsgY1swXS50ZXh0KTsKICAgICAgICAgIGMuc2hpZnQoKTsKICAgICAgICB9CgogICAgICAgIHJlcy5wdXNoLmFwcGx5KHJlcywgYyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNQcmltaXRpdmUoYykpIHsKICAgICAgaWYgKGlzVGV4dE5vZGUobGFzdCkpIHsKICAgICAgICAvLyBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzCiAgICAgICAgLy8gdGhpcyBpcyBuZWNlc3NhcnkgZm9yIFNTUiBoeWRyYXRpb24gYmVjYXVzZSB0ZXh0IG5vZGVzIGFyZQogICAgICAgIC8vIGVzc2VudGlhbGx5IG1lcmdlZCB3aGVuIHJlbmRlcmVkIHRvIEhUTUwgc3RyaW5ncwogICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIGMpOwogICAgICB9IGVsc2UgaWYgKGMgIT09ICcnKSB7CiAgICAgICAgLy8gY29udmVydCBwcmltaXRpdmUgdG8gdm5vZGUKICAgICAgICByZXMucHVzaChjcmVhdGVUZXh0Vk5vZGUoYykpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoaXNUZXh0Tm9kZShjKSAmJiBpc1RleHROb2RlKGxhc3QpKSB7CiAgICAgICAgLy8gbWVyZ2UgYWRqYWNlbnQgdGV4dCBub2RlcwogICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIGMudGV4dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVmYXVsdCBrZXkgZm9yIG5lc3RlZCBhcnJheSBjaGlsZHJlbiAobGlrZWx5IGdlbmVyYXRlZCBieSB2LWZvcikKICAgICAgICBpZiAoaXNUcnVlKGNoaWxkcmVuLl9pc1ZMaXN0KSAmJiBpc0RlZihjLnRhZykgJiYgaXNVbmRlZihjLmtleSkgJiYgaXNEZWYobmVzdGVkSW5kZXgpKSB7CiAgICAgICAgICBjLmtleSA9ICJfX3ZsaXN0Ii5jb25jYXQobmVzdGVkSW5kZXgsICJfIikuY29uY2F0KGksICJfXyIpOwogICAgICAgIH0KCiAgICAgICAgcmVzLnB1c2goYyk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KLyoqDQogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIHYtZm9yIGxpc3RzLg0KICovCgoKZnVuY3Rpb24gcmVuZGVyTGlzdCh2YWwsIHJlbmRlcikgewogIHZhciByZXQgPSBudWxsLAogICAgICBpLAogICAgICBsLAogICAgICBrZXlzLAogICAgICBrZXk7CgogIGlmIChpc0FycmF5KHZhbCkgfHwgdHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgIHJldCA9IG5ldyBBcnJheSh2YWwubGVuZ3RoKTsKCiAgICBmb3IgKGkgPSAwLCBsID0gdmFsLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICByZXRbaV0gPSByZW5kZXIodmFsW2ldLCBpKTsKICAgIH0KICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICByZXQgPSBuZXcgQXJyYXkodmFsKTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgdmFsOyBpKyspIHsKICAgICAgcmV0W2ldID0gcmVuZGVyKGkgKyAxLCBpKTsKICAgIH0KICB9IGVsc2UgaWYgKGlzT2JqZWN0KHZhbCkpIHsKICAgIGlmIChoYXNTeW1ib2wgJiYgdmFsW1N5bWJvbC5pdGVyYXRvcl0pIHsKICAgICAgcmV0ID0gW107CiAgICAgIHZhciBpdGVyYXRvciA9IHZhbFtTeW1ib2wuaXRlcmF0b3JdKCk7CiAgICAgIHZhciByZXN1bHQgPSBpdGVyYXRvci5uZXh0KCk7CgogICAgICB3aGlsZSAoIXJlc3VsdC5kb25lKSB7CiAgICAgICAgcmV0LnB1c2gocmVuZGVyKHJlc3VsdC52YWx1ZSwgcmV0Lmxlbmd0aCkpOwogICAgICAgIHJlc3VsdCA9IGl0ZXJhdG9yLm5leHQoKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAga2V5cyA9IE9iamVjdC5rZXlzKHZhbCk7CiAgICAgIHJldCA9IG5ldyBBcnJheShrZXlzLmxlbmd0aCk7CgogICAgICBmb3IgKGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIHJldFtpXSA9IHJlbmRlcih2YWxba2V5XSwga2V5LCBpKTsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKCFpc0RlZihyZXQpKSB7CiAgICByZXQgPSBbXTsKICB9CgogIHJldC5faXNWTGlzdCA9IHRydWU7CiAgcmV0dXJuIHJldDsKfQovKioNCiAqIFJ1bnRpbWUgaGVscGVyIGZvciByZW5kZXJpbmcgPHNsb3Q+DQogKi8KCgpmdW5jdGlvbiByZW5kZXJTbG90KG5hbWUsIGZhbGxiYWNrUmVuZGVyLCBwcm9wcywgYmluZE9iamVjdCkgewogIHZhciBzY29wZWRTbG90Rm4gPSB0aGlzLiRzY29wZWRTbG90c1tuYW1lXTsKICB2YXIgbm9kZXM7CgogIGlmIChzY29wZWRTbG90Rm4pIHsKICAgIC8vIHNjb3BlZCBzbG90CiAgICBwcm9wcyA9IHByb3BzIHx8IHt9OwoKICAgIGlmIChiaW5kT2JqZWN0KSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFpc09iamVjdChiaW5kT2JqZWN0KSkgewogICAgICAgIHdhcm4oJ3Nsb3Qgdi1iaW5kIHdpdGhvdXQgYXJndW1lbnQgZXhwZWN0cyBhbiBPYmplY3QnLCB0aGlzKTsKICAgICAgfQoKICAgICAgcHJvcHMgPSBleHRlbmQoZXh0ZW5kKHt9LCBiaW5kT2JqZWN0KSwgcHJvcHMpOwogICAgfQoKICAgIG5vZGVzID0gc2NvcGVkU2xvdEZuKHByb3BzKSB8fCAoaXNGdW5jdGlvbihmYWxsYmFja1JlbmRlcikgPyBmYWxsYmFja1JlbmRlcigpIDogZmFsbGJhY2tSZW5kZXIpOwogIH0gZWxzZSB7CiAgICBub2RlcyA9IHRoaXMuJHNsb3RzW25hbWVdIHx8IChpc0Z1bmN0aW9uKGZhbGxiYWNrUmVuZGVyKSA/IGZhbGxiYWNrUmVuZGVyKCkgOiBmYWxsYmFja1JlbmRlcik7CiAgfQoKICB2YXIgdGFyZ2V0ID0gcHJvcHMgJiYgcHJvcHMuc2xvdDsKCiAgaWYgKHRhcmdldCkgewogICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJywgewogICAgICBzbG90OiB0YXJnZXQKICAgIH0sIG5vZGVzKTsKICB9IGVsc2UgewogICAgcmV0dXJuIG5vZGVzOwogIH0KfQovKioNCiAqIFJ1bnRpbWUgaGVscGVyIGZvciByZXNvbHZpbmcgZmlsdGVycw0KICovCgoKZnVuY3Rpb24gcmVzb2x2ZUZpbHRlcihpZCkgewogIHJldHVybiByZXNvbHZlQXNzZXQodGhpcy4kb3B0aW9ucywgJ2ZpbHRlcnMnLCBpZCwgdHJ1ZSkgfHwgaWRlbnRpdHk7Cn0KCmZ1bmN0aW9uIGlzS2V5Tm90TWF0Y2goZXhwZWN0LCBhY3R1YWwpIHsKICBpZiAoaXNBcnJheShleHBlY3QpKSB7CiAgICByZXR1cm4gZXhwZWN0LmluZGV4T2YoYWN0dWFsKSA9PT0gLTE7CiAgfSBlbHNlIHsKICAgIHJldHVybiBleHBlY3QgIT09IGFjdHVhbDsKICB9Cn0KLyoqDQogKiBSdW50aW1lIGhlbHBlciBmb3IgY2hlY2tpbmcga2V5Q29kZXMgZnJvbSBjb25maWcuDQogKiBleHBvc2VkIGFzIFZ1ZS5wcm90b3R5cGUuX2sNCiAqIHBhc3NpbmcgaW4gZXZlbnRLZXlOYW1lIGFzIGxhc3QgYXJndW1lbnQgc2VwYXJhdGVseSBmb3IgYmFja3dhcmRzIGNvbXBhdA0KICovCgoKZnVuY3Rpb24gY2hlY2tLZXlDb2RlcyhldmVudEtleUNvZGUsIGtleSwgYnVpbHRJbktleUNvZGUsIGV2ZW50S2V5TmFtZSwgYnVpbHRJbktleU5hbWUpIHsKICB2YXIgbWFwcGVkS2V5Q29kZSA9IGNvbmZpZy5rZXlDb2Rlc1trZXldIHx8IGJ1aWx0SW5LZXlDb2RlOwoKICBpZiAoYnVpbHRJbktleU5hbWUgJiYgZXZlbnRLZXlOYW1lICYmICFjb25maWcua2V5Q29kZXNba2V5XSkgewogICAgcmV0dXJuIGlzS2V5Tm90TWF0Y2goYnVpbHRJbktleU5hbWUsIGV2ZW50S2V5TmFtZSk7CiAgfSBlbHNlIGlmIChtYXBwZWRLZXlDb2RlKSB7CiAgICByZXR1cm4gaXNLZXlOb3RNYXRjaChtYXBwZWRLZXlDb2RlLCBldmVudEtleUNvZGUpOwogIH0gZWxzZSBpZiAoZXZlbnRLZXlOYW1lKSB7CiAgICByZXR1cm4gaHlwaGVuYXRlKGV2ZW50S2V5TmFtZSkgIT09IGtleTsKICB9CgogIHJldHVybiBldmVudEtleUNvZGUgPT09IHVuZGVmaW5lZDsKfQovKioNCiAqIFJ1bnRpbWUgaGVscGVyIGZvciBtZXJnaW5nIHYtYmluZD0ib2JqZWN0IiBpbnRvIGEgVk5vZGUncyBkYXRhLg0KICovCgoKZnVuY3Rpb24gYmluZE9iamVjdFByb3BzKGRhdGEsIHRhZywgdmFsdWUsIGFzUHJvcCwgaXNTeW5jKSB7CiAgaWYgKHZhbHVlKSB7CiAgICBpZiAoIWlzT2JqZWN0KHZhbHVlKSkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ3YtYmluZCB3aXRob3V0IGFyZ3VtZW50IGV4cGVjdHMgYW4gT2JqZWN0IG9yIEFycmF5IHZhbHVlJywgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZSA9IHRvT2JqZWN0KHZhbHVlKTsKICAgICAgfQoKICAgICAgdmFyIGhhc2ggPSB2b2lkIDA7CgogICAgICB2YXIgX2xvb3BfMSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBpZiAoa2V5ID09PSAnY2xhc3MnIHx8IGtleSA9PT0gJ3N0eWxlJyB8fCBpc1Jlc2VydmVkQXR0cmlidXRlKGtleSkpIHsKICAgICAgICAgIGhhc2ggPSBkYXRhOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgdHlwZSA9IGRhdGEuYXR0cnMgJiYgZGF0YS5hdHRycy50eXBlOwogICAgICAgICAgaGFzaCA9IGFzUHJvcCB8fCBjb25maWcubXVzdFVzZVByb3AodGFnLCB0eXBlLCBrZXkpID8gZGF0YS5kb21Qcm9wcyB8fCAoZGF0YS5kb21Qcm9wcyA9IHt9KSA6IGRhdGEuYXR0cnMgfHwgKGRhdGEuYXR0cnMgPSB7fSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgY2FtZWxpemVkS2V5ID0gY2FtZWxpemUoa2V5KTsKICAgICAgICB2YXIgaHlwaGVuYXRlZEtleSA9IGh5cGhlbmF0ZShrZXkpOwoKICAgICAgICBpZiAoIShjYW1lbGl6ZWRLZXkgaW4gaGFzaCkgJiYgIShoeXBoZW5hdGVkS2V5IGluIGhhc2gpKSB7CiAgICAgICAgICBoYXNoW2tleV0gPSB2YWx1ZVtrZXldOwoKICAgICAgICAgIGlmIChpc1N5bmMpIHsKICAgICAgICAgICAgdmFyIG9uID0gZGF0YS5vbiB8fCAoZGF0YS5vbiA9IHt9KTsKCiAgICAgICAgICAgIG9uWyJ1cGRhdGU6Ii5jb25jYXQoa2V5KV0gPSBmdW5jdGlvbiAoJGV2ZW50KSB7CiAgICAgICAgICAgICAgdmFsdWVba2V5XSA9ICRldmVudDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CgogICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHsKICAgICAgICBfbG9vcF8xKGtleSk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiBkYXRhOwp9Ci8qKg0KICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyBzdGF0aWMgdHJlZXMuDQogKi8KCgpmdW5jdGlvbiByZW5kZXJTdGF0aWMoaW5kZXgsIGlzSW5Gb3IpIHsKICB2YXIgY2FjaGVkID0gdGhpcy5fc3RhdGljVHJlZXMgfHwgKHRoaXMuX3N0YXRpY1RyZWVzID0gW10pOwogIHZhciB0cmVlID0gY2FjaGVkW2luZGV4XTsgLy8gaWYgaGFzIGFscmVhZHktcmVuZGVyZWQgc3RhdGljIHRyZWUgYW5kIG5vdCBpbnNpZGUgdi1mb3IsCiAgLy8gd2UgY2FuIHJldXNlIHRoZSBzYW1lIHRyZWUuCgogIGlmICh0cmVlICYmICFpc0luRm9yKSB7CiAgICByZXR1cm4gdHJlZTsKICB9IC8vIG90aGVyd2lzZSwgcmVuZGVyIGEgZnJlc2ggdHJlZS4KCgogIHRyZWUgPSBjYWNoZWRbaW5kZXhdID0gdGhpcy4kb3B0aW9ucy5zdGF0aWNSZW5kZXJGbnNbaW5kZXhdLmNhbGwodGhpcy5fcmVuZGVyUHJveHksIHRoaXMuX2MsIHRoaXMgLy8gZm9yIHJlbmRlciBmbnMgZ2VuZXJhdGVkIGZvciBmdW5jdGlvbmFsIGNvbXBvbmVudCB0ZW1wbGF0ZXMKICApOwogIG1hcmtTdGF0aWModHJlZSwgIl9fc3RhdGljX18iLmNvbmNhdChpbmRleCksIGZhbHNlKTsKICByZXR1cm4gdHJlZTsKfQovKioNCiAqIFJ1bnRpbWUgaGVscGVyIGZvciB2LW9uY2UuDQogKiBFZmZlY3RpdmVseSBpdCBtZWFucyBtYXJraW5nIHRoZSBub2RlIGFzIHN0YXRpYyB3aXRoIGEgdW5pcXVlIGtleS4NCiAqLwoKCmZ1bmN0aW9uIG1hcmtPbmNlKHRyZWUsIGluZGV4LCBrZXkpIHsKICBtYXJrU3RhdGljKHRyZWUsICJfX29uY2VfXyIuY29uY2F0KGluZGV4KS5jb25jYXQoa2V5ID8gIl8iLmNvbmNhdChrZXkpIDogIiIpLCB0cnVlKTsKICByZXR1cm4gdHJlZTsKfQoKZnVuY3Rpb24gbWFya1N0YXRpYyh0cmVlLCBrZXksIGlzT25jZSkgewogIGlmIChpc0FycmF5KHRyZWUpKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyZWUubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRyZWVbaV0gJiYgdHlwZW9mIHRyZWVbaV0gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgbWFya1N0YXRpY05vZGUodHJlZVtpXSwgIiIuY29uY2F0KGtleSwgIl8iKS5jb25jYXQoaSksIGlzT25jZSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgbWFya1N0YXRpY05vZGUodHJlZSwga2V5LCBpc09uY2UpOwogIH0KfQoKZnVuY3Rpb24gbWFya1N0YXRpY05vZGUobm9kZSwga2V5LCBpc09uY2UpIHsKICBub2RlLmlzU3RhdGljID0gdHJ1ZTsKICBub2RlLmtleSA9IGtleTsKICBub2RlLmlzT25jZSA9IGlzT25jZTsKfQoKZnVuY3Rpb24gYmluZE9iamVjdExpc3RlbmVycyhkYXRhLCB2YWx1ZSkgewogIGlmICh2YWx1ZSkgewogICAgaWYgKCFpc1BsYWluT2JqZWN0KHZhbHVlKSkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ3Ytb24gd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCB2YWx1ZScsIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG9uID0gZGF0YS5vbiA9IGRhdGEub24gPyBleHRlbmQoe30sIGRhdGEub24pIDoge307CgogICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHsKICAgICAgICB2YXIgZXhpc3RpbmcgPSBvbltrZXldOwogICAgICAgIHZhciBvdXJzID0gdmFsdWVba2V5XTsKICAgICAgICBvbltrZXldID0gZXhpc3RpbmcgPyBbXS5jb25jYXQoZXhpc3RpbmcsIG91cnMpIDogb3VyczsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIGRhdGE7Cn0KCmZ1bmN0aW9uIHJlc29sdmVTY29wZWRTbG90cyhmbnMsIHJlcywgLy8gdGhlIGZvbGxvd2luZyBhcmUgYWRkZWQgaW4gMi42Cmhhc0R5bmFtaWNLZXlzLCBjb250ZW50SGFzaEtleSkgewogIHJlcyA9IHJlcyB8fCB7CiAgICAkc3RhYmxlOiAhaGFzRHluYW1pY0tleXMKICB9OwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGZucy5sZW5ndGg7IGkrKykgewogICAgdmFyIHNsb3QgPSBmbnNbaV07CgogICAgaWYgKGlzQXJyYXkoc2xvdCkpIHsKICAgICAgcmVzb2x2ZVNjb3BlZFNsb3RzKHNsb3QsIHJlcywgaGFzRHluYW1pY0tleXMpOwogICAgfSBlbHNlIGlmIChzbG90KSB7CiAgICAgIC8vIG1hcmtlciBmb3IgcmV2ZXJzZSBwcm94eWluZyB2LXNsb3Qgd2l0aG91dCBzY29wZSBvbiB0aGlzLiRzbG90cwogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yCiAgICAgIGlmIChzbG90LnByb3h5KSB7CiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvcgogICAgICAgIHNsb3QuZm4ucHJveHkgPSB0cnVlOwogICAgICB9CgogICAgICByZXNbc2xvdC5rZXldID0gc2xvdC5mbjsKICAgIH0KICB9CgogIGlmIChjb250ZW50SGFzaEtleSkgewogICAgcmVzLiRrZXkgPSBjb250ZW50SGFzaEtleTsKICB9CgogIHJldHVybiByZXM7Cn0gLy8gaGVscGVyIHRvIHByb2Nlc3MgZHluYW1pYyBrZXlzIGZvciBkeW5hbWljIGFyZ3VtZW50cyBpbiB2LWJpbmQgYW5kIHYtb24uCgoKZnVuY3Rpb24gYmluZER5bmFtaWNLZXlzKGJhc2VPYmosIHZhbHVlcykgewogIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSArPSAyKSB7CiAgICB2YXIga2V5ID0gdmFsdWVzW2ldOwoKICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiBrZXkpIHsKICAgICAgYmFzZU9ialt2YWx1ZXNbaV1dID0gdmFsdWVzW2kgKyAxXTsKICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBrZXkgIT09ICcnICYmIGtleSAhPT0gbnVsbCkgewogICAgICAvLyBudWxsIGlzIGEgc3BlY2lhbCB2YWx1ZSBmb3IgZXhwbGljaXRseSByZW1vdmluZyBhIGJpbmRpbmcKICAgICAgd2FybigiSW52YWxpZCB2YWx1ZSBmb3IgZHluYW1pYyBkaXJlY3RpdmUgYXJndW1lbnQgKGV4cGVjdGVkIHN0cmluZyBvciBudWxsKTogIi5jb25jYXQoa2V5KSwgdGhpcyk7CiAgICB9CiAgfQoKICByZXR1cm4gYmFzZU9iajsKfSAvLyBoZWxwZXIgdG8gZHluYW1pY2FsbHkgYXBwZW5kIG1vZGlmaWVyIHJ1bnRpbWUgbWFya2VycyB0byBldmVudCBuYW1lcy4KLy8gZW5zdXJlIG9ubHkgYXBwZW5kIHdoZW4gdmFsdWUgaXMgYWxyZWFkeSBzdHJpbmcsIG90aGVyd2lzZSBpdCB3aWxsIGJlIGNhc3QKLy8gdG8gc3RyaW5nIGFuZCBjYXVzZSB0aGUgdHlwZSBjaGVjayB0byBtaXNzLgoKCmZ1bmN0aW9uIHByZXBlbmRNb2RpZmllcih2YWx1ZSwgc3ltYm9sKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBzeW1ib2wgKyB2YWx1ZSA6IHZhbHVlOwp9CgpmdW5jdGlvbiBpbnN0YWxsUmVuZGVySGVscGVycyh0YXJnZXQpIHsKICB0YXJnZXQuX28gPSBtYXJrT25jZTsKICB0YXJnZXQuX24gPSB0b051bWJlcjsKICB0YXJnZXQuX3MgPSB0b1N0cmluZzsKICB0YXJnZXQuX2wgPSByZW5kZXJMaXN0OwogIHRhcmdldC5fdCA9IHJlbmRlclNsb3Q7CiAgdGFyZ2V0Ll9xID0gbG9vc2VFcXVhbDsKICB0YXJnZXQuX2kgPSBsb29zZUluZGV4T2Y7CiAgdGFyZ2V0Ll9tID0gcmVuZGVyU3RhdGljOwogIHRhcmdldC5fZiA9IHJlc29sdmVGaWx0ZXI7CiAgdGFyZ2V0Ll9rID0gY2hlY2tLZXlDb2RlczsKICB0YXJnZXQuX2IgPSBiaW5kT2JqZWN0UHJvcHM7CiAgdGFyZ2V0Ll92ID0gY3JlYXRlVGV4dFZOb2RlOwogIHRhcmdldC5fZSA9IGNyZWF0ZUVtcHR5Vk5vZGU7CiAgdGFyZ2V0Ll91ID0gcmVzb2x2ZVNjb3BlZFNsb3RzOwogIHRhcmdldC5fZyA9IGJpbmRPYmplY3RMaXN0ZW5lcnM7CiAgdGFyZ2V0Ll9kID0gYmluZER5bmFtaWNLZXlzOwogIHRhcmdldC5fcCA9IHByZXBlbmRNb2RpZmllcjsKfQovKioNCiAqIFJ1bnRpbWUgaGVscGVyIGZvciByZXNvbHZpbmcgcmF3IGNoaWxkcmVuIFZOb2RlcyBpbnRvIGEgc2xvdCBvYmplY3QuDQogKi8KCgpmdW5jdGlvbiByZXNvbHZlU2xvdHMoY2hpbGRyZW4sIGNvbnRleHQpIHsKICBpZiAoIWNoaWxkcmVuIHx8ICFjaGlsZHJlbi5sZW5ndGgpIHsKICAgIHJldHVybiB7fTsKICB9CgogIHZhciBzbG90cyA9IHt9OwoKICBmb3IgKHZhciBpID0gMCwgbCA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdmFyIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICB2YXIgZGF0YSA9IGNoaWxkLmRhdGE7IC8vIHJlbW92ZSBzbG90IGF0dHJpYnV0ZSBpZiB0aGUgbm9kZSBpcyByZXNvbHZlZCBhcyBhIFZ1ZSBzbG90IG5vZGUKCiAgICBpZiAoZGF0YSAmJiBkYXRhLmF0dHJzICYmIGRhdGEuYXR0cnMuc2xvdCkgewogICAgICBkZWxldGUgZGF0YS5hdHRycy5zbG90OwogICAgfSAvLyBuYW1lZCBzbG90cyBzaG91bGQgb25seSBiZSByZXNwZWN0ZWQgaWYgdGhlIHZub2RlIHdhcyByZW5kZXJlZCBpbiB0aGUKICAgIC8vIHNhbWUgY29udGV4dC4KCgogICAgaWYgKChjaGlsZC5jb250ZXh0ID09PSBjb250ZXh0IHx8IGNoaWxkLmZuQ29udGV4dCA9PT0gY29udGV4dCkgJiYgZGF0YSAmJiBkYXRhLnNsb3QgIT0gbnVsbCkgewogICAgICB2YXIgbmFtZV8xID0gZGF0YS5zbG90OwogICAgICB2YXIgc2xvdCA9IHNsb3RzW25hbWVfMV0gfHwgKHNsb3RzW25hbWVfMV0gPSBbXSk7CgogICAgICBpZiAoY2hpbGQudGFnID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgc2xvdC5wdXNoLmFwcGx5KHNsb3QsIGNoaWxkLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzbG90LnB1c2goY2hpbGQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAoc2xvdHMuZGVmYXVsdCB8fCAoc2xvdHMuZGVmYXVsdCA9IFtdKSkucHVzaChjaGlsZCk7CiAgICB9CiAgfSAvLyBpZ25vcmUgc2xvdHMgdGhhdCBjb250YWlucyBvbmx5IHdoaXRlc3BhY2UKCgogIGZvciAodmFyIG5hbWVfMiBpbiBzbG90cykgewogICAgaWYgKHNsb3RzW25hbWVfMl0uZXZlcnkoaXNXaGl0ZXNwYWNlKSkgewogICAgICBkZWxldGUgc2xvdHNbbmFtZV8yXTsKICAgIH0KICB9CgogIHJldHVybiBzbG90czsKfQoKZnVuY3Rpb24gaXNXaGl0ZXNwYWNlKG5vZGUpIHsKICByZXR1cm4gbm9kZS5pc0NvbW1lbnQgJiYgIW5vZGUuYXN5bmNGYWN0b3J5IHx8IG5vZGUudGV4dCA9PT0gJyAnOwp9CgpmdW5jdGlvbiBpc0FzeW5jUGxhY2Vob2xkZXIobm9kZSkgewogIC8vIEB0cy1leHBlY3QtZXJyb3Igbm90IHJlYWxseSBib29sZWFuIHR5cGUKICByZXR1cm4gbm9kZS5pc0NvbW1lbnQgJiYgbm9kZS5hc3luY0ZhY3Rvcnk7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKG93bmVyVm0sIHNjb3BlZFNsb3RzLCBub3JtYWxTbG90cywgcHJldlNjb3BlZFNsb3RzKSB7CiAgdmFyIHJlczsKICB2YXIgaGFzTm9ybWFsU2xvdHMgPSBPYmplY3Qua2V5cyhub3JtYWxTbG90cykubGVuZ3RoID4gMDsKICB2YXIgaXNTdGFibGUgPSBzY29wZWRTbG90cyA/ICEhc2NvcGVkU2xvdHMuJHN0YWJsZSA6ICFoYXNOb3JtYWxTbG90czsKICB2YXIga2V5ID0gc2NvcGVkU2xvdHMgJiYgc2NvcGVkU2xvdHMuJGtleTsKCiAgaWYgKCFzY29wZWRTbG90cykgewogICAgcmVzID0ge307CiAgfSBlbHNlIGlmIChzY29wZWRTbG90cy5fbm9ybWFsaXplZCkgewogICAgLy8gZmFzdCBwYXRoIDE6IGNoaWxkIGNvbXBvbmVudCByZS1yZW5kZXIgb25seSwgcGFyZW50IGRpZCBub3QgY2hhbmdlCiAgICByZXR1cm4gc2NvcGVkU2xvdHMuX25vcm1hbGl6ZWQ7CiAgfSBlbHNlIGlmIChpc1N0YWJsZSAmJiBwcmV2U2NvcGVkU2xvdHMgJiYgcHJldlNjb3BlZFNsb3RzICE9PSBlbXB0eU9iamVjdCAmJiBrZXkgPT09IHByZXZTY29wZWRTbG90cy4ka2V5ICYmICFoYXNOb3JtYWxTbG90cyAmJiAhcHJldlNjb3BlZFNsb3RzLiRoYXNOb3JtYWwpIHsKICAgIC8vIGZhc3QgcGF0aCAyOiBzdGFibGUgc2NvcGVkIHNsb3RzIHcvIG5vIG5vcm1hbCBzbG90cyB0byBwcm94eSwKICAgIC8vIG9ubHkgbmVlZCB0byBub3JtYWxpemUgb25jZQogICAgcmV0dXJuIHByZXZTY29wZWRTbG90czsKICB9IGVsc2UgewogICAgcmVzID0ge307CgogICAgZm9yICh2YXIga2V5XzEgaW4gc2NvcGVkU2xvdHMpIHsKICAgICAgaWYgKHNjb3BlZFNsb3RzW2tleV8xXSAmJiBrZXlfMVswXSAhPT0gJyQnKSB7CiAgICAgICAgcmVzW2tleV8xXSA9IG5vcm1hbGl6ZVNjb3BlZFNsb3Qob3duZXJWbSwgbm9ybWFsU2xvdHMsIGtleV8xLCBzY29wZWRTbG90c1trZXlfMV0pOwogICAgICB9CiAgICB9CiAgfSAvLyBleHBvc2Ugbm9ybWFsIHNsb3RzIG9uIHNjb3BlZFNsb3RzCgoKICBmb3IgKHZhciBrZXlfMiBpbiBub3JtYWxTbG90cykgewogICAgaWYgKCEoa2V5XzIgaW4gcmVzKSkgewogICAgICByZXNba2V5XzJdID0gcHJveHlOb3JtYWxTbG90KG5vcm1hbFNsb3RzLCBrZXlfMik7CiAgICB9CiAgfSAvLyBhdm9yaWF6IHNlZW1zIHRvIG1vY2sgYSBub24tZXh0ZW5zaWJsZSAkc2NvcGVkU2xvdHMgb2JqZWN0CiAgLy8gYW5kIHdoZW4gdGhhdCBpcyBwYXNzZWQgZG93biB0aGlzIHdvdWxkIGNhdXNlIGFuIGVycm9yCgoKICBpZiAoc2NvcGVkU2xvdHMgJiYgT2JqZWN0LmlzRXh0ZW5zaWJsZShzY29wZWRTbG90cykpIHsKICAgIHNjb3BlZFNsb3RzLl9ub3JtYWxpemVkID0gcmVzOwogIH0KCiAgZGVmKHJlcywgJyRzdGFibGUnLCBpc1N0YWJsZSk7CiAgZGVmKHJlcywgJyRrZXknLCBrZXkpOwogIGRlZihyZXMsICckaGFzTm9ybWFsJywgaGFzTm9ybWFsU2xvdHMpOwogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVNjb3BlZFNsb3Qodm0sIG5vcm1hbFNsb3RzLCBrZXksIGZuKSB7CiAgdmFyIG5vcm1hbGl6ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY3VyID0gY3VycmVudEluc3RhbmNlOwogICAgc2V0Q3VycmVudEluc3RhbmNlKHZtKTsKICAgIHZhciByZXMgPSBhcmd1bWVudHMubGVuZ3RoID8gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKSA6IGZuKHt9KTsKICAgIHJlcyA9IHJlcyAmJiB0eXBlb2YgcmVzID09PSAnb2JqZWN0JyAmJiAhaXNBcnJheShyZXMpID8gW3Jlc10gLy8gc2luZ2xlIHZub2RlCiAgICA6IG5vcm1hbGl6ZUNoaWxkcmVuKHJlcyk7CiAgICB2YXIgdm5vZGUgPSByZXMgJiYgcmVzWzBdOwogICAgc2V0Q3VycmVudEluc3RhbmNlKGN1cik7CiAgICByZXR1cm4gcmVzICYmICghdm5vZGUgfHwgcmVzLmxlbmd0aCA9PT0gMSAmJiB2bm9kZS5pc0NvbW1lbnQgJiYgIWlzQXN5bmNQbGFjZWhvbGRlcih2bm9kZSkpIC8vICM5NjU4LCAjMTAzOTEKICAgID8gdW5kZWZpbmVkIDogcmVzOwogIH07IC8vIHRoaXMgaXMgYSBzbG90IHVzaW5nIHRoZSBuZXcgdi1zbG90IHN5bnRheCB3aXRob3V0IHNjb3BlLiBhbHRob3VnaCBpdCBpcwogIC8vIGNvbXBpbGVkIGFzIGEgc2NvcGVkIHNsb3QsIHJlbmRlciBmbiB1c2VycyB3b3VsZCBleHBlY3QgaXQgdG8gYmUgcHJlc2VudAogIC8vIG9uIHRoaXMuJHNsb3RzIGJlY2F1c2UgdGhlIHVzYWdlIGlzIHNlbWFudGljYWxseSBhIG5vcm1hbCBzbG90LgoKCiAgaWYgKGZuLnByb3h5KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9ybWFsU2xvdHMsIGtleSwgewogICAgICBnZXQ6IG5vcm1hbGl6ZWQsCiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgfSk7CiAgfQoKICByZXR1cm4gbm9ybWFsaXplZDsKfQoKZnVuY3Rpb24gcHJveHlOb3JtYWxTbG90KHNsb3RzLCBrZXkpIHsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHNsb3RzW2tleV07CiAgfTsKfQoKZnVuY3Rpb24gaW5pdFNldHVwKHZtKSB7CiAgdmFyIG9wdGlvbnMgPSB2bS4kb3B0aW9uczsKICB2YXIgc2V0dXAgPSBvcHRpb25zLnNldHVwOwoKICBpZiAoc2V0dXApIHsKICAgIHZhciBjdHggPSB2bS5fc2V0dXBDb250ZXh0ID0gY3JlYXRlU2V0dXBDb250ZXh0KHZtKTsKICAgIHNldEN1cnJlbnRJbnN0YW5jZSh2bSk7CiAgICBwdXNoVGFyZ2V0KCk7CiAgICB2YXIgc2V0dXBSZXN1bHQgPSBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhzZXR1cCwgbnVsbCwgW3ZtLl9wcm9wcyB8fCBzaGFsbG93UmVhY3RpdmUoe30pLCBjdHhdLCB2bSwgInNldHVwIik7CiAgICBwb3BUYXJnZXQoKTsKICAgIHNldEN1cnJlbnRJbnN0YW5jZSgpOwoKICAgIGlmIChpc0Z1bmN0aW9uKHNldHVwUmVzdWx0KSkgewogICAgICAvLyByZW5kZXIgZnVuY3Rpb24KICAgICAgLy8gQHRzLWlnbm9yZQogICAgICBvcHRpb25zLnJlbmRlciA9IHNldHVwUmVzdWx0OwogICAgfSBlbHNlIGlmIChpc09iamVjdChzZXR1cFJlc3VsdCkpIHsKICAgICAgLy8gYmluZGluZ3MKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgc2V0dXBSZXN1bHQgaW5zdGFuY2VvZiBWTm9kZSkgewogICAgICAgIHdhcm4oInNldHVwKCkgc2hvdWxkIG5vdCByZXR1cm4gVk5vZGVzIGRpcmVjdGx5IC0gIiArICJyZXR1cm4gYSByZW5kZXIgZnVuY3Rpb24gaW5zdGVhZC4iKTsKICAgICAgfQoKICAgICAgdm0uX3NldHVwU3RhdGUgPSBzZXR1cFJlc3VsdDsgLy8gX19zZmMgaW5kaWNhdGVzIGNvbXBpbGVkIGJpbmRpbmdzIGZyb20gPHNjcmlwdCBzZXR1cD4KCiAgICAgIGlmICghc2V0dXBSZXN1bHQuX19zZmMpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gc2V0dXBSZXN1bHQpIHsKICAgICAgICAgIGlmICghaXNSZXNlcnZlZChrZXkpKSB7CiAgICAgICAgICAgIHByb3h5V2l0aFJlZlVud3JhcCh2bSwgc2V0dXBSZXN1bHQsIGtleSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgICAgd2FybigiQXZvaWQgdXNpbmcgdmFyaWFibGVzIHRoYXQgc3RhcnQgd2l0aCBfIG9yICQgaW4gc2V0dXAoKS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZXhwb3NlZCBmb3IgY29tcGlsZWQgcmVuZGVyIGZuCiAgICAgICAgdmFyIHByb3h5ID0gdm0uX3NldHVwUHJveHkgPSB7fTsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHNldHVwUmVzdWx0KSB7CiAgICAgICAgICBpZiAoa2V5ICE9PSAnX19zZmMnKSB7CiAgICAgICAgICAgIHByb3h5V2l0aFJlZlVud3JhcChwcm94eSwgc2V0dXBSZXN1bHQsIGtleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgc2V0dXBSZXN1bHQgIT09IHVuZGVmaW5lZCkgewogICAgICB3YXJuKCJzZXR1cCgpIHNob3VsZCByZXR1cm4gYW4gb2JqZWN0LiBSZWNlaXZlZDogIi5jb25jYXQoc2V0dXBSZXN1bHQgPT09IG51bGwgPyAnbnVsbCcgOiB0eXBlb2Ygc2V0dXBSZXN1bHQpKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNyZWF0ZVNldHVwQ29udGV4dCh2bSkgewogIHZhciBleHBvc2VDYWxsZWQgPSBmYWxzZTsKICByZXR1cm4gewogICAgZ2V0IGF0dHJzKCkgewogICAgICBpZiAoIXZtLl9hdHRyc1Byb3h5KSB7CiAgICAgICAgdmFyIHByb3h5ID0gdm0uX2F0dHJzUHJveHkgPSB7fTsKICAgICAgICBkZWYocHJveHksICdfdl9hdHRyX3Byb3h5JywgdHJ1ZSk7CiAgICAgICAgc3luY1NldHVwUHJveHkocHJveHksIHZtLiRhdHRycywgZW1wdHlPYmplY3QsIHZtLCAnJGF0dHJzJyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB2bS5fYXR0cnNQcm94eTsKICAgIH0sCgogICAgZ2V0IGxpc3RlbmVycygpIHsKICAgICAgaWYgKCF2bS5fbGlzdGVuZXJzUHJveHkpIHsKICAgICAgICB2YXIgcHJveHkgPSB2bS5fbGlzdGVuZXJzUHJveHkgPSB7fTsKICAgICAgICBzeW5jU2V0dXBQcm94eShwcm94eSwgdm0uJGxpc3RlbmVycywgZW1wdHlPYmplY3QsIHZtLCAnJGxpc3RlbmVycycpOwogICAgICB9CgogICAgICByZXR1cm4gdm0uX2xpc3RlbmVyc1Byb3h5OwogICAgfSwKCiAgICBnZXQgc2xvdHMoKSB7CiAgICAgIHJldHVybiBpbml0U2xvdHNQcm94eSh2bSk7CiAgICB9LAoKICAgIGVtaXQ6IGJpbmQodm0uJGVtaXQsIHZtKSwKICAgIGV4cG9zZTogZnVuY3Rpb24gKGV4cG9zZWQpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBpZiAoZXhwb3NlQ2FsbGVkKSB7CiAgICAgICAgICB3YXJuKCJleHBvc2UoKSBzaG91bGQgYmUgY2FsbGVkIG9ubHkgb25jZSBwZXIgc2V0dXAoKS4iLCB2bSk7CiAgICAgICAgfQoKICAgICAgICBleHBvc2VDYWxsZWQgPSB0cnVlOwogICAgICB9CgogICAgICBpZiAoZXhwb3NlZCkgewogICAgICAgIE9iamVjdC5rZXlzKGV4cG9zZWQpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgcmV0dXJuIHByb3h5V2l0aFJlZlVud3JhcCh2bSwgZXhwb3NlZCwga2V5KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07Cn0KCmZ1bmN0aW9uIHN5bmNTZXR1cFByb3h5KHRvLCBmcm9tLCBwcmV2LCBpbnN0YW5jZSwgdHlwZSkgewogIHZhciBjaGFuZ2VkID0gZmFsc2U7CgogIGZvciAodmFyIGtleSBpbiBmcm9tKSB7CiAgICBpZiAoIShrZXkgaW4gdG8pKSB7CiAgICAgIGNoYW5nZWQgPSB0cnVlOwogICAgICBkZWZpbmVQcm94eUF0dHIodG8sIGtleSwgaW5zdGFuY2UsIHR5cGUpOwogICAgfSBlbHNlIGlmIChmcm9tW2tleV0gIT09IHByZXZba2V5XSkgewogICAgICBjaGFuZ2VkID0gdHJ1ZTsKICAgIH0KICB9CgogIGZvciAodmFyIGtleSBpbiB0bykgewogICAgaWYgKCEoa2V5IGluIGZyb20pKSB7CiAgICAgIGNoYW5nZWQgPSB0cnVlOwogICAgICBkZWxldGUgdG9ba2V5XTsKICAgIH0KICB9CgogIHJldHVybiBjaGFuZ2VkOwp9CgpmdW5jdGlvbiBkZWZpbmVQcm94eUF0dHIocHJveHksIGtleSwgaW5zdGFuY2UsIHR5cGUpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJveHksIGtleSwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gaW5zdGFuY2VbdHlwZV1ba2V5XTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gaW5pdFNsb3RzUHJveHkodm0pIHsKICBpZiAoIXZtLl9zbG90c1Byb3h5KSB7CiAgICBzeW5jU2V0dXBTbG90cyh2bS5fc2xvdHNQcm94eSA9IHt9LCB2bS4kc2NvcGVkU2xvdHMpOwogIH0KCiAgcmV0dXJuIHZtLl9zbG90c1Byb3h5Owp9CgpmdW5jdGlvbiBzeW5jU2V0dXBTbG90cyh0bywgZnJvbSkgewogIGZvciAodmFyIGtleSBpbiBmcm9tKSB7CiAgICB0b1trZXldID0gZnJvbVtrZXldOwogIH0KCiAgZm9yICh2YXIga2V5IGluIHRvKSB7CiAgICBpZiAoIShrZXkgaW4gZnJvbSkpIHsKICAgICAgZGVsZXRlIHRvW2tleV07CiAgICB9CiAgfQp9Ci8qKg0KICogQGludGVybmFsIHVzZSBtYW51YWwgdHlwZSBkZWYgYmVjYXVzZSBwdWJsaWMgc2V0dXAgY29udGV4dCB0eXBlIHJlbGllcyBvbg0KICogbGVnYWN5IFZOb2RlIHR5cGVzDQogKi8KCgpmdW5jdGlvbiB1c2VTbG90cygpIHsKICByZXR1cm4gZ2V0Q29udGV4dCgpLnNsb3RzOwp9Ci8qKg0KICogQGludGVybmFsIHVzZSBtYW51YWwgdHlwZSBkZWYgYmVjYXVzZSBwdWJsaWMgc2V0dXAgY29udGV4dCB0eXBlIHJlbGllcyBvbg0KICogbGVnYWN5IFZOb2RlIHR5cGVzDQogKi8KCgpmdW5jdGlvbiB1c2VBdHRycygpIHsKICByZXR1cm4gZ2V0Q29udGV4dCgpLmF0dHJzOwp9Ci8qKg0KICogVnVlIDIgb25seQ0KICogQGludGVybmFsIHVzZSBtYW51YWwgdHlwZSBkZWYgYmVjYXVzZSBwdWJsaWMgc2V0dXAgY29udGV4dCB0eXBlIHJlbGllcyBvbg0KICogbGVnYWN5IFZOb2RlIHR5cGVzDQogKi8KCgpmdW5jdGlvbiB1c2VMaXN0ZW5lcnMoKSB7CiAgcmV0dXJuIGdldENvbnRleHQoKS5saXN0ZW5lcnM7Cn0KCmZ1bmN0aW9uIGdldENvbnRleHQoKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIWN1cnJlbnRJbnN0YW5jZSkgewogICAgd2FybigidXNlQ29udGV4dCgpIGNhbGxlZCB3aXRob3V0IGFjdGl2ZSBpbnN0YW5jZS4iKTsKICB9CgogIHZhciB2bSA9IGN1cnJlbnRJbnN0YW5jZTsKICByZXR1cm4gdm0uX3NldHVwQ29udGV4dCB8fCAodm0uX3NldHVwQ29udGV4dCA9IGNyZWF0ZVNldHVwQ29udGV4dCh2bSkpOwp9Ci8qKg0KICogUnVudGltZSBoZWxwZXIgZm9yIG1lcmdpbmcgZGVmYXVsdCBkZWNsYXJhdGlvbnMuIEltcG9ydGVkIGJ5IGNvbXBpbGVkIGNvZGUNCiAqIG9ubHkuDQogKiBAaW50ZXJuYWwNCiAqLwoKCmZ1bmN0aW9uIG1lcmdlRGVmYXVsdHMocmF3LCBkZWZhdWx0cykgewogIHZhciBwcm9wcyA9IGlzQXJyYXkocmF3KSA/IHJhdy5yZWR1Y2UoZnVuY3Rpb24gKG5vcm1hbGl6ZWQsIHApIHsKICAgIHJldHVybiBub3JtYWxpemVkW3BdID0ge30sIG5vcm1hbGl6ZWQ7CiAgfSwge30pIDogcmF3OwoKICBmb3IgKHZhciBrZXkgaW4gZGVmYXVsdHMpIHsKICAgIHZhciBvcHQgPSBwcm9wc1trZXldOwoKICAgIGlmIChvcHQpIHsKICAgICAgaWYgKGlzQXJyYXkob3B0KSB8fCBpc0Z1bmN0aW9uKG9wdCkpIHsKICAgICAgICBwcm9wc1trZXldID0gewogICAgICAgICAgdHlwZTogb3B0LAogICAgICAgICAgZGVmYXVsdDogZGVmYXVsdHNba2V5XQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3B0LmRlZmF1bHQgPSBkZWZhdWx0c1trZXldOwogICAgICB9CiAgICB9IGVsc2UgaWYgKG9wdCA9PT0gbnVsbCkgewogICAgICBwcm9wc1trZXldID0gewogICAgICAgIGRlZmF1bHQ6IGRlZmF1bHRzW2tleV0KICAgICAgfTsKICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB3YXJuKCJwcm9wcyBkZWZhdWx0IGtleSBcIiIuY29uY2F0KGtleSwgIlwiIGhhcyBubyBjb3JyZXNwb25kaW5nIGRlY2xhcmF0aW9uLiIpKTsKICAgIH0KICB9CgogIHJldHVybiBwcm9wczsKfQoKZnVuY3Rpb24gaW5pdFJlbmRlcih2bSkgewogIHZtLl92bm9kZSA9IG51bGw7IC8vIHRoZSByb290IG9mIHRoZSBjaGlsZCB0cmVlCgogIHZtLl9zdGF0aWNUcmVlcyA9IG51bGw7IC8vIHYtb25jZSBjYWNoZWQgdHJlZXMKCiAgdmFyIG9wdGlvbnMgPSB2bS4kb3B0aW9uczsKICB2YXIgcGFyZW50Vm5vZGUgPSB2bS4kdm5vZGUgPSBvcHRpb25zLl9wYXJlbnRWbm9kZTsgLy8gdGhlIHBsYWNlaG9sZGVyIG5vZGUgaW4gcGFyZW50IHRyZWUKCiAgdmFyIHJlbmRlckNvbnRleHQgPSBwYXJlbnRWbm9kZSAmJiBwYXJlbnRWbm9kZS5jb250ZXh0OwogIHZtLiRzbG90cyA9IHJlc29sdmVTbG90cyhvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiwgcmVuZGVyQ29udGV4dCk7CiAgdm0uJHNjb3BlZFNsb3RzID0gcGFyZW50Vm5vZGUgPyBub3JtYWxpemVTY29wZWRTbG90cyh2bS4kcGFyZW50LCBwYXJlbnRWbm9kZS5kYXRhLnNjb3BlZFNsb3RzLCB2bS4kc2xvdHMpIDogZW1wdHlPYmplY3Q7IC8vIGJpbmQgdGhlIGNyZWF0ZUVsZW1lbnQgZm4gdG8gdGhpcyBpbnN0YW5jZQogIC8vIHNvIHRoYXQgd2UgZ2V0IHByb3BlciByZW5kZXIgY29udGV4dCBpbnNpZGUgaXQuCiAgLy8gYXJncyBvcmRlcjogdGFnLCBkYXRhLCBjaGlsZHJlbiwgbm9ybWFsaXphdGlvblR5cGUsIGFsd2F5c05vcm1hbGl6ZQogIC8vIGludGVybmFsIHZlcnNpb24gaXMgdXNlZCBieSByZW5kZXIgZnVuY3Rpb25zIGNvbXBpbGVkIGZyb20gdGVtcGxhdGVzCiAgLy8gQHRzLWV4cGVjdC1lcnJvcgoKICB2bS5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICByZXR1cm4gY3JlYXRlRWxlbWVudCQxKHZtLCBhLCBiLCBjLCBkLCBmYWxzZSk7CiAgfTsgLy8gbm9ybWFsaXphdGlvbiBpcyBhbHdheXMgYXBwbGllZCBmb3IgdGhlIHB1YmxpYyB2ZXJzaW9uLCB1c2VkIGluCiAgLy8gdXNlci13cml0dGVuIHJlbmRlciBmdW5jdGlvbnMuCiAgLy8gQHRzLWV4cGVjdC1lcnJvcgoKCiAgdm0uJGNyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQkMSh2bSwgYSwgYiwgYywgZCwgdHJ1ZSk7CiAgfTsgLy8gJGF0dHJzICYgJGxpc3RlbmVycyBhcmUgZXhwb3NlZCBmb3IgZWFzaWVyIEhPQyBjcmVhdGlvbi4KICAvLyB0aGV5IG5lZWQgdG8gYmUgcmVhY3RpdmUgc28gdGhhdCBIT0NzIHVzaW5nIHRoZW0gYXJlIGFsd2F5cyB1cGRhdGVkCgoKICB2YXIgcGFyZW50RGF0YSA9IHBhcmVudFZub2RlICYmIHBhcmVudFZub2RlLmRhdGE7CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGRlZmluZVJlYWN0aXZlKHZtLCAnJGF0dHJzJywgcGFyZW50RGF0YSAmJiBwYXJlbnREYXRhLmF0dHJzIHx8IGVtcHR5T2JqZWN0LCBmdW5jdGlvbiAoKSB7CiAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGF0dHJzIGlzIHJlYWRvbmx5LiIsIHZtKTsKICAgIH0sIHRydWUpOwogICAgZGVmaW5lUmVhY3RpdmUodm0sICckbGlzdGVuZXJzJywgb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0LCBmdW5jdGlvbiAoKSB7CiAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGxpc3RlbmVycyBpcyByZWFkb25seS4iLCB2bSk7CiAgICB9LCB0cnVlKTsKICB9IGVsc2UgewogICAgZGVmaW5lUmVhY3RpdmUodm0sICckYXR0cnMnLCBwYXJlbnREYXRhICYmIHBhcmVudERhdGEuYXR0cnMgfHwgZW1wdHlPYmplY3QsIG51bGwsIHRydWUpOwogICAgZGVmaW5lUmVhY3RpdmUodm0sICckbGlzdGVuZXJzJywgb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0LCBudWxsLCB0cnVlKTsKICB9Cn0KCnZhciBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgPSBudWxsOwoKZnVuY3Rpb24gcmVuZGVyTWl4aW4oVnVlKSB7CiAgLy8gaW5zdGFsbCBydW50aW1lIGNvbnZlbmllbmNlIGhlbHBlcnMKICBpbnN0YWxsUmVuZGVySGVscGVycyhWdWUucHJvdG90eXBlKTsKCiAgVnVlLnByb3RvdHlwZS4kbmV4dFRpY2sgPSBmdW5jdGlvbiAoZm4pIHsKICAgIHJldHVybiBuZXh0VGljayhmbiwgdGhpcyk7CiAgfTsKCiAgVnVlLnByb3RvdHlwZS5fcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZtID0gdGhpczsKICAgIHZhciBfYSA9IHZtLiRvcHRpb25zLAogICAgICAgIHJlbmRlciA9IF9hLnJlbmRlciwKICAgICAgICBfcGFyZW50Vm5vZGUgPSBfYS5fcGFyZW50Vm5vZGU7CgogICAgaWYgKF9wYXJlbnRWbm9kZSAmJiB2bS5faXNNb3VudGVkKSB7CiAgICAgIHZtLiRzY29wZWRTbG90cyA9IG5vcm1hbGl6ZVNjb3BlZFNsb3RzKHZtLiRwYXJlbnQsIF9wYXJlbnRWbm9kZS5kYXRhLnNjb3BlZFNsb3RzLCB2bS4kc2xvdHMsIHZtLiRzY29wZWRTbG90cyk7CgogICAgICBpZiAodm0uX3Nsb3RzUHJveHkpIHsKICAgICAgICBzeW5jU2V0dXBTbG90cyh2bS5fc2xvdHNQcm94eSwgdm0uJHNjb3BlZFNsb3RzKTsKICAgICAgfQogICAgfSAvLyBzZXQgcGFyZW50IHZub2RlLiB0aGlzIGFsbG93cyByZW5kZXIgZnVuY3Rpb25zIHRvIGhhdmUgYWNjZXNzCiAgICAvLyB0byB0aGUgZGF0YSBvbiB0aGUgcGxhY2Vob2xkZXIgbm9kZS4KCgogICAgdm0uJHZub2RlID0gX3BhcmVudFZub2RlOyAvLyByZW5kZXIgc2VsZgoKICAgIHZhciB2bm9kZTsKCiAgICB0cnkgewogICAgICAvLyBUaGVyZSdzIG5vIG5lZWQgdG8gbWFpbnRhaW4gYSBzdGFjayBiZWNhdXNlIGFsbCByZW5kZXIgZm5zIGFyZSBjYWxsZWQKICAgICAgLy8gc2VwYXJhdGVseSBmcm9tIG9uZSBhbm90aGVyLiBOZXN0ZWQgY29tcG9uZW50J3MgcmVuZGVyIGZucyBhcmUgY2FsbGVkCiAgICAgIC8vIHdoZW4gcGFyZW50IGNvbXBvbmVudCBpcyBwYXRjaGVkLgogICAgICBzZXRDdXJyZW50SW5zdGFuY2Uodm0pOwogICAgICBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgPSB2bTsKICAgICAgdm5vZGUgPSByZW5kZXIuY2FsbCh2bS5fcmVuZGVyUHJveHksIHZtLiRjcmVhdGVFbGVtZW50KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICJyZW5kZXIiKTsgLy8gcmV0dXJuIGVycm9yIHJlbmRlciByZXN1bHQsCiAgICAgIC8vIG9yIHByZXZpb3VzIHZub2RlIHRvIHByZXZlbnQgcmVuZGVyIGVycm9yIGNhdXNpbmcgYmxhbmsgY29tcG9uZW50CgogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgdm0uJG9wdGlvbnMucmVuZGVyRXJyb3IpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdm5vZGUgPSB2bS4kb3B0aW9ucy5yZW5kZXJFcnJvci5jYWxsKHZtLl9yZW5kZXJQcm94eSwgdm0uJGNyZWF0ZUVsZW1lbnQsIGUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGhhbmRsZUVycm9yKGUsIHZtLCAicmVuZGVyRXJyb3IiKTsKICAgICAgICAgIHZub2RlID0gdm0uX3Zub2RlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2bm9kZSA9IHZtLl92bm9kZTsKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlID0gbnVsbDsKICAgICAgc2V0Q3VycmVudEluc3RhbmNlKCk7CiAgICB9IC8vIGlmIHRoZSByZXR1cm5lZCBhcnJheSBjb250YWlucyBvbmx5IGEgc2luZ2xlIG5vZGUsIGFsbG93IGl0CgoKICAgIGlmIChpc0FycmF5KHZub2RlKSAmJiB2bm9kZS5sZW5ndGggPT09IDEpIHsKICAgICAgdm5vZGUgPSB2bm9kZVswXTsKICAgIH0gLy8gcmV0dXJuIGVtcHR5IHZub2RlIGluIGNhc2UgdGhlIHJlbmRlciBmdW5jdGlvbiBlcnJvcmVkIG91dAoKCiAgICBpZiAoISh2bm9kZSBpbnN0YW5jZW9mIFZOb2RlKSkgewogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBpc0FycmF5KHZub2RlKSkgewogICAgICAgIHdhcm4oJ011bHRpcGxlIHJvb3Qgbm9kZXMgcmV0dXJuZWQgZnJvbSByZW5kZXIgZnVuY3Rpb24uIFJlbmRlciBmdW5jdGlvbiAnICsgJ3Nob3VsZCByZXR1cm4gYSBzaW5nbGUgcm9vdCBub2RlLicsIHZtKTsKICAgICAgfQoKICAgICAgdm5vZGUgPSBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgICB9IC8vIHNldCBwYXJlbnQKCgogICAgdm5vZGUucGFyZW50ID0gX3BhcmVudFZub2RlOwogICAgcmV0dXJuIHZub2RlOwogIH07Cn0KCmZ1bmN0aW9uIGVuc3VyZUN0b3IoY29tcCwgYmFzZSkgewogIGlmIChjb21wLl9fZXNNb2R1bGUgfHwgaGFzU3ltYm9sICYmIGNvbXBbU3ltYm9sLnRvU3RyaW5nVGFnXSA9PT0gJ01vZHVsZScpIHsKICAgIGNvbXAgPSBjb21wLmRlZmF1bHQ7CiAgfQoKICByZXR1cm4gaXNPYmplY3QoY29tcCkgPyBiYXNlLmV4dGVuZChjb21wKSA6IGNvbXA7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUFzeW5jUGxhY2Vob2xkZXIoZmFjdG9yeSwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZykgewogIHZhciBub2RlID0gY3JlYXRlRW1wdHlWTm9kZSgpOwogIG5vZGUuYXN5bmNGYWN0b3J5ID0gZmFjdG9yeTsKICBub2RlLmFzeW5jTWV0YSA9IHsKICAgIGRhdGE6IGRhdGEsCiAgICBjb250ZXh0OiBjb250ZXh0LAogICAgY2hpbGRyZW46IGNoaWxkcmVuLAogICAgdGFnOiB0YWcKICB9OwogIHJldHVybiBub2RlOwp9CgpmdW5jdGlvbiByZXNvbHZlQXN5bmNDb21wb25lbnQoZmFjdG9yeSwgYmFzZUN0b3IpIHsKICBpZiAoaXNUcnVlKGZhY3RvcnkuZXJyb3IpICYmIGlzRGVmKGZhY3RvcnkuZXJyb3JDb21wKSkgewogICAgcmV0dXJuIGZhY3RvcnkuZXJyb3JDb21wOwogIH0KCiAgaWYgKGlzRGVmKGZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICByZXR1cm4gZmFjdG9yeS5yZXNvbHZlZDsKICB9CgogIHZhciBvd25lciA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsKCiAgaWYgKG93bmVyICYmIGlzRGVmKGZhY3Rvcnkub3duZXJzKSAmJiBmYWN0b3J5Lm93bmVycy5pbmRleE9mKG93bmVyKSA9PT0gLTEpIHsKICAgIC8vIGFscmVhZHkgcGVuZGluZwogICAgZmFjdG9yeS5vd25lcnMucHVzaChvd25lcik7CiAgfQoKICBpZiAoaXNUcnVlKGZhY3RvcnkubG9hZGluZykgJiYgaXNEZWYoZmFjdG9yeS5sb2FkaW5nQ29tcCkpIHsKICAgIHJldHVybiBmYWN0b3J5LmxvYWRpbmdDb21wOwogIH0KCiAgaWYgKG93bmVyICYmICFpc0RlZihmYWN0b3J5Lm93bmVycykpIHsKICAgIHZhciBvd25lcnNfMSA9IGZhY3Rvcnkub3duZXJzID0gW293bmVyXTsKICAgIHZhciBzeW5jXzEgPSB0cnVlOwogICAgdmFyIHRpbWVyTG9hZGluZ18xID0gbnVsbDsKICAgIHZhciB0aW1lclRpbWVvdXRfMSA9IG51bGw7CiAgICBvd25lci4kb24oJ2hvb2s6ZGVzdHJveWVkJywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcmVtb3ZlJDIob3duZXJzXzEsIG93bmVyKTsKICAgIH0pOwoKICAgIHZhciBmb3JjZVJlbmRlcl8xID0gZnVuY3Rpb24gKHJlbmRlckNvbXBsZXRlZCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG93bmVyc18xLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG93bmVyc18xW2ldLiRmb3JjZVVwZGF0ZSgpOwogICAgICB9CgogICAgICBpZiAocmVuZGVyQ29tcGxldGVkKSB7CiAgICAgICAgb3duZXJzXzEubGVuZ3RoID0gMDsKCiAgICAgICAgaWYgKHRpbWVyTG9hZGluZ18xICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJMb2FkaW5nXzEpOwogICAgICAgICAgdGltZXJMb2FkaW5nXzEgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRpbWVyVGltZW91dF8xICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJUaW1lb3V0XzEpOwogICAgICAgICAgdGltZXJUaW1lb3V0XzEgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICB2YXIgcmVzb2x2ZSA9IG9uY2UoZnVuY3Rpb24gKHJlcykgewogICAgICAvLyBjYWNoZSByZXNvbHZlZAogICAgICBmYWN0b3J5LnJlc29sdmVkID0gZW5zdXJlQ3RvcihyZXMsIGJhc2VDdG9yKTsgLy8gaW52b2tlIGNhbGxiYWNrcyBvbmx5IGlmIHRoaXMgaXMgbm90IGEgc3luY2hyb25vdXMgcmVzb2x2ZQogICAgICAvLyAoYXN5bmMgcmVzb2x2ZXMgYXJlIHNoaW1tZWQgYXMgc3luY2hyb25vdXMgZHVyaW5nIFNTUikKCiAgICAgIGlmICghc3luY18xKSB7CiAgICAgICAgZm9yY2VSZW5kZXJfMSh0cnVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvd25lcnNfMS5sZW5ndGggPSAwOwogICAgICB9CiAgICB9KTsKICAgIHZhciByZWplY3RfMSA9IG9uY2UoZnVuY3Rpb24gKHJlYXNvbikgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkZhaWxlZCB0byByZXNvbHZlIGFzeW5jIGNvbXBvbmVudDogIi5jb25jYXQoU3RyaW5nKGZhY3RvcnkpKSArIChyZWFzb24gPyAiXG5SZWFzb246ICIuY29uY2F0KHJlYXNvbikgOiAnJykpOwoKICAgICAgaWYgKGlzRGVmKGZhY3RvcnkuZXJyb3JDb21wKSkgewogICAgICAgIGZhY3RvcnkuZXJyb3IgPSB0cnVlOwogICAgICAgIGZvcmNlUmVuZGVyXzEodHJ1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlc18xID0gZmFjdG9yeShyZXNvbHZlLCByZWplY3RfMSk7CgogICAgaWYgKGlzT2JqZWN0KHJlc18xKSkgewogICAgICBpZiAoaXNQcm9taXNlKHJlc18xKSkgewogICAgICAgIC8vICgpID0+IFByb21pc2UKICAgICAgICBpZiAoaXNVbmRlZihmYWN0b3J5LnJlc29sdmVkKSkgewogICAgICAgICAgcmVzXzEudGhlbihyZXNvbHZlLCByZWplY3RfMSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGlzUHJvbWlzZShyZXNfMS5jb21wb25lbnQpKSB7CiAgICAgICAgcmVzXzEuY29tcG9uZW50LnRoZW4ocmVzb2x2ZSwgcmVqZWN0XzEpOwoKICAgICAgICBpZiAoaXNEZWYocmVzXzEuZXJyb3IpKSB7CiAgICAgICAgICBmYWN0b3J5LmVycm9yQ29tcCA9IGVuc3VyZUN0b3IocmVzXzEuZXJyb3IsIGJhc2VDdG9yKTsKICAgICAgICB9CgogICAgICAgIGlmIChpc0RlZihyZXNfMS5sb2FkaW5nKSkgewogICAgICAgICAgZmFjdG9yeS5sb2FkaW5nQ29tcCA9IGVuc3VyZUN0b3IocmVzXzEubG9hZGluZywgYmFzZUN0b3IpOwoKICAgICAgICAgIGlmIChyZXNfMS5kZWxheSA9PT0gMCkgewogICAgICAgICAgICBmYWN0b3J5LmxvYWRpbmcgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBOb2RlSlMgdGltZW91dCB0eXBlCiAgICAgICAgICAgIHRpbWVyTG9hZGluZ18xID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdGltZXJMb2FkaW5nXzEgPSBudWxsOwoKICAgICAgICAgICAgICBpZiAoaXNVbmRlZihmYWN0b3J5LnJlc29sdmVkKSAmJiBpc1VuZGVmKGZhY3RvcnkuZXJyb3IpKSB7CiAgICAgICAgICAgICAgICBmYWN0b3J5LmxvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgZm9yY2VSZW5kZXJfMShmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCByZXNfMS5kZWxheSB8fCAyMDApOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRGVmKHJlc18xLnRpbWVvdXQpKSB7CiAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIE5vZGVKUyB0aW1lb3V0IHR5cGUKICAgICAgICAgIHRpbWVyVGltZW91dF8xID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRpbWVyVGltZW91dF8xID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChpc1VuZGVmKGZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICAgICAgICAgICAgcmVqZWN0XzEocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/ICJ0aW1lb3V0ICgiLmNvbmNhdChyZXNfMS50aW1lb3V0LCAibXMpIikgOiBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgcmVzXzEudGltZW91dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgc3luY18xID0gZmFsc2U7IC8vIHJldHVybiBpbiBjYXNlIHJlc29sdmVkIHN5bmNocm9ub3VzbHkKCiAgICByZXR1cm4gZmFjdG9yeS5sb2FkaW5nID8gZmFjdG9yeS5sb2FkaW5nQ29tcCA6IGZhY3RvcnkucmVzb2x2ZWQ7CiAgfQp9CgpmdW5jdGlvbiBnZXRGaXJzdENvbXBvbmVudENoaWxkKGNoaWxkcmVuKSB7CiAgaWYgKGlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBjID0gY2hpbGRyZW5baV07CgogICAgICBpZiAoaXNEZWYoYykgJiYgKGlzRGVmKGMuY29tcG9uZW50T3B0aW9ucykgfHwgaXNBc3luY1BsYWNlaG9sZGVyKGMpKSkgewogICAgICAgIHJldHVybiBjOwogICAgICB9CiAgICB9CiAgfQp9Cgp2YXIgU0lNUExFX05PUk1BTElaRSA9IDE7CnZhciBBTFdBWVNfTk9STUFMSVpFID0gMjsgLy8gd3JhcHBlciBmdW5jdGlvbiBmb3IgcHJvdmlkaW5nIGEgbW9yZSBmbGV4aWJsZSBpbnRlcmZhY2UKLy8gd2l0aG91dCBnZXR0aW5nIHllbGxlZCBhdCBieSBmbG93CgpmdW5jdGlvbiBjcmVhdGVFbGVtZW50JDEoY29udGV4dCwgdGFnLCBkYXRhLCBjaGlsZHJlbiwgbm9ybWFsaXphdGlvblR5cGUsIGFsd2F5c05vcm1hbGl6ZSkgewogIGlmIChpc0FycmF5KGRhdGEpIHx8IGlzUHJpbWl0aXZlKGRhdGEpKSB7CiAgICBub3JtYWxpemF0aW9uVHlwZSA9IGNoaWxkcmVuOwogICAgY2hpbGRyZW4gPSBkYXRhOwogICAgZGF0YSA9IHVuZGVmaW5lZDsKICB9CgogIGlmIChpc1RydWUoYWx3YXlzTm9ybWFsaXplKSkgewogICAgbm9ybWFsaXphdGlvblR5cGUgPSBBTFdBWVNfTk9STUFMSVpFOwogIH0KCiAgcmV0dXJuIF9jcmVhdGVFbGVtZW50KGNvbnRleHQsIHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlKTsKfQoKZnVuY3Rpb24gX2NyZWF0ZUVsZW1lbnQoY29udGV4dCwgdGFnLCBkYXRhLCBjaGlsZHJlbiwgbm9ybWFsaXphdGlvblR5cGUpIHsKICBpZiAoaXNEZWYoZGF0YSkgJiYgaXNEZWYoZGF0YS5fX29iX18pKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkF2b2lkIHVzaW5nIG9ic2VydmVkIGRhdGEgb2JqZWN0IGFzIHZub2RlIGRhdGE6ICIuY29uY2F0KEpTT04uc3RyaW5naWZ5KGRhdGEpLCAiXG4iKSArICdBbHdheXMgY3JlYXRlIGZyZXNoIHZub2RlIGRhdGEgb2JqZWN0cyBpbiBlYWNoIHJlbmRlciEnLCBjb250ZXh0KTsKICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgfSAvLyBvYmplY3Qgc3ludGF4IGluIHYtYmluZAoKCiAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEuaXMpKSB7CiAgICB0YWcgPSBkYXRhLmlzOwogIH0KCiAgaWYgKCF0YWcpIHsKICAgIC8vIGluIGNhc2Ugb2YgY29tcG9uZW50IDppcyBzZXQgdG8gZmFsc3kgdmFsdWUKICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgfSAvLyB3YXJuIGFnYWluc3Qgbm9uLXByaW1pdGl2ZSBrZXkKCgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEua2V5KSAmJiAhaXNQcmltaXRpdmUoZGF0YS5rZXkpKSB7CiAgICB3YXJuKCdBdm9pZCB1c2luZyBub24tcHJpbWl0aXZlIHZhbHVlIGFzIGtleSwgJyArICd1c2Ugc3RyaW5nL251bWJlciB2YWx1ZSBpbnN0ZWFkLicsIGNvbnRleHQpOwogIH0gLy8gc3VwcG9ydCBzaW5nbGUgZnVuY3Rpb24gY2hpbGRyZW4gYXMgZGVmYXVsdCBzY29wZWQgc2xvdAoKCiAgaWYgKGlzQXJyYXkoY2hpbGRyZW4pICYmIGlzRnVuY3Rpb24oY2hpbGRyZW5bMF0pKSB7CiAgICBkYXRhID0gZGF0YSB8fCB7fTsKICAgIGRhdGEuc2NvcGVkU2xvdHMgPSB7CiAgICAgIGRlZmF1bHQ6IGNoaWxkcmVuWzBdCiAgICB9OwogICAgY2hpbGRyZW4ubGVuZ3RoID0gMDsKICB9CgogIGlmIChub3JtYWxpemF0aW9uVHlwZSA9PT0gQUxXQVlTX05PUk1BTElaRSkgewogICAgY2hpbGRyZW4gPSBub3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbik7CiAgfSBlbHNlIGlmIChub3JtYWxpemF0aW9uVHlwZSA9PT0gU0lNUExFX05PUk1BTElaRSkgewogICAgY2hpbGRyZW4gPSBzaW1wbGVOb3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbik7CiAgfQoKICB2YXIgdm5vZGUsIG5zOwoKICBpZiAodHlwZW9mIHRhZyA9PT0gJ3N0cmluZycpIHsKICAgIHZhciBDdG9yID0gdm9pZCAwOwogICAgbnMgPSBjb250ZXh0LiR2bm9kZSAmJiBjb250ZXh0LiR2bm9kZS5ucyB8fCBjb25maWcuZ2V0VGFnTmFtZXNwYWNlKHRhZyk7CgogICAgaWYgKGNvbmZpZy5pc1Jlc2VydmVkVGFnKHRhZykpIHsKICAgICAgLy8gcGxhdGZvcm0gYnVpbHQtaW4gZWxlbWVudHMKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNEZWYoZGF0YSkgJiYgaXNEZWYoZGF0YS5uYXRpdmVPbikgJiYgZGF0YS50YWcgIT09ICdjb21wb25lbnQnKSB7CiAgICAgICAgd2FybigiVGhlIC5uYXRpdmUgbW9kaWZpZXIgZm9yIHYtb24gaXMgb25seSB2YWxpZCBvbiBjb21wb25lbnRzIGJ1dCBpdCB3YXMgdXNlZCBvbiA8Ii5jb25jYXQodGFnLCAiPi4iKSwgY29udGV4dCk7CiAgICAgIH0KCiAgICAgIHZub2RlID0gbmV3IFZOb2RlKGNvbmZpZy5wYXJzZVBsYXRmb3JtVGFnTmFtZSh0YWcpLCBkYXRhLCBjaGlsZHJlbiwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmICgoIWRhdGEgfHwgIWRhdGEucHJlKSAmJiBpc0RlZihDdG9yID0gcmVzb2x2ZUFzc2V0KGNvbnRleHQuJG9wdGlvbnMsICdjb21wb25lbnRzJywgdGFnKSkpIHsKICAgICAgLy8gY29tcG9uZW50CiAgICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KEN0b3IsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpOwogICAgfSBlbHNlIHsKICAgICAgLy8gdW5rbm93biBvciB1bmxpc3RlZCBuYW1lc3BhY2VkIGVsZW1lbnRzCiAgICAgIC8vIGNoZWNrIGF0IHJ1bnRpbWUgYmVjYXVzZSBpdCBtYXkgZ2V0IGFzc2lnbmVkIGEgbmFtZXNwYWNlIHdoZW4gaXRzCiAgICAgIC8vIHBhcmVudCBub3JtYWxpemVzIGNoaWxkcmVuCiAgICAgIHZub2RlID0gbmV3IFZOb2RlKHRhZywgZGF0YSwgY2hpbGRyZW4sIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZXh0KTsKICAgIH0KICB9IGVsc2UgewogICAgLy8gZGlyZWN0IGNvbXBvbmVudCBvcHRpb25zIC8gY29uc3RydWN0b3IKICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KHRhZywgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4pOwogIH0KCiAgaWYgKGlzQXJyYXkodm5vZGUpKSB7CiAgICByZXR1cm4gdm5vZGU7CiAgfSBlbHNlIGlmIChpc0RlZih2bm9kZSkpIHsKICAgIGlmIChpc0RlZihucykpIGFwcGx5TlModm5vZGUsIG5zKTsKICAgIGlmIChpc0RlZihkYXRhKSkgcmVnaXN0ZXJEZWVwQmluZGluZ3MoZGF0YSk7CiAgICByZXR1cm4gdm5vZGU7CiAgfSBlbHNlIHsKICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseU5TKHZub2RlLCBucywgZm9yY2UpIHsKICB2bm9kZS5ucyA9IG5zOwoKICBpZiAodm5vZGUudGFnID09PSAnZm9yZWlnbk9iamVjdCcpIHsKICAgIC8vIHVzZSBkZWZhdWx0IG5hbWVzcGFjZSBpbnNpZGUgZm9yZWlnbk9iamVjdAogICAgbnMgPSB1bmRlZmluZWQ7CiAgICBmb3JjZSA9IHRydWU7CiAgfQoKICBpZiAoaXNEZWYodm5vZGUuY2hpbGRyZW4pKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2YXIgY2hpbGQgPSB2bm9kZS5jaGlsZHJlbltpXTsKCiAgICAgIGlmIChpc0RlZihjaGlsZC50YWcpICYmIChpc1VuZGVmKGNoaWxkLm5zKSB8fCBpc1RydWUoZm9yY2UpICYmIGNoaWxkLnRhZyAhPT0gJ3N2ZycpKSB7CiAgICAgICAgYXBwbHlOUyhjaGlsZCwgbnMsIGZvcmNlKTsKICAgICAgfQogICAgfQogIH0KfSAvLyByZWYgIzUzMTgKLy8gbmVjZXNzYXJ5IHRvIGVuc3VyZSBwYXJlbnQgcmUtcmVuZGVyIHdoZW4gZGVlcCBiaW5kaW5ncyBsaWtlIDpzdHlsZSBhbmQKLy8gOmNsYXNzIGFyZSB1c2VkIG9uIHNsb3Qgbm9kZXMKCgpmdW5jdGlvbiByZWdpc3RlckRlZXBCaW5kaW5ncyhkYXRhKSB7CiAgaWYgKGlzT2JqZWN0KGRhdGEuc3R5bGUpKSB7CiAgICB0cmF2ZXJzZShkYXRhLnN0eWxlKTsKICB9CgogIGlmIChpc09iamVjdChkYXRhLmNsYXNzKSkgewogICAgdHJhdmVyc2UoZGF0YS5jbGFzcyk7CiAgfQp9Ci8qKg0KICogQGludGVybmFsIHRoaXMgZnVuY3Rpb24gbmVlZHMgbWFudWFsIHB1YmxpYyB0eXBlIGRlY2xhcmF0aW9uIGJlY2F1c2UgaXQgcmVsaWVzDQogKiBvbiBwcmV2aW91c2x5IG1hbnVhbGx5IGF1dGhvcmVkIHR5cGVzIGZyb20gVnVlIDINCiAqLwoKCmZ1bmN0aW9uIGgodHlwZSwgcHJvcHMsIGNoaWxkcmVuKSB7CiAgaWYgKCFjdXJyZW50SW5zdGFuY2UpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiZ2xvYmFsbHkgaW1wb3J0ZWQgaCgpIGNhbiBvbmx5IGJlIGludm9rZWQgd2hlbiB0aGVyZSBpcyBhbiBhY3RpdmUgIiArICJjb21wb25lbnQgaW5zdGFuY2UsIGUuZy4gc3luY2hyb25vdXNseSBpbiBhIGNvbXBvbmVudCdzIHJlbmRlciBvciBzZXR1cCBmdW5jdGlvbi4iKTsKICB9CgogIHJldHVybiBjcmVhdGVFbGVtZW50JDEoY3VycmVudEluc3RhbmNlLCB0eXBlLCBwcm9wcywgY2hpbGRyZW4sIDIsIHRydWUpOwp9CgpmdW5jdGlvbiBoYW5kbGVFcnJvcihlcnIsIHZtLCBpbmZvKSB7CiAgLy8gRGVhY3RpdmF0ZSBkZXBzIHRyYWNraW5nIHdoaWxlIHByb2Nlc3NpbmcgZXJyb3IgaGFuZGxlciB0byBhdm9pZCBwb3NzaWJsZSBpbmZpbml0ZSByZW5kZXJpbmcuCiAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vdnVlanMvdnVleC9pc3N1ZXMvMTUwNQogIHB1c2hUYXJnZXQoKTsKCiAgdHJ5IHsKICAgIGlmICh2bSkgewogICAgICB2YXIgY3VyID0gdm07CgogICAgICB3aGlsZSAoY3VyID0gY3VyLiRwYXJlbnQpIHsKICAgICAgICB2YXIgaG9va3MgPSBjdXIuJG9wdGlvbnMuZXJyb3JDYXB0dXJlZDsKCiAgICAgICAgaWYgKGhvb2tzKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGNhcHR1cmUgPSBob29rc1tpXS5jYWxsKGN1ciwgZXJyLCB2bSwgaW5mbykgPT09IGZhbHNlOwogICAgICAgICAgICAgIGlmIChjYXB0dXJlKSByZXR1cm47CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBnbG9iYWxIYW5kbGVFcnJvcihlLCBjdXIsICdlcnJvckNhcHR1cmVkIGhvb2snKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGdsb2JhbEhhbmRsZUVycm9yKGVyciwgdm0sIGluZm8pOwogIH0gZmluYWxseSB7CiAgICBwb3BUYXJnZXQoKTsKICB9Cn0KCmZ1bmN0aW9uIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGhhbmRsZXIsIGNvbnRleHQsIGFyZ3MsIHZtLCBpbmZvKSB7CiAgdmFyIHJlczsKCiAgdHJ5IHsKICAgIHJlcyA9IGFyZ3MgPyBoYW5kbGVyLmFwcGx5KGNvbnRleHQsIGFyZ3MpIDogaGFuZGxlci5jYWxsKGNvbnRleHQpOwoKICAgIGlmIChyZXMgJiYgIXJlcy5faXNWdWUgJiYgaXNQcm9taXNlKHJlcykgJiYgIXJlcy5faGFuZGxlZCkgewogICAgICByZXMuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gaGFuZGxlRXJyb3IoZSwgdm0sIGluZm8gKyAiIChQcm9taXNlL2FzeW5jKSIpOwogICAgICB9KTsKICAgICAgcmVzLl9oYW5kbGVkID0gdHJ1ZTsKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICBoYW5kbGVFcnJvcihlLCB2bSwgaW5mbyk7CiAgfQoKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBnbG9iYWxIYW5kbGVFcnJvcihlcnIsIHZtLCBpbmZvKSB7CiAgaWYgKGNvbmZpZy5lcnJvckhhbmRsZXIpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBjb25maWcuZXJyb3JIYW5kbGVyLmNhbGwobnVsbCwgZXJyLCB2bSwgaW5mbyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIC8vIGlmIHRoZSB1c2VyIGludGVudGlvbmFsbHkgdGhyb3dzIHRoZSBvcmlnaW5hbCBlcnJvciBpbiB0aGUgaGFuZGxlciwKICAgICAgLy8gZG8gbm90IGxvZyBpdCB0d2ljZQogICAgICBpZiAoZSAhPT0gZXJyKSB7CiAgICAgICAgbG9nRXJyb3IoZSwgbnVsbCwgJ2NvbmZpZy5lcnJvckhhbmRsZXInKTsKICAgICAgfQogICAgfQogIH0KCiAgbG9nRXJyb3IoZXJyLCB2bSwgaW5mbyk7Cn0KCmZ1bmN0aW9uIGxvZ0Vycm9yKGVyciwgdm0sIGluZm8pIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgd2FybigiRXJyb3IgaW4gIi5jb25jYXQoaW5mbywgIjogXCIiKS5jb25jYXQoZXJyLnRvU3RyaW5nKCksICJcIiIpLCB2bSk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgoKICBpZiAoaW5Ccm93c2VyICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgY29uc29sZS5lcnJvcihlcnIpOwogIH0gZWxzZSB7CiAgICB0aHJvdyBlcnI7CiAgfQp9Ci8qIGdsb2JhbHMgTXV0YXRpb25PYnNlcnZlciAqLwoKCnZhciBpc1VzaW5nTWljcm9UYXNrID0gZmFsc2U7CnZhciBjYWxsYmFja3MgPSBbXTsKdmFyIHBlbmRpbmcgPSBmYWxzZTsKCmZ1bmN0aW9uIGZsdXNoQ2FsbGJhY2tzKCkgewogIHBlbmRpbmcgPSBmYWxzZTsKICB2YXIgY29waWVzID0gY2FsbGJhY2tzLnNsaWNlKDApOwogIGNhbGxiYWNrcy5sZW5ndGggPSAwOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGNvcGllcy5sZW5ndGg7IGkrKykgewogICAgY29waWVzW2ldKCk7CiAgfQp9IC8vIEhlcmUgd2UgaGF2ZSBhc3luYyBkZWZlcnJpbmcgd3JhcHBlcnMgdXNpbmcgbWljcm90YXNrcy4KLy8gSW4gMi41IHdlIHVzZWQgKG1hY3JvKSB0YXNrcyAoaW4gY29tYmluYXRpb24gd2l0aCBtaWNyb3Rhc2tzKS4KLy8gSG93ZXZlciwgaXQgaGFzIHN1YnRsZSBwcm9ibGVtcyB3aGVuIHN0YXRlIGlzIGNoYW5nZWQgcmlnaHQgYmVmb3JlIHJlcGFpbnQKLy8gKGUuZy4gIzY4MTMsIG91dC1pbiB0cmFuc2l0aW9ucykuCi8vIEFsc28sIHVzaW5nIChtYWNybykgdGFza3MgaW4gZXZlbnQgaGFuZGxlciB3b3VsZCBjYXVzZSBzb21lIHdlaXJkIGJlaGF2aW9ycwovLyB0aGF0IGNhbm5vdCBiZSBjaXJjdW12ZW50ZWQgKGUuZy4gIzcxMDksICM3MTUzLCAjNzU0NiwgIzc4MzQsICM4MTA5KS4KLy8gU28gd2Ugbm93IHVzZSBtaWNyb3Rhc2tzIGV2ZXJ5d2hlcmUsIGFnYWluLgovLyBBIG1ham9yIGRyYXdiYWNrIG9mIHRoaXMgdHJhZGVvZmYgaXMgdGhhdCB0aGVyZSBhcmUgc29tZSBzY2VuYXJpb3MKLy8gd2hlcmUgbWljcm90YXNrcyBoYXZlIHRvbyBoaWdoIGEgcHJpb3JpdHkgYW5kIGZpcmUgaW4gYmV0d2VlbiBzdXBwb3NlZGx5Ci8vIHNlcXVlbnRpYWwgZXZlbnRzIChlLmcuICM0NTIxLCAjNjY5MCwgd2hpY2ggaGF2ZSB3b3JrYXJvdW5kcykKLy8gb3IgZXZlbiBiZXR3ZWVuIGJ1YmJsaW5nIG9mIHRoZSBzYW1lIGV2ZW50ICgjNjU2NikuCgoKdmFyIHRpbWVyRnVuYzsgLy8gVGhlIG5leHRUaWNrIGJlaGF2aW9yIGxldmVyYWdlcyB0aGUgbWljcm90YXNrIHF1ZXVlLCB3aGljaCBjYW4gYmUgYWNjZXNzZWQKLy8gdmlhIGVpdGhlciBuYXRpdmUgUHJvbWlzZS50aGVuIG9yIE11dGF0aW9uT2JzZXJ2ZXIuCi8vIE11dGF0aW9uT2JzZXJ2ZXIgaGFzIHdpZGVyIHN1cHBvcnQsIGhvd2V2ZXIgaXQgaXMgc2VyaW91c2x5IGJ1Z2dlZCBpbgovLyBVSVdlYlZpZXcgaW4gaU9TID49IDkuMy4zIHdoZW4gdHJpZ2dlcmVkIGluIHRvdWNoIGV2ZW50IGhhbmRsZXJzLiBJdAovLyBjb21wbGV0ZWx5IHN0b3BzIHdvcmtpbmcgYWZ0ZXIgdHJpZ2dlcmluZyBhIGZldyB0aW1lcy4uLiBzbywgaWYgbmF0aXZlCi8vIFByb21pc2UgaXMgYXZhaWxhYmxlLCB3ZSB3aWxsIHVzZSBpdDoKCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0LCAkZmxvdy1kaXNhYmxlLWxpbmUgKi8KCmlmICh0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoUHJvbWlzZSkpIHsKICB2YXIgcF8xID0gUHJvbWlzZS5yZXNvbHZlKCk7CgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgIHBfMS50aGVuKGZsdXNoQ2FsbGJhY2tzKTsgLy8gSW4gcHJvYmxlbWF0aWMgVUlXZWJWaWV3cywgUHJvbWlzZS50aGVuIGRvZXNuJ3QgY29tcGxldGVseSBicmVhaywgYnV0CiAgICAvLyBpdCBjYW4gZ2V0IHN0dWNrIGluIGEgd2VpcmQgc3RhdGUgd2hlcmUgY2FsbGJhY2tzIGFyZSBwdXNoZWQgaW50byB0aGUKICAgIC8vIG1pY3JvdGFzayBxdWV1ZSBidXQgdGhlIHF1ZXVlIGlzbid0IGJlaW5nIGZsdXNoZWQsIHVudGlsIHRoZSBicm93c2VyCiAgICAvLyBuZWVkcyB0byBkbyBzb21lIG90aGVyIHdvcmssIGUuZy4gaGFuZGxlIGEgdGltZXIuIFRoZXJlZm9yZSB3ZSBjYW4KICAgIC8vICJmb3JjZSIgdGhlIG1pY3JvdGFzayBxdWV1ZSB0byBiZSBmbHVzaGVkIGJ5IGFkZGluZyBhbiBlbXB0eSB0aW1lci4KCiAgICBpZiAoaXNJT1MpIHNldFRpbWVvdXQobm9vcCk7CiAgfTsKCiAgaXNVc2luZ01pY3JvVGFzayA9IHRydWU7Cn0gZWxzZSBpZiAoIWlzSUUgJiYgdHlwZW9mIE11dGF0aW9uT2JzZXJ2ZXIgIT09ICd1bmRlZmluZWQnICYmIChpc05hdGl2ZShNdXRhdGlvbk9ic2VydmVyKSB8fCAvLyBQaGFudG9tSlMgYW5kIGlPUyA3LngKTXV0YXRpb25PYnNlcnZlci50b1N0cmluZygpID09PSAnW29iamVjdCBNdXRhdGlvbk9ic2VydmVyQ29uc3RydWN0b3JdJykpIHsKICAvLyBVc2UgTXV0YXRpb25PYnNlcnZlciB3aGVyZSBuYXRpdmUgUHJvbWlzZSBpcyBub3QgYXZhaWxhYmxlLAogIC8vIGUuZy4gUGhhbnRvbUpTLCBpT1M3LCBBbmRyb2lkIDQuNAogIC8vICgjNjQ2NiBNdXRhdGlvbk9ic2VydmVyIGlzIHVucmVsaWFibGUgaW4gSUUxMSkKICB2YXIgY291bnRlcl8xID0gMTsKICB2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmbHVzaENhbGxiYWNrcyk7CiAgdmFyIHRleHROb2RlXzEgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShTdHJpbmcoY291bnRlcl8xKSk7CiAgb2JzZXJ2ZXIub2JzZXJ2ZSh0ZXh0Tm9kZV8xLCB7CiAgICBjaGFyYWN0ZXJEYXRhOiB0cnVlCiAgfSk7CgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgIGNvdW50ZXJfMSA9IChjb3VudGVyXzEgKyAxKSAlIDI7CiAgICB0ZXh0Tm9kZV8xLmRhdGEgPSBTdHJpbmcoY291bnRlcl8xKTsKICB9OwoKICBpc1VzaW5nTWljcm9UYXNrID0gdHJ1ZTsKfSBlbHNlIGlmICh0eXBlb2Ygc2V0SW1tZWRpYXRlICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShzZXRJbW1lZGlhdGUpKSB7CiAgLy8gRmFsbGJhY2sgdG8gc2V0SW1tZWRpYXRlLgogIC8vIFRlY2huaWNhbGx5IGl0IGxldmVyYWdlcyB0aGUgKG1hY3JvKSB0YXNrIHF1ZXVlLAogIC8vIGJ1dCBpdCBpcyBzdGlsbCBhIGJldHRlciBjaG9pY2UgdGhhbiBzZXRUaW1lb3V0LgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgIHNldEltbWVkaWF0ZShmbHVzaENhbGxiYWNrcyk7CiAgfTsKfSBlbHNlIHsKICAvLyBGYWxsYmFjayB0byBzZXRUaW1lb3V0LgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgIHNldFRpbWVvdXQoZmx1c2hDYWxsYmFja3MsIDApOwogIH07Cn0KLyoqDQogKiBAaW50ZXJuYWwNCiAqLwoKCmZ1bmN0aW9uIG5leHRUaWNrKGNiLCBjdHgpIHsKICB2YXIgX3Jlc29sdmU7CgogIGNhbGxiYWNrcy5wdXNoKGZ1bmN0aW9uICgpIHsKICAgIGlmIChjYikgewogICAgICB0cnkgewogICAgICAgIGNiLmNhbGwoY3R4KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGhhbmRsZUVycm9yKGUsIGN0eCwgJ25leHRUaWNrJyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoX3Jlc29sdmUpIHsKICAgICAgX3Jlc29sdmUoY3R4KTsKICAgIH0KICB9KTsKCiAgaWYgKCFwZW5kaW5nKSB7CiAgICBwZW5kaW5nID0gdHJ1ZTsKICAgIHRpbWVyRnVuYygpOwogIH0gLy8gJGZsb3ctZGlzYWJsZS1saW5lCgoKICBpZiAoIWNiICYmIHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgIF9yZXNvbHZlID0gcmVzb2x2ZTsKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gdXNlQ3NzTW9kdWxlKG5hbWUpIHsKICBpZiAobmFtZSA9PT0gdm9pZCAwKSB7CiAgICBuYW1lID0gJyRzdHlsZSc7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgoKICB7CiAgICBpZiAoIWN1cnJlbnRJbnN0YW5jZSkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oInVzZUNzc01vZHVsZSBtdXN0IGJlIGNhbGxlZCBpbnNpZGUgc2V0dXAoKSIpOwogICAgICByZXR1cm4gZW1wdHlPYmplY3Q7CiAgICB9CgogICAgdmFyIG1vZCA9IGN1cnJlbnRJbnN0YW5jZVtuYW1lXTsKCiAgICBpZiAoIW1vZCkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkN1cnJlbnQgaW5zdGFuY2UgZG9lcyBub3QgaGF2ZSBDU1MgbW9kdWxlIG5hbWVkIFwiIi5jb25jYXQobmFtZSwgIlwiLiIpKTsKICAgICAgcmV0dXJuIGVtcHR5T2JqZWN0OwogICAgfQoKICAgIHJldHVybiBtb2Q7CiAgfQp9Ci8qKg0KICogUnVudGltZSBoZWxwZXIgZm9yIFNGQydzIENTUyB2YXJpYWJsZSBpbmplY3Rpb24gZmVhdHVyZS4NCiAqIEBwcml2YXRlDQogKi8KCgpmdW5jdGlvbiB1c2VDc3NWYXJzKGdldHRlcikgewogIGlmICghaW5Ccm93c2VyICYmICFmYWxzZSkgcmV0dXJuOwogIHZhciBpbnN0YW5jZSA9IGN1cnJlbnRJbnN0YW5jZTsKCiAgaWYgKCFpbnN0YW5jZSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJ1c2VDc3NWYXJzIGlzIGNhbGxlZCB3aXRob3V0IGN1cnJlbnQgYWN0aXZlIGNvbXBvbmVudCBpbnN0YW5jZS4iKTsKICAgIHJldHVybjsKICB9CgogIHdhdGNoUG9zdEVmZmVjdChmdW5jdGlvbiAoKSB7CiAgICB2YXIgZWwgPSBpbnN0YW5jZS4kZWw7CiAgICB2YXIgdmFycyA9IGdldHRlcihpbnN0YW5jZSwgaW5zdGFuY2UuX3NldHVwUHJveHkpOwoKICAgIGlmIChlbCAmJiBlbC5ub2RlVHlwZSA9PT0gMSkgewogICAgICB2YXIgc3R5bGUgPSBlbC5zdHlsZTsKCiAgICAgIGZvciAodmFyIGtleSBpbiB2YXJzKSB7CiAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoIi0tIi5jb25jYXQoa2V5KSwgdmFyc1trZXldKTsKICAgICAgfQogICAgfQogIH0pOwp9Ci8qKg0KICogdjMtY29tcGF0aWJsZSBhc3luYyBjb21wb25lbnQgQVBJLg0KICogQGludGVybmFsIHRoZSB0eXBlIGlzIG1hbnVhbGx5IGRlY2xhcmVkIGluIDxyb290Pi90eXBlcy92My1kZWZpbmUtYXN5bmMtY29tcG9uZW50LmQudHMNCiAqIGJlY2F1c2UgaXQgcmVsaWVzIG9uIGV4aXN0aW5nIG1hbnVhbCB0eXBlcw0KICovCgoKZnVuY3Rpb24gZGVmaW5lQXN5bmNDb21wb25lbnQoc291cmNlKSB7CiAgaWYgKGlzRnVuY3Rpb24oc291cmNlKSkgewogICAgc291cmNlID0gewogICAgICBsb2FkZXI6IHNvdXJjZQogICAgfTsKICB9CgogIHZhciBsb2FkZXIgPSBzb3VyY2UubG9hZGVyLAogICAgICBsb2FkaW5nQ29tcG9uZW50ID0gc291cmNlLmxvYWRpbmdDb21wb25lbnQsCiAgICAgIGVycm9yQ29tcG9uZW50ID0gc291cmNlLmVycm9yQ29tcG9uZW50LAogICAgICBfYSA9IHNvdXJjZS5kZWxheSwKICAgICAgZGVsYXkgPSBfYSA9PT0gdm9pZCAwID8gMjAwIDogX2EsCiAgICAgIHRpbWVvdXQgPSBzb3VyY2UudGltZW91dCwKICAgICAgLy8gdW5kZWZpbmVkID0gbmV2ZXIgdGltZXMgb3V0CiAgX2IgPSBzb3VyY2Uuc3VzcGVuc2libGUsCiAgICAgIC8vIHVuZGVmaW5lZCA9IG5ldmVyIHRpbWVzIG91dAogIHN1c3BlbnNpYmxlID0gX2IgPT09IHZvaWQgMCA/IGZhbHNlIDogX2IsCiAgICAgIC8vIGluIFZ1ZSAzIGRlZmF1bHQgaXMgdHJ1ZQogIHVzZXJPbkVycm9yID0gc291cmNlLm9uRXJyb3I7CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHN1c3BlbnNpYmxlKSB7CiAgICB3YXJuKCJUaGUgc3VzcGVuc2libGJlIG9wdGlvbiBmb3IgYXN5bmMgY29tcG9uZW50cyBpcyBub3Qgc3VwcG9ydGVkIGluIFZ1ZTIuIEl0IGlzIGlnbm9yZWQuIik7CiAgfQoKICB2YXIgcGVuZGluZ1JlcXVlc3QgPSBudWxsOwogIHZhciByZXRyaWVzID0gMDsKCiAgdmFyIHJldHJ5ID0gZnVuY3Rpb24gKCkgewogICAgcmV0cmllcysrOwogICAgcGVuZGluZ1JlcXVlc3QgPSBudWxsOwogICAgcmV0dXJuIGxvYWQoKTsKICB9OwoKICB2YXIgbG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB0aGlzUmVxdWVzdDsKICAgIHJldHVybiBwZW5kaW5nUmVxdWVzdCB8fCAodGhpc1JlcXVlc3QgPSBwZW5kaW5nUmVxdWVzdCA9IGxvYWRlcigpLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgZXJyID0gZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIgOiBuZXcgRXJyb3IoU3RyaW5nKGVycikpOwoKICAgICAgaWYgKHVzZXJPbkVycm9yKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIHZhciB1c2VyUmV0cnkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHJldHJ5KCkpOwogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgdXNlckZhaWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTsKICAgICAgICAgIH07CgogICAgICAgICAgdXNlck9uRXJyb3IoZXJyLCB1c2VyUmV0cnksIHVzZXJGYWlsLCByZXRyaWVzICsgMSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgZXJyOwogICAgICB9CiAgICB9KS50aGVuKGZ1bmN0aW9uIChjb21wKSB7CiAgICAgIGlmICh0aGlzUmVxdWVzdCAhPT0gcGVuZGluZ1JlcXVlc3QgJiYgcGVuZGluZ1JlcXVlc3QpIHsKICAgICAgICByZXR1cm4gcGVuZGluZ1JlcXVlc3Q7CiAgICAgIH0KCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFjb21wKSB7CiAgICAgICAgd2FybigiQXN5bmMgY29tcG9uZW50IGxvYWRlciByZXNvbHZlZCB0byB1bmRlZmluZWQuICIgKyAiSWYgeW91IGFyZSB1c2luZyByZXRyeSgpLCBtYWtlIHN1cmUgdG8gcmV0dXJuIGl0cyByZXR1cm4gdmFsdWUuIik7CiAgICAgIH0gLy8gaW50ZXJvcCBtb2R1bGUgZGVmYXVsdAoKCiAgICAgIGlmIChjb21wICYmIChjb21wLl9fZXNNb2R1bGUgfHwgY29tcFtTeW1ib2wudG9TdHJpbmdUYWddID09PSAnTW9kdWxlJykpIHsKICAgICAgICBjb21wID0gY29tcC5kZWZhdWx0OwogICAgICB9CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjb21wICYmICFpc09iamVjdChjb21wKSAmJiAhaXNGdW5jdGlvbihjb21wKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBhc3luYyBjb21wb25lbnQgbG9hZCByZXN1bHQ6ICIuY29uY2F0KGNvbXApKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNvbXA7CiAgICB9KSk7CiAgfTsKCiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb21wb25lbnQgPSBsb2FkKCk7CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGNvbXBvbmVudCwKICAgICAgZGVsYXk6IGRlbGF5LAogICAgICB0aW1lb3V0OiB0aW1lb3V0LAogICAgICBlcnJvcjogZXJyb3JDb21wb25lbnQsCiAgICAgIGxvYWRpbmc6IGxvYWRpbmdDb21wb25lbnQKICAgIH07CiAgfTsKfQoKZnVuY3Rpb24gY3JlYXRlTGlmZUN5Y2xlKGhvb2tOYW1lKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIChmbiwgdGFyZ2V0KSB7CiAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgdGFyZ2V0ID0gY3VycmVudEluc3RhbmNlOwogICAgfQoKICAgIGlmICghdGFyZ2V0KSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiIi5jb25jYXQoZm9ybWF0TmFtZShob29rTmFtZSksICIgaXMgY2FsbGVkIHdoZW4gdGhlcmUgaXMgbm8gYWN0aXZlIGNvbXBvbmVudCBpbnN0YW5jZSB0byBiZSAiKSArICJhc3NvY2lhdGVkIHdpdGguICIgKyAiTGlmZWN5Y2xlIGluamVjdGlvbiBBUElzIGNhbiBvbmx5IGJlIHVzZWQgZHVyaW5nIGV4ZWN1dGlvbiBvZiBzZXR1cCgpLiIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgcmV0dXJuIGluamVjdEhvb2sodGFyZ2V0LCBob29rTmFtZSwgZm4pOwogIH07Cn0KCmZ1bmN0aW9uIGZvcm1hdE5hbWUobmFtZSkgewogIGlmIChuYW1lID09PSAnYmVmb3JlRGVzdHJveScpIHsKICAgIG5hbWUgPSAnYmVmb3JlVW5tb3VudCc7CiAgfSBlbHNlIGlmIChuYW1lID09PSAnZGVzdHJveWVkJykgewogICAgbmFtZSA9ICd1bm1vdW50ZWQnOwogIH0KCiAgcmV0dXJuICJvbiIuY29uY2F0KG5hbWVbMF0udG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwp9CgpmdW5jdGlvbiBpbmplY3RIb29rKGluc3RhbmNlLCBob29rTmFtZSwgZm4pIHsKICB2YXIgb3B0aW9ucyA9IGluc3RhbmNlLiRvcHRpb25zOwogIG9wdGlvbnNbaG9va05hbWVdID0gbWVyZ2VMaWZlY3ljbGVIb29rKG9wdGlvbnNbaG9va05hbWVdLCBmbik7Cn0KCnZhciBvbkJlZm9yZU1vdW50ID0gY3JlYXRlTGlmZUN5Y2xlKCdiZWZvcmVNb3VudCcpOwp2YXIgb25Nb3VudGVkID0gY3JlYXRlTGlmZUN5Y2xlKCdtb3VudGVkJyk7CnZhciBvbkJlZm9yZVVwZGF0ZSA9IGNyZWF0ZUxpZmVDeWNsZSgnYmVmb3JlVXBkYXRlJyk7CnZhciBvblVwZGF0ZWQgPSBjcmVhdGVMaWZlQ3ljbGUoJ3VwZGF0ZWQnKTsKdmFyIG9uQmVmb3JlVW5tb3VudCA9IGNyZWF0ZUxpZmVDeWNsZSgnYmVmb3JlRGVzdHJveScpOwp2YXIgb25Vbm1vdW50ZWQgPSBjcmVhdGVMaWZlQ3ljbGUoJ2Rlc3Ryb3llZCcpOwp2YXIgb25BY3RpdmF0ZWQgPSBjcmVhdGVMaWZlQ3ljbGUoJ2FjdGl2YXRlZCcpOwp2YXIgb25EZWFjdGl2YXRlZCA9IGNyZWF0ZUxpZmVDeWNsZSgnZGVhY3RpdmF0ZWQnKTsKdmFyIG9uU2VydmVyUHJlZmV0Y2ggPSBjcmVhdGVMaWZlQ3ljbGUoJ3NlcnZlclByZWZldGNoJyk7CnZhciBvblJlbmRlclRyYWNrZWQgPSBjcmVhdGVMaWZlQ3ljbGUoJ3JlbmRlclRyYWNrZWQnKTsKdmFyIG9uUmVuZGVyVHJpZ2dlcmVkID0gY3JlYXRlTGlmZUN5Y2xlKCdyZW5kZXJUcmlnZ2VyZWQnKTsKdmFyIGluamVjdEVycm9yQ2FwdHVyZWRIb29rID0gY3JlYXRlTGlmZUN5Y2xlKCdlcnJvckNhcHR1cmVkJyk7CgpmdW5jdGlvbiBvbkVycm9yQ2FwdHVyZWQoaG9vaywgdGFyZ2V0KSB7CiAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICB0YXJnZXQgPSBjdXJyZW50SW5zdGFuY2U7CiAgfQoKICBpbmplY3RFcnJvckNhcHR1cmVkSG9vayhob29rLCB0YXJnZXQpOwp9Ci8qKg0KICogTm90ZTogYWxzbyB1cGRhdGUgZGlzdC92dWUucnVudGltZS5tanMgd2hlbiBhZGRpbmcgbmV3IGV4cG9ydHMgdG8gdGhpcyBmaWxlLg0KICovCgoKdmFyIHZlcnNpb24gPSAnMi43LjEwJzsKLyoqDQogKiBAaW50ZXJuYWwgdHlwZSBpcyBtYW51YWxseSBkZWNsYXJlZCBpbiA8cm9vdD4vdHlwZXMvdjMtZGVmaW5lLWNvbXBvbmVudC5kLnRzDQogKi8KCmZ1bmN0aW9uIGRlZmluZUNvbXBvbmVudChvcHRpb25zKSB7CiAgcmV0dXJuIG9wdGlvbnM7Cn0KCnZhciBzZWVuT2JqZWN0cyA9IG5ldyBfU2V0KCk7Ci8qKg0KICogUmVjdXJzaXZlbHkgdHJhdmVyc2UgYW4gb2JqZWN0IHRvIGV2b2tlIGFsbCBjb252ZXJ0ZWQNCiAqIGdldHRlcnMsIHNvIHRoYXQgZXZlcnkgbmVzdGVkIHByb3BlcnR5IGluc2lkZSB0aGUgb2JqZWN0DQogKiBpcyBjb2xsZWN0ZWQgYXMgYSAiZGVlcCIgZGVwZW5kZW5jeS4NCiAqLwoKZnVuY3Rpb24gdHJhdmVyc2UodmFsKSB7CiAgX3RyYXZlcnNlKHZhbCwgc2Vlbk9iamVjdHMpOwoKICBzZWVuT2JqZWN0cy5jbGVhcigpOwogIHJldHVybiB2YWw7Cn0KCmZ1bmN0aW9uIF90cmF2ZXJzZSh2YWwsIHNlZW4pIHsKICB2YXIgaSwga2V5czsKICB2YXIgaXNBID0gaXNBcnJheSh2YWwpOwoKICBpZiAoIWlzQSAmJiAhaXNPYmplY3QodmFsKSB8fCBPYmplY3QuaXNGcm96ZW4odmFsKSB8fCB2YWwgaW5zdGFuY2VvZiBWTm9kZSkgewogICAgcmV0dXJuOwogIH0KCiAgaWYgKHZhbC5fX29iX18pIHsKICAgIHZhciBkZXBJZCA9IHZhbC5fX29iX18uZGVwLmlkOwoKICAgIGlmIChzZWVuLmhhcyhkZXBJZCkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHNlZW4uYWRkKGRlcElkKTsKICB9CgogIGlmIChpc0EpIHsKICAgIGkgPSB2YWwubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIF90cmF2ZXJzZSh2YWxbaV0sIHNlZW4pOwogIH0gZWxzZSBpZiAoaXNSZWYodmFsKSkgewogICAgX3RyYXZlcnNlKHZhbC52YWx1ZSwgc2Vlbik7CiAgfSBlbHNlIHsKICAgIGtleXMgPSBPYmplY3Qua2V5cyh2YWwpOwogICAgaSA9IGtleXMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIF90cmF2ZXJzZSh2YWxba2V5c1tpXV0sIHNlZW4pOwogIH0KfQoKdmFyIHVpZCQxID0gMDsKLyoqDQogKiBBIHdhdGNoZXIgcGFyc2VzIGFuIGV4cHJlc3Npb24sIGNvbGxlY3RzIGRlcGVuZGVuY2llcywNCiAqIGFuZCBmaXJlcyBjYWxsYmFjayB3aGVuIHRoZSBleHByZXNzaW9uIHZhbHVlIGNoYW5nZXMuDQogKiBUaGlzIGlzIHVzZWQgZm9yIGJvdGggdGhlICR3YXRjaCgpIGFwaSBhbmQgZGlyZWN0aXZlcy4NCiAqIEBpbnRlcm5hbA0KICovCgp2YXIgV2F0Y2hlciA9Ci8qKiBAY2xhc3MgKi8KZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zLCBpc1JlbmRlcldhdGNoZXIpIHsKICAgIHJlY29yZEVmZmVjdFNjb3BlKHRoaXMsIC8vIGlmIHRoZSBhY3RpdmUgZWZmZWN0IHNjb3BlIGlzIG1hbnVhbGx5IGNyZWF0ZWQgKG5vdCBhIGNvbXBvbmVudCBzY29wZSksCiAgICAvLyBwcmlvcml0aXplIGl0CiAgICBhY3RpdmVFZmZlY3RTY29wZSAmJiAhYWN0aXZlRWZmZWN0U2NvcGUuX3ZtID8gYWN0aXZlRWZmZWN0U2NvcGUgOiB2bSA/IHZtLl9zY29wZSA6IHVuZGVmaW5lZCk7CgogICAgaWYgKCh0aGlzLnZtID0gdm0pICYmIGlzUmVuZGVyV2F0Y2hlcikgewogICAgICB2bS5fd2F0Y2hlciA9IHRoaXM7CiAgICB9IC8vIG9wdGlvbnMKCgogICAgaWYgKG9wdGlvbnMpIHsKICAgICAgdGhpcy5kZWVwID0gISFvcHRpb25zLmRlZXA7CiAgICAgIHRoaXMudXNlciA9ICEhb3B0aW9ucy51c2VyOwogICAgICB0aGlzLmxhenkgPSAhIW9wdGlvbnMubGF6eTsKICAgICAgdGhpcy5zeW5jID0gISFvcHRpb25zLnN5bmM7CiAgICAgIHRoaXMuYmVmb3JlID0gb3B0aW9ucy5iZWZvcmU7CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIHRoaXMub25UcmFjayA9IG9wdGlvbnMub25UcmFjazsKICAgICAgICB0aGlzLm9uVHJpZ2dlciA9IG9wdGlvbnMub25UcmlnZ2VyOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLmRlZXAgPSB0aGlzLnVzZXIgPSB0aGlzLmxhenkgPSB0aGlzLnN5bmMgPSBmYWxzZTsKICAgIH0KCiAgICB0aGlzLmNiID0gY2I7CiAgICB0aGlzLmlkID0gKyt1aWQkMTsgLy8gdWlkIGZvciBiYXRjaGluZwoKICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgIHRoaXMucG9zdCA9IGZhbHNlOwogICAgdGhpcy5kaXJ0eSA9IHRoaXMubGF6eTsgLy8gZm9yIGxhenkgd2F0Y2hlcnMKCiAgICB0aGlzLmRlcHMgPSBbXTsKICAgIHRoaXMubmV3RGVwcyA9IFtdOwogICAgdGhpcy5kZXBJZHMgPSBuZXcgX1NldCgpOwogICAgdGhpcy5uZXdEZXBJZHMgPSBuZXcgX1NldCgpOwogICAgdGhpcy5leHByZXNzaW9uID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IGV4cE9yRm4udG9TdHJpbmcoKSA6ICcnOyAvLyBwYXJzZSBleHByZXNzaW9uIGZvciBnZXR0ZXIKCiAgICBpZiAoaXNGdW5jdGlvbihleHBPckZuKSkgewogICAgICB0aGlzLmdldHRlciA9IGV4cE9yRm47CiAgICB9IGVsc2UgewogICAgICB0aGlzLmdldHRlciA9IHBhcnNlUGF0aChleHBPckZuKTsKCiAgICAgIGlmICghdGhpcy5nZXR0ZXIpIHsKICAgICAgICB0aGlzLmdldHRlciA9IG5vb3A7CiAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJGYWlsZWQgd2F0Y2hpbmcgcGF0aDogXCIiLmNvbmNhdChleHBPckZuLCAiXCIgIikgKyAnV2F0Y2hlciBvbmx5IGFjY2VwdHMgc2ltcGxlIGRvdC1kZWxpbWl0ZWQgcGF0aHMuICcgKyAnRm9yIGZ1bGwgY29udHJvbCwgdXNlIGEgZnVuY3Rpb24gaW5zdGVhZC4nLCB2bSk7CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnZhbHVlID0gdGhpcy5sYXp5ID8gdW5kZWZpbmVkIDogdGhpcy5nZXQoKTsKICB9CiAgLyoqDQogICAqIEV2YWx1YXRlIHRoZSBnZXR0ZXIsIGFuZCByZS1jb2xsZWN0IGRlcGVuZGVuY2llcy4NCiAgICovCgoKICBXYXRjaGVyLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAoKSB7CiAgICBwdXNoVGFyZ2V0KHRoaXMpOwogICAgdmFyIHZhbHVlOwogICAgdmFyIHZtID0gdGhpcy52bTsKCiAgICB0cnkgewogICAgICB2YWx1ZSA9IHRoaXMuZ2V0dGVyLmNhbGwodm0sIHZtKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKHRoaXMudXNlcikgewogICAgICAgIGhhbmRsZUVycm9yKGUsIHZtLCAiZ2V0dGVyIGZvciB3YXRjaGVyIFwiIi5jb25jYXQodGhpcy5leHByZXNzaW9uLCAiXCIiKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgZTsKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgLy8gInRvdWNoIiBldmVyeSBwcm9wZXJ0eSBzbyB0aGV5IGFyZSBhbGwgdHJhY2tlZCBhcwogICAgICAvLyBkZXBlbmRlbmNpZXMgZm9yIGRlZXAgd2F0Y2hpbmcKICAgICAgaWYgKHRoaXMuZGVlcCkgewogICAgICAgIHRyYXZlcnNlKHZhbHVlKTsKICAgICAgfQoKICAgICAgcG9wVGFyZ2V0KCk7CiAgICAgIHRoaXMuY2xlYW51cERlcHMoKTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICAvKioNCiAgICogQWRkIGEgZGVwZW5kZW5jeSB0byB0aGlzIGRpcmVjdGl2ZS4NCiAgICovCgoKICBXYXRjaGVyLnByb3RvdHlwZS5hZGREZXAgPSBmdW5jdGlvbiAoZGVwKSB7CiAgICB2YXIgaWQgPSBkZXAuaWQ7CgogICAgaWYgKCF0aGlzLm5ld0RlcElkcy5oYXMoaWQpKSB7CiAgICAgIHRoaXMubmV3RGVwSWRzLmFkZChpZCk7CiAgICAgIHRoaXMubmV3RGVwcy5wdXNoKGRlcCk7CgogICAgICBpZiAoIXRoaXMuZGVwSWRzLmhhcyhpZCkpIHsKICAgICAgICBkZXAuYWRkU3ViKHRoaXMpOwogICAgICB9CiAgICB9CiAgfTsKICAvKioNCiAgICogQ2xlYW4gdXAgZm9yIGRlcGVuZGVuY3kgY29sbGVjdGlvbi4NCiAgICovCgoKICBXYXRjaGVyLnByb3RvdHlwZS5jbGVhbnVwRGVwcyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpID0gdGhpcy5kZXBzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHZhciBkZXAgPSB0aGlzLmRlcHNbaV07CgogICAgICBpZiAoIXRoaXMubmV3RGVwSWRzLmhhcyhkZXAuaWQpKSB7CiAgICAgICAgZGVwLnJlbW92ZVN1Yih0aGlzKTsKICAgICAgfQogICAgfQoKICAgIHZhciB0bXAgPSB0aGlzLmRlcElkczsKICAgIHRoaXMuZGVwSWRzID0gdGhpcy5uZXdEZXBJZHM7CiAgICB0aGlzLm5ld0RlcElkcyA9IHRtcDsKICAgIHRoaXMubmV3RGVwSWRzLmNsZWFyKCk7CiAgICB0bXAgPSB0aGlzLmRlcHM7CiAgICB0aGlzLmRlcHMgPSB0aGlzLm5ld0RlcHM7CiAgICB0aGlzLm5ld0RlcHMgPSB0bXA7CiAgICB0aGlzLm5ld0RlcHMubGVuZ3RoID0gMDsKICB9OwogIC8qKg0KICAgKiBTdWJzY3JpYmVyIGludGVyZmFjZS4NCiAgICogV2lsbCBiZSBjYWxsZWQgd2hlbiBhIGRlcGVuZGVuY3kgY2hhbmdlcy4NCiAgICovCgoKICBXYXRjaGVyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgaWYgKHRoaXMubGF6eSkgewogICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAodGhpcy5zeW5jKSB7CiAgICAgIHRoaXMucnVuKCk7CiAgICB9IGVsc2UgewogICAgICBxdWV1ZVdhdGNoZXIodGhpcyk7CiAgICB9CiAgfTsKICAvKioNCiAgICogU2NoZWR1bGVyIGpvYiBpbnRlcmZhY2UuDQogICAqIFdpbGwgYmUgY2FsbGVkIGJ5IHRoZSBzY2hlZHVsZXIuDQogICAqLwoKCiAgV2F0Y2hlci5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CgogICAgICBpZiAodmFsdWUgIT09IHRoaXMudmFsdWUgfHwgLy8gRGVlcCB3YXRjaGVycyBhbmQgd2F0Y2hlcnMgb24gT2JqZWN0L0FycmF5cyBzaG91bGQgZmlyZSBldmVuCiAgICAgIC8vIHdoZW4gdGhlIHZhbHVlIGlzIHRoZSBzYW1lLCBiZWNhdXNlIHRoZSB2YWx1ZSBtYXkKICAgICAgLy8gaGF2ZSBtdXRhdGVkLgogICAgICBpc09iamVjdCh2YWx1ZSkgfHwgdGhpcy5kZWVwKSB7CiAgICAgICAgLy8gc2V0IG5ldyB2YWx1ZQogICAgICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMudmFsdWU7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwoKICAgICAgICBpZiAodGhpcy51c2VyKSB7CiAgICAgICAgICB2YXIgaW5mbyA9ICJjYWxsYmFjayBmb3Igd2F0Y2hlciBcIiIuY29uY2F0KHRoaXMuZXhwcmVzc2lvbiwgIlwiIik7CiAgICAgICAgICBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyh0aGlzLmNiLCB0aGlzLnZtLCBbdmFsdWUsIG9sZFZhbHVlXSwgdGhpcy52bSwgaW5mbyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY2IuY2FsbCh0aGlzLnZtLCB2YWx1ZSwgb2xkVmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CiAgLyoqDQogICAqIEV2YWx1YXRlIHRoZSB2YWx1ZSBvZiB0aGUgd2F0Y2hlci4NCiAgICogVGhpcyBvbmx5IGdldHMgY2FsbGVkIGZvciBsYXp5IHdhdGNoZXJzLg0KICAgKi8KCgogIFdhdGNoZXIucHJvdG90eXBlLmV2YWx1YXRlID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy52YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CiAgfTsKICAvKioNCiAgICogRGVwZW5kIG9uIGFsbCBkZXBzIGNvbGxlY3RlZCBieSB0aGlzIHdhdGNoZXIuDQogICAqLwoKCiAgV2F0Y2hlci5wcm90b3R5cGUuZGVwZW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGkgPSB0aGlzLmRlcHMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdGhpcy5kZXBzW2ldLmRlcGVuZCgpOwogICAgfQogIH07CiAgLyoqDQogICAqIFJlbW92ZSBzZWxmIGZyb20gYWxsIGRlcGVuZGVuY2llcycgc3Vic2NyaWJlciBsaXN0Lg0KICAgKi8KCgogIFdhdGNoZXIucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMudm0gJiYgIXRoaXMudm0uX2lzQmVpbmdEZXN0cm95ZWQpIHsKICAgICAgcmVtb3ZlJDIodGhpcy52bS5fc2NvcGUuZWZmZWN0cywgdGhpcyk7CiAgICB9CgogICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgIHZhciBpID0gdGhpcy5kZXBzLmxlbmd0aDsKCiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICB0aGlzLmRlcHNbaV0ucmVtb3ZlU3ViKHRoaXMpOwogICAgICB9CgogICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwoKICAgICAgaWYgKHRoaXMub25TdG9wKSB7CiAgICAgICAgdGhpcy5vblN0b3AoKTsKICAgICAgfQogICAgfQogIH07CgogIHJldHVybiBXYXRjaGVyOwp9KCk7Cgp2YXIgbWFyazsKdmFyIG1lYXN1cmU7CgppZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogIHZhciBwZXJmXzEgPSBpbkJyb3dzZXIgJiYgd2luZG93LnBlcmZvcm1hbmNlOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAocGVyZl8xICYmIC8vIEB0cy1pZ25vcmUKICBwZXJmXzEubWFyayAmJiAvLyBAdHMtaWdub3JlCiAgcGVyZl8xLm1lYXN1cmUgJiYgLy8gQHRzLWlnbm9yZQogIHBlcmZfMS5jbGVhck1hcmtzICYmIC8vIEB0cy1pZ25vcmUKICBwZXJmXzEuY2xlYXJNZWFzdXJlcykgewogICAgbWFyayA9IGZ1bmN0aW9uICh0YWcpIHsKICAgICAgcmV0dXJuIHBlcmZfMS5tYXJrKHRhZyk7CiAgICB9OwoKICAgIG1lYXN1cmUgPSBmdW5jdGlvbiAobmFtZSwgc3RhcnRUYWcsIGVuZFRhZykgewogICAgICBwZXJmXzEubWVhc3VyZShuYW1lLCBzdGFydFRhZywgZW5kVGFnKTsKICAgICAgcGVyZl8xLmNsZWFyTWFya3Moc3RhcnRUYWcpOwogICAgICBwZXJmXzEuY2xlYXJNYXJrcyhlbmRUYWcpOyAvLyBwZXJmLmNsZWFyTWVhc3VyZXMobmFtZSkKICAgIH07CiAgfQp9CgpmdW5jdGlvbiBpbml0RXZlbnRzKHZtKSB7CiAgdm0uX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdm0uX2hhc0hvb2tFdmVudCA9IGZhbHNlOyAvLyBpbml0IHBhcmVudCBhdHRhY2hlZCBldmVudHMKCiAgdmFyIGxpc3RlbmVycyA9IHZtLiRvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CgogIGlmIChsaXN0ZW5lcnMpIHsKICAgIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyh2bSwgbGlzdGVuZXJzKTsKICB9Cn0KCnZhciB0YXJnZXQkMTsKCmZ1bmN0aW9uIGFkZCQxKGV2ZW50LCBmbikgewogIHRhcmdldCQxLiRvbihldmVudCwgZm4pOwp9CgpmdW5jdGlvbiByZW1vdmUkMShldmVudCwgZm4pIHsKICB0YXJnZXQkMS4kb2ZmKGV2ZW50LCBmbik7Cn0KCmZ1bmN0aW9uIGNyZWF0ZU9uY2VIYW5kbGVyJDEoZXZlbnQsIGZuKSB7CiAgdmFyIF90YXJnZXQgPSB0YXJnZXQkMTsKICByZXR1cm4gZnVuY3Rpb24gb25jZUhhbmRsZXIoKSB7CiAgICB2YXIgcmVzID0gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKCiAgICBpZiAocmVzICE9PSBudWxsKSB7CiAgICAgIF90YXJnZXQuJG9mZihldmVudCwgb25jZUhhbmRsZXIpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyh2bSwgbGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMpIHsKICB0YXJnZXQkMSA9IHZtOwogIHVwZGF0ZUxpc3RlbmVycyhsaXN0ZW5lcnMsIG9sZExpc3RlbmVycyB8fCB7fSwgYWRkJDEsIHJlbW92ZSQxLCBjcmVhdGVPbmNlSGFuZGxlciQxLCB2bSk7CiAgdGFyZ2V0JDEgPSB1bmRlZmluZWQ7Cn0KCmZ1bmN0aW9uIGV2ZW50c01peGluKFZ1ZSkgewogIHZhciBob29rUkUgPSAvXmhvb2s6LzsKCiAgVnVlLnByb3RvdHlwZS4kb24gPSBmdW5jdGlvbiAoZXZlbnQsIGZuKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmIChpc0FycmF5KGV2ZW50KSkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGV2ZW50Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZtLiRvbihldmVudFtpXSwgZm4pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAodm0uX2V2ZW50c1tldmVudF0gfHwgKHZtLl9ldmVudHNbZXZlbnRdID0gW10pKS5wdXNoKGZuKTsgLy8gb3B0aW1pemUgaG9vazpldmVudCBjb3N0IGJ5IHVzaW5nIGEgYm9vbGVhbiBmbGFnIG1hcmtlZCBhdCByZWdpc3RyYXRpb24KICAgICAgLy8gaW5zdGVhZCBvZiBhIGhhc2ggbG9va3VwCgogICAgICBpZiAoaG9va1JFLnRlc3QoZXZlbnQpKSB7CiAgICAgICAgdm0uX2hhc0hvb2tFdmVudCA9IHRydWU7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdm07CiAgfTsKCiAgVnVlLnByb3RvdHlwZS4kb25jZSA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgIHZhciB2bSA9IHRoaXM7CgogICAgZnVuY3Rpb24gb24oKSB7CiAgICAgIHZtLiRvZmYoZXZlbnQsIG9uKTsKICAgICAgZm4uYXBwbHkodm0sIGFyZ3VtZW50cyk7CiAgICB9CgogICAgb24uZm4gPSBmbjsKICAgIHZtLiRvbihldmVudCwgb24pOwogICAgcmV0dXJuIHZtOwogIH07CgogIFZ1ZS5wcm90b3R5cGUuJG9mZiA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgIHZhciB2bSA9IHRoaXM7IC8vIGFsbAoKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICB2bS5fZXZlbnRzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgcmV0dXJuIHZtOwogICAgfSAvLyBhcnJheSBvZiBldmVudHMKCgogICAgaWYgKGlzQXJyYXkoZXZlbnQpKSB7CiAgICAgIGZvciAodmFyIGlfMSA9IDAsIGwgPSBldmVudC5sZW5ndGg7IGlfMSA8IGw7IGlfMSsrKSB7CiAgICAgICAgdm0uJG9mZihldmVudFtpXzFdLCBmbik7CiAgICAgIH0KCiAgICAgIHJldHVybiB2bTsKICAgIH0gLy8gc3BlY2lmaWMgZXZlbnQKCgogICAgdmFyIGNicyA9IHZtLl9ldmVudHNbZXZlbnRdOwoKICAgIGlmICghY2JzKSB7CiAgICAgIHJldHVybiB2bTsKICAgIH0KCiAgICBpZiAoIWZuKSB7CiAgICAgIHZtLl9ldmVudHNbZXZlbnRdID0gbnVsbDsKICAgICAgcmV0dXJuIHZtOwogICAgfSAvLyBzcGVjaWZpYyBoYW5kbGVyCgoKICAgIHZhciBjYjsKICAgIHZhciBpID0gY2JzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIGNiID0gY2JzW2ldOwoKICAgICAgaWYgKGNiID09PSBmbiB8fCBjYi5mbiA9PT0gZm4pIHsKICAgICAgICBjYnMuc3BsaWNlKGksIDEpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHZtOwogIH07CgogIFZ1ZS5wcm90b3R5cGUuJGVtaXQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIHZhciB2bSA9IHRoaXM7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgdmFyIGxvd2VyQ2FzZUV2ZW50ID0gZXZlbnQudG9Mb3dlckNhc2UoKTsKCiAgICAgIGlmIChsb3dlckNhc2VFdmVudCAhPT0gZXZlbnQgJiYgdm0uX2V2ZW50c1tsb3dlckNhc2VFdmVudF0pIHsKICAgICAgICB0aXAoIkV2ZW50IFwiIi5jb25jYXQobG93ZXJDYXNlRXZlbnQsICJcIiBpcyBlbWl0dGVkIGluIGNvbXBvbmVudCAiKSArICIiLmNvbmNhdChmb3JtYXRDb21wb25lbnROYW1lKHZtKSwgIiBidXQgdGhlIGhhbmRsZXIgaXMgcmVnaXN0ZXJlZCBmb3IgXCIiKS5jb25jYXQoZXZlbnQsICJcIi4gIikgKyAiTm90ZSB0aGF0IEhUTUwgYXR0cmlidXRlcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZSBhbmQgeW91IGNhbm5vdCB1c2UgIiArICJ2LW9uIHRvIGxpc3RlbiB0byBjYW1lbENhc2UgZXZlbnRzIHdoZW4gdXNpbmcgaW4tRE9NIHRlbXBsYXRlcy4gIiArICJZb3Ugc2hvdWxkIHByb2JhYmx5IHVzZSBcIiIuY29uY2F0KGh5cGhlbmF0ZShldmVudCksICJcIiBpbnN0ZWFkIG9mIFwiIikuY29uY2F0KGV2ZW50LCAiXCIuIikpOwogICAgICB9CiAgICB9CgogICAgdmFyIGNicyA9IHZtLl9ldmVudHNbZXZlbnRdOwoKICAgIGlmIChjYnMpIHsKICAgICAgY2JzID0gY2JzLmxlbmd0aCA+IDEgPyB0b0FycmF5KGNicykgOiBjYnM7CiAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMsIDEpOwogICAgICB2YXIgaW5mbyA9ICJldmVudCBoYW5kbGVyIGZvciBcIiIuY29uY2F0KGV2ZW50LCAiXCIiKTsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2JzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGNic1tpXSwgdm0sIGFyZ3MsIHZtLCBpbmZvKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB2bTsKICB9Owp9Cgp2YXIgYWN0aXZlSW5zdGFuY2UgPSBudWxsOwp2YXIgaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ID0gZmFsc2U7CgpmdW5jdGlvbiBzZXRBY3RpdmVJbnN0YW5jZSh2bSkgewogIHZhciBwcmV2QWN0aXZlSW5zdGFuY2UgPSBhY3RpdmVJbnN0YW5jZTsKICBhY3RpdmVJbnN0YW5jZSA9IHZtOwogIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICBhY3RpdmVJbnN0YW5jZSA9IHByZXZBY3RpdmVJbnN0YW5jZTsKICB9Owp9CgpmdW5jdGlvbiBpbml0TGlmZWN5Y2xlKHZtKSB7CiAgdmFyIG9wdGlvbnMgPSB2bS4kb3B0aW9uczsgLy8gbG9jYXRlIGZpcnN0IG5vbi1hYnN0cmFjdCBwYXJlbnQKCiAgdmFyIHBhcmVudCA9IG9wdGlvbnMucGFyZW50OwoKICBpZiAocGFyZW50ICYmICFvcHRpb25zLmFic3RyYWN0KSB7CiAgICB3aGlsZSAocGFyZW50LiRvcHRpb25zLmFic3RyYWN0ICYmIHBhcmVudC4kcGFyZW50KSB7CiAgICAgIHBhcmVudCA9IHBhcmVudC4kcGFyZW50OwogICAgfQoKICAgIHBhcmVudC4kY2hpbGRyZW4ucHVzaCh2bSk7CiAgfQoKICB2bS4kcGFyZW50ID0gcGFyZW50OwogIHZtLiRyb290ID0gcGFyZW50ID8gcGFyZW50LiRyb290IDogdm07CiAgdm0uJGNoaWxkcmVuID0gW107CiAgdm0uJHJlZnMgPSB7fTsKICB2bS5fcHJvdmlkZWQgPSBwYXJlbnQgPyBwYXJlbnQuX3Byb3ZpZGVkIDogT2JqZWN0LmNyZWF0ZShudWxsKTsKICB2bS5fd2F0Y2hlciA9IG51bGw7CiAgdm0uX2luYWN0aXZlID0gbnVsbDsKICB2bS5fZGlyZWN0SW5hY3RpdmUgPSBmYWxzZTsKICB2bS5faXNNb3VudGVkID0gZmFsc2U7CiAgdm0uX2lzRGVzdHJveWVkID0gZmFsc2U7CiAgdm0uX2lzQmVpbmdEZXN0cm95ZWQgPSBmYWxzZTsKfQoKZnVuY3Rpb24gbGlmZWN5Y2xlTWl4aW4oVnVlKSB7CiAgVnVlLnByb3RvdHlwZS5fdXBkYXRlID0gZnVuY3Rpb24gKHZub2RlLCBoeWRyYXRpbmcpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB2YXIgcHJldkVsID0gdm0uJGVsOwogICAgdmFyIHByZXZWbm9kZSA9IHZtLl92bm9kZTsKICAgIHZhciByZXN0b3JlQWN0aXZlSW5zdGFuY2UgPSBzZXRBY3RpdmVJbnN0YW5jZSh2bSk7CiAgICB2bS5fdm5vZGUgPSB2bm9kZTsgLy8gVnVlLnByb3RvdHlwZS5fX3BhdGNoX18gaXMgaW5qZWN0ZWQgaW4gZW50cnkgcG9pbnRzCiAgICAvLyBiYXNlZCBvbiB0aGUgcmVuZGVyaW5nIGJhY2tlbmQgdXNlZC4KCiAgICBpZiAoIXByZXZWbm9kZSkgewogICAgICAvLyBpbml0aWFsIHJlbmRlcgogICAgICB2bS4kZWwgPSB2bS5fX3BhdGNoX18odm0uJGVsLCB2bm9kZSwgaHlkcmF0aW5nLCBmYWxzZQogICAgICAvKiByZW1vdmVPbmx5ICovCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICAvLyB1cGRhdGVzCiAgICAgIHZtLiRlbCA9IHZtLl9fcGF0Y2hfXyhwcmV2Vm5vZGUsIHZub2RlKTsKICAgIH0KCiAgICByZXN0b3JlQWN0aXZlSW5zdGFuY2UoKTsgLy8gdXBkYXRlIF9fdnVlX18gcmVmZXJlbmNlCgogICAgaWYgKHByZXZFbCkgewogICAgICBwcmV2RWwuX192dWVfXyA9IG51bGw7CiAgICB9CgogICAgaWYgKHZtLiRlbCkgewogICAgICB2bS4kZWwuX192dWVfXyA9IHZtOwogICAgfSAvLyBpZiBwYXJlbnQgaXMgYW4gSE9DLCB1cGRhdGUgaXRzICRlbCBhcyB3ZWxsCgoKICAgIHZhciB3cmFwcGVyID0gdm07CgogICAgd2hpbGUgKHdyYXBwZXIgJiYgd3JhcHBlci4kdm5vZGUgJiYgd3JhcHBlci4kcGFyZW50ICYmIHdyYXBwZXIuJHZub2RlID09PSB3cmFwcGVyLiRwYXJlbnQuX3Zub2RlKSB7CiAgICAgIHdyYXBwZXIuJHBhcmVudC4kZWwgPSB3cmFwcGVyLiRlbDsKICAgICAgd3JhcHBlciA9IHdyYXBwZXIuJHBhcmVudDsKICAgIH0gLy8gdXBkYXRlZCBob29rIGlzIGNhbGxlZCBieSB0aGUgc2NoZWR1bGVyIHRvIGVuc3VyZSB0aGF0IGNoaWxkcmVuIGFyZQogICAgLy8gdXBkYXRlZCBpbiBhIHBhcmVudCdzIHVwZGF0ZWQgaG9vay4KCiAgfTsKCiAgVnVlLnByb3RvdHlwZS4kZm9yY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmICh2bS5fd2F0Y2hlcikgewogICAgICB2bS5fd2F0Y2hlci51cGRhdGUoKTsKICAgIH0KICB9OwoKICBWdWUucHJvdG90eXBlLiRkZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBpZiAodm0uX2lzQmVpbmdEZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNhbGxIb29rJDEodm0sICdiZWZvcmVEZXN0cm95Jyk7CiAgICB2bS5faXNCZWluZ0Rlc3Ryb3llZCA9IHRydWU7IC8vIHJlbW92ZSBzZWxmIGZyb20gcGFyZW50CgogICAgdmFyIHBhcmVudCA9IHZtLiRwYXJlbnQ7CgogICAgaWYgKHBhcmVudCAmJiAhcGFyZW50Ll9pc0JlaW5nRGVzdHJveWVkICYmICF2bS4kb3B0aW9ucy5hYnN0cmFjdCkgewogICAgICByZW1vdmUkMihwYXJlbnQuJGNoaWxkcmVuLCB2bSk7CiAgICB9IC8vIHRlYXJkb3duIHNjb3BlLiB0aGlzIGluY2x1ZGVzIGJvdGggdGhlIHJlbmRlciB3YXRjaGVyIGFuZCBvdGhlcgogICAgLy8gd2F0Y2hlcnMgY3JlYXRlZAoKCiAgICB2bS5fc2NvcGUuc3RvcCgpOyAvLyByZW1vdmUgcmVmZXJlbmNlIGZyb20gZGF0YSBvYgogICAgLy8gZnJvemVuIG9iamVjdCBtYXkgbm90IGhhdmUgb2JzZXJ2ZXIuCgoKICAgIGlmICh2bS5fZGF0YS5fX29iX18pIHsKICAgICAgdm0uX2RhdGEuX19vYl9fLnZtQ291bnQtLTsKICAgIH0gLy8gY2FsbCB0aGUgbGFzdCBob29rLi4uCgoKICAgIHZtLl9pc0Rlc3Ryb3llZCA9IHRydWU7IC8vIGludm9rZSBkZXN0cm95IGhvb2tzIG9uIGN1cnJlbnQgcmVuZGVyZWQgdHJlZQoKICAgIHZtLl9fcGF0Y2hfXyh2bS5fdm5vZGUsIG51bGwpOyAvLyBmaXJlIGRlc3Ryb3llZCBob29rCgoKICAgIGNhbGxIb29rJDEodm0sICdkZXN0cm95ZWQnKTsgLy8gdHVybiBvZmYgYWxsIGluc3RhbmNlIGxpc3RlbmVycy4KCiAgICB2bS4kb2ZmKCk7IC8vIHJlbW92ZSBfX3Z1ZV9fIHJlZmVyZW5jZQoKICAgIGlmICh2bS4kZWwpIHsKICAgICAgdm0uJGVsLl9fdnVlX18gPSBudWxsOwogICAgfSAvLyByZWxlYXNlIGNpcmN1bGFyIHJlZmVyZW5jZSAoIzY3NTkpCgoKICAgIGlmICh2bS4kdm5vZGUpIHsKICAgICAgdm0uJHZub2RlLnBhcmVudCA9IG51bGw7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gbW91bnRDb21wb25lbnQodm0sIGVsLCBoeWRyYXRpbmcpIHsKICB2bS4kZWwgPSBlbDsKCiAgaWYgKCF2bS4kb3B0aW9ucy5yZW5kZXIpIHsKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgaW52YWxpZCB0eXBlCiAgICB2bS4kb3B0aW9ucy5yZW5kZXIgPSBjcmVhdGVFbXB0eVZOb2RlOwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAodm0uJG9wdGlvbnMudGVtcGxhdGUgJiYgdm0uJG9wdGlvbnMudGVtcGxhdGUuY2hhckF0KDApICE9PSAnIycgfHwgdm0uJG9wdGlvbnMuZWwgfHwgZWwpIHsKICAgICAgICB3YXJuKCdZb3UgYXJlIHVzaW5nIHRoZSBydW50aW1lLW9ubHkgYnVpbGQgb2YgVnVlIHdoZXJlIHRoZSB0ZW1wbGF0ZSAnICsgJ2NvbXBpbGVyIGlzIG5vdCBhdmFpbGFibGUuIEVpdGhlciBwcmUtY29tcGlsZSB0aGUgdGVtcGxhdGVzIGludG8gJyArICdyZW5kZXIgZnVuY3Rpb25zLCBvciB1c2UgdGhlIGNvbXBpbGVyLWluY2x1ZGVkIGJ1aWxkLicsIHZtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3YXJuKCdGYWlsZWQgdG8gbW91bnQgY29tcG9uZW50OiB0ZW1wbGF0ZSBvciByZW5kZXIgZnVuY3Rpb24gbm90IGRlZmluZWQuJywgdm0pOwogICAgICB9CiAgICB9CiAgfQoKICBjYWxsSG9vayQxKHZtLCAnYmVmb3JlTW91bnQnKTsKICB2YXIgdXBkYXRlQ29tcG9uZW50OwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgdXBkYXRlQ29tcG9uZW50ID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgbmFtZSA9IHZtLl9uYW1lOwogICAgICB2YXIgaWQgPSB2bS5fdWlkOwogICAgICB2YXIgc3RhcnRUYWcgPSAidnVlLXBlcmYtc3RhcnQ6Ii5jb25jYXQoaWQpOwogICAgICB2YXIgZW5kVGFnID0gInZ1ZS1wZXJmLWVuZDoiLmNvbmNhdChpZCk7CiAgICAgIG1hcmsoc3RhcnRUYWcpOwoKICAgICAgdmFyIHZub2RlID0gdm0uX3JlbmRlcigpOwoKICAgICAgbWFyayhlbmRUYWcpOwogICAgICBtZWFzdXJlKCJ2dWUgIi5jb25jYXQobmFtZSwgIiByZW5kZXIiKSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICAgIG1hcmsoc3RhcnRUYWcpOwoKICAgICAgdm0uX3VwZGF0ZSh2bm9kZSwgaHlkcmF0aW5nKTsKCiAgICAgIG1hcmsoZW5kVGFnKTsKICAgICAgbWVhc3VyZSgidnVlICIuY29uY2F0KG5hbWUsICIgcGF0Y2giKSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICB9OwogIH0gZWxzZSB7CiAgICB1cGRhdGVDb21wb25lbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZtLl91cGRhdGUodm0uX3JlbmRlcigpLCBoeWRyYXRpbmcpOwogICAgfTsKICB9CgogIHZhciB3YXRjaGVyT3B0aW9ucyA9IHsKICAgIGJlZm9yZTogZnVuY3Rpb24gKCkgewogICAgICBpZiAodm0uX2lzTW91bnRlZCAmJiAhdm0uX2lzRGVzdHJveWVkKSB7CiAgICAgICAgY2FsbEhvb2skMSh2bSwgJ2JlZm9yZVVwZGF0ZScpOwogICAgICB9CiAgICB9CiAgfTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhdGNoZXJPcHRpb25zLm9uVHJhY2sgPSBmdW5jdGlvbiAoZSkgewogICAgICByZXR1cm4gY2FsbEhvb2skMSh2bSwgJ3JlbmRlclRyYWNrZWQnLCBbZV0pOwogICAgfTsKCiAgICB3YXRjaGVyT3B0aW9ucy5vblRyaWdnZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICByZXR1cm4gY2FsbEhvb2skMSh2bSwgJ3JlbmRlclRyaWdnZXJlZCcsIFtlXSk7CiAgICB9OwogIH0gLy8gd2Ugc2V0IHRoaXMgdG8gdm0uX3dhdGNoZXIgaW5zaWRlIHRoZSB3YXRjaGVyJ3MgY29uc3RydWN0b3IKICAvLyBzaW5jZSB0aGUgd2F0Y2hlcidzIGluaXRpYWwgcGF0Y2ggbWF5IGNhbGwgJGZvcmNlVXBkYXRlIChlLmcuIGluc2lkZSBjaGlsZAogIC8vIGNvbXBvbmVudCdzIG1vdW50ZWQgaG9vayksIHdoaWNoIHJlbGllcyBvbiB2bS5fd2F0Y2hlciBiZWluZyBhbHJlYWR5IGRlZmluZWQKCgogIG5ldyBXYXRjaGVyKHZtLCB1cGRhdGVDb21wb25lbnQsIG5vb3AsIHdhdGNoZXJPcHRpb25zLCB0cnVlCiAgLyogaXNSZW5kZXJXYXRjaGVyICovCiAgKTsKICBoeWRyYXRpbmcgPSBmYWxzZTsgLy8gZmx1c2ggYnVmZmVyIGZvciBmbHVzaDogInByZSIgd2F0Y2hlcnMgcXVldWVkIGluIHNldHVwKCkKCiAgdmFyIHByZVdhdGNoZXJzID0gdm0uX3ByZVdhdGNoZXJzOwoKICBpZiAocHJlV2F0Y2hlcnMpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJlV2F0Y2hlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgcHJlV2F0Y2hlcnNbaV0ucnVuKCk7CiAgICB9CiAgfSAvLyBtYW51YWxseSBtb3VudGVkIGluc3RhbmNlLCBjYWxsIG1vdW50ZWQgb24gc2VsZgogIC8vIG1vdW50ZWQgaXMgY2FsbGVkIGZvciByZW5kZXItY3JlYXRlZCBjaGlsZCBjb21wb25lbnRzIGluIGl0cyBpbnNlcnRlZCBob29rCgoKICBpZiAodm0uJHZub2RlID09IG51bGwpIHsKICAgIHZtLl9pc01vdW50ZWQgPSB0cnVlOwogICAgY2FsbEhvb2skMSh2bSwgJ21vdW50ZWQnKTsKICB9CgogIHJldHVybiB2bTsKfQoKZnVuY3Rpb24gdXBkYXRlQ2hpbGRDb21wb25lbnQodm0sIHByb3BzRGF0YSwgbGlzdGVuZXJzLCBwYXJlbnRWbm9kZSwgcmVuZGVyQ2hpbGRyZW4pIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ID0gdHJ1ZTsKICB9IC8vIGRldGVybWluZSB3aGV0aGVyIGNvbXBvbmVudCBoYXMgc2xvdCBjaGlsZHJlbgogIC8vIHdlIG5lZWQgdG8gZG8gdGhpcyBiZWZvcmUgb3ZlcndyaXRpbmcgJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuLgogIC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBkeW5hbWljIHNjb3BlZFNsb3RzIChoYW5kLXdyaXR0ZW4gb3IgY29tcGlsZWQgYnV0IHdpdGgKICAvLyBkeW5hbWljIHNsb3QgbmFtZXMpLiBTdGF0aWMgc2NvcGVkIHNsb3RzIGNvbXBpbGVkIGZyb20gdGVtcGxhdGUgaGFzIHRoZQogIC8vICIkc3RhYmxlIiBtYXJrZXIuCgoKICB2YXIgbmV3U2NvcGVkU2xvdHMgPSBwYXJlbnRWbm9kZS5kYXRhLnNjb3BlZFNsb3RzOwogIHZhciBvbGRTY29wZWRTbG90cyA9IHZtLiRzY29wZWRTbG90czsKICB2YXIgaGFzRHluYW1pY1Njb3BlZFNsb3QgPSAhIShuZXdTY29wZWRTbG90cyAmJiAhbmV3U2NvcGVkU2xvdHMuJHN0YWJsZSB8fCBvbGRTY29wZWRTbG90cyAhPT0gZW1wdHlPYmplY3QgJiYgIW9sZFNjb3BlZFNsb3RzLiRzdGFibGUgfHwgbmV3U2NvcGVkU2xvdHMgJiYgdm0uJHNjb3BlZFNsb3RzLiRrZXkgIT09IG5ld1Njb3BlZFNsb3RzLiRrZXkgfHwgIW5ld1Njb3BlZFNsb3RzICYmIHZtLiRzY29wZWRTbG90cy4ka2V5KTsgLy8gQW55IHN0YXRpYyBzbG90IGNoaWxkcmVuIGZyb20gdGhlIHBhcmVudCBtYXkgaGF2ZSBjaGFuZ2VkIGR1cmluZyBwYXJlbnQncwogIC8vIHVwZGF0ZS4gRHluYW1pYyBzY29wZWQgc2xvdHMgbWF5IGFsc28gaGF2ZSBjaGFuZ2VkLiBJbiBzdWNoIGNhc2VzLCBhIGZvcmNlZAogIC8vIHVwZGF0ZSBpcyBuZWNlc3NhcnkgdG8gZW5zdXJlIGNvcnJlY3RuZXNzLgoKICB2YXIgbmVlZHNGb3JjZVVwZGF0ZSA9ICEhKHJlbmRlckNoaWxkcmVuIHx8IC8vIGhhcyBuZXcgc3RhdGljIHNsb3RzCiAgdm0uJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuIHx8IC8vIGhhcyBvbGQgc3RhdGljIHNsb3RzCiAgaGFzRHluYW1pY1Njb3BlZFNsb3QpOwogIHZhciBwcmV2Vk5vZGUgPSB2bS4kdm5vZGU7CiAgdm0uJG9wdGlvbnMuX3BhcmVudFZub2RlID0gcGFyZW50Vm5vZGU7CiAgdm0uJHZub2RlID0gcGFyZW50Vm5vZGU7IC8vIHVwZGF0ZSB2bSdzIHBsYWNlaG9sZGVyIG5vZGUgd2l0aG91dCByZS1yZW5kZXIKCiAgaWYgKHZtLl92bm9kZSkgewogICAgLy8gdXBkYXRlIGNoaWxkIHRyZWUncyBwYXJlbnQKICAgIHZtLl92bm9kZS5wYXJlbnQgPSBwYXJlbnRWbm9kZTsKICB9CgogIHZtLiRvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiA9IHJlbmRlckNoaWxkcmVuOyAvLyB1cGRhdGUgJGF0dHJzIGFuZCAkbGlzdGVuZXJzIGhhc2gKICAvLyB0aGVzZSBhcmUgYWxzbyByZWFjdGl2ZSBzbyB0aGV5IG1heSB0cmlnZ2VyIGNoaWxkIHVwZGF0ZSBpZiB0aGUgY2hpbGQKICAvLyB1c2VkIHRoZW0gZHVyaW5nIHJlbmRlcgoKICB2YXIgYXR0cnMgPSBwYXJlbnRWbm9kZS5kYXRhLmF0dHJzIHx8IGVtcHR5T2JqZWN0OwoKICBpZiAodm0uX2F0dHJzUHJveHkpIHsKICAgIC8vIGZvcmNlIHVwZGF0ZSBpZiBhdHRycyBhcmUgYWNjZXNzZWQgYW5kIGhhcyBjaGFuZ2VkIHNpbmNlIGl0IG1heSBiZQogICAgLy8gcGFzc2VkIHRvIGEgY2hpbGQgY29tcG9uZW50LgogICAgaWYgKHN5bmNTZXR1cFByb3h5KHZtLl9hdHRyc1Byb3h5LCBhdHRycywgcHJldlZOb2RlLmRhdGEgJiYgcHJldlZOb2RlLmRhdGEuYXR0cnMgfHwgZW1wdHlPYmplY3QsIHZtLCAnJGF0dHJzJykpIHsKICAgICAgbmVlZHNGb3JjZVVwZGF0ZSA9IHRydWU7CiAgICB9CiAgfQoKICB2bS4kYXR0cnMgPSBhdHRyczsgLy8gdXBkYXRlIGxpc3RlbmVycwoKICBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMgfHwgZW1wdHlPYmplY3Q7CiAgdmFyIHByZXZMaXN0ZW5lcnMgPSB2bS4kb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzOwoKICBpZiAodm0uX2xpc3RlbmVyc1Byb3h5KSB7CiAgICBzeW5jU2V0dXBQcm94eSh2bS5fbGlzdGVuZXJzUHJveHksIGxpc3RlbmVycywgcHJldkxpc3RlbmVycyB8fCBlbXB0eU9iamVjdCwgdm0sICckbGlzdGVuZXJzJyk7CiAgfQoKICB2bS4kbGlzdGVuZXJzID0gdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyA9IGxpc3RlbmVyczsKICB1cGRhdGVDb21wb25lbnRMaXN0ZW5lcnModm0sIGxpc3RlbmVycywgcHJldkxpc3RlbmVycyk7IC8vIHVwZGF0ZSBwcm9wcwoKICBpZiAocHJvcHNEYXRhICYmIHZtLiRvcHRpb25zLnByb3BzKSB7CiAgICB0b2dnbGVPYnNlcnZpbmcoZmFsc2UpOwogICAgdmFyIHByb3BzID0gdm0uX3Byb3BzOwogICAgdmFyIHByb3BLZXlzID0gdm0uJG9wdGlvbnMuX3Byb3BLZXlzIHx8IFtdOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcEtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGtleSA9IHByb3BLZXlzW2ldOwogICAgICB2YXIgcHJvcE9wdGlvbnMgPSB2bS4kb3B0aW9ucy5wcm9wczsgLy8gd3RmIGZsb3c/CgogICAgICBwcm9wc1trZXldID0gdmFsaWRhdGVQcm9wKGtleSwgcHJvcE9wdGlvbnMsIHByb3BzRGF0YSwgdm0pOwogICAgfQoKICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsgLy8ga2VlcCBhIGNvcHkgb2YgcmF3IHByb3BzRGF0YQoKICAgIHZtLiRvcHRpb25zLnByb3BzRGF0YSA9IHByb3BzRGF0YTsKICB9IC8vIHJlc29sdmUgc2xvdHMgKyBmb3JjZSB1cGRhdGUgaWYgaGFzIGNoaWxkcmVuCgoKICBpZiAobmVlZHNGb3JjZVVwZGF0ZSkgewogICAgdm0uJHNsb3RzID0gcmVzb2x2ZVNsb3RzKHJlbmRlckNoaWxkcmVuLCBwYXJlbnRWbm9kZS5jb250ZXh0KTsKICAgIHZtLiRmb3JjZVVwZGF0ZSgpOwogIH0KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCA9IGZhbHNlOwogIH0KfQoKZnVuY3Rpb24gaXNJbkluYWN0aXZlVHJlZSh2bSkgewogIHdoaWxlICh2bSAmJiAodm0gPSB2bS4kcGFyZW50KSkgewogICAgaWYgKHZtLl9pbmFjdGl2ZSkgcmV0dXJuIHRydWU7CiAgfQoKICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGFjdGl2YXRlQ2hpbGRDb21wb25lbnQodm0sIGRpcmVjdCkgewogIGlmIChkaXJlY3QpIHsKICAgIHZtLl9kaXJlY3RJbmFjdGl2ZSA9IGZhbHNlOwoKICAgIGlmIChpc0luSW5hY3RpdmVUcmVlKHZtKSkgewogICAgICByZXR1cm47CiAgICB9CiAgfSBlbHNlIGlmICh2bS5fZGlyZWN0SW5hY3RpdmUpIHsKICAgIHJldHVybjsKICB9CgogIGlmICh2bS5faW5hY3RpdmUgfHwgdm0uX2luYWN0aXZlID09PSBudWxsKSB7CiAgICB2bS5faW5hY3RpdmUgPSBmYWxzZTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZtLiRjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLiRjaGlsZHJlbltpXSk7CiAgICB9CgogICAgY2FsbEhvb2skMSh2bSwgJ2FjdGl2YXRlZCcpOwogIH0KfQoKZnVuY3Rpb24gZGVhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLCBkaXJlY3QpIHsKICBpZiAoZGlyZWN0KSB7CiAgICB2bS5fZGlyZWN0SW5hY3RpdmUgPSB0cnVlOwoKICAgIGlmIChpc0luSW5hY3RpdmVUcmVlKHZtKSkgewogICAgICByZXR1cm47CiAgICB9CiAgfQoKICBpZiAoIXZtLl9pbmFjdGl2ZSkgewogICAgdm0uX2luYWN0aXZlID0gdHJ1ZTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZtLiRjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQodm0uJGNoaWxkcmVuW2ldKTsKICAgIH0KCiAgICBjYWxsSG9vayQxKHZtLCAnZGVhY3RpdmF0ZWQnKTsKICB9Cn0KCmZ1bmN0aW9uIGNhbGxIb29rJDEodm0sIGhvb2ssIGFyZ3MsIHNldENvbnRleHQpIHsKICBpZiAoc2V0Q29udGV4dCA9PT0gdm9pZCAwKSB7CiAgICBzZXRDb250ZXh0ID0gdHJ1ZTsKICB9IC8vICM3NTczIGRpc2FibGUgZGVwIGNvbGxlY3Rpb24gd2hlbiBpbnZva2luZyBsaWZlY3ljbGUgaG9va3MKCgogIHB1c2hUYXJnZXQoKTsKICB2YXIgcHJldiA9IGN1cnJlbnRJbnN0YW5jZTsKICBzZXRDb250ZXh0ICYmIHNldEN1cnJlbnRJbnN0YW5jZSh2bSk7CiAgdmFyIGhhbmRsZXJzID0gdm0uJG9wdGlvbnNbaG9va107CiAgdmFyIGluZm8gPSAiIi5jb25jYXQoaG9vaywgIiBob29rIik7CgogIGlmIChoYW5kbGVycykgewogICAgZm9yICh2YXIgaSA9IDAsIGogPSBoYW5kbGVycy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoaGFuZGxlcnNbaV0sIHZtLCBhcmdzIHx8IG51bGwsIHZtLCBpbmZvKTsKICAgIH0KICB9CgogIGlmICh2bS5faGFzSG9va0V2ZW50KSB7CiAgICB2bS4kZW1pdCgnaG9vazonICsgaG9vayk7CiAgfQoKICBzZXRDb250ZXh0ICYmIHNldEN1cnJlbnRJbnN0YW5jZShwcmV2KTsKICBwb3BUYXJnZXQoKTsKfQoKdmFyIE1BWF9VUERBVEVfQ09VTlQgPSAxMDA7CnZhciBxdWV1ZSA9IFtdOwp2YXIgYWN0aXZhdGVkQ2hpbGRyZW4gPSBbXTsKdmFyIGhhcyA9IHt9Owp2YXIgY2lyY3VsYXIgPSB7fTsKdmFyIHdhaXRpbmcgPSBmYWxzZTsKdmFyIGZsdXNoaW5nID0gZmFsc2U7CnZhciBpbmRleCA9IDA7Ci8qKg0KICogUmVzZXQgdGhlIHNjaGVkdWxlcidzIHN0YXRlLg0KICovCgpmdW5jdGlvbiByZXNldFNjaGVkdWxlclN0YXRlKCkgewogIGluZGV4ID0gcXVldWUubGVuZ3RoID0gYWN0aXZhdGVkQ2hpbGRyZW4ubGVuZ3RoID0gMDsKICBoYXMgPSB7fTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGNpcmN1bGFyID0ge307CiAgfQoKICB3YWl0aW5nID0gZmx1c2hpbmcgPSBmYWxzZTsKfSAvLyBBc3luYyBlZGdlIGNhc2UgIzY1NjYgcmVxdWlyZXMgc2F2aW5nIHRoZSB0aW1lc3RhbXAgd2hlbiBldmVudCBsaXN0ZW5lcnMgYXJlCi8vIGF0dGFjaGVkLiBIb3dldmVyLCBjYWxsaW5nIHBlcmZvcm1hbmNlLm5vdygpIGhhcyBhIHBlcmYgb3ZlcmhlYWQgZXNwZWNpYWxseQovLyBpZiB0aGUgcGFnZSBoYXMgdGhvdXNhbmRzIG9mIGV2ZW50IGxpc3RlbmVycy4gSW5zdGVhZCwgd2UgdGFrZSBhIHRpbWVzdGFtcAovLyBldmVyeSB0aW1lIHRoZSBzY2hlZHVsZXIgZmx1c2hlcyBhbmQgdXNlIHRoYXQgZm9yIGFsbCBldmVudCBsaXN0ZW5lcnMKLy8gYXR0YWNoZWQgZHVyaW5nIHRoYXQgZmx1c2guCgoKdmFyIGN1cnJlbnRGbHVzaFRpbWVzdGFtcCA9IDA7IC8vIEFzeW5jIGVkZ2UgY2FzZSBmaXggcmVxdWlyZXMgc3RvcmluZyBhbiBldmVudCBsaXN0ZW5lcidzIGF0dGFjaCB0aW1lc3RhbXAuCgp2YXIgZ2V0Tm93ID0gRGF0ZS5ub3c7IC8vIERldGVybWluZSB3aGF0IGV2ZW50IHRpbWVzdGFtcCB0aGUgYnJvd3NlciBpcyB1c2luZy4gQW5ub3lpbmdseSwgdGhlCi8vIHRpbWVzdGFtcCBjYW4gZWl0aGVyIGJlIGhpLXJlcyAocmVsYXRpdmUgdG8gcGFnZSBsb2FkKSBvciBsb3ctcmVzCi8vIChyZWxhdGl2ZSB0byBVTklYIGVwb2NoKSwgc28gaW4gb3JkZXIgdG8gY29tcGFyZSB0aW1lIHdlIGhhdmUgdG8gdXNlIHRoZQovLyBzYW1lIHRpbWVzdGFtcCB0eXBlIHdoZW4gc2F2aW5nIHRoZSBmbHVzaCB0aW1lc3RhbXAuCi8vIEFsbCBJRSB2ZXJzaW9ucyB1c2UgbG93LXJlcyBldmVudCB0aW1lc3RhbXBzLCBhbmQgaGF2ZSBwcm9ibGVtYXRpYyBjbG9jawovLyBpbXBsZW1lbnRhdGlvbnMgKCM5NjMyKQoKaWYgKGluQnJvd3NlciAmJiAhaXNJRSkgewogIHZhciBwZXJmb3JtYW5jZV8xID0gd2luZG93LnBlcmZvcm1hbmNlOwoKICBpZiAocGVyZm9ybWFuY2VfMSAmJiB0eXBlb2YgcGVyZm9ybWFuY2VfMS5ub3cgPT09ICdmdW5jdGlvbicgJiYgZ2V0Tm93KCkgPiBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnQnKS50aW1lU3RhbXApIHsKICAgIC8vIGlmIHRoZSBldmVudCB0aW1lc3RhbXAsIGFsdGhvdWdoIGV2YWx1YXRlZCBBRlRFUiB0aGUgRGF0ZS5ub3coKSwgaXMKICAgIC8vIHNtYWxsZXIgdGhhbiBpdCwgaXQgbWVhbnMgdGhlIGV2ZW50IGlzIHVzaW5nIGEgaGktcmVzIHRpbWVzdGFtcCwKICAgIC8vIGFuZCB3ZSBuZWVkIHRvIHVzZSB0aGUgaGktcmVzIHZlcnNpb24gZm9yIGV2ZW50IGxpc3RlbmVyIHRpbWVzdGFtcHMgYXMKICAgIC8vIHdlbGwuCiAgICBnZXROb3cgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBwZXJmb3JtYW5jZV8xLm5vdygpOwogICAgfTsKICB9Cn0KCnZhciBzb3J0Q29tcGFyZUZuID0gZnVuY3Rpb24gKGEsIGIpIHsKICBpZiAoYS5wb3N0KSB7CiAgICBpZiAoIWIucG9zdCkgcmV0dXJuIDE7CiAgfSBlbHNlIGlmIChiLnBvc3QpIHsKICAgIHJldHVybiAtMTsKICB9CgogIHJldHVybiBhLmlkIC0gYi5pZDsKfTsKLyoqDQogKiBGbHVzaCBib3RoIHF1ZXVlcyBhbmQgcnVuIHRoZSB3YXRjaGVycy4NCiAqLwoKCmZ1bmN0aW9uIGZsdXNoU2NoZWR1bGVyUXVldWUoKSB7CiAgY3VycmVudEZsdXNoVGltZXN0YW1wID0gZ2V0Tm93KCk7CiAgZmx1c2hpbmcgPSB0cnVlOwogIHZhciB3YXRjaGVyLCBpZDsgLy8gU29ydCBxdWV1ZSBiZWZvcmUgZmx1c2guCiAgLy8gVGhpcyBlbnN1cmVzIHRoYXQ6CiAgLy8gMS4gQ29tcG9uZW50cyBhcmUgdXBkYXRlZCBmcm9tIHBhcmVudCB0byBjaGlsZC4gKGJlY2F1c2UgcGFyZW50IGlzIGFsd2F5cwogIC8vICAgIGNyZWF0ZWQgYmVmb3JlIHRoZSBjaGlsZCkKICAvLyAyLiBBIGNvbXBvbmVudCdzIHVzZXIgd2F0Y2hlcnMgYXJlIHJ1biBiZWZvcmUgaXRzIHJlbmRlciB3YXRjaGVyIChiZWNhdXNlCiAgLy8gICAgdXNlciB3YXRjaGVycyBhcmUgY3JlYXRlZCBiZWZvcmUgdGhlIHJlbmRlciB3YXRjaGVyKQogIC8vIDMuIElmIGEgY29tcG9uZW50IGlzIGRlc3Ryb3llZCBkdXJpbmcgYSBwYXJlbnQgY29tcG9uZW50J3Mgd2F0Y2hlciBydW4sCiAgLy8gICAgaXRzIHdhdGNoZXJzIGNhbiBiZSBza2lwcGVkLgoKICBxdWV1ZS5zb3J0KHNvcnRDb21wYXJlRm4pOyAvLyBkbyBub3QgY2FjaGUgbGVuZ3RoIGJlY2F1c2UgbW9yZSB3YXRjaGVycyBtaWdodCBiZSBwdXNoZWQKICAvLyBhcyB3ZSBydW4gZXhpc3Rpbmcgd2F0Y2hlcnMKCiAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgcXVldWUubGVuZ3RoOyBpbmRleCsrKSB7CiAgICB3YXRjaGVyID0gcXVldWVbaW5kZXhdOwoKICAgIGlmICh3YXRjaGVyLmJlZm9yZSkgewogICAgICB3YXRjaGVyLmJlZm9yZSgpOwogICAgfQoKICAgIGlkID0gd2F0Y2hlci5pZDsKICAgIGhhc1tpZF0gPSBudWxsOwogICAgd2F0Y2hlci5ydW4oKTsgLy8gaW4gZGV2IGJ1aWxkLCBjaGVjayBhbmQgc3RvcCBjaXJjdWxhciB1cGRhdGVzLgoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGhhc1tpZF0gIT0gbnVsbCkgewogICAgICBjaXJjdWxhcltpZF0gPSAoY2lyY3VsYXJbaWRdIHx8IDApICsgMTsKCiAgICAgIGlmIChjaXJjdWxhcltpZF0gPiBNQVhfVVBEQVRFX0NPVU5UKSB7CiAgICAgICAgd2FybignWW91IG1heSBoYXZlIGFuIGluZmluaXRlIHVwZGF0ZSBsb29wICcgKyAod2F0Y2hlci51c2VyID8gImluIHdhdGNoZXIgd2l0aCBleHByZXNzaW9uIFwiIi5jb25jYXQod2F0Y2hlci5leHByZXNzaW9uLCAiXCIiKSA6ICJpbiBhIGNvbXBvbmVudCByZW5kZXIgZnVuY3Rpb24uIiksIHdhdGNoZXIudm0pOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfSAvLyBrZWVwIGNvcGllcyBvZiBwb3N0IHF1ZXVlcyBiZWZvcmUgcmVzZXR0aW5nIHN0YXRlCgoKICB2YXIgYWN0aXZhdGVkUXVldWUgPSBhY3RpdmF0ZWRDaGlsZHJlbi5zbGljZSgpOwogIHZhciB1cGRhdGVkUXVldWUgPSBxdWV1ZS5zbGljZSgpOwogIHJlc2V0U2NoZWR1bGVyU3RhdGUoKTsgLy8gY2FsbCBjb21wb25lbnQgdXBkYXRlZCBhbmQgYWN0aXZhdGVkIGhvb2tzCgogIGNhbGxBY3RpdmF0ZWRIb29rcyhhY3RpdmF0ZWRRdWV1ZSk7CiAgY2FsbFVwZGF0ZWRIb29rcyh1cGRhdGVkUXVldWUpOyAvLyBkZXZ0b29sIGhvb2sKCiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChkZXZ0b29scyAmJiBjb25maWcuZGV2dG9vbHMpIHsKICAgIGRldnRvb2xzLmVtaXQoJ2ZsdXNoJyk7CiAgfQp9CgpmdW5jdGlvbiBjYWxsVXBkYXRlZEhvb2tzKHF1ZXVlKSB7CiAgdmFyIGkgPSBxdWV1ZS5sZW5ndGg7CgogIHdoaWxlIChpLS0pIHsKICAgIHZhciB3YXRjaGVyID0gcXVldWVbaV07CiAgICB2YXIgdm0gPSB3YXRjaGVyLnZtOwoKICAgIGlmICh2bSAmJiB2bS5fd2F0Y2hlciA9PT0gd2F0Y2hlciAmJiB2bS5faXNNb3VudGVkICYmICF2bS5faXNEZXN0cm95ZWQpIHsKICAgICAgY2FsbEhvb2skMSh2bSwgJ3VwZGF0ZWQnKTsKICAgIH0KICB9Cn0KLyoqDQogKiBRdWV1ZSBhIGtlcHQtYWxpdmUgY29tcG9uZW50IHRoYXQgd2FzIGFjdGl2YXRlZCBkdXJpbmcgcGF0Y2guDQogKiBUaGUgcXVldWUgd2lsbCBiZSBwcm9jZXNzZWQgYWZ0ZXIgdGhlIGVudGlyZSB0cmVlIGhhcyBiZWVuIHBhdGNoZWQuDQogKi8KCgpmdW5jdGlvbiBxdWV1ZUFjdGl2YXRlZENvbXBvbmVudCh2bSkgewogIC8vIHNldHRpbmcgX2luYWN0aXZlIHRvIGZhbHNlIGhlcmUgc28gdGhhdCBhIHJlbmRlciBmdW5jdGlvbiBjYW4KICAvLyByZWx5IG9uIGNoZWNraW5nIHdoZXRoZXIgaXQncyBpbiBhbiBpbmFjdGl2ZSB0cmVlIChlLmcuIHJvdXRlci12aWV3KQogIHZtLl9pbmFjdGl2ZSA9IGZhbHNlOwogIGFjdGl2YXRlZENoaWxkcmVuLnB1c2godm0pOwp9CgpmdW5jdGlvbiBjYWxsQWN0aXZhdGVkSG9va3MocXVldWUpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICBxdWV1ZVtpXS5faW5hY3RpdmUgPSB0cnVlOwogICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudChxdWV1ZVtpXSwgdHJ1ZQogICAgLyogdHJ1ZSAqLwogICAgKTsKICB9Cn0KLyoqDQogKiBQdXNoIGEgd2F0Y2hlciBpbnRvIHRoZSB3YXRjaGVyIHF1ZXVlLg0KICogSm9icyB3aXRoIGR1cGxpY2F0ZSBJRHMgd2lsbCBiZSBza2lwcGVkIHVubGVzcyBpdCdzDQogKiBwdXNoZWQgd2hlbiB0aGUgcXVldWUgaXMgYmVpbmcgZmx1c2hlZC4NCiAqLwoKCmZ1bmN0aW9uIHF1ZXVlV2F0Y2hlcih3YXRjaGVyKSB7CiAgdmFyIGlkID0gd2F0Y2hlci5pZDsKCiAgaWYgKGhhc1tpZF0gIT0gbnVsbCkgewogICAgcmV0dXJuOwogIH0KCiAgaWYgKHdhdGNoZXIgPT09IERlcC50YXJnZXQgJiYgd2F0Y2hlci5ub1JlY3Vyc2UpIHsKICAgIHJldHVybjsKICB9CgogIGhhc1tpZF0gPSB0cnVlOwoKICBpZiAoIWZsdXNoaW5nKSB7CiAgICBxdWV1ZS5wdXNoKHdhdGNoZXIpOwogIH0gZWxzZSB7CiAgICAvLyBpZiBhbHJlYWR5IGZsdXNoaW5nLCBzcGxpY2UgdGhlIHdhdGNoZXIgYmFzZWQgb24gaXRzIGlkCiAgICAvLyBpZiBhbHJlYWR5IHBhc3QgaXRzIGlkLCBpdCB3aWxsIGJlIHJ1biBuZXh0IGltbWVkaWF0ZWx5LgogICAgdmFyIGkgPSBxdWV1ZS5sZW5ndGggLSAxOwoKICAgIHdoaWxlIChpID4gaW5kZXggJiYgcXVldWVbaV0uaWQgPiB3YXRjaGVyLmlkKSB7CiAgICAgIGktLTsKICAgIH0KCiAgICBxdWV1ZS5zcGxpY2UoaSArIDEsIDAsIHdhdGNoZXIpOwogIH0gLy8gcXVldWUgdGhlIGZsdXNoCgoKICBpZiAoIXdhaXRpbmcpIHsKICAgIHdhaXRpbmcgPSB0cnVlOwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFjb25maWcuYXN5bmMpIHsKICAgICAgZmx1c2hTY2hlZHVsZXJRdWV1ZSgpOwogICAgICByZXR1cm47CiAgICB9CgogICAgbmV4dFRpY2soZmx1c2hTY2hlZHVsZXJRdWV1ZSk7CiAgfQp9CgpmdW5jdGlvbiBpbml0UHJvdmlkZSh2bSkgewogIHZhciBwcm92aWRlT3B0aW9uID0gdm0uJG9wdGlvbnMucHJvdmlkZTsKCiAgaWYgKHByb3ZpZGVPcHRpb24pIHsKICAgIHZhciBwcm92aWRlZCA9IGlzRnVuY3Rpb24ocHJvdmlkZU9wdGlvbikgPyBwcm92aWRlT3B0aW9uLmNhbGwodm0pIDogcHJvdmlkZU9wdGlvbjsKCiAgICBpZiAoIWlzT2JqZWN0KHByb3ZpZGVkKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHNvdXJjZSA9IHJlc29sdmVQcm92aWRlZCh2bSk7IC8vIElFOSBkb2Vzbid0IHN1cHBvcnQgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgc28gd2UgaGF2ZSB0bwogICAgLy8gaXRlcmF0ZSB0aGUga2V5cyBvdXJzZWx2ZXMuCgogICAgdmFyIGtleXMgPSBoYXNTeW1ib2wgPyBSZWZsZWN0Lm93bktleXMocHJvdmlkZWQpIDogT2JqZWN0LmtleXMocHJvdmlkZWQpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHNvdXJjZSwga2V5LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3ZpZGVkLCBrZXkpKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGluaXRJbmplY3Rpb25zKHZtKSB7CiAgdmFyIHJlc3VsdCA9IHJlc29sdmVJbmplY3Qodm0uJG9wdGlvbnMuaW5qZWN0LCB2bSk7CgogIGlmIChyZXN1bHQpIHsKICAgIHRvZ2dsZU9ic2VydmluZyhmYWxzZSk7CiAgICBPYmplY3Qua2V5cyhyZXN1bHQpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGRlZmluZVJlYWN0aXZlKHZtLCBrZXksIHJlc3VsdFtrZXldLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB3YXJuKCJBdm9pZCBtdXRhdGluZyBhbiBpbmplY3RlZCB2YWx1ZSBkaXJlY3RseSBzaW5jZSB0aGUgY2hhbmdlcyB3aWxsIGJlICIgKyAib3ZlcndyaXR0ZW4gd2hlbmV2ZXIgdGhlIHByb3ZpZGVkIGNvbXBvbmVudCByZS1yZW5kZXJzLiAiICsgImluamVjdGlvbiBiZWluZyBtdXRhdGVkOiBcIiIuY29uY2F0KGtleSwgIlwiIiksIHZtKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWZpbmVSZWFjdGl2ZSh2bSwga2V5LCByZXN1bHRba2V5XSk7CiAgICAgIH0KICAgIH0pOwogICAgdG9nZ2xlT2JzZXJ2aW5nKHRydWUpOwogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZUluamVjdChpbmplY3QsIHZtKSB7CiAgaWYgKGluamVjdCkgewogICAgLy8gaW5qZWN0IGlzIDphbnkgYmVjYXVzZSBmbG93IGlzIG5vdCBzbWFydCBlbm91Z2ggdG8gZmlndXJlIG91dCBjYWNoZWQKICAgIHZhciByZXN1bHQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdmFyIGtleXMgPSBoYXNTeW1ib2wgPyBSZWZsZWN0Lm93bktleXMoaW5qZWN0KSA6IE9iamVjdC5rZXlzKGluamVjdCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOyAvLyAjNjU3NCBpbiBjYXNlIHRoZSBpbmplY3Qgb2JqZWN0IGlzIG9ic2VydmVkLi4uCgogICAgICBpZiAoa2V5ID09PSAnX19vYl9fJykgY29udGludWU7CiAgICAgIHZhciBwcm92aWRlS2V5ID0gaW5qZWN0W2tleV0uZnJvbTsKCiAgICAgIGlmIChwcm92aWRlS2V5IGluIHZtLl9wcm92aWRlZCkgewogICAgICAgIHJlc3VsdFtrZXldID0gdm0uX3Byb3ZpZGVkW3Byb3ZpZGVLZXldOwogICAgICB9IGVsc2UgaWYgKCdkZWZhdWx0JyBpbiBpbmplY3Rba2V5XSkgewogICAgICAgIHZhciBwcm92aWRlRGVmYXVsdCA9IGluamVjdFtrZXldLmRlZmF1bHQ7CiAgICAgICAgcmVzdWx0W2tleV0gPSBpc0Z1bmN0aW9uKHByb3ZpZGVEZWZhdWx0KSA/IHByb3ZpZGVEZWZhdWx0LmNhbGwodm0pIDogcHJvdmlkZURlZmF1bHQ7CiAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIHdhcm4oIkluamVjdGlvbiBcIiIuY29uY2F0KGtleSwgIlwiIG5vdCBmb3VuZCIpLCB2bSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwogIH0KfQoKZnVuY3Rpb24gRnVuY3Rpb25hbFJlbmRlckNvbnRleHQoZGF0YSwgcHJvcHMsIGNoaWxkcmVuLCBwYXJlbnQsIEN0b3IpIHsKICB2YXIgX3RoaXMgPSB0aGlzOwoKICB2YXIgb3B0aW9ucyA9IEN0b3Iub3B0aW9uczsgLy8gZW5zdXJlIHRoZSBjcmVhdGVFbGVtZW50IGZ1bmN0aW9uIGluIGZ1bmN0aW9uYWwgY29tcG9uZW50cwogIC8vIGdldHMgYSB1bmlxdWUgY29udGV4dCAtIHRoaXMgaXMgbmVjZXNzYXJ5IGZvciBjb3JyZWN0IG5hbWVkIHNsb3QgY2hlY2sKCiAgdmFyIGNvbnRleHRWbTsKCiAgaWYgKGhhc093bihwYXJlbnQsICdfdWlkJykpIHsKICAgIGNvbnRleHRWbSA9IE9iamVjdC5jcmVhdGUocGFyZW50KTsKICAgIGNvbnRleHRWbS5fb3JpZ2luYWwgPSBwYXJlbnQ7CiAgfSBlbHNlIHsKICAgIC8vIHRoZSBjb250ZXh0IHZtIHBhc3NlZCBpbiBpcyBhIGZ1bmN0aW9uYWwgY29udGV4dCBhcyB3ZWxsLgogICAgLy8gaW4gdGhpcyBjYXNlIHdlIHdhbnQgdG8gbWFrZSBzdXJlIHdlIGFyZSBhYmxlIHRvIGdldCBhIGhvbGQgdG8gdGhlCiAgICAvLyByZWFsIGNvbnRleHQgaW5zdGFuY2UuCiAgICBjb250ZXh0Vm0gPSBwYXJlbnQ7IC8vIEB0cy1pZ25vcmUKCiAgICBwYXJlbnQgPSBwYXJlbnQuX29yaWdpbmFsOwogIH0KCiAgdmFyIGlzQ29tcGlsZWQgPSBpc1RydWUob3B0aW9ucy5fY29tcGlsZWQpOwogIHZhciBuZWVkTm9ybWFsaXphdGlvbiA9ICFpc0NvbXBpbGVkOwogIHRoaXMuZGF0YSA9IGRhdGE7CiAgdGhpcy5wcm9wcyA9IHByb3BzOwogIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICB0aGlzLmxpc3RlbmVycyA9IGRhdGEub24gfHwgZW1wdHlPYmplY3Q7CiAgdGhpcy5pbmplY3Rpb25zID0gcmVzb2x2ZUluamVjdChvcHRpb25zLmluamVjdCwgcGFyZW50KTsKCiAgdGhpcy5zbG90cyA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghX3RoaXMuJHNsb3RzKSB7CiAgICAgIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKHBhcmVudCwgZGF0YS5zY29wZWRTbG90cywgX3RoaXMuJHNsb3RzID0gcmVzb2x2ZVNsb3RzKGNoaWxkcmVuLCBwYXJlbnQpKTsKICAgIH0KCiAgICByZXR1cm4gX3RoaXMuJHNsb3RzOwogIH07CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnc2NvcGVkU2xvdHMnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBub3JtYWxpemVTY29wZWRTbG90cyhwYXJlbnQsIGRhdGEuc2NvcGVkU2xvdHMsIHRoaXMuc2xvdHMoKSk7CiAgICB9CiAgfSk7IC8vIHN1cHBvcnQgZm9yIGNvbXBpbGVkIGZ1bmN0aW9uYWwgdGVtcGxhdGUKCiAgaWYgKGlzQ29tcGlsZWQpIHsKICAgIC8vIGV4cG9zaW5nICRvcHRpb25zIGZvciByZW5kZXJTdGF0aWMoKQogICAgdGhpcy4kb3B0aW9ucyA9IG9wdGlvbnM7IC8vIHByZS1yZXNvbHZlIHNsb3RzIGZvciByZW5kZXJTbG90KCkKCiAgICB0aGlzLiRzbG90cyA9IHRoaXMuc2xvdHMoKTsKICAgIHRoaXMuJHNjb3BlZFNsb3RzID0gbm9ybWFsaXplU2NvcGVkU2xvdHMocGFyZW50LCBkYXRhLnNjb3BlZFNsb3RzLCB0aGlzLiRzbG90cyk7CiAgfQoKICBpZiAob3B0aW9ucy5fc2NvcGVJZCkgewogICAgdGhpcy5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgIHZhciB2bm9kZSA9IGNyZWF0ZUVsZW1lbnQkMShjb250ZXh0Vm0sIGEsIGIsIGMsIGQsIG5lZWROb3JtYWxpemF0aW9uKTsKCiAgICAgIGlmICh2bm9kZSAmJiAhaXNBcnJheSh2bm9kZSkpIHsKICAgICAgICB2bm9kZS5mblNjb3BlSWQgPSBvcHRpb25zLl9zY29wZUlkOwogICAgICAgIHZub2RlLmZuQ29udGV4dCA9IHBhcmVudDsKICAgICAgfQoKICAgICAgcmV0dXJuIHZub2RlOwogICAgfTsKICB9IGVsc2UgewogICAgdGhpcy5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgIHJldHVybiBjcmVhdGVFbGVtZW50JDEoY29udGV4dFZtLCBhLCBiLCBjLCBkLCBuZWVkTm9ybWFsaXphdGlvbik7CiAgICB9OwogIH0KfQoKaW5zdGFsbFJlbmRlckhlbHBlcnMoRnVuY3Rpb25hbFJlbmRlckNvbnRleHQucHJvdG90eXBlKTsKCmZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uYWxDb21wb25lbnQoQ3RvciwgcHJvcHNEYXRhLCBkYXRhLCBjb250ZXh0Vm0sIGNoaWxkcmVuKSB7CiAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CiAgdmFyIHByb3BzID0ge307CiAgdmFyIHByb3BPcHRpb25zID0gb3B0aW9ucy5wcm9wczsKCiAgaWYgKGlzRGVmKHByb3BPcHRpb25zKSkgewogICAgZm9yICh2YXIga2V5IGluIHByb3BPcHRpb25zKSB7CiAgICAgIHByb3BzW2tleV0gPSB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wT3B0aW9ucywgcHJvcHNEYXRhIHx8IGVtcHR5T2JqZWN0KTsKICAgIH0KICB9IGVsc2UgewogICAgaWYgKGlzRGVmKGRhdGEuYXR0cnMpKSBtZXJnZVByb3BzKHByb3BzLCBkYXRhLmF0dHJzKTsKICAgIGlmIChpc0RlZihkYXRhLnByb3BzKSkgbWVyZ2VQcm9wcyhwcm9wcywgZGF0YS5wcm9wcyk7CiAgfQoKICB2YXIgcmVuZGVyQ29udGV4dCA9IG5ldyBGdW5jdGlvbmFsUmVuZGVyQ29udGV4dChkYXRhLCBwcm9wcywgY2hpbGRyZW4sIGNvbnRleHRWbSwgQ3Rvcik7CiAgdmFyIHZub2RlID0gb3B0aW9ucy5yZW5kZXIuY2FsbChudWxsLCByZW5kZXJDb250ZXh0Ll9jLCByZW5kZXJDb250ZXh0KTsKCiAgaWYgKHZub2RlIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgIHJldHVybiBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2RlLCBkYXRhLCByZW5kZXJDb250ZXh0LnBhcmVudCwgb3B0aW9ucywgcmVuZGVyQ29udGV4dCk7CiAgfSBlbHNlIGlmIChpc0FycmF5KHZub2RlKSkgewogICAgdmFyIHZub2RlcyA9IG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlKSB8fCBbXTsKICAgIHZhciByZXMgPSBuZXcgQXJyYXkodm5vZGVzLmxlbmd0aCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVzW2ldID0gY2xvbmVBbmRNYXJrRnVuY3Rpb25hbFJlc3VsdCh2bm9kZXNbaV0sIGRhdGEsIHJlbmRlckNvbnRleHQucGFyZW50LCBvcHRpb25zLCByZW5kZXJDb250ZXh0KTsKICAgIH0KCiAgICByZXR1cm4gcmVzOwogIH0KfQoKZnVuY3Rpb24gY2xvbmVBbmRNYXJrRnVuY3Rpb25hbFJlc3VsdCh2bm9kZSwgZGF0YSwgY29udGV4dFZtLCBvcHRpb25zLCByZW5kZXJDb250ZXh0KSB7CiAgLy8gIzc4MTcgY2xvbmUgbm9kZSBiZWZvcmUgc2V0dGluZyBmbkNvbnRleHQsIG90aGVyd2lzZSBpZiB0aGUgbm9kZSBpcyByZXVzZWQKICAvLyAoZS5nLiBpdCB3YXMgZnJvbSBhIGNhY2hlZCBub3JtYWwgc2xvdCkgdGhlIGZuQ29udGV4dCBjYXVzZXMgbmFtZWQgc2xvdHMKICAvLyB0aGF0IHNob3VsZCBub3QgYmUgbWF0Y2hlZCB0byBtYXRjaC4KICB2YXIgY2xvbmUgPSBjbG9uZVZOb2RlKHZub2RlKTsKICBjbG9uZS5mbkNvbnRleHQgPSBjb250ZXh0Vm07CiAgY2xvbmUuZm5PcHRpb25zID0gb3B0aW9uczsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIChjbG9uZS5kZXZ0b29sc01ldGEgPSBjbG9uZS5kZXZ0b29sc01ldGEgfHwge30pLnJlbmRlckNvbnRleHQgPSByZW5kZXJDb250ZXh0OwogIH0KCiAgaWYgKGRhdGEuc2xvdCkgewogICAgKGNsb25lLmRhdGEgfHwgKGNsb25lLmRhdGEgPSB7fSkpLnNsb3QgPSBkYXRhLnNsb3Q7CiAgfQoKICByZXR1cm4gY2xvbmU7Cn0KCmZ1bmN0aW9uIG1lcmdlUHJvcHModG8sIGZyb20pIHsKICBmb3IgKHZhciBrZXkgaW4gZnJvbSkgewogICAgdG9bY2FtZWxpemUoa2V5KV0gPSBmcm9tW2tleV07CiAgfQp9CgpmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lKG9wdGlvbnMpIHsKICByZXR1cm4gb3B0aW9ucy5uYW1lIHx8IG9wdGlvbnMuX19uYW1lIHx8IG9wdGlvbnMuX2NvbXBvbmVudFRhZzsKfSAvLyBpbmxpbmUgaG9va3MgdG8gYmUgaW52b2tlZCBvbiBjb21wb25lbnQgVk5vZGVzIGR1cmluZyBwYXRjaAoKCnZhciBjb21wb25lbnRWTm9kZUhvb2tzID0gewogIGluaXQ6IGZ1bmN0aW9uICh2bm9kZSwgaHlkcmF0aW5nKSB7CiAgICBpZiAodm5vZGUuY29tcG9uZW50SW5zdGFuY2UgJiYgIXZub2RlLmNvbXBvbmVudEluc3RhbmNlLl9pc0Rlc3Ryb3llZCAmJiB2bm9kZS5kYXRhLmtlZXBBbGl2ZSkgewogICAgICAvLyBrZXB0LWFsaXZlIGNvbXBvbmVudHMsIHRyZWF0IGFzIGEgcGF0Y2gKICAgICAgdmFyIG1vdW50ZWROb2RlID0gdm5vZGU7IC8vIHdvcmsgYXJvdW5kIGZsb3cKCiAgICAgIGNvbXBvbmVudFZOb2RlSG9va3MucHJlcGF0Y2gobW91bnRlZE5vZGUsIG1vdW50ZWROb2RlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjaGlsZCA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gY3JlYXRlQ29tcG9uZW50SW5zdGFuY2VGb3JWbm9kZSh2bm9kZSwgYWN0aXZlSW5zdGFuY2UpOwogICAgICBjaGlsZC4kbW91bnQoaHlkcmF0aW5nID8gdm5vZGUuZWxtIDogdW5kZWZpbmVkLCBoeWRyYXRpbmcpOwogICAgfQogIH0sCiAgcHJlcGF0Y2g6IGZ1bmN0aW9uIChvbGRWbm9kZSwgdm5vZGUpIHsKICAgIHZhciBvcHRpb25zID0gdm5vZGUuY29tcG9uZW50T3B0aW9uczsKICAgIHZhciBjaGlsZCA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gb2xkVm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICB1cGRhdGVDaGlsZENvbXBvbmVudChjaGlsZCwgb3B0aW9ucy5wcm9wc0RhdGEsIC8vIHVwZGF0ZWQgcHJvcHMKICAgIG9wdGlvbnMubGlzdGVuZXJzLCAvLyB1cGRhdGVkIGxpc3RlbmVycwogICAgdm5vZGUsIC8vIG5ldyBwYXJlbnQgdm5vZGUKICAgIG9wdGlvbnMuY2hpbGRyZW4gLy8gbmV3IGNoaWxkcmVuCiAgICApOwogIH0sCiAgaW5zZXJ0OiBmdW5jdGlvbiAodm5vZGUpIHsKICAgIHZhciBjb250ZXh0ID0gdm5vZGUuY29udGV4dCwKICAgICAgICBjb21wb25lbnRJbnN0YW5jZSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlOwoKICAgIGlmICghY29tcG9uZW50SW5zdGFuY2UuX2lzTW91bnRlZCkgewogICAgICBjb21wb25lbnRJbnN0YW5jZS5faXNNb3VudGVkID0gdHJ1ZTsKICAgICAgY2FsbEhvb2skMShjb21wb25lbnRJbnN0YW5jZSwgJ21vdW50ZWQnKTsKICAgIH0KCiAgICBpZiAodm5vZGUuZGF0YS5rZWVwQWxpdmUpIHsKICAgICAgaWYgKGNvbnRleHQuX2lzTW91bnRlZCkgewogICAgICAgIC8vIHZ1ZS1yb3V0ZXIjMTIxMgogICAgICAgIC8vIER1cmluZyB1cGRhdGVzLCBhIGtlcHQtYWxpdmUgY29tcG9uZW50J3MgY2hpbGQgY29tcG9uZW50cyBtYXkKICAgICAgICAvLyBjaGFuZ2UsIHNvIGRpcmVjdGx5IHdhbGtpbmcgdGhlIHRyZWUgaGVyZSBtYXkgY2FsbCBhY3RpdmF0ZWQgaG9va3MKICAgICAgICAvLyBvbiBpbmNvcnJlY3QgY2hpbGRyZW4uIEluc3RlYWQgd2UgcHVzaCB0aGVtIGludG8gYSBxdWV1ZSB3aGljaCB3aWxsCiAgICAgICAgLy8gYmUgcHJvY2Vzc2VkIGFmdGVyIHRoZSB3aG9sZSBwYXRjaCBwcm9jZXNzIGVuZGVkLgogICAgICAgIHF1ZXVlQWN0aXZhdGVkQ29tcG9uZW50KGNvbXBvbmVudEluc3RhbmNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KGNvbXBvbmVudEluc3RhbmNlLCB0cnVlCiAgICAgICAgLyogZGlyZWN0ICovCiAgICAgICAgKTsKICAgICAgfQogICAgfQogIH0sCiAgZGVzdHJveTogZnVuY3Rpb24gKHZub2RlKSB7CiAgICB2YXIgY29tcG9uZW50SW5zdGFuY2UgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZTsKCiAgICBpZiAoIWNvbXBvbmVudEluc3RhbmNlLl9pc0Rlc3Ryb3llZCkgewogICAgICBpZiAoIXZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgICAgY29tcG9uZW50SW5zdGFuY2UuJGRlc3Ryb3koKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQoY29tcG9uZW50SW5zdGFuY2UsIHRydWUKICAgICAgICAvKiBkaXJlY3QgKi8KICAgICAgICApOwogICAgICB9CiAgICB9CiAgfQp9Owp2YXIgaG9va3NUb01lcmdlID0gT2JqZWN0LmtleXMoY29tcG9uZW50Vk5vZGVIb29rcyk7CgpmdW5jdGlvbiBjcmVhdGVDb21wb25lbnQoQ3RvciwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZykgewogIGlmIChpc1VuZGVmKEN0b3IpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgYmFzZUN0b3IgPSBjb250ZXh0LiRvcHRpb25zLl9iYXNlOyAvLyBwbGFpbiBvcHRpb25zIG9iamVjdDogdHVybiBpdCBpbnRvIGEgY29uc3RydWN0b3IKCiAgaWYgKGlzT2JqZWN0KEN0b3IpKSB7CiAgICBDdG9yID0gYmFzZUN0b3IuZXh0ZW5kKEN0b3IpOwogIH0gLy8gaWYgYXQgdGhpcyBzdGFnZSBpdCdzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIGFuIGFzeW5jIGNvbXBvbmVudCBmYWN0b3J5LAogIC8vIHJlamVjdC4KCgogIGlmICh0eXBlb2YgQ3RvciAhPT0gJ2Z1bmN0aW9uJykgewogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgd2FybigiSW52YWxpZCBDb21wb25lbnQgZGVmaW5pdGlvbjogIi5jb25jYXQoU3RyaW5nKEN0b3IpKSwgY29udGV4dCk7CiAgICB9CgogICAgcmV0dXJuOwogIH0gLy8gYXN5bmMgY29tcG9uZW50CgoKICB2YXIgYXN5bmNGYWN0b3J5OyAvLyBAdHMtZXhwZWN0LWVycm9yCgogIGlmIChpc1VuZGVmKEN0b3IuY2lkKSkgewogICAgYXN5bmNGYWN0b3J5ID0gQ3RvcjsKICAgIEN0b3IgPSByZXNvbHZlQXN5bmNDb21wb25lbnQoYXN5bmNGYWN0b3J5LCBiYXNlQ3Rvcik7CgogICAgaWYgKEN0b3IgPT09IHVuZGVmaW5lZCkgewogICAgICAvLyByZXR1cm4gYSBwbGFjZWhvbGRlciBub2RlIGZvciBhc3luYyBjb21wb25lbnQsIHdoaWNoIGlzIHJlbmRlcmVkCiAgICAgIC8vIGFzIGEgY29tbWVudCBub2RlIGJ1dCBwcmVzZXJ2ZXMgYWxsIHRoZSByYXcgaW5mb3JtYXRpb24gZm9yIHRoZSBub2RlLgogICAgICAvLyB0aGUgaW5mb3JtYXRpb24gd2lsbCBiZSB1c2VkIGZvciBhc3luYyBzZXJ2ZXItcmVuZGVyaW5nIGFuZCBoeWRyYXRpb24uCiAgICAgIHJldHVybiBjcmVhdGVBc3luY1BsYWNlaG9sZGVyKGFzeW5jRmFjdG9yeSwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZyk7CiAgICB9CiAgfQoKICBkYXRhID0gZGF0YSB8fCB7fTsgLy8gcmVzb2x2ZSBjb25zdHJ1Y3RvciBvcHRpb25zIGluIGNhc2UgZ2xvYmFsIG1peGlucyBhcmUgYXBwbGllZCBhZnRlcgogIC8vIGNvbXBvbmVudCBjb25zdHJ1Y3RvciBjcmVhdGlvbgoKICByZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKEN0b3IpOyAvLyB0cmFuc2Zvcm0gY29tcG9uZW50IHYtbW9kZWwgZGF0YSBpbnRvIHByb3BzICYgZXZlbnRzCgogIGlmIChpc0RlZihkYXRhLm1vZGVsKSkgewogICAgLy8gQHRzLWV4cGVjdC1lcnJvcgogICAgdHJhbnNmb3JtTW9kZWwoQ3Rvci5vcHRpb25zLCBkYXRhKTsKICB9IC8vIGV4dHJhY3QgcHJvcHMKICAvLyBAdHMtZXhwZWN0LWVycm9yCgoKICB2YXIgcHJvcHNEYXRhID0gZXh0cmFjdFByb3BzRnJvbVZOb2RlRGF0YShkYXRhLCBDdG9yLCB0YWcpOyAvLyBmdW5jdGlvbmFsIGNvbXBvbmVudAogIC8vIEB0cy1leHBlY3QtZXJyb3IKCiAgaWYgKGlzVHJ1ZShDdG9yLm9wdGlvbnMuZnVuY3Rpb25hbCkpIHsKICAgIHJldHVybiBjcmVhdGVGdW5jdGlvbmFsQ29tcG9uZW50KEN0b3IsIHByb3BzRGF0YSwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4pOwogIH0gLy8gZXh0cmFjdCBsaXN0ZW5lcnMsIHNpbmNlIHRoZXNlIG5lZWRzIHRvIGJlIHRyZWF0ZWQgYXMKICAvLyBjaGlsZCBjb21wb25lbnQgbGlzdGVuZXJzIGluc3RlYWQgb2YgRE9NIGxpc3RlbmVycwoKCiAgdmFyIGxpc3RlbmVycyA9IGRhdGEub247IC8vIHJlcGxhY2Ugd2l0aCBsaXN0ZW5lcnMgd2l0aCAubmF0aXZlIG1vZGlmaWVyCiAgLy8gc28gaXQgZ2V0cyBwcm9jZXNzZWQgZHVyaW5nIHBhcmVudCBjb21wb25lbnQgcGF0Y2guCgogIGRhdGEub24gPSBkYXRhLm5hdGl2ZU9uOyAvLyBAdHMtZXhwZWN0LWVycm9yCgogIGlmIChpc1RydWUoQ3Rvci5vcHRpb25zLmFic3RyYWN0KSkgewogICAgLy8gYWJzdHJhY3QgY29tcG9uZW50cyBkbyBub3Qga2VlcCBhbnl0aGluZwogICAgLy8gb3RoZXIgdGhhbiBwcm9wcyAmIGxpc3RlbmVycyAmIHNsb3QKICAgIC8vIHdvcmsgYXJvdW5kIGZsb3cKICAgIHZhciBzbG90ID0gZGF0YS5zbG90OwogICAgZGF0YSA9IHt9OwoKICAgIGlmIChzbG90KSB7CiAgICAgIGRhdGEuc2xvdCA9IHNsb3Q7CiAgICB9CiAgfSAvLyBpbnN0YWxsIGNvbXBvbmVudCBtYW5hZ2VtZW50IGhvb2tzIG9udG8gdGhlIHBsYWNlaG9sZGVyIG5vZGUKCgogIGluc3RhbGxDb21wb25lbnRIb29rcyhkYXRhKTsgLy8gcmV0dXJuIGEgcGxhY2Vob2xkZXIgdm5vZGUKICAvLyBAdHMtZXhwZWN0LWVycm9yCgogIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZShDdG9yLm9wdGlvbnMpIHx8IHRhZzsKICB2YXIgdm5vZGUgPSBuZXcgVk5vZGUoIC8vIEB0cy1leHBlY3QtZXJyb3IKICAidnVlLWNvbXBvbmVudC0iLmNvbmNhdChDdG9yLmNpZCkuY29uY2F0KG5hbWUgPyAiLSIuY29uY2F0KG5hbWUpIDogJycpLCBkYXRhLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZXh0LCAvLyBAdHMtZXhwZWN0LWVycm9yCiAgewogICAgQ3RvcjogQ3RvciwKICAgIHByb3BzRGF0YTogcHJvcHNEYXRhLAogICAgbGlzdGVuZXJzOiBsaXN0ZW5lcnMsCiAgICB0YWc6IHRhZywKICAgIGNoaWxkcmVuOiBjaGlsZHJlbgogIH0sIGFzeW5jRmFjdG9yeSk7CiAgcmV0dXJuIHZub2RlOwp9CgpmdW5jdGlvbiBjcmVhdGVDb21wb25lbnRJbnN0YW5jZUZvclZub2RlKCAvLyB3ZSBrbm93IGl0J3MgTW91bnRlZENvbXBvbmVudFZOb2RlIGJ1dCBmbG93IGRvZXNuJ3QKdm5vZGUsIC8vIGFjdGl2ZUluc3RhbmNlIGluIGxpZmVjeWNsZSBzdGF0ZQpwYXJlbnQpIHsKICB2YXIgb3B0aW9ucyA9IHsKICAgIF9pc0NvbXBvbmVudDogdHJ1ZSwKICAgIF9wYXJlbnRWbm9kZTogdm5vZGUsCiAgICBwYXJlbnQ6IHBhcmVudAogIH07IC8vIGNoZWNrIGlubGluZS10ZW1wbGF0ZSByZW5kZXIgZnVuY3Rpb25zCgogIHZhciBpbmxpbmVUZW1wbGF0ZSA9IHZub2RlLmRhdGEuaW5saW5lVGVtcGxhdGU7CgogIGlmIChpc0RlZihpbmxpbmVUZW1wbGF0ZSkpIHsKICAgIG9wdGlvbnMucmVuZGVyID0gaW5saW5lVGVtcGxhdGUucmVuZGVyOwogICAgb3B0aW9ucy5zdGF0aWNSZW5kZXJGbnMgPSBpbmxpbmVUZW1wbGF0ZS5zdGF0aWNSZW5kZXJGbnM7CiAgfQoKICByZXR1cm4gbmV3IHZub2RlLmNvbXBvbmVudE9wdGlvbnMuQ3RvcihvcHRpb25zKTsKfQoKZnVuY3Rpb24gaW5zdGFsbENvbXBvbmVudEhvb2tzKGRhdGEpIHsKICB2YXIgaG9va3MgPSBkYXRhLmhvb2sgfHwgKGRhdGEuaG9vayA9IHt9KTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBob29rc1RvTWVyZ2UubGVuZ3RoOyBpKyspIHsKICAgIHZhciBrZXkgPSBob29rc1RvTWVyZ2VbaV07CiAgICB2YXIgZXhpc3RpbmcgPSBob29rc1trZXldOwogICAgdmFyIHRvTWVyZ2UgPSBjb21wb25lbnRWTm9kZUhvb2tzW2tleV07IC8vIEB0cy1leHBlY3QtZXJyb3IKCiAgICBpZiAoZXhpc3RpbmcgIT09IHRvTWVyZ2UgJiYgIShleGlzdGluZyAmJiBleGlzdGluZy5fbWVyZ2VkKSkgewogICAgICBob29rc1trZXldID0gZXhpc3RpbmcgPyBtZXJnZUhvb2sodG9NZXJnZSwgZXhpc3RpbmcpIDogdG9NZXJnZTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIG1lcmdlSG9vayhmMSwgZjIpIHsKICB2YXIgbWVyZ2VkID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgIC8vIGZsb3cgY29tcGxhaW5zIGFib3V0IGV4dHJhIGFyZ3Mgd2hpY2ggaXMgd2h5IHdlIHVzZSBhbnkKICAgIGYxKGEsIGIpOwogICAgZjIoYSwgYik7CiAgfTsKCiAgbWVyZ2VkLl9tZXJnZWQgPSB0cnVlOwogIHJldHVybiBtZXJnZWQ7Cn0gLy8gdHJhbnNmb3JtIGNvbXBvbmVudCB2LW1vZGVsIGluZm8gKHZhbHVlIGFuZCBjYWxsYmFjaykgaW50bwovLyBwcm9wIGFuZCBldmVudCBoYW5kbGVyIHJlc3BlY3RpdmVseS4KCgpmdW5jdGlvbiB0cmFuc2Zvcm1Nb2RlbChvcHRpb25zLCBkYXRhKSB7CiAgdmFyIHByb3AgPSBvcHRpb25zLm1vZGVsICYmIG9wdGlvbnMubW9kZWwucHJvcCB8fCAndmFsdWUnOwogIHZhciBldmVudCA9IG9wdGlvbnMubW9kZWwgJiYgb3B0aW9ucy5tb2RlbC5ldmVudCB8fCAnaW5wdXQnOwogIChkYXRhLmF0dHJzIHx8IChkYXRhLmF0dHJzID0ge30pKVtwcm9wXSA9IGRhdGEubW9kZWwudmFsdWU7CiAgdmFyIG9uID0gZGF0YS5vbiB8fCAoZGF0YS5vbiA9IHt9KTsKICB2YXIgZXhpc3RpbmcgPSBvbltldmVudF07CiAgdmFyIGNhbGxiYWNrID0gZGF0YS5tb2RlbC5jYWxsYmFjazsKCiAgaWYgKGlzRGVmKGV4aXN0aW5nKSkgewogICAgaWYgKGlzQXJyYXkoZXhpc3RpbmcpID8gZXhpc3RpbmcuaW5kZXhPZihjYWxsYmFjaykgPT09IC0xIDogZXhpc3RpbmcgIT09IGNhbGxiYWNrKSB7CiAgICAgIG9uW2V2ZW50XSA9IFtjYWxsYmFja10uY29uY2F0KGV4aXN0aW5nKTsKICAgIH0KICB9IGVsc2UgewogICAgb25bZXZlbnRdID0gY2FsbGJhY2s7CiAgfQp9Cgp2YXIgd2FybiA9IG5vb3A7CnZhciB0aXAgPSBub29wOwp2YXIgZ2VuZXJhdGVDb21wb25lbnRUcmFjZTsgLy8gd29yayBhcm91bmQgZmxvdyBjaGVjawoKdmFyIGZvcm1hdENvbXBvbmVudE5hbWU7CgppZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogIHZhciBoYXNDb25zb2xlXzEgPSB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCc7CiAgdmFyIGNsYXNzaWZ5UkVfMSA9IC8oPzpefFstX10pKFx3KS9nOwoKICB2YXIgY2xhc3NpZnlfMSA9IGZ1bmN0aW9uIChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZShjbGFzc2lmeVJFXzEsIGZ1bmN0aW9uIChjKSB7CiAgICAgIHJldHVybiBjLnRvVXBwZXJDYXNlKCk7CiAgICB9KS5yZXBsYWNlKC9bLV9dL2csICcnKTsKICB9OwoKICB3YXJuID0gZnVuY3Rpb24gKG1zZywgdm0pIHsKICAgIGlmICh2bSA9PT0gdm9pZCAwKSB7CiAgICAgIHZtID0gY3VycmVudEluc3RhbmNlOwogICAgfQoKICAgIHZhciB0cmFjZSA9IHZtID8gZ2VuZXJhdGVDb21wb25lbnRUcmFjZSh2bSkgOiAnJzsKCiAgICBpZiAoY29uZmlnLndhcm5IYW5kbGVyKSB7CiAgICAgIGNvbmZpZy53YXJuSGFuZGxlci5jYWxsKG51bGwsIG1zZywgdm0sIHRyYWNlKTsKICAgIH0gZWxzZSBpZiAoaGFzQ29uc29sZV8xICYmICFjb25maWcuc2lsZW50KSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIltWdWUgd2Fybl06ICIuY29uY2F0KG1zZykuY29uY2F0KHRyYWNlKSk7CiAgICB9CiAgfTsKCiAgdGlwID0gZnVuY3Rpb24gKG1zZywgdm0pIHsKICAgIGlmIChoYXNDb25zb2xlXzEgJiYgIWNvbmZpZy5zaWxlbnQpIHsKICAgICAgY29uc29sZS53YXJuKCJbVnVlIHRpcF06ICIuY29uY2F0KG1zZykgKyAodm0gPyBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlKHZtKSA6ICcnKSk7CiAgICB9CiAgfTsKCiAgZm9ybWF0Q29tcG9uZW50TmFtZSA9IGZ1bmN0aW9uICh2bSwgaW5jbHVkZUZpbGUpIHsKICAgIGlmICh2bS4kcm9vdCA9PT0gdm0pIHsKICAgICAgcmV0dXJuICc8Um9vdD4nOwogICAgfQoKICAgIHZhciBvcHRpb25zID0gaXNGdW5jdGlvbih2bSkgJiYgdm0uY2lkICE9IG51bGwgPyB2bS5vcHRpb25zIDogdm0uX2lzVnVlID8gdm0uJG9wdGlvbnMgfHwgdm0uY29uc3RydWN0b3Iub3B0aW9ucyA6IHZtOwogICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lKG9wdGlvbnMpOwogICAgdmFyIGZpbGUgPSBvcHRpb25zLl9fZmlsZTsKCiAgICBpZiAoIW5hbWUgJiYgZmlsZSkgewogICAgICB2YXIgbWF0Y2ggPSBmaWxlLm1hdGNoKC8oW14vXFxdKylcLnZ1ZSQvKTsKICAgICAgbmFtZSA9IG1hdGNoICYmIG1hdGNoWzFdOwogICAgfQoKICAgIHJldHVybiAobmFtZSA/ICI8Ii5jb25jYXQoY2xhc3NpZnlfMShuYW1lKSwgIj4iKSA6ICI8QW5vbnltb3VzPiIpICsgKGZpbGUgJiYgaW5jbHVkZUZpbGUgIT09IGZhbHNlID8gIiBhdCAiLmNvbmNhdChmaWxlKSA6ICcnKTsKICB9OwoKICB2YXIgcmVwZWF0XzEgPSBmdW5jdGlvbiAoc3RyLCBuKSB7CiAgICB2YXIgcmVzID0gJyc7CgogICAgd2hpbGUgKG4pIHsKICAgICAgaWYgKG4gJSAyID09PSAxKSByZXMgKz0gc3RyOwogICAgICBpZiAobiA+IDEpIHN0ciArPSBzdHI7CiAgICAgIG4gPj49IDE7CiAgICB9CgogICAgcmV0dXJuIHJlczsKICB9OwoKICBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlID0gZnVuY3Rpb24gKHZtKSB7CiAgICBpZiAodm0uX2lzVnVlICYmIHZtLiRwYXJlbnQpIHsKICAgICAgdmFyIHRyZWUgPSBbXTsKICAgICAgdmFyIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA9IDA7CgogICAgICB3aGlsZSAodm0pIHsKICAgICAgICBpZiAodHJlZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgbGFzdCA9IHRyZWVbdHJlZS5sZW5ndGggLSAxXTsKCiAgICAgICAgICBpZiAobGFzdC5jb25zdHJ1Y3RvciA9PT0gdm0uY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlKys7CiAgICAgICAgICAgIHZtID0gdm0uJHBhcmVudDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA+IDApIHsKICAgICAgICAgICAgdHJlZVt0cmVlLmxlbmd0aCAtIDFdID0gW2xhc3QsIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZV07CiAgICAgICAgICAgIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0cmVlLnB1c2godm0pOwogICAgICAgIHZtID0gdm0uJHBhcmVudDsKICAgICAgfQoKICAgICAgcmV0dXJuICdcblxuZm91bmQgaW5cblxuJyArIHRyZWUubWFwKGZ1bmN0aW9uICh2bSwgaSkgewogICAgICAgIHJldHVybiAiIi5jb25jYXQoaSA9PT0gMCA/ICctLS0+ICcgOiByZXBlYXRfMSgnICcsIDUgKyBpICogMikpLmNvbmNhdChpc0FycmF5KHZtKSA/ICIiLmNvbmNhdChmb3JtYXRDb21wb25lbnROYW1lKHZtWzBdKSwgIi4uLiAoIikuY29uY2F0KHZtWzFdLCAiIHJlY3Vyc2l2ZSBjYWxscykiKSA6IGZvcm1hdENvbXBvbmVudE5hbWUodm0pKTsKICAgICAgfSkuam9pbignXG4nKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAiXG5cbihmb3VuZCBpbiAiLmNvbmNhdChmb3JtYXRDb21wb25lbnROYW1lKHZtKSwgIikiKTsKICAgIH0KICB9Owp9Ci8qKg0KICogT3B0aW9uIG92ZXJ3cml0aW5nIHN0cmF0ZWdpZXMgYXJlIGZ1bmN0aW9ucyB0aGF0IGhhbmRsZQ0KICogaG93IHRvIG1lcmdlIGEgcGFyZW50IG9wdGlvbiB2YWx1ZSBhbmQgYSBjaGlsZCBvcHRpb24NCiAqIHZhbHVlIGludG8gdGhlIGZpbmFsIHZhbHVlLg0KICovCgoKdmFyIHN0cmF0cyA9IGNvbmZpZy5vcHRpb25NZXJnZVN0cmF0ZWdpZXM7Ci8qKg0KICogT3B0aW9ucyB3aXRoIHJlc3RyaWN0aW9ucw0KICovCgppZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogIHN0cmF0cy5lbCA9IHN0cmF0cy5wcm9wc0RhdGEgPSBmdW5jdGlvbiAocGFyZW50LCBjaGlsZCwgdm0sIGtleSkgewogICAgaWYgKCF2bSkgewogICAgICB3YXJuKCJvcHRpb24gXCIiLmNvbmNhdChrZXksICJcIiBjYW4gb25seSBiZSB1c2VkIGR1cmluZyBpbnN0YW5jZSAiKSArICdjcmVhdGlvbiB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkLicpOwogICAgfQoKICAgIHJldHVybiBkZWZhdWx0U3RyYXQocGFyZW50LCBjaGlsZCk7CiAgfTsKfQovKioNCiAqIEhlbHBlciB0aGF0IHJlY3Vyc2l2ZWx5IG1lcmdlcyB0d28gZGF0YSBvYmplY3RzIHRvZ2V0aGVyLg0KICovCgoKZnVuY3Rpb24gbWVyZ2VEYXRhKHRvLCBmcm9tKSB7CiAgaWYgKCFmcm9tKSByZXR1cm4gdG87CiAgdmFyIGtleSwgdG9WYWwsIGZyb21WYWw7CiAgdmFyIGtleXMgPSBoYXNTeW1ib2wgPyBSZWZsZWN0Lm93bktleXMoZnJvbSkgOiBPYmplY3Qua2V5cyhmcm9tKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBrZXkgPSBrZXlzW2ldOyAvLyBpbiBjYXNlIHRoZSBvYmplY3QgaXMgYWxyZWFkeSBvYnNlcnZlZC4uLgoKICAgIGlmIChrZXkgPT09ICdfX29iX18nKSBjb250aW51ZTsKICAgIHRvVmFsID0gdG9ba2V5XTsKICAgIGZyb21WYWwgPSBmcm9tW2tleV07CgogICAgaWYgKCFoYXNPd24odG8sIGtleSkpIHsKICAgICAgc2V0KHRvLCBrZXksIGZyb21WYWwpOwogICAgfSBlbHNlIGlmICh0b1ZhbCAhPT0gZnJvbVZhbCAmJiBpc1BsYWluT2JqZWN0KHRvVmFsKSAmJiBpc1BsYWluT2JqZWN0KGZyb21WYWwpKSB7CiAgICAgIG1lcmdlRGF0YSh0b1ZhbCwgZnJvbVZhbCk7CiAgICB9CiAgfQoKICByZXR1cm4gdG87Cn0KLyoqDQogKiBEYXRhDQogKi8KCgpmdW5jdGlvbiBtZXJnZURhdGFPckZuKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtKSB7CiAgaWYgKCF2bSkgewogICAgLy8gaW4gYSBWdWUuZXh0ZW5kIG1lcmdlLCBib3RoIHNob3VsZCBiZSBmdW5jdGlvbnMKICAgIGlmICghY2hpbGRWYWwpIHsKICAgICAgcmV0dXJuIHBhcmVudFZhbDsKICAgIH0KCiAgICBpZiAoIXBhcmVudFZhbCkgewogICAgICByZXR1cm4gY2hpbGRWYWw7CiAgICB9IC8vIHdoZW4gcGFyZW50VmFsICYgY2hpbGRWYWwgYXJlIGJvdGggcHJlc2VudCwKICAgIC8vIHdlIG5lZWQgdG8gcmV0dXJuIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogICAgLy8gbWVyZ2VkIHJlc3VsdCBvZiBib3RoIGZ1bmN0aW9ucy4uLiBubyBuZWVkIHRvCiAgICAvLyBjaGVjayBpZiBwYXJlbnRWYWwgaXMgYSBmdW5jdGlvbiBoZXJlIGJlY2F1c2UKICAgIC8vIGl0IGhhcyB0byBiZSBhIGZ1bmN0aW9uIHRvIHBhc3MgcHJldmlvdXMgbWVyZ2VzLgoKCiAgICByZXR1cm4gZnVuY3Rpb24gbWVyZ2VkRGF0YUZuKCkgewogICAgICByZXR1cm4gbWVyZ2VEYXRhKGlzRnVuY3Rpb24oY2hpbGRWYWwpID8gY2hpbGRWYWwuY2FsbCh0aGlzLCB0aGlzKSA6IGNoaWxkVmFsLCBpc0Z1bmN0aW9uKHBhcmVudFZhbCkgPyBwYXJlbnRWYWwuY2FsbCh0aGlzLCB0aGlzKSA6IHBhcmVudFZhbCk7CiAgICB9OwogIH0gZWxzZSB7CiAgICByZXR1cm4gZnVuY3Rpb24gbWVyZ2VkSW5zdGFuY2VEYXRhRm4oKSB7CiAgICAgIC8vIGluc3RhbmNlIG1lcmdlCiAgICAgIHZhciBpbnN0YW5jZURhdGEgPSBpc0Z1bmN0aW9uKGNoaWxkVmFsKSA/IGNoaWxkVmFsLmNhbGwodm0sIHZtKSA6IGNoaWxkVmFsOwogICAgICB2YXIgZGVmYXVsdERhdGEgPSBpc0Z1bmN0aW9uKHBhcmVudFZhbCkgPyBwYXJlbnRWYWwuY2FsbCh2bSwgdm0pIDogcGFyZW50VmFsOwoKICAgICAgaWYgKGluc3RhbmNlRGF0YSkgewogICAgICAgIHJldHVybiBtZXJnZURhdGEoaW5zdGFuY2VEYXRhLCBkZWZhdWx0RGF0YSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHREYXRhOwogICAgICB9CiAgICB9OwogIH0KfQoKc3RyYXRzLmRhdGEgPSBmdW5jdGlvbiAocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0pIHsKICBpZiAoIXZtKSB7CiAgICBpZiAoY2hpbGRWYWwgJiYgdHlwZW9mIGNoaWxkVmFsICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybignVGhlICJkYXRhIiBvcHRpb24gc2hvdWxkIGJlIGEgZnVuY3Rpb24gJyArICd0aGF0IHJldHVybnMgYSBwZXItaW5zdGFuY2UgdmFsdWUgaW4gY29tcG9uZW50ICcgKyAnZGVmaW5pdGlvbnMuJywgdm0pOwogICAgICByZXR1cm4gcGFyZW50VmFsOwogICAgfQoKICAgIHJldHVybiBtZXJnZURhdGFPckZuKHBhcmVudFZhbCwgY2hpbGRWYWwpOwogIH0KCiAgcmV0dXJuIG1lcmdlRGF0YU9yRm4ocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0pOwp9OwovKioNCiAqIEhvb2tzIGFuZCBwcm9wcyBhcmUgbWVyZ2VkIGFzIGFycmF5cy4NCiAqLwoKCmZ1bmN0aW9uIG1lcmdlTGlmZWN5Y2xlSG9vayhwYXJlbnRWYWwsIGNoaWxkVmFsKSB7CiAgdmFyIHJlcyA9IGNoaWxkVmFsID8gcGFyZW50VmFsID8gcGFyZW50VmFsLmNvbmNhdChjaGlsZFZhbCkgOiBpc0FycmF5KGNoaWxkVmFsKSA/IGNoaWxkVmFsIDogW2NoaWxkVmFsXSA6IHBhcmVudFZhbDsKICByZXR1cm4gcmVzID8gZGVkdXBlSG9va3MocmVzKSA6IHJlczsKfQoKZnVuY3Rpb24gZGVkdXBlSG9va3MoaG9va3MpIHsKICB2YXIgcmVzID0gW107CgogIGZvciAodmFyIGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyBpKyspIHsKICAgIGlmIChyZXMuaW5kZXhPZihob29rc1tpXSkgPT09IC0xKSB7CiAgICAgIHJlcy5wdXNoKGhvb2tzW2ldKTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KCkxJRkVDWUNMRV9IT09LUy5mb3JFYWNoKGZ1bmN0aW9uIChob29rKSB7CiAgc3RyYXRzW2hvb2tdID0gbWVyZ2VMaWZlY3ljbGVIb29rOwp9KTsKLyoqDQogKiBBc3NldHMNCiAqDQogKiBXaGVuIGEgdm0gaXMgcHJlc2VudCAoaW5zdGFuY2UgY3JlYXRpb24pLCB3ZSBuZWVkIHRvIGRvDQogKiBhIHRocmVlLXdheSBtZXJnZSBiZXR3ZWVuIGNvbnN0cnVjdG9yIG9wdGlvbnMsIGluc3RhbmNlDQogKiBvcHRpb25zIGFuZCBwYXJlbnQgb3B0aW9ucy4NCiAqLwoKZnVuY3Rpb24gbWVyZ2VBc3NldHMocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0sIGtleSkgewogIHZhciByZXMgPSBPYmplY3QuY3JlYXRlKHBhcmVudFZhbCB8fCBudWxsKTsKCiAgaWYgKGNoaWxkVmFsKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGFzc2VydE9iamVjdFR5cGUoa2V5LCBjaGlsZFZhbCwgdm0pOwogICAgcmV0dXJuIGV4dGVuZChyZXMsIGNoaWxkVmFsKTsKICB9IGVsc2UgewogICAgcmV0dXJuIHJlczsKICB9Cn0KCkFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICBzdHJhdHNbdHlwZSArICdzJ10gPSBtZXJnZUFzc2V0czsKfSk7Ci8qKg0KICogV2F0Y2hlcnMuDQogKg0KICogV2F0Y2hlcnMgaGFzaGVzIHNob3VsZCBub3Qgb3ZlcndyaXRlIG9uZQ0KICogYW5vdGhlciwgc28gd2UgbWVyZ2UgdGhlbSBhcyBhcnJheXMuDQogKi8KCnN0cmF0cy53YXRjaCA9IGZ1bmN0aW9uIChwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSwga2V5KSB7CiAgLy8gd29yayBhcm91bmQgRmlyZWZveCdzIE9iamVjdC5wcm90b3R5cGUud2F0Y2guLi4KICAvL0B0cy1leHBlY3QtZXJyb3Igd29yayBhcm91bmQKICBpZiAocGFyZW50VmFsID09PSBuYXRpdmVXYXRjaCkgcGFyZW50VmFsID0gdW5kZWZpbmVkOyAvL0B0cy1leHBlY3QtZXJyb3Igd29yayBhcm91bmQKCiAgaWYgKGNoaWxkVmFsID09PSBuYXRpdmVXYXRjaCkgY2hpbGRWYWwgPSB1bmRlZmluZWQ7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmICghY2hpbGRWYWwpIHJldHVybiBPYmplY3QuY3JlYXRlKHBhcmVudFZhbCB8fCBudWxsKTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGFzc2VydE9iamVjdFR5cGUoa2V5LCBjaGlsZFZhbCwgdm0pOwogIH0KCiAgaWYgKCFwYXJlbnRWYWwpIHJldHVybiBjaGlsZFZhbDsKICB2YXIgcmV0ID0ge307CiAgZXh0ZW5kKHJldCwgcGFyZW50VmFsKTsKCiAgZm9yICh2YXIga2V5XzEgaW4gY2hpbGRWYWwpIHsKICAgIHZhciBwYXJlbnRfMSA9IHJldFtrZXlfMV07CiAgICB2YXIgY2hpbGQgPSBjaGlsZFZhbFtrZXlfMV07CgogICAgaWYgKHBhcmVudF8xICYmICFpc0FycmF5KHBhcmVudF8xKSkgewogICAgICBwYXJlbnRfMSA9IFtwYXJlbnRfMV07CiAgICB9CgogICAgcmV0W2tleV8xXSA9IHBhcmVudF8xID8gcGFyZW50XzEuY29uY2F0KGNoaWxkKSA6IGlzQXJyYXkoY2hpbGQpID8gY2hpbGQgOiBbY2hpbGRdOwogIH0KCiAgcmV0dXJuIHJldDsKfTsKLyoqDQogKiBPdGhlciBvYmplY3QgaGFzaGVzLg0KICovCgoKc3RyYXRzLnByb3BzID0gc3RyYXRzLm1ldGhvZHMgPSBzdHJhdHMuaW5qZWN0ID0gc3RyYXRzLmNvbXB1dGVkID0gZnVuY3Rpb24gKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtLCBrZXkpIHsKICBpZiAoY2hpbGRWYWwgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgYXNzZXJ0T2JqZWN0VHlwZShrZXksIGNoaWxkVmFsLCB2bSk7CiAgfQoKICBpZiAoIXBhcmVudFZhbCkgcmV0dXJuIGNoaWxkVmFsOwogIHZhciByZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIGV4dGVuZChyZXQsIHBhcmVudFZhbCk7CiAgaWYgKGNoaWxkVmFsKSBleHRlbmQocmV0LCBjaGlsZFZhbCk7CiAgcmV0dXJuIHJldDsKfTsKCnN0cmF0cy5wcm92aWRlID0gbWVyZ2VEYXRhT3JGbjsKLyoqDQogKiBEZWZhdWx0IHN0cmF0ZWd5Lg0KICovCgp2YXIgZGVmYXVsdFN0cmF0ID0gZnVuY3Rpb24gKHBhcmVudFZhbCwgY2hpbGRWYWwpIHsKICByZXR1cm4gY2hpbGRWYWwgPT09IHVuZGVmaW5lZCA/IHBhcmVudFZhbCA6IGNoaWxkVmFsOwp9OwovKioNCiAqIFZhbGlkYXRlIGNvbXBvbmVudCBuYW1lcw0KICovCgoKZnVuY3Rpb24gY2hlY2tDb21wb25lbnRzKG9wdGlvbnMpIHsKICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucy5jb21wb25lbnRzKSB7CiAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUoa2V5KTsKICB9Cn0KCmZ1bmN0aW9uIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lKSB7CiAgaWYgKCFuZXcgUmVnRXhwKCJeW2EtekEtWl1bXFwtXFwuMC05XyIuY29uY2F0KHVuaWNvZGVSZWdFeHAuc291cmNlLCAiXSokIikpLnRlc3QobmFtZSkpIHsKICAgIHdhcm4oJ0ludmFsaWQgY29tcG9uZW50IG5hbWU6ICInICsgbmFtZSArICciLiBDb21wb25lbnQgbmFtZXMgJyArICdzaG91bGQgY29uZm9ybSB0byB2YWxpZCBjdXN0b20gZWxlbWVudCBuYW1lIGluIGh0bWw1IHNwZWNpZmljYXRpb24uJyk7CiAgfQoKICBpZiAoaXNCdWlsdEluVGFnKG5hbWUpIHx8IGNvbmZpZy5pc1Jlc2VydmVkVGFnKG5hbWUpKSB7CiAgICB3YXJuKCdEbyBub3QgdXNlIGJ1aWx0LWluIG9yIHJlc2VydmVkIEhUTUwgZWxlbWVudHMgYXMgY29tcG9uZW50ICcgKyAnaWQ6ICcgKyBuYW1lKTsKICB9Cn0KLyoqDQogKiBFbnN1cmUgYWxsIHByb3BzIG9wdGlvbiBzeW50YXggYXJlIG5vcm1hbGl6ZWQgaW50byB0aGUNCiAqIE9iamVjdC1iYXNlZCBmb3JtYXQuDQogKi8KCgpmdW5jdGlvbiBub3JtYWxpemVQcm9wcyhvcHRpb25zLCB2bSkgewogIHZhciBwcm9wcyA9IG9wdGlvbnMucHJvcHM7CiAgaWYgKCFwcm9wcykgcmV0dXJuOwogIHZhciByZXMgPSB7fTsKICB2YXIgaSwgdmFsLCBuYW1lOwoKICBpZiAoaXNBcnJheShwcm9wcykpIHsKICAgIGkgPSBwcm9wcy5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICB2YWwgPSBwcm9wc1tpXTsKCiAgICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgICAgIG5hbWUgPSBjYW1lbGl6ZSh2YWwpOwogICAgICAgIHJlc1tuYW1lXSA9IHsKICAgICAgICAgIHR5cGU6IG51bGwKICAgICAgICB9OwogICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICB3YXJuKCdwcm9wcyBtdXN0IGJlIHN0cmluZ3Mgd2hlbiB1c2luZyBhcnJheSBzeW50YXguJyk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QocHJvcHMpKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgdmFsID0gcHJvcHNba2V5XTsKICAgICAgbmFtZSA9IGNhbWVsaXplKGtleSk7CiAgICAgIHJlc1tuYW1lXSA9IGlzUGxhaW5PYmplY3QodmFsKSA/IHZhbCA6IHsKICAgICAgICB0eXBlOiB2YWwKICAgICAgfTsKICAgIH0KICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcInByb3BzXCI6IGV4cGVjdGVkIGFuIEFycmF5IG9yIGFuIE9iamVjdCwgIiArICJidXQgZ290ICIuY29uY2F0KHRvUmF3VHlwZShwcm9wcyksICIuIiksIHZtKTsKICB9CgogIG9wdGlvbnMucHJvcHMgPSByZXM7Cn0KLyoqDQogKiBOb3JtYWxpemUgYWxsIGluamVjdGlvbnMgaW50byBPYmplY3QtYmFzZWQgZm9ybWF0DQogKi8KCgpmdW5jdGlvbiBub3JtYWxpemVJbmplY3Qob3B0aW9ucywgdm0pIHsKICB2YXIgaW5qZWN0ID0gb3B0aW9ucy5pbmplY3Q7CiAgaWYgKCFpbmplY3QpIHJldHVybjsKICB2YXIgbm9ybWFsaXplZCA9IG9wdGlvbnMuaW5qZWN0ID0ge307CgogIGlmIChpc0FycmF5KGluamVjdCkpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5qZWN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIG5vcm1hbGl6ZWRbaW5qZWN0W2ldXSA9IHsKICAgICAgICBmcm9tOiBpbmplY3RbaV0KICAgICAgfTsKICAgIH0KICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QoaW5qZWN0KSkgewogICAgZm9yICh2YXIga2V5IGluIGluamVjdCkgewogICAgICB2YXIgdmFsID0gaW5qZWN0W2tleV07CiAgICAgIG5vcm1hbGl6ZWRba2V5XSA9IGlzUGxhaW5PYmplY3QodmFsKSA/IGV4dGVuZCh7CiAgICAgICAgZnJvbToga2V5CiAgICAgIH0sIHZhbCkgOiB7CiAgICAgICAgZnJvbTogdmFsCiAgICAgIH07CiAgICB9CiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCJpbmplY3RcIjogZXhwZWN0ZWQgYW4gQXJyYXkgb3IgYW4gT2JqZWN0LCAiICsgImJ1dCBnb3QgIi5jb25jYXQodG9SYXdUeXBlKGluamVjdCksICIuIiksIHZtKTsKICB9Cn0KLyoqDQogKiBOb3JtYWxpemUgcmF3IGZ1bmN0aW9uIGRpcmVjdGl2ZXMgaW50byBvYmplY3QgZm9ybWF0Lg0KICovCgoKZnVuY3Rpb24gbm9ybWFsaXplRGlyZWN0aXZlcyQxKG9wdGlvbnMpIHsKICB2YXIgZGlycyA9IG9wdGlvbnMuZGlyZWN0aXZlczsKCiAgaWYgKGRpcnMpIHsKICAgIGZvciAodmFyIGtleSBpbiBkaXJzKSB7CiAgICAgIHZhciBkZWYgPSBkaXJzW2tleV07CgogICAgICBpZiAoaXNGdW5jdGlvbihkZWYpKSB7CiAgICAgICAgZGlyc1trZXldID0gewogICAgICAgICAgYmluZDogZGVmLAogICAgICAgICAgdXBkYXRlOiBkZWYKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBhc3NlcnRPYmplY3RUeXBlKG5hbWUsIHZhbHVlLCB2bSkgewogIGlmICghaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHsKICAgIHdhcm4oIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcIiIuY29uY2F0KG5hbWUsICJcIjogZXhwZWN0ZWQgYW4gT2JqZWN0LCAiKSArICJidXQgZ290ICIuY29uY2F0KHRvUmF3VHlwZSh2YWx1ZSksICIuIiksIHZtKTsKICB9Cn0KLyoqDQogKiBNZXJnZSB0d28gb3B0aW9uIG9iamVjdHMgaW50byBhIG5ldyBvbmUuDQogKiBDb3JlIHV0aWxpdHkgdXNlZCBpbiBib3RoIGluc3RhbnRpYXRpb24gYW5kIGluaGVyaXRhbmNlLg0KICovCgoKZnVuY3Rpb24gbWVyZ2VPcHRpb25zKHBhcmVudCwgY2hpbGQsIHZtKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGNoZWNrQ29tcG9uZW50cyhjaGlsZCk7CiAgfQoKICBpZiAoaXNGdW5jdGlvbihjaGlsZCkpIHsKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgIGNoaWxkID0gY2hpbGQub3B0aW9uczsKICB9CgogIG5vcm1hbGl6ZVByb3BzKGNoaWxkLCB2bSk7CiAgbm9ybWFsaXplSW5qZWN0KGNoaWxkLCB2bSk7CiAgbm9ybWFsaXplRGlyZWN0aXZlcyQxKGNoaWxkKTsgLy8gQXBwbHkgZXh0ZW5kcyBhbmQgbWl4aW5zIG9uIHRoZSBjaGlsZCBvcHRpb25zLAogIC8vIGJ1dCBvbmx5IGlmIGl0IGlzIGEgcmF3IG9wdGlvbnMgb2JqZWN0IHRoYXQgaXNuJ3QKICAvLyB0aGUgcmVzdWx0IG9mIGFub3RoZXIgbWVyZ2VPcHRpb25zIGNhbGwuCiAgLy8gT25seSBtZXJnZWQgb3B0aW9ucyBoYXMgdGhlIF9iYXNlIHByb3BlcnR5LgoKICBpZiAoIWNoaWxkLl9iYXNlKSB7CiAgICBpZiAoY2hpbGQuZXh0ZW5kcykgewogICAgICBwYXJlbnQgPSBtZXJnZU9wdGlvbnMocGFyZW50LCBjaGlsZC5leHRlbmRzLCB2bSk7CiAgICB9CgogICAgaWYgKGNoaWxkLm1peGlucykgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoaWxkLm1peGlucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBwYXJlbnQgPSBtZXJnZU9wdGlvbnMocGFyZW50LCBjaGlsZC5taXhpbnNbaV0sIHZtKTsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIG9wdGlvbnMgPSB7fTsKICB2YXIga2V5OwoKICBmb3IgKGtleSBpbiBwYXJlbnQpIHsKICAgIG1lcmdlRmllbGQoa2V5KTsKICB9CgogIGZvciAoa2V5IGluIGNoaWxkKSB7CiAgICBpZiAoIWhhc093bihwYXJlbnQsIGtleSkpIHsKICAgICAgbWVyZ2VGaWVsZChrZXkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbWVyZ2VGaWVsZChrZXkpIHsKICAgIHZhciBzdHJhdCA9IHN0cmF0c1trZXldIHx8IGRlZmF1bHRTdHJhdDsKICAgIG9wdGlvbnNba2V5XSA9IHN0cmF0KHBhcmVudFtrZXldLCBjaGlsZFtrZXldLCB2bSwga2V5KTsKICB9CgogIHJldHVybiBvcHRpb25zOwp9Ci8qKg0KICogUmVzb2x2ZSBhbiBhc3NldC4NCiAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBiZWNhdXNlIGNoaWxkIGluc3RhbmNlcyBuZWVkIGFjY2Vzcw0KICogdG8gYXNzZXRzIGRlZmluZWQgaW4gaXRzIGFuY2VzdG9yIGNoYWluLg0KICovCgoKZnVuY3Rpb24gcmVzb2x2ZUFzc2V0KG9wdGlvbnMsIHR5cGUsIGlkLCB3YXJuTWlzc2luZykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmICh0eXBlb2YgaWQgIT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgYXNzZXRzID0gb3B0aW9uc1t0eXBlXTsgLy8gY2hlY2sgbG9jYWwgcmVnaXN0cmF0aW9uIHZhcmlhdGlvbnMgZmlyc3QKCiAgaWYgKGhhc093bihhc3NldHMsIGlkKSkgcmV0dXJuIGFzc2V0c1tpZF07CiAgdmFyIGNhbWVsaXplZElkID0gY2FtZWxpemUoaWQpOwogIGlmIChoYXNPd24oYXNzZXRzLCBjYW1lbGl6ZWRJZCkpIHJldHVybiBhc3NldHNbY2FtZWxpemVkSWRdOwogIHZhciBQYXNjYWxDYXNlSWQgPSBjYXBpdGFsaXplKGNhbWVsaXplZElkKTsKICBpZiAoaGFzT3duKGFzc2V0cywgUGFzY2FsQ2FzZUlkKSkgcmV0dXJuIGFzc2V0c1tQYXNjYWxDYXNlSWRdOyAvLyBmYWxsYmFjayB0byBwcm90b3R5cGUgY2hhaW4KCiAgdmFyIHJlcyA9IGFzc2V0c1tpZF0gfHwgYXNzZXRzW2NhbWVsaXplZElkXSB8fCBhc3NldHNbUGFzY2FsQ2FzZUlkXTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2Fybk1pc3NpbmcgJiYgIXJlcykgewogICAgd2FybignRmFpbGVkIHRvIHJlc29sdmUgJyArIHR5cGUuc2xpY2UoMCwgLTEpICsgJzogJyArIGlkKTsKICB9CgogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIHZhbGlkYXRlUHJvcChrZXksIHByb3BPcHRpb25zLCBwcm9wc0RhdGEsIHZtKSB7CiAgdmFyIHByb3AgPSBwcm9wT3B0aW9uc1trZXldOwogIHZhciBhYnNlbnQgPSAhaGFzT3duKHByb3BzRGF0YSwga2V5KTsKICB2YXIgdmFsdWUgPSBwcm9wc0RhdGFba2V5XTsgLy8gYm9vbGVhbiBjYXN0aW5nCgogIHZhciBib29sZWFuSW5kZXggPSBnZXRUeXBlSW5kZXgoQm9vbGVhbiwgcHJvcC50eXBlKTsKCiAgaWYgKGJvb2xlYW5JbmRleCA+IC0xKSB7CiAgICBpZiAoYWJzZW50ICYmICFoYXNPd24ocHJvcCwgJ2RlZmF1bHQnKSkgewogICAgICB2YWx1ZSA9IGZhbHNlOwogICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IGh5cGhlbmF0ZShrZXkpKSB7CiAgICAgIC8vIG9ubHkgY2FzdCBlbXB0eSBzdHJpbmcgLyBzYW1lIG5hbWUgdG8gYm9vbGVhbiBpZgogICAgICAvLyBib29sZWFuIGhhcyBoaWdoZXIgcHJpb3JpdHkKICAgICAgdmFyIHN0cmluZ0luZGV4ID0gZ2V0VHlwZUluZGV4KFN0cmluZywgcHJvcC50eXBlKTsKCiAgICAgIGlmIChzdHJpbmdJbmRleCA8IDAgfHwgYm9vbGVhbkluZGV4IDwgc3RyaW5nSW5kZXgpIHsKICAgICAgICB2YWx1ZSA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9IC8vIGNoZWNrIGRlZmF1bHQgdmFsdWUKCgogIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICB2YWx1ZSA9IGdldFByb3BEZWZhdWx0VmFsdWUodm0sIHByb3AsIGtleSk7IC8vIHNpbmNlIHRoZSBkZWZhdWx0IHZhbHVlIGlzIGEgZnJlc2ggY29weSwKICAgIC8vIG1ha2Ugc3VyZSB0byBvYnNlcnZlIGl0LgoKICAgIHZhciBwcmV2U2hvdWxkT2JzZXJ2ZSA9IHNob3VsZE9ic2VydmU7CiAgICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7CiAgICBvYnNlcnZlKHZhbHVlKTsKICAgIHRvZ2dsZU9ic2VydmluZyhwcmV2U2hvdWxkT2JzZXJ2ZSk7CiAgfQoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgYXNzZXJ0UHJvcChwcm9wLCBrZXksIHZhbHVlLCB2bSwgYWJzZW50KTsKICB9CgogIHJldHVybiB2YWx1ZTsKfQovKioNCiAqIEdldCB0aGUgZGVmYXVsdCB2YWx1ZSBvZiBhIHByb3AuDQogKi8KCgpmdW5jdGlvbiBnZXRQcm9wRGVmYXVsdFZhbHVlKHZtLCBwcm9wLCBrZXkpIHsKICAvLyBubyBkZWZhdWx0LCByZXR1cm4gdW5kZWZpbmVkCiAgaWYgKCFoYXNPd24ocHJvcCwgJ2RlZmF1bHQnKSkgewogICAgcmV0dXJuIHVuZGVmaW5lZDsKICB9CgogIHZhciBkZWYgPSBwcm9wLmRlZmF1bHQ7IC8vIHdhcm4gYWdhaW5zdCBub24tZmFjdG9yeSBkZWZhdWx0cyBmb3IgT2JqZWN0ICYgQXJyYXkKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNPYmplY3QoZGVmKSkgewogICAgd2FybignSW52YWxpZCBkZWZhdWx0IHZhbHVlIGZvciBwcm9wICInICsga2V5ICsgJyI6ICcgKyAnUHJvcHMgd2l0aCB0eXBlIE9iamVjdC9BcnJheSBtdXN0IHVzZSBhIGZhY3RvcnkgZnVuY3Rpb24gJyArICd0byByZXR1cm4gdGhlIGRlZmF1bHQgdmFsdWUuJywgdm0pOwogIH0gLy8gdGhlIHJhdyBwcm9wIHZhbHVlIHdhcyBhbHNvIHVuZGVmaW5lZCBmcm9tIHByZXZpb3VzIHJlbmRlciwKICAvLyByZXR1cm4gcHJldmlvdXMgZGVmYXVsdCB2YWx1ZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSB3YXRjaGVyIHRyaWdnZXIKCgogIGlmICh2bSAmJiB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgJiYgdm0uJG9wdGlvbnMucHJvcHNEYXRhW2tleV0gPT09IHVuZGVmaW5lZCAmJiB2bS5fcHJvcHNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICByZXR1cm4gdm0uX3Byb3BzW2tleV07CiAgfSAvLyBjYWxsIGZhY3RvcnkgZnVuY3Rpb24gZm9yIG5vbi1GdW5jdGlvbiB0eXBlcwogIC8vIGEgdmFsdWUgaXMgRnVuY3Rpb24gaWYgaXRzIHByb3RvdHlwZSBpcyBmdW5jdGlvbiBldmVuIGFjcm9zcyBkaWZmZXJlbnQgZXhlY3V0aW9uIGNvbnRleHQKCgogIHJldHVybiBpc0Z1bmN0aW9uKGRlZikgJiYgZ2V0VHlwZShwcm9wLnR5cGUpICE9PSAnRnVuY3Rpb24nID8gZGVmLmNhbGwodm0pIDogZGVmOwp9Ci8qKg0KICogQXNzZXJ0IHdoZXRoZXIgYSBwcm9wIGlzIHZhbGlkLg0KICovCgoKZnVuY3Rpb24gYXNzZXJ0UHJvcChwcm9wLCBuYW1lLCB2YWx1ZSwgdm0sIGFic2VudCkgewogIGlmIChwcm9wLnJlcXVpcmVkICYmIGFic2VudCkgewogICAgd2FybignTWlzc2luZyByZXF1aXJlZCBwcm9wOiAiJyArIG5hbWUgKyAnIicsIHZtKTsKICAgIHJldHVybjsKICB9CgogIGlmICh2YWx1ZSA9PSBudWxsICYmICFwcm9wLnJlcXVpcmVkKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgdHlwZSA9IHByb3AudHlwZTsKICB2YXIgdmFsaWQgPSAhdHlwZSB8fCB0eXBlID09PSB0cnVlOwogIHZhciBleHBlY3RlZFR5cGVzID0gW107CgogIGlmICh0eXBlKSB7CiAgICBpZiAoIWlzQXJyYXkodHlwZSkpIHsKICAgICAgdHlwZSA9IFt0eXBlXTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHR5cGUubGVuZ3RoICYmICF2YWxpZDsgaSsrKSB7CiAgICAgIHZhciBhc3NlcnRlZFR5cGUgPSBhc3NlcnRUeXBlKHZhbHVlLCB0eXBlW2ldLCB2bSk7CiAgICAgIGV4cGVjdGVkVHlwZXMucHVzaChhc3NlcnRlZFR5cGUuZXhwZWN0ZWRUeXBlIHx8ICcnKTsKICAgICAgdmFsaWQgPSBhc3NlcnRlZFR5cGUudmFsaWQ7CiAgICB9CiAgfQoKICB2YXIgaGF2ZUV4cGVjdGVkVHlwZXMgPSBleHBlY3RlZFR5cGVzLnNvbWUoZnVuY3Rpb24gKHQpIHsKICAgIHJldHVybiB0OwogIH0pOwoKICBpZiAoIXZhbGlkICYmIGhhdmVFeHBlY3RlZFR5cGVzKSB7CiAgICB3YXJuKGdldEludmFsaWRUeXBlTWVzc2FnZShuYW1lLCB2YWx1ZSwgZXhwZWN0ZWRUeXBlcyksIHZtKTsKICAgIHJldHVybjsKICB9CgogIHZhciB2YWxpZGF0b3IgPSBwcm9wLnZhbGlkYXRvcjsKCiAgaWYgKHZhbGlkYXRvcikgewogICAgaWYgKCF2YWxpZGF0b3IodmFsdWUpKSB7CiAgICAgIHdhcm4oJ0ludmFsaWQgcHJvcDogY3VzdG9tIHZhbGlkYXRvciBjaGVjayBmYWlsZWQgZm9yIHByb3AgIicgKyBuYW1lICsgJyIuJywgdm0pOwogICAgfQogIH0KfQoKdmFyIHNpbXBsZUNoZWNrUkUgPSAvXihTdHJpbmd8TnVtYmVyfEJvb2xlYW58RnVuY3Rpb258U3ltYm9sfEJpZ0ludCkkLzsKCmZ1bmN0aW9uIGFzc2VydFR5cGUodmFsdWUsIHR5cGUsIHZtKSB7CiAgdmFyIHZhbGlkOwogIHZhciBleHBlY3RlZFR5cGUgPSBnZXRUeXBlKHR5cGUpOwoKICBpZiAoc2ltcGxlQ2hlY2tSRS50ZXN0KGV4cGVjdGVkVHlwZSkpIHsKICAgIHZhciB0ID0gdHlwZW9mIHZhbHVlOwogICAgdmFsaWQgPSB0ID09PSBleHBlY3RlZFR5cGUudG9Mb3dlckNhc2UoKTsgLy8gZm9yIHByaW1pdGl2ZSB3cmFwcGVyIG9iamVjdHMKCiAgICBpZiAoIXZhbGlkICYmIHQgPT09ICdvYmplY3QnKSB7CiAgICAgIHZhbGlkID0gdmFsdWUgaW5zdGFuY2VvZiB0eXBlOwogICAgfQogIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAnT2JqZWN0JykgewogICAgdmFsaWQgPSBpc1BsYWluT2JqZWN0KHZhbHVlKTsKICB9IGVsc2UgaWYgKGV4cGVjdGVkVHlwZSA9PT0gJ0FycmF5JykgewogICAgdmFsaWQgPSBpc0FycmF5KHZhbHVlKTsKICB9IGVsc2UgewogICAgdHJ5IHsKICAgICAgdmFsaWQgPSB2YWx1ZSBpbnN0YW5jZW9mIHR5cGU7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHdhcm4oJ0ludmFsaWQgcHJvcCB0eXBlOiAiJyArIFN0cmluZyh0eXBlKSArICciIGlzIG5vdCBhIGNvbnN0cnVjdG9yJywgdm0pOwogICAgICB2YWxpZCA9IGZhbHNlOwogICAgfQogIH0KCiAgcmV0dXJuIHsKICAgIHZhbGlkOiB2YWxpZCwKICAgIGV4cGVjdGVkVHlwZTogZXhwZWN0ZWRUeXBlCiAgfTsKfQoKdmFyIGZ1bmN0aW9uVHlwZUNoZWNrUkUgPSAvXlxzKmZ1bmN0aW9uIChcdyspLzsKLyoqDQogKiBVc2UgZnVuY3Rpb24gc3RyaW5nIG5hbWUgdG8gY2hlY2sgYnVpbHQtaW4gdHlwZXMsDQogKiBiZWNhdXNlIGEgc2ltcGxlIGVxdWFsaXR5IGNoZWNrIHdpbGwgZmFpbCB3aGVuIHJ1bm5pbmcNCiAqIGFjcm9zcyBkaWZmZXJlbnQgdm1zIC8gaWZyYW1lcy4NCiAqLwoKZnVuY3Rpb24gZ2V0VHlwZShmbikgewogIHZhciBtYXRjaCA9IGZuICYmIGZuLnRvU3RyaW5nKCkubWF0Y2goZnVuY3Rpb25UeXBlQ2hlY2tSRSk7CiAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKfQoKZnVuY3Rpb24gaXNTYW1lVHlwZShhLCBiKSB7CiAgcmV0dXJuIGdldFR5cGUoYSkgPT09IGdldFR5cGUoYik7Cn0KCmZ1bmN0aW9uIGdldFR5cGVJbmRleCh0eXBlLCBleHBlY3RlZFR5cGVzKSB7CiAgaWYgKCFpc0FycmF5KGV4cGVjdGVkVHlwZXMpKSB7CiAgICByZXR1cm4gaXNTYW1lVHlwZShleHBlY3RlZFR5cGVzLCB0eXBlKSA/IDAgOiAtMTsKICB9CgogIGZvciAodmFyIGkgPSAwLCBsZW4gPSBleHBlY3RlZFR5cGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICBpZiAoaXNTYW1lVHlwZShleHBlY3RlZFR5cGVzW2ldLCB0eXBlKSkgewogICAgICByZXR1cm4gaTsKICAgIH0KICB9CgogIHJldHVybiAtMTsKfQoKZnVuY3Rpb24gZ2V0SW52YWxpZFR5cGVNZXNzYWdlKG5hbWUsIHZhbHVlLCBleHBlY3RlZFR5cGVzKSB7CiAgdmFyIG1lc3NhZ2UgPSAiSW52YWxpZCBwcm9wOiB0eXBlIGNoZWNrIGZhaWxlZCBmb3IgcHJvcCBcIiIuY29uY2F0KG5hbWUsICJcIi4iKSArICIgRXhwZWN0ZWQgIi5jb25jYXQoZXhwZWN0ZWRUeXBlcy5tYXAoY2FwaXRhbGl6ZSkuam9pbignLCAnKSk7CiAgdmFyIGV4cGVjdGVkVHlwZSA9IGV4cGVjdGVkVHlwZXNbMF07CiAgdmFyIHJlY2VpdmVkVHlwZSA9IHRvUmF3VHlwZSh2YWx1ZSk7IC8vIGNoZWNrIGlmIHdlIG5lZWQgdG8gc3BlY2lmeSBleHBlY3RlZCB2YWx1ZQoKICBpZiAoZXhwZWN0ZWRUeXBlcy5sZW5ndGggPT09IDEgJiYgaXNFeHBsaWNhYmxlKGV4cGVjdGVkVHlwZSkgJiYgaXNFeHBsaWNhYmxlKHR5cGVvZiB2YWx1ZSkgJiYgIWlzQm9vbGVhbihleHBlY3RlZFR5cGUsIHJlY2VpdmVkVHlwZSkpIHsKICAgIG1lc3NhZ2UgKz0gIiB3aXRoIHZhbHVlICIuY29uY2F0KHN0eWxlVmFsdWUodmFsdWUsIGV4cGVjdGVkVHlwZSkpOwogIH0KCiAgbWVzc2FnZSArPSAiLCBnb3QgIi5jb25jYXQocmVjZWl2ZWRUeXBlLCAiICIpOyAvLyBjaGVjayBpZiB3ZSBuZWVkIHRvIHNwZWNpZnkgcmVjZWl2ZWQgdmFsdWUKCiAgaWYgKGlzRXhwbGljYWJsZShyZWNlaXZlZFR5cGUpKSB7CiAgICBtZXNzYWdlICs9ICJ3aXRoIHZhbHVlICIuY29uY2F0KHN0eWxlVmFsdWUodmFsdWUsIHJlY2VpdmVkVHlwZSksICIuIik7CiAgfQoKICByZXR1cm4gbWVzc2FnZTsKfQoKZnVuY3Rpb24gc3R5bGVWYWx1ZSh2YWx1ZSwgdHlwZSkgewogIGlmICh0eXBlID09PSAnU3RyaW5nJykgewogICAgcmV0dXJuICJcIiIuY29uY2F0KHZhbHVlLCAiXCIiKTsKICB9IGVsc2UgaWYgKHR5cGUgPT09ICdOdW1iZXInKSB7CiAgICByZXR1cm4gIiIuY29uY2F0KE51bWJlcih2YWx1ZSkpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gIiIuY29uY2F0KHZhbHVlKTsKICB9Cn0KCnZhciBFWFBMSUNBQkxFX1RZUEVTID0gWydzdHJpbmcnLCAnbnVtYmVyJywgJ2Jvb2xlYW4nXTsKCmZ1bmN0aW9uIGlzRXhwbGljYWJsZSh2YWx1ZSkgewogIHJldHVybiBFWFBMSUNBQkxFX1RZUEVTLnNvbWUoZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiB2YWx1ZS50b0xvd2VyQ2FzZSgpID09PSBlbGVtOwogIH0pOwp9CgpmdW5jdGlvbiBpc0Jvb2xlYW4oKSB7CiAgdmFyIGFyZ3MgPSBbXTsKCiAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHsKICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pXTsKICB9CgogIHJldHVybiBhcmdzLnNvbWUoZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiBlbGVtLnRvTG93ZXJDYXNlKCkgPT09ICdib29sZWFuJzsKICB9KTsKfQovKiBub3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgcGxheSB3ZWxsIHdpdGggUHJveHkgKi8KCgp2YXIgaW5pdFByb3h5OwoKaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICB2YXIgYWxsb3dlZEdsb2JhbHNfMSA9IG1ha2VNYXAoJ0luZmluaXR5LHVuZGVmaW5lZCxOYU4saXNGaW5pdGUsaXNOYU4sJyArICdwYXJzZUZsb2F0LHBhcnNlSW50LGRlY29kZVVSSSxkZWNvZGVVUklDb21wb25lbnQsZW5jb2RlVVJJLGVuY29kZVVSSUNvbXBvbmVudCwnICsgJ01hdGgsTnVtYmVyLERhdGUsQXJyYXksT2JqZWN0LEJvb2xlYW4sU3RyaW5nLFJlZ0V4cCxNYXAsU2V0LEpTT04sSW50bCxCaWdJbnQsJyArICdyZXF1aXJlJyAvLyBmb3IgV2VicGFjay9Ccm93c2VyaWZ5CiAgKTsKCiAgdmFyIHdhcm5Ob25QcmVzZW50XzEgPSBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsKICAgIHdhcm4oIlByb3BlcnR5IG9yIG1ldGhvZCBcIiIuY29uY2F0KGtleSwgIlwiIGlzIG5vdCBkZWZpbmVkIG9uIHRoZSBpbnN0YW5jZSBidXQgIikgKyAncmVmZXJlbmNlZCBkdXJpbmcgcmVuZGVyLiBNYWtlIHN1cmUgdGhhdCB0aGlzIHByb3BlcnR5IGlzIHJlYWN0aXZlLCAnICsgJ2VpdGhlciBpbiB0aGUgZGF0YSBvcHRpb24sIG9yIGZvciBjbGFzcy1iYXNlZCBjb21wb25lbnRzLCBieSAnICsgJ2luaXRpYWxpemluZyB0aGUgcHJvcGVydHkuICcgKyAnU2VlOiBodHRwczovL3YyLnZ1ZWpzLm9yZy92Mi9ndWlkZS9yZWFjdGl2aXR5Lmh0bWwjRGVjbGFyaW5nLVJlYWN0aXZlLVByb3BlcnRpZXMuJywgdGFyZ2V0KTsKICB9OwoKICB2YXIgd2FyblJlc2VydmVkUHJlZml4XzEgPSBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsKICAgIHdhcm4oIlByb3BlcnR5IFwiIi5jb25jYXQoa2V5LCAiXCIgbXVzdCBiZSBhY2Nlc3NlZCB3aXRoIFwiJGRhdGEuIikuY29uY2F0KGtleSwgIlwiIGJlY2F1c2UgIikgKyAncHJvcGVydGllcyBzdGFydGluZyB3aXRoICIkIiBvciAiXyIgYXJlIG5vdCBwcm94aWVkIGluIHRoZSBWdWUgaW5zdGFuY2UgdG8gJyArICdwcmV2ZW50IGNvbmZsaWN0cyB3aXRoIFZ1ZSBpbnRlcm5hbHMuICcgKyAnU2VlOiBodHRwczovL3YyLnZ1ZWpzLm9yZy92Mi9hcGkvI2RhdGEnLCB0YXJnZXQpOwogIH07CgogIHZhciBoYXNQcm94eV8xID0gdHlwZW9mIFByb3h5ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShQcm94eSk7CgogIGlmIChoYXNQcm94eV8xKSB7CiAgICB2YXIgaXNCdWlsdEluTW9kaWZpZXJfMSA9IG1ha2VNYXAoJ3N0b3AscHJldmVudCxzZWxmLGN0cmwsc2hpZnQsYWx0LG1ldGEsZXhhY3QnKTsKICAgIGNvbmZpZy5rZXlDb2RlcyA9IG5ldyBQcm94eShjb25maWcua2V5Q29kZXMsIHsKICAgICAgc2V0OiBmdW5jdGlvbiAodGFyZ2V0LCBrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGlzQnVpbHRJbk1vZGlmaWVyXzEoa2V5KSkgewogICAgICAgICAgd2FybigiQXZvaWQgb3ZlcndyaXRpbmcgYnVpbHQtaW4gbW9kaWZpZXIgaW4gY29uZmlnLmtleUNvZGVzOiAuIi5jb25jYXQoa2V5KSk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRhcmdldFtrZXldID0gdmFsdWU7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KCiAgdmFyIGhhc0hhbmRsZXJfMSA9IHsKICAgIGhhczogZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7CiAgICAgIHZhciBoYXMgPSAoa2V5IGluIHRhcmdldCk7CiAgICAgIHZhciBpc0FsbG93ZWQgPSBhbGxvd2VkR2xvYmFsc18xKGtleSkgfHwgdHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYga2V5LmNoYXJBdCgwKSA9PT0gJ18nICYmICEoa2V5IGluIHRhcmdldC4kZGF0YSk7CgogICAgICBpZiAoIWhhcyAmJiAhaXNBbGxvd2VkKSB7CiAgICAgICAgaWYgKGtleSBpbiB0YXJnZXQuJGRhdGEpIHdhcm5SZXNlcnZlZFByZWZpeF8xKHRhcmdldCwga2V5KTtlbHNlIHdhcm5Ob25QcmVzZW50XzEodGFyZ2V0LCBrZXkpOwogICAgICB9CgogICAgICByZXR1cm4gaGFzIHx8ICFpc0FsbG93ZWQ7CiAgICB9CiAgfTsKICB2YXIgZ2V0SGFuZGxlcl8xID0gewogICAgZ2V0OiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsKICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmICEoa2V5IGluIHRhcmdldCkpIHsKICAgICAgICBpZiAoa2V5IGluIHRhcmdldC4kZGF0YSkgd2FyblJlc2VydmVkUHJlZml4XzEodGFyZ2V0LCBrZXkpO2Vsc2Ugd2Fybk5vblByZXNlbnRfMSh0YXJnZXQsIGtleSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0YXJnZXRba2V5XTsKICAgIH0KICB9OwoKICBpbml0UHJveHkgPSBmdW5jdGlvbiBpbml0UHJveHkodm0pIHsKICAgIGlmIChoYXNQcm94eV8xKSB7CiAgICAgIC8vIGRldGVybWluZSB3aGljaCBwcm94eSBoYW5kbGVyIHRvIHVzZQogICAgICB2YXIgb3B0aW9ucyA9IHZtLiRvcHRpb25zOwogICAgICB2YXIgaGFuZGxlcnMgPSBvcHRpb25zLnJlbmRlciAmJiBvcHRpb25zLnJlbmRlci5fd2l0aFN0cmlwcGVkID8gZ2V0SGFuZGxlcl8xIDogaGFzSGFuZGxlcl8xOwogICAgICB2bS5fcmVuZGVyUHJveHkgPSBuZXcgUHJveHkodm0sIGhhbmRsZXJzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZtLl9yZW5kZXJQcm94eSA9IHZtOwogICAgfQogIH07Cn0KCnZhciBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24gPSB7CiAgZW51bWVyYWJsZTogdHJ1ZSwKICBjb25maWd1cmFibGU6IHRydWUsCiAgZ2V0OiBub29wLAogIHNldDogbm9vcAp9OwoKZnVuY3Rpb24gcHJveHkodGFyZ2V0LCBzb3VyY2VLZXksIGtleSkgewogIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5nZXQgPSBmdW5jdGlvbiBwcm94eUdldHRlcigpIHsKICAgIHJldHVybiB0aGlzW3NvdXJjZUtleV1ba2V5XTsKICB9OwoKICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gZnVuY3Rpb24gcHJveHlTZXR0ZXIodmFsKSB7CiAgICB0aGlzW3NvdXJjZUtleV1ba2V5XSA9IHZhbDsKICB9OwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbik7Cn0KCmZ1bmN0aW9uIGluaXRTdGF0ZSh2bSkgewogIHZhciBvcHRzID0gdm0uJG9wdGlvbnM7CiAgaWYgKG9wdHMucHJvcHMpIGluaXRQcm9wcyQxKHZtLCBvcHRzLnByb3BzKTsgLy8gQ29tcG9zaXRpb24gQVBJCgogIGluaXRTZXR1cCh2bSk7CiAgaWYgKG9wdHMubWV0aG9kcykgaW5pdE1ldGhvZHModm0sIG9wdHMubWV0aG9kcyk7CgogIGlmIChvcHRzLmRhdGEpIHsKICAgIGluaXREYXRhKHZtKTsKICB9IGVsc2UgewogICAgdmFyIG9iID0gb2JzZXJ2ZSh2bS5fZGF0YSA9IHt9KTsKICAgIG9iICYmIG9iLnZtQ291bnQrKzsKICB9CgogIGlmIChvcHRzLmNvbXB1dGVkKSBpbml0Q29tcHV0ZWQkMSh2bSwgb3B0cy5jb21wdXRlZCk7CgogIGlmIChvcHRzLndhdGNoICYmIG9wdHMud2F0Y2ggIT09IG5hdGl2ZVdhdGNoKSB7CiAgICBpbml0V2F0Y2godm0sIG9wdHMud2F0Y2gpOwogIH0KfQoKZnVuY3Rpb24gaW5pdFByb3BzJDEodm0sIHByb3BzT3B0aW9ucykgewogIHZhciBwcm9wc0RhdGEgPSB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgfHwge307CiAgdmFyIHByb3BzID0gdm0uX3Byb3BzID0gc2hhbGxvd1JlYWN0aXZlKHt9KTsgLy8gY2FjaGUgcHJvcCBrZXlzIHNvIHRoYXQgZnV0dXJlIHByb3BzIHVwZGF0ZXMgY2FuIGl0ZXJhdGUgdXNpbmcgQXJyYXkKICAvLyBpbnN0ZWFkIG9mIGR5bmFtaWMgb2JqZWN0IGtleSBlbnVtZXJhdGlvbi4KCiAgdmFyIGtleXMgPSB2bS4kb3B0aW9ucy5fcHJvcEtleXMgPSBbXTsKICB2YXIgaXNSb290ID0gIXZtLiRwYXJlbnQ7IC8vIHJvb3QgaW5zdGFuY2UgcHJvcHMgc2hvdWxkIGJlIGNvbnZlcnRlZAoKICBpZiAoIWlzUm9vdCkgewogICAgdG9nZ2xlT2JzZXJ2aW5nKGZhbHNlKTsKICB9CgogIHZhciBfbG9vcF8xID0gZnVuY3Rpb24gKGtleSkgewogICAga2V5cy5wdXNoKGtleSk7CiAgICB2YXIgdmFsdWUgPSB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wc09wdGlvbnMsIHByb3BzRGF0YSwgdm0pOwogICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB2YXIgaHlwaGVuYXRlZEtleSA9IGh5cGhlbmF0ZShrZXkpOwoKICAgICAgaWYgKGlzUmVzZXJ2ZWRBdHRyaWJ1dGUoaHlwaGVuYXRlZEtleSkgfHwgY29uZmlnLmlzUmVzZXJ2ZWRBdHRyKGh5cGhlbmF0ZWRLZXkpKSB7CiAgICAgICAgd2FybigiXCIiLmNvbmNhdChoeXBoZW5hdGVkS2V5LCAiXCIgaXMgYSByZXNlcnZlZCBhdHRyaWJ1dGUgYW5kIGNhbm5vdCBiZSB1c2VkIGFzIGNvbXBvbmVudCBwcm9wLiIpLCB2bSk7CiAgICAgIH0KCiAgICAgIGRlZmluZVJlYWN0aXZlKHByb3BzLCBrZXksIHZhbHVlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFpc1Jvb3QgJiYgIWlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCkgewogICAgICAgICAgd2FybigiQXZvaWQgbXV0YXRpbmcgYSBwcm9wIGRpcmVjdGx5IHNpbmNlIHRoZSB2YWx1ZSB3aWxsIGJlICIgKyAib3ZlcndyaXR0ZW4gd2hlbmV2ZXIgdGhlIHBhcmVudCBjb21wb25lbnQgcmUtcmVuZGVycy4gIiArICJJbnN0ZWFkLCB1c2UgYSBkYXRhIG9yIGNvbXB1dGVkIHByb3BlcnR5IGJhc2VkIG9uIHRoZSBwcm9wJ3MgIiArICJ2YWx1ZS4gUHJvcCBiZWluZyBtdXRhdGVkOiBcIiIuY29uY2F0KGtleSwgIlwiIiksIHZtKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZGVmaW5lUmVhY3RpdmUocHJvcHMsIGtleSwgdmFsdWUpOwogICAgfSAvLyBzdGF0aWMgcHJvcHMgYXJlIGFscmVhZHkgcHJveGllZCBvbiB0aGUgY29tcG9uZW50J3MgcHJvdG90eXBlCiAgICAvLyBkdXJpbmcgVnVlLmV4dGVuZCgpLiBXZSBvbmx5IG5lZWQgdG8gcHJveHkgcHJvcHMgZGVmaW5lZCBhdAogICAgLy8gaW5zdGFudGlhdGlvbiBoZXJlLgoKCiAgICBpZiAoIShrZXkgaW4gdm0pKSB7CiAgICAgIHByb3h5KHZtLCAiX3Byb3BzIiwga2V5KTsKICAgIH0KICB9OwoKICBmb3IgKHZhciBrZXkgaW4gcHJvcHNPcHRpb25zKSB7CiAgICBfbG9vcF8xKGtleSk7CiAgfQoKICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7Cn0KCmZ1bmN0aW9uIGluaXREYXRhKHZtKSB7CiAgdmFyIGRhdGEgPSB2bS4kb3B0aW9ucy5kYXRhOwogIGRhdGEgPSB2bS5fZGF0YSA9IGlzRnVuY3Rpb24oZGF0YSkgPyBnZXREYXRhKGRhdGEsIHZtKSA6IGRhdGEgfHwge307CgogIGlmICghaXNQbGFpbk9iamVjdChkYXRhKSkgewogICAgZGF0YSA9IHt9OwogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdkYXRhIGZ1bmN0aW9ucyBzaG91bGQgcmV0dXJuIGFuIG9iamVjdDpcbicgKyAnaHR0cHM6Ly92Mi52dWVqcy5vcmcvdjIvZ3VpZGUvY29tcG9uZW50cy5odG1sI2RhdGEtTXVzdC1CZS1hLUZ1bmN0aW9uJywgdm0pOwogIH0gLy8gcHJveHkgZGF0YSBvbiBpbnN0YW5jZQoKCiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhkYXRhKTsKICB2YXIgcHJvcHMgPSB2bS4kb3B0aW9ucy5wcm9wczsKICB2YXIgbWV0aG9kcyA9IHZtLiRvcHRpb25zLm1ldGhvZHM7CiAgdmFyIGkgPSBrZXlzLmxlbmd0aDsKCiAgd2hpbGUgKGktLSkgewogICAgdmFyIGtleSA9IGtleXNbaV07CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKG1ldGhvZHMgJiYgaGFzT3duKG1ldGhvZHMsIGtleSkpIHsKICAgICAgICB3YXJuKCJNZXRob2QgXCIiLmNvbmNhdChrZXksICJcIiBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQgYXMgYSBkYXRhIHByb3BlcnR5LiIpLCB2bSk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAocHJvcHMgJiYgaGFzT3duKHByb3BzLCBrZXkpKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiVGhlIGRhdGEgcHJvcGVydHkgXCIiLmNvbmNhdChrZXksICJcIiBpcyBhbHJlYWR5IGRlY2xhcmVkIGFzIGEgcHJvcC4gIikgKyAiVXNlIHByb3AgZGVmYXVsdCB2YWx1ZSBpbnN0ZWFkLiIsIHZtKTsKICAgIH0gZWxzZSBpZiAoIWlzUmVzZXJ2ZWQoa2V5KSkgewogICAgICBwcm94eSh2bSwgIl9kYXRhIiwga2V5KTsKICAgIH0KICB9IC8vIG9ic2VydmUgZGF0YQoKCiAgdmFyIG9iID0gb2JzZXJ2ZShkYXRhKTsKICBvYiAmJiBvYi52bUNvdW50Kys7Cn0KCmZ1bmN0aW9uIGdldERhdGEoZGF0YSwgdm0pIHsKICAvLyAjNzU3MyBkaXNhYmxlIGRlcCBjb2xsZWN0aW9uIHdoZW4gaW52b2tpbmcgZGF0YSBnZXR0ZXJzCiAgcHVzaFRhcmdldCgpOwoKICB0cnkgewogICAgcmV0dXJuIGRhdGEuY2FsbCh2bSwgdm0pOwogIH0gY2F0Y2ggKGUpIHsKICAgIGhhbmRsZUVycm9yKGUsIHZtLCAiZGF0YSgpIik7CiAgICByZXR1cm4ge307CiAgfSBmaW5hbGx5IHsKICAgIHBvcFRhcmdldCgpOwogIH0KfQoKdmFyIGNvbXB1dGVkV2F0Y2hlck9wdGlvbnMgPSB7CiAgbGF6eTogdHJ1ZQp9OwoKZnVuY3Rpb24gaW5pdENvbXB1dGVkJDEodm0sIGNvbXB1dGVkKSB7CiAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgdmFyIHdhdGNoZXJzID0gdm0uX2NvbXB1dGVkV2F0Y2hlcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOyAvLyBjb21wdXRlZCBwcm9wZXJ0aWVzIGFyZSBqdXN0IGdldHRlcnMgZHVyaW5nIFNTUgoKICB2YXIgaXNTU1IgPSBpc1NlcnZlclJlbmRlcmluZygpOwoKICBmb3IgKHZhciBrZXkgaW4gY29tcHV0ZWQpIHsKICAgIHZhciB1c2VyRGVmID0gY29tcHV0ZWRba2V5XTsKICAgIHZhciBnZXR0ZXIgPSBpc0Z1bmN0aW9uKHVzZXJEZWYpID8gdXNlckRlZiA6IHVzZXJEZWYuZ2V0OwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGdldHRlciA9PSBudWxsKSB7CiAgICAgIHdhcm4oIkdldHRlciBpcyBtaXNzaW5nIGZvciBjb21wdXRlZCBwcm9wZXJ0eSBcIiIuY29uY2F0KGtleSwgIlwiLiIpLCB2bSk7CiAgICB9CgogICAgaWYgKCFpc1NTUikgewogICAgICAvLyBjcmVhdGUgaW50ZXJuYWwgd2F0Y2hlciBmb3IgdGhlIGNvbXB1dGVkIHByb3BlcnR5LgogICAgICB3YXRjaGVyc1trZXldID0gbmV3IFdhdGNoZXIodm0sIGdldHRlciB8fCBub29wLCBub29wLCBjb21wdXRlZFdhdGNoZXJPcHRpb25zKTsKICAgIH0gLy8gY29tcG9uZW50LWRlZmluZWQgY29tcHV0ZWQgcHJvcGVydGllcyBhcmUgYWxyZWFkeSBkZWZpbmVkIG9uIHRoZQogICAgLy8gY29tcG9uZW50IHByb3RvdHlwZS4gV2Ugb25seSBuZWVkIHRvIGRlZmluZSBjb21wdXRlZCBwcm9wZXJ0aWVzIGRlZmluZWQKICAgIC8vIGF0IGluc3RhbnRpYXRpb24gaGVyZS4KCgogICAgaWYgKCEoa2V5IGluIHZtKSkgewogICAgICBkZWZpbmVDb21wdXRlZCh2bSwga2V5LCB1c2VyRGVmKTsKICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpZiAoa2V5IGluIHZtLiRkYXRhKSB7CiAgICAgICAgd2FybigiVGhlIGNvbXB1dGVkIHByb3BlcnR5IFwiIi5jb25jYXQoa2V5LCAiXCIgaXMgYWxyZWFkeSBkZWZpbmVkIGluIGRhdGEuIiksIHZtKTsKICAgICAgfSBlbHNlIGlmICh2bS4kb3B0aW9ucy5wcm9wcyAmJiBrZXkgaW4gdm0uJG9wdGlvbnMucHJvcHMpIHsKICAgICAgICB3YXJuKCJUaGUgY29tcHV0ZWQgcHJvcGVydHkgXCIiLmNvbmNhdChrZXksICJcIiBpcyBhbHJlYWR5IGRlZmluZWQgYXMgYSBwcm9wLiIpLCB2bSk7CiAgICAgIH0gZWxzZSBpZiAodm0uJG9wdGlvbnMubWV0aG9kcyAmJiBrZXkgaW4gdm0uJG9wdGlvbnMubWV0aG9kcykgewogICAgICAgIHdhcm4oIlRoZSBjb21wdXRlZCBwcm9wZXJ0eSBcIiIuY29uY2F0KGtleSwgIlwiIGlzIGFscmVhZHkgZGVmaW5lZCBhcyBhIG1ldGhvZC4iKSwgdm0pOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVDb21wdXRlZCh0YXJnZXQsIGtleSwgdXNlckRlZikgewogIHZhciBzaG91bGRDYWNoZSA9ICFpc1NlcnZlclJlbmRlcmluZygpOwoKICBpZiAoaXNGdW5jdGlvbih1c2VyRGVmKSkgewogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLmdldCA9IHNob3VsZENhY2hlID8gY3JlYXRlQ29tcHV0ZWRHZXR0ZXIoa2V5KSA6IGNyZWF0ZUdldHRlckludm9rZXIodXNlckRlZik7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gbm9vcDsKICB9IGVsc2UgewogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLmdldCA9IHVzZXJEZWYuZ2V0ID8gc2hvdWxkQ2FjaGUgJiYgdXNlckRlZi5jYWNoZSAhPT0gZmFsc2UgPyBjcmVhdGVDb21wdXRlZEdldHRlcihrZXkpIDogY3JlYXRlR2V0dGVySW52b2tlcih1c2VyRGVmLmdldCkgOiBub29wOwogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IHVzZXJEZWYuc2V0IHx8IG5vb3A7CiAgfQoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID09PSBub29wKSB7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCJDb21wdXRlZCBwcm9wZXJ0eSBcIiIuY29uY2F0KGtleSwgIlwiIHdhcyBhc3NpZ25lZCB0byBidXQgaXQgaGFzIG5vIHNldHRlci4iKSwgdGhpcyk7CiAgICB9OwogIH0KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24pOwp9CgpmdW5jdGlvbiBjcmVhdGVDb21wdXRlZEdldHRlcihrZXkpIHsKICByZXR1cm4gZnVuY3Rpb24gY29tcHV0ZWRHZXR0ZXIoKSB7CiAgICB2YXIgd2F0Y2hlciA9IHRoaXMuX2NvbXB1dGVkV2F0Y2hlcnMgJiYgdGhpcy5fY29tcHV0ZWRXYXRjaGVyc1trZXldOwoKICAgIGlmICh3YXRjaGVyKSB7CiAgICAgIGlmICh3YXRjaGVyLmRpcnR5KSB7CiAgICAgICAgd2F0Y2hlci5ldmFsdWF0ZSgpOwogICAgICB9CgogICAgICBpZiAoRGVwLnRhcmdldCkgewogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIERlcC50YXJnZXQub25UcmFjaykgewogICAgICAgICAgRGVwLnRhcmdldC5vblRyYWNrKHsKICAgICAgICAgICAgZWZmZWN0OiBEZXAudGFyZ2V0LAogICAgICAgICAgICB0YXJnZXQ6IHRoaXMsCiAgICAgICAgICAgIHR5cGU6ICJnZXQiCiAgICAgICAgICAgIC8qIFRyYWNrT3BUeXBlcy5HRVQgKi8KICAgICAgICAgICAgLAogICAgICAgICAgICBrZXk6IGtleQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB3YXRjaGVyLmRlcGVuZCgpOwogICAgICB9CgogICAgICByZXR1cm4gd2F0Y2hlci52YWx1ZTsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBjcmVhdGVHZXR0ZXJJbnZva2VyKGZuKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbXB1dGVkR2V0dGVyKCkgewogICAgcmV0dXJuIGZuLmNhbGwodGhpcywgdGhpcyk7CiAgfTsKfQoKZnVuY3Rpb24gaW5pdE1ldGhvZHModm0sIG1ldGhvZHMpIHsKICB2YXIgcHJvcHMgPSB2bS4kb3B0aW9ucy5wcm9wczsKCiAgZm9yICh2YXIga2V5IGluIG1ldGhvZHMpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmICh0eXBlb2YgbWV0aG9kc1trZXldICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgd2FybigiTWV0aG9kIFwiIi5jb25jYXQoa2V5LCAiXCIgaGFzIHR5cGUgXCIiKS5jb25jYXQodHlwZW9mIG1ldGhvZHNba2V5XSwgIlwiIGluIHRoZSBjb21wb25lbnQgZGVmaW5pdGlvbi4gIikgKyAiRGlkIHlvdSByZWZlcmVuY2UgdGhlIGZ1bmN0aW9uIGNvcnJlY3RseT8iLCB2bSk7CiAgICAgIH0KCiAgICAgIGlmIChwcm9wcyAmJiBoYXNPd24ocHJvcHMsIGtleSkpIHsKICAgICAgICB3YXJuKCJNZXRob2QgXCIiLmNvbmNhdChrZXksICJcIiBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQgYXMgYSBwcm9wLiIpLCB2bSk7CiAgICAgIH0KCiAgICAgIGlmIChrZXkgaW4gdm0gJiYgaXNSZXNlcnZlZChrZXkpKSB7CiAgICAgICAgd2FybigiTWV0aG9kIFwiIi5jb25jYXQoa2V5LCAiXCIgY29uZmxpY3RzIHdpdGggYW4gZXhpc3RpbmcgVnVlIGluc3RhbmNlIG1ldGhvZC4gIikgKyAiQXZvaWQgZGVmaW5pbmcgY29tcG9uZW50IG1ldGhvZHMgdGhhdCBzdGFydCB3aXRoIF8gb3IgJC4iKTsKICAgICAgfQogICAgfQoKICAgIHZtW2tleV0gPSB0eXBlb2YgbWV0aG9kc1trZXldICE9PSAnZnVuY3Rpb24nID8gbm9vcCA6IGJpbmQobWV0aG9kc1trZXldLCB2bSk7CiAgfQp9CgpmdW5jdGlvbiBpbml0V2F0Y2godm0sIHdhdGNoKSB7CiAgZm9yICh2YXIga2V5IGluIHdhdGNoKSB7CiAgICB2YXIgaGFuZGxlciA9IHdhdGNoW2tleV07CgogICAgaWYgKGlzQXJyYXkoaGFuZGxlcikpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYW5kbGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY3JlYXRlV2F0Y2hlcih2bSwga2V5LCBoYW5kbGVyW2ldKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY3JlYXRlV2F0Y2hlcih2bSwga2V5LCBoYW5kbGVyKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNyZWF0ZVdhdGNoZXIodm0sIGV4cE9yRm4sIGhhbmRsZXIsIG9wdGlvbnMpIHsKICBpZiAoaXNQbGFpbk9iamVjdChoYW5kbGVyKSkgewogICAgb3B0aW9ucyA9IGhhbmRsZXI7CiAgICBoYW5kbGVyID0gaGFuZGxlci5oYW5kbGVyOwogIH0KCiAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAnc3RyaW5nJykgewogICAgaGFuZGxlciA9IHZtW2hhbmRsZXJdOwogIH0KCiAgcmV0dXJuIHZtLiR3YXRjaChleHBPckZuLCBoYW5kbGVyLCBvcHRpb25zKTsKfQoKZnVuY3Rpb24gc3RhdGVNaXhpbihWdWUpIHsKICAvLyBmbG93IHNvbWVob3cgaGFzIHByb2JsZW1zIHdpdGggZGlyZWN0bHkgZGVjbGFyZWQgZGVmaW5pdGlvbiBvYmplY3QKICAvLyB3aGVuIHVzaW5nIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSwgc28gd2UgaGF2ZSB0byBwcm9jZWR1cmFsbHkgYnVpbGQgdXAKICAvLyB0aGUgb2JqZWN0IGhlcmUuCiAgdmFyIGRhdGFEZWYgPSB7fTsKCiAgZGF0YURlZi5nZXQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZGF0YTsKICB9OwoKICB2YXIgcHJvcHNEZWYgPSB7fTsKCiAgcHJvcHNEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3Byb3BzOwogIH07CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBkYXRhRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybignQXZvaWQgcmVwbGFjaW5nIGluc3RhbmNlIHJvb3QgJGRhdGEuICcgKyAnVXNlIG5lc3RlZCBkYXRhIHByb3BlcnRpZXMgaW5zdGVhZC4nLCB0aGlzKTsKICAgIH07CgogICAgcHJvcHNEZWYuc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCIkcHJvcHMgaXMgcmVhZG9ubHkuIiwgdGhpcyk7CiAgICB9OwogIH0KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZS5wcm90b3R5cGUsICckZGF0YScsIGRhdGFEZWYpOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJHByb3BzJywgcHJvcHNEZWYpOwogIFZ1ZS5wcm90b3R5cGUuJHNldCA9IHNldDsKICBWdWUucHJvdG90eXBlLiRkZWxldGUgPSBkZWw7CgogIFZ1ZS5wcm90b3R5cGUuJHdhdGNoID0gZnVuY3Rpb24gKGV4cE9yRm4sIGNiLCBvcHRpb25zKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmIChpc1BsYWluT2JqZWN0KGNiKSkgewogICAgICByZXR1cm4gY3JlYXRlV2F0Y2hlcih2bSwgZXhwT3JGbiwgY2IsIG9wdGlvbnMpOwogICAgfQoKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgb3B0aW9ucy51c2VyID0gdHJ1ZTsKICAgIHZhciB3YXRjaGVyID0gbmV3IFdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zKTsKCiAgICBpZiAob3B0aW9ucy5pbW1lZGlhdGUpIHsKICAgICAgdmFyIGluZm8gPSAiY2FsbGJhY2sgZm9yIGltbWVkaWF0ZSB3YXRjaGVyIFwiIi5jb25jYXQod2F0Y2hlci5leHByZXNzaW9uLCAiXCIiKTsKICAgICAgcHVzaFRhcmdldCgpOwogICAgICBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhjYiwgdm0sIFt3YXRjaGVyLnZhbHVlXSwgdm0sIGluZm8pOwogICAgICBwb3BUYXJnZXQoKTsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gdW53YXRjaEZuKCkgewogICAgICB3YXRjaGVyLnRlYXJkb3duKCk7CiAgICB9OwogIH07Cn0KCnZhciB1aWQgPSAwOwoKZnVuY3Rpb24gaW5pdE1peGluJDEoVnVlKSB7CiAgVnVlLnByb3RvdHlwZS5faW5pdCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB2YXIgdm0gPSB0aGlzOyAvLyBhIHVpZAoKICAgIHZtLl91aWQgPSB1aWQrKzsKICAgIHZhciBzdGFydFRhZywgZW5kVGFnOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgICAgc3RhcnRUYWcgPSAidnVlLXBlcmYtc3RhcnQ6Ii5jb25jYXQodm0uX3VpZCk7CiAgICAgIGVuZFRhZyA9ICJ2dWUtcGVyZi1lbmQ6Ii5jb25jYXQodm0uX3VpZCk7CiAgICAgIG1hcmsoc3RhcnRUYWcpOwogICAgfSAvLyBhIGZsYWcgdG8gbWFyayB0aGlzIGFzIGEgVnVlIGluc3RhbmNlIHdpdGhvdXQgaGF2aW5nIHRvIGRvIGluc3RhbmNlb2YKICAgIC8vIGNoZWNrCgoKICAgIHZtLl9pc1Z1ZSA9IHRydWU7IC8vIGF2b2lkIGluc3RhbmNlcyBmcm9tIGJlaW5nIG9ic2VydmVkCgogICAgdm0uX192X3NraXAgPSB0cnVlOyAvLyBlZmZlY3Qgc2NvcGUKCiAgICB2bS5fc2NvcGUgPSBuZXcgRWZmZWN0U2NvcGUodHJ1ZQogICAgLyogZGV0YWNoZWQgKi8KICAgICk7CiAgICB2bS5fc2NvcGUuX3ZtID0gdHJ1ZTsgLy8gbWVyZ2Ugb3B0aW9ucwoKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuX2lzQ29tcG9uZW50KSB7CiAgICAgIC8vIG9wdGltaXplIGludGVybmFsIGNvbXBvbmVudCBpbnN0YW50aWF0aW9uCiAgICAgIC8vIHNpbmNlIGR5bmFtaWMgb3B0aW9ucyBtZXJnaW5nIGlzIHByZXR0eSBzbG93LCBhbmQgbm9uZSBvZiB0aGUKICAgICAgLy8gaW50ZXJuYWwgY29tcG9uZW50IG9wdGlvbnMgbmVlZHMgc3BlY2lhbCB0cmVhdG1lbnQuCiAgICAgIGluaXRJbnRlcm5hbENvbXBvbmVudCh2bSwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICB2bS4kb3B0aW9ucyA9IG1lcmdlT3B0aW9ucyhyZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKHZtLmNvbnN0cnVjdG9yKSwgb3B0aW9ucyB8fCB7fSwgdm0pOwogICAgfQogICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaW5pdFByb3h5KHZtKTsKICAgIH0gZWxzZSB7CiAgICAgIHZtLl9yZW5kZXJQcm94eSA9IHZtOwogICAgfSAvLyBleHBvc2UgcmVhbCBzZWxmCgoKICAgIHZtLl9zZWxmID0gdm07CiAgICBpbml0TGlmZWN5Y2xlKHZtKTsKICAgIGluaXRFdmVudHModm0pOwogICAgaW5pdFJlbmRlcih2bSk7CiAgICBjYWxsSG9vayQxKHZtLCAnYmVmb3JlQ3JlYXRlJywgdW5kZWZpbmVkLCBmYWxzZQogICAgLyogc2V0Q29udGV4dCAqLwogICAgKTsKICAgIGluaXRJbmplY3Rpb25zKHZtKTsgLy8gcmVzb2x2ZSBpbmplY3Rpb25zIGJlZm9yZSBkYXRhL3Byb3BzCgogICAgaW5pdFN0YXRlKHZtKTsKICAgIGluaXRQcm92aWRlKHZtKTsgLy8gcmVzb2x2ZSBwcm92aWRlIGFmdGVyIGRhdGEvcHJvcHMKCiAgICBjYWxsSG9vayQxKHZtLCAnY3JlYXRlZCcpOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgICAgdm0uX25hbWUgPSBmb3JtYXRDb21wb25lbnROYW1lKHZtLCBmYWxzZSk7CiAgICAgIG1hcmsoZW5kVGFnKTsKICAgICAgbWVhc3VyZSgidnVlICIuY29uY2F0KHZtLl9uYW1lLCAiIGluaXQiKSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICB9CgogICAgaWYgKHZtLiRvcHRpb25zLmVsKSB7CiAgICAgIHZtLiRtb3VudCh2bS4kb3B0aW9ucy5lbCk7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gaW5pdEludGVybmFsQ29tcG9uZW50KHZtLCBvcHRpb25zKSB7CiAgdmFyIG9wdHMgPSB2bS4kb3B0aW9ucyA9IE9iamVjdC5jcmVhdGUodm0uY29uc3RydWN0b3Iub3B0aW9ucyk7IC8vIGRvaW5nIHRoaXMgYmVjYXVzZSBpdCdzIGZhc3RlciB0aGFuIGR5bmFtaWMgZW51bWVyYXRpb24uCgogIHZhciBwYXJlbnRWbm9kZSA9IG9wdGlvbnMuX3BhcmVudFZub2RlOwogIG9wdHMucGFyZW50ID0gb3B0aW9ucy5wYXJlbnQ7CiAgb3B0cy5fcGFyZW50Vm5vZGUgPSBwYXJlbnRWbm9kZTsKICB2YXIgdm5vZGVDb21wb25lbnRPcHRpb25zID0gcGFyZW50Vm5vZGUuY29tcG9uZW50T3B0aW9uczsKICBvcHRzLnByb3BzRGF0YSA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy5wcm9wc0RhdGE7CiAgb3B0cy5fcGFyZW50TGlzdGVuZXJzID0gdm5vZGVDb21wb25lbnRPcHRpb25zLmxpc3RlbmVyczsKICBvcHRzLl9yZW5kZXJDaGlsZHJlbiA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy5jaGlsZHJlbjsKICBvcHRzLl9jb21wb25lbnRUYWcgPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMudGFnOwoKICBpZiAob3B0aW9ucy5yZW5kZXIpIHsKICAgIG9wdHMucmVuZGVyID0gb3B0aW9ucy5yZW5kZXI7CiAgICBvcHRzLnN0YXRpY1JlbmRlckZucyA9IG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zOwogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyhDdG9yKSB7CiAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CgogIGlmIChDdG9yLnN1cGVyKSB7CiAgICB2YXIgc3VwZXJPcHRpb25zID0gcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyhDdG9yLnN1cGVyKTsKICAgIHZhciBjYWNoZWRTdXBlck9wdGlvbnMgPSBDdG9yLnN1cGVyT3B0aW9uczsKCiAgICBpZiAoc3VwZXJPcHRpb25zICE9PSBjYWNoZWRTdXBlck9wdGlvbnMpIHsKICAgICAgLy8gc3VwZXIgb3B0aW9uIGNoYW5nZWQsCiAgICAgIC8vIG5lZWQgdG8gcmVzb2x2ZSBuZXcgb3B0aW9ucy4KICAgICAgQ3Rvci5zdXBlck9wdGlvbnMgPSBzdXBlck9wdGlvbnM7IC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBhbnkgbGF0ZS1tb2RpZmllZC9hdHRhY2hlZCBvcHRpb25zICgjNDk3NikKCiAgICAgIHZhciBtb2RpZmllZE9wdGlvbnMgPSByZXNvbHZlTW9kaWZpZWRPcHRpb25zKEN0b3IpOyAvLyB1cGRhdGUgYmFzZSBleHRlbmQgb3B0aW9ucwoKICAgICAgaWYgKG1vZGlmaWVkT3B0aW9ucykgewogICAgICAgIGV4dGVuZChDdG9yLmV4dGVuZE9wdGlvbnMsIG1vZGlmaWVkT3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoc3VwZXJPcHRpb25zLCBDdG9yLmV4dGVuZE9wdGlvbnMpOwoKICAgICAgaWYgKG9wdGlvbnMubmFtZSkgewogICAgICAgIG9wdGlvbnMuY29tcG9uZW50c1tvcHRpb25zLm5hbWVdID0gQ3RvcjsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIG9wdGlvbnM7Cn0KCmZ1bmN0aW9uIHJlc29sdmVNb2RpZmllZE9wdGlvbnMoQ3RvcikgewogIHZhciBtb2RpZmllZDsKICB2YXIgbGF0ZXN0ID0gQ3Rvci5vcHRpb25zOwogIHZhciBzZWFsZWQgPSBDdG9yLnNlYWxlZE9wdGlvbnM7CgogIGZvciAodmFyIGtleSBpbiBsYXRlc3QpIHsKICAgIGlmIChsYXRlc3Rba2V5XSAhPT0gc2VhbGVkW2tleV0pIHsKICAgICAgaWYgKCFtb2RpZmllZCkgbW9kaWZpZWQgPSB7fTsKICAgICAgbW9kaWZpZWRba2V5XSA9IGxhdGVzdFtrZXldOwogICAgfQogIH0KCiAgcmV0dXJuIG1vZGlmaWVkOwp9CgpmdW5jdGlvbiBWdWUob3B0aW9ucykgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICEodGhpcyBpbnN0YW5jZW9mIFZ1ZSkpIHsKICAgIHdhcm4oJ1Z1ZSBpcyBhIGNvbnN0cnVjdG9yIGFuZCBzaG91bGQgYmUgY2FsbGVkIHdpdGggdGhlIGBuZXdgIGtleXdvcmQnKTsKICB9CgogIHRoaXMuX2luaXQob3B0aW9ucyk7Cn0gLy9AdHMtZXhwZWN0LWVycm9yIFZ1ZSBoYXMgZnVuY3Rpb24gdHlwZQoKCmluaXRNaXhpbiQxKFZ1ZSk7IC8vQHRzLWV4cGVjdC1lcnJvciBWdWUgaGFzIGZ1bmN0aW9uIHR5cGUKCnN0YXRlTWl4aW4oVnVlKTsgLy9AdHMtZXhwZWN0LWVycm9yIFZ1ZSBoYXMgZnVuY3Rpb24gdHlwZQoKZXZlbnRzTWl4aW4oVnVlKTsgLy9AdHMtZXhwZWN0LWVycm9yIFZ1ZSBoYXMgZnVuY3Rpb24gdHlwZQoKbGlmZWN5Y2xlTWl4aW4oVnVlKTsgLy9AdHMtZXhwZWN0LWVycm9yIFZ1ZSBoYXMgZnVuY3Rpb24gdHlwZQoKcmVuZGVyTWl4aW4oVnVlKTsKCmZ1bmN0aW9uIGluaXRVc2UoVnVlKSB7CiAgVnVlLnVzZSA9IGZ1bmN0aW9uIChwbHVnaW4pIHsKICAgIHZhciBpbnN0YWxsZWRQbHVnaW5zID0gdGhpcy5faW5zdGFsbGVkUGx1Z2lucyB8fCAodGhpcy5faW5zdGFsbGVkUGx1Z2lucyA9IFtdKTsKCiAgICBpZiAoaW5zdGFsbGVkUGx1Z2lucy5pbmRleE9mKHBsdWdpbikgPiAtMSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0gLy8gYWRkaXRpb25hbCBwYXJhbWV0ZXJzCgoKICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMsIDEpOwogICAgYXJncy51bnNoaWZ0KHRoaXMpOwoKICAgIGlmIChpc0Z1bmN0aW9uKHBsdWdpbi5pbnN0YWxsKSkgewogICAgICBwbHVnaW4uaW5zdGFsbC5hcHBseShwbHVnaW4sIGFyZ3MpOwogICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHBsdWdpbikpIHsKICAgICAgcGx1Z2luLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgfQoKICAgIGluc3RhbGxlZFBsdWdpbnMucHVzaChwbHVnaW4pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKfQoKZnVuY3Rpb24gaW5pdE1peGluKFZ1ZSkgewogIFZ1ZS5taXhpbiA9IGZ1bmN0aW9uIChtaXhpbikgewogICAgdGhpcy5vcHRpb25zID0gbWVyZ2VPcHRpb25zKHRoaXMub3B0aW9ucywgbWl4aW4pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKfQoKZnVuY3Rpb24gaW5pdEV4dGVuZChWdWUpIHsKICAvKioNCiAgICogRWFjaCBpbnN0YW5jZSBjb25zdHJ1Y3RvciwgaW5jbHVkaW5nIFZ1ZSwgaGFzIGEgdW5pcXVlDQogICAqIGNpZC4gVGhpcyBlbmFibGVzIHVzIHRvIGNyZWF0ZSB3cmFwcGVkICJjaGlsZA0KICAgKiBjb25zdHJ1Y3RvcnMiIGZvciBwcm90b3R5cGFsIGluaGVyaXRhbmNlIGFuZCBjYWNoZSB0aGVtLg0KICAgKi8KICBWdWUuY2lkID0gMDsKICB2YXIgY2lkID0gMTsKICAvKioNCiAgICogQ2xhc3MgaW5oZXJpdGFuY2UNCiAgICovCgogIFZ1ZS5leHRlbmQgPSBmdW5jdGlvbiAoZXh0ZW5kT3B0aW9ucykgewogICAgZXh0ZW5kT3B0aW9ucyA9IGV4dGVuZE9wdGlvbnMgfHwge307CiAgICB2YXIgU3VwZXIgPSB0aGlzOwogICAgdmFyIFN1cGVySWQgPSBTdXBlci5jaWQ7CiAgICB2YXIgY2FjaGVkQ3RvcnMgPSBleHRlbmRPcHRpb25zLl9DdG9yIHx8IChleHRlbmRPcHRpb25zLl9DdG9yID0ge30pOwoKICAgIGlmIChjYWNoZWRDdG9yc1tTdXBlcklkXSkgewogICAgICByZXR1cm4gY2FjaGVkQ3RvcnNbU3VwZXJJZF07CiAgICB9CgogICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lKGV4dGVuZE9wdGlvbnMpIHx8IGdldENvbXBvbmVudE5hbWUoU3VwZXIub3B0aW9ucyk7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgbmFtZSkgewogICAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUobmFtZSk7CiAgICB9CgogICAgdmFyIFN1YiA9IGZ1bmN0aW9uIFZ1ZUNvbXBvbmVudChvcHRpb25zKSB7CiAgICAgIHRoaXMuX2luaXQob3B0aW9ucyk7CiAgICB9OwoKICAgIFN1Yi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN1cGVyLnByb3RvdHlwZSk7CiAgICBTdWIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU3ViOwogICAgU3ViLmNpZCA9IGNpZCsrOwogICAgU3ViLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoU3VwZXIub3B0aW9ucywgZXh0ZW5kT3B0aW9ucyk7CiAgICBTdWJbJ3N1cGVyJ10gPSBTdXBlcjsgLy8gRm9yIHByb3BzIGFuZCBjb21wdXRlZCBwcm9wZXJ0aWVzLCB3ZSBkZWZpbmUgdGhlIHByb3h5IGdldHRlcnMgb24KICAgIC8vIHRoZSBWdWUgaW5zdGFuY2VzIGF0IGV4dGVuc2lvbiB0aW1lLCBvbiB0aGUgZXh0ZW5kZWQgcHJvdG90eXBlLiBUaGlzCiAgICAvLyBhdm9pZHMgT2JqZWN0LmRlZmluZVByb3BlcnR5IGNhbGxzIGZvciBlYWNoIGluc3RhbmNlIGNyZWF0ZWQuCgogICAgaWYgKFN1Yi5vcHRpb25zLnByb3BzKSB7CiAgICAgIGluaXRQcm9wcyhTdWIpOwogICAgfQoKICAgIGlmIChTdWIub3B0aW9ucy5jb21wdXRlZCkgewogICAgICBpbml0Q29tcHV0ZWQoU3ViKTsKICAgIH0gLy8gYWxsb3cgZnVydGhlciBleHRlbnNpb24vbWl4aW4vcGx1Z2luIHVzYWdlCgoKICAgIFN1Yi5leHRlbmQgPSBTdXBlci5leHRlbmQ7CiAgICBTdWIubWl4aW4gPSBTdXBlci5taXhpbjsKICAgIFN1Yi51c2UgPSBTdXBlci51c2U7IC8vIGNyZWF0ZSBhc3NldCByZWdpc3RlcnMsIHNvIGV4dGVuZGVkIGNsYXNzZXMKICAgIC8vIGNhbiBoYXZlIHRoZWlyIHByaXZhdGUgYXNzZXRzIHRvby4KCiAgICBBU1NFVF9UWVBFUy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIFN1Ylt0eXBlXSA9IFN1cGVyW3R5cGVdOwogICAgfSk7IC8vIGVuYWJsZSByZWN1cnNpdmUgc2VsZi1sb29rdXAKCiAgICBpZiAobmFtZSkgewogICAgICBTdWIub3B0aW9ucy5jb21wb25lbnRzW25hbWVdID0gU3ViOwogICAgfSAvLyBrZWVwIGEgcmVmZXJlbmNlIHRvIHRoZSBzdXBlciBvcHRpb25zIGF0IGV4dGVuc2lvbiB0aW1lLgogICAgLy8gbGF0ZXIgYXQgaW5zdGFudGlhdGlvbiB3ZSBjYW4gY2hlY2sgaWYgU3VwZXIncyBvcHRpb25zIGhhdmUKICAgIC8vIGJlZW4gdXBkYXRlZC4KCgogICAgU3ViLnN1cGVyT3B0aW9ucyA9IFN1cGVyLm9wdGlvbnM7CiAgICBTdWIuZXh0ZW5kT3B0aW9ucyA9IGV4dGVuZE9wdGlvbnM7CiAgICBTdWIuc2VhbGVkT3B0aW9ucyA9IGV4dGVuZCh7fSwgU3ViLm9wdGlvbnMpOyAvLyBjYWNoZSBjb25zdHJ1Y3RvcgoKICAgIGNhY2hlZEN0b3JzW1N1cGVySWRdID0gU3ViOwogICAgcmV0dXJuIFN1YjsKICB9Owp9CgpmdW5jdGlvbiBpbml0UHJvcHMoQ29tcCkgewogIHZhciBwcm9wcyA9IENvbXAub3B0aW9ucy5wcm9wczsKCiAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICBwcm94eShDb21wLnByb3RvdHlwZSwgIl9wcm9wcyIsIGtleSk7CiAgfQp9CgpmdW5jdGlvbiBpbml0Q29tcHV0ZWQoQ29tcCkgewogIHZhciBjb21wdXRlZCA9IENvbXAub3B0aW9ucy5jb21wdXRlZDsKCiAgZm9yICh2YXIga2V5IGluIGNvbXB1dGVkKSB7CiAgICBkZWZpbmVDb21wdXRlZChDb21wLnByb3RvdHlwZSwga2V5LCBjb21wdXRlZFtrZXldKTsKICB9Cn0KCmZ1bmN0aW9uIGluaXRBc3NldFJlZ2lzdGVycyhWdWUpIHsKICAvKioNCiAgICogQ3JlYXRlIGFzc2V0IHJlZ2lzdHJhdGlvbiBtZXRob2RzLg0KICAgKi8KICBBU1NFVF9UWVBFUy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGZ1bmN0aW9uIGlzIG5vdCBleGFjdCBzYW1lIHR5cGUKICAgIFZ1ZVt0eXBlXSA9IGZ1bmN0aW9uIChpZCwgZGVmaW5pdGlvbikgewogICAgICBpZiAoIWRlZmluaXRpb24pIHsKICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zW3R5cGUgKyAncyddW2lkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB0eXBlID09PSAnY29tcG9uZW50JykgewogICAgICAgICAgdmFsaWRhdGVDb21wb25lbnROYW1lKGlkKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlID09PSAnY29tcG9uZW50JyAmJiBpc1BsYWluT2JqZWN0KGRlZmluaXRpb24pKSB7CiAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yCiAgICAgICAgICBkZWZpbml0aW9uLm5hbWUgPSBkZWZpbml0aW9uLm5hbWUgfHwgaWQ7CiAgICAgICAgICBkZWZpbml0aW9uID0gdGhpcy5vcHRpb25zLl9iYXNlLmV4dGVuZChkZWZpbml0aW9uKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlID09PSAnZGlyZWN0aXZlJyAmJiBpc0Z1bmN0aW9uKGRlZmluaXRpb24pKSB7CiAgICAgICAgICBkZWZpbml0aW9uID0gewogICAgICAgICAgICBiaW5kOiBkZWZpbml0aW9uLAogICAgICAgICAgICB1cGRhdGU6IGRlZmluaXRpb24KICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICB0aGlzLm9wdGlvbnNbdHlwZSArICdzJ11baWRdID0gZGVmaW5pdGlvbjsKICAgICAgICByZXR1cm4gZGVmaW5pdGlvbjsKICAgICAgfQogICAgfTsKICB9KTsKfQoKZnVuY3Rpb24gX2dldENvbXBvbmVudE5hbWUob3B0cykgewogIHJldHVybiBvcHRzICYmIChnZXRDb21wb25lbnROYW1lKG9wdHMuQ3Rvci5vcHRpb25zKSB8fCBvcHRzLnRhZyk7Cn0KCmZ1bmN0aW9uIG1hdGNoZXMocGF0dGVybiwgbmFtZSkgewogIGlmIChpc0FycmF5KHBhdHRlcm4pKSB7CiAgICByZXR1cm4gcGF0dGVybi5pbmRleE9mKG5hbWUpID4gLTE7CiAgfSBlbHNlIGlmICh0eXBlb2YgcGF0dGVybiA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBwYXR0ZXJuLnNwbGl0KCcsJykuaW5kZXhPZihuYW1lKSA+IC0xOwogIH0gZWxzZSBpZiAoaXNSZWdFeHAocGF0dGVybikpIHsKICAgIHJldHVybiBwYXR0ZXJuLnRlc3QobmFtZSk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgoKICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIHBydW5lQ2FjaGUoa2VlcEFsaXZlSW5zdGFuY2UsIGZpbHRlcikgewogIHZhciBjYWNoZSA9IGtlZXBBbGl2ZUluc3RhbmNlLmNhY2hlLAogICAgICBrZXlzID0ga2VlcEFsaXZlSW5zdGFuY2Uua2V5cywKICAgICAgX3Zub2RlID0ga2VlcEFsaXZlSW5zdGFuY2UuX3Zub2RlOwoKICBmb3IgKHZhciBrZXkgaW4gY2FjaGUpIHsKICAgIHZhciBlbnRyeSA9IGNhY2hlW2tleV07CgogICAgaWYgKGVudHJ5KSB7CiAgICAgIHZhciBuYW1lXzEgPSBlbnRyeS5uYW1lOwoKICAgICAgaWYgKG5hbWVfMSAmJiAhZmlsdGVyKG5hbWVfMSkpIHsKICAgICAgICBwcnVuZUNhY2hlRW50cnkoY2FjaGUsIGtleSwga2V5cywgX3Zub2RlKTsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXksIGtleXMsIGN1cnJlbnQpIHsKICB2YXIgZW50cnkgPSBjYWNoZVtrZXldOwoKICBpZiAoZW50cnkgJiYgKCFjdXJyZW50IHx8IGVudHJ5LnRhZyAhPT0gY3VycmVudC50YWcpKSB7CiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGNhbiBiZSB1bmRlZmluZWQKICAgIGVudHJ5LmNvbXBvbmVudEluc3RhbmNlLiRkZXN0cm95KCk7CiAgfQoKICBjYWNoZVtrZXldID0gbnVsbDsKICByZW1vdmUkMihrZXlzLCBrZXkpOwp9Cgp2YXIgcGF0dGVyblR5cGVzID0gW1N0cmluZywgUmVnRXhwLCBBcnJheV07IC8vIFRPRE8gZGVmaW5lQ29tcG9uZW50Cgp2YXIgS2VlcEFsaXZlID0gewogIG5hbWU6ICdrZWVwLWFsaXZlJywKICBhYnN0cmFjdDogdHJ1ZSwKICBwcm9wczogewogICAgaW5jbHVkZTogcGF0dGVyblR5cGVzLAogICAgZXhjbHVkZTogcGF0dGVyblR5cGVzLAogICAgbWF4OiBbU3RyaW5nLCBOdW1iZXJdCiAgfSwKICBtZXRob2RzOiB7CiAgICBjYWNoZVZOb2RlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfYSA9IHRoaXMsCiAgICAgICAgICBjYWNoZSA9IF9hLmNhY2hlLAogICAgICAgICAga2V5cyA9IF9hLmtleXMsCiAgICAgICAgICB2bm9kZVRvQ2FjaGUgPSBfYS52bm9kZVRvQ2FjaGUsCiAgICAgICAgICBrZXlUb0NhY2hlID0gX2Eua2V5VG9DYWNoZTsKCiAgICAgIGlmICh2bm9kZVRvQ2FjaGUpIHsKICAgICAgICB2YXIgdGFnID0gdm5vZGVUb0NhY2hlLnRhZywKICAgICAgICAgICAgY29tcG9uZW50SW5zdGFuY2UgPSB2bm9kZVRvQ2FjaGUuY29tcG9uZW50SW5zdGFuY2UsCiAgICAgICAgICAgIGNvbXBvbmVudE9wdGlvbnMgPSB2bm9kZVRvQ2FjaGUuY29tcG9uZW50T3B0aW9uczsKICAgICAgICBjYWNoZVtrZXlUb0NhY2hlXSA9IHsKICAgICAgICAgIG5hbWU6IF9nZXRDb21wb25lbnROYW1lKGNvbXBvbmVudE9wdGlvbnMpLAogICAgICAgICAgdGFnOiB0YWcsCiAgICAgICAgICBjb21wb25lbnRJbnN0YW5jZTogY29tcG9uZW50SW5zdGFuY2UKICAgICAgICB9OwogICAgICAgIGtleXMucHVzaChrZXlUb0NhY2hlKTsgLy8gcHJ1bmUgb2xkZXN0IGVudHJ5CgogICAgICAgIGlmICh0aGlzLm1heCAmJiBrZXlzLmxlbmd0aCA+IHBhcnNlSW50KHRoaXMubWF4KSkgewogICAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXlzWzBdLCBrZXlzLCB0aGlzLl92bm9kZSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnZub2RlVG9DYWNoZSA9IG51bGw7CiAgICAgIH0KICAgIH0KICB9LAogIGNyZWF0ZWQ6IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5rZXlzID0gW107CiAgfSwKICBkZXN0cm95ZWQ6IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmNhY2hlKSB7CiAgICAgIHBydW5lQ2FjaGVFbnRyeSh0aGlzLmNhY2hlLCBrZXksIHRoaXMua2V5cyk7CiAgICB9CiAgfSwKICBtb3VudGVkOiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHRoaXMuY2FjaGVWTm9kZSgpOwogICAgdGhpcy4kd2F0Y2goJ2luY2x1ZGUnLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgIHBydW5lQ2FjaGUoX3RoaXMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIG1hdGNoZXModmFsLCBuYW1lKTsKICAgICAgfSk7CiAgICB9KTsKICAgIHRoaXMuJHdhdGNoKCdleGNsdWRlJywgZnVuY3Rpb24gKHZhbCkgewogICAgICBwcnVuZUNhY2hlKF90aGlzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiAhbWF0Y2hlcyh2YWwsIG5hbWUpOwogICAgICB9KTsKICAgIH0pOwogIH0sCiAgdXBkYXRlZDogZnVuY3Rpb24gKCkgewogICAgdGhpcy5jYWNoZVZOb2RlKCk7CiAgfSwKICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzbG90ID0gdGhpcy4kc2xvdHMuZGVmYXVsdDsKICAgIHZhciB2bm9kZSA9IGdldEZpcnN0Q29tcG9uZW50Q2hpbGQoc2xvdCk7CiAgICB2YXIgY29tcG9uZW50T3B0aW9ucyA9IHZub2RlICYmIHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CgogICAgaWYgKGNvbXBvbmVudE9wdGlvbnMpIHsKICAgICAgLy8gY2hlY2sgcGF0dGVybgogICAgICB2YXIgbmFtZV8yID0gX2dldENvbXBvbmVudE5hbWUoY29tcG9uZW50T3B0aW9ucyk7CgogICAgICB2YXIgX2EgPSB0aGlzLAogICAgICAgICAgaW5jbHVkZSA9IF9hLmluY2x1ZGUsCiAgICAgICAgICBleGNsdWRlID0gX2EuZXhjbHVkZTsKCiAgICAgIGlmICggLy8gbm90IGluY2x1ZGVkCiAgICAgIGluY2x1ZGUgJiYgKCFuYW1lXzIgfHwgIW1hdGNoZXMoaW5jbHVkZSwgbmFtZV8yKSkgfHwgLy8gZXhjbHVkZWQKICAgICAgZXhjbHVkZSAmJiBuYW1lXzIgJiYgbWF0Y2hlcyhleGNsdWRlLCBuYW1lXzIpKSB7CiAgICAgICAgcmV0dXJuIHZub2RlOwogICAgICB9CgogICAgICB2YXIgX2IgPSB0aGlzLAogICAgICAgICAgY2FjaGUgPSBfYi5jYWNoZSwKICAgICAgICAgIGtleXMgPSBfYi5rZXlzOwoKICAgICAgdmFyIGtleSA9IHZub2RlLmtleSA9PSBudWxsID8gLy8gc2FtZSBjb25zdHJ1Y3RvciBtYXkgZ2V0IHJlZ2lzdGVyZWQgYXMgZGlmZmVyZW50IGxvY2FsIGNvbXBvbmVudHMKICAgICAgLy8gc28gY2lkIGFsb25lIGlzIG5vdCBlbm91Z2ggKCMzMjY5KQogICAgICBjb21wb25lbnRPcHRpb25zLkN0b3IuY2lkICsgKGNvbXBvbmVudE9wdGlvbnMudGFnID8gIjo6Ii5jb25jYXQoY29tcG9uZW50T3B0aW9ucy50YWcpIDogJycpIDogdm5vZGUua2V5OwoKICAgICAgaWYgKGNhY2hlW2tleV0pIHsKICAgICAgICB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSA9IGNhY2hlW2tleV0uY29tcG9uZW50SW5zdGFuY2U7IC8vIG1ha2UgY3VycmVudCBrZXkgZnJlc2hlc3QKCiAgICAgICAgcmVtb3ZlJDIoa2V5cywga2V5KTsKICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBkZWxheSBzZXR0aW5nIHRoZSBjYWNoZSB1bnRpbCB1cGRhdGUKICAgICAgICB0aGlzLnZub2RlVG9DYWNoZSA9IHZub2RlOwogICAgICAgIHRoaXMua2V5VG9DYWNoZSA9IGtleTsKICAgICAgfSAvLyBAdHMtZXhwZWN0LWVycm9yIGNhbiB2bm9kZS5kYXRhIGNhbiBiZSB1bmRlZmluZWQKCgogICAgICB2bm9kZS5kYXRhLmtlZXBBbGl2ZSA9IHRydWU7CiAgICB9CgogICAgcmV0dXJuIHZub2RlIHx8IHNsb3QgJiYgc2xvdFswXTsKICB9Cn07CnZhciBidWlsdEluQ29tcG9uZW50cyA9IHsKICBLZWVwQWxpdmU6IEtlZXBBbGl2ZQp9OwoKZnVuY3Rpb24gaW5pdEdsb2JhbEFQSShWdWUpIHsKICAvLyBjb25maWcKICB2YXIgY29uZmlnRGVmID0ge307CgogIGNvbmZpZ0RlZi5nZXQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29uZmlnOwogIH07CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBjb25maWdEZWYuc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCdEbyBub3QgcmVwbGFjZSB0aGUgVnVlLmNvbmZpZyBvYmplY3QsIHNldCBpbmRpdmlkdWFsIGZpZWxkcyBpbnN0ZWFkLicpOwogICAgfTsKICB9CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUsICdjb25maWcnLCBjb25maWdEZWYpOyAvLyBleHBvc2VkIHV0aWwgbWV0aG9kcy4KICAvLyBOT1RFOiB0aGVzZSBhcmUgbm90IGNvbnNpZGVyZWQgcGFydCBvZiB0aGUgcHVibGljIEFQSSAtIGF2b2lkIHJlbHlpbmcgb24KICAvLyB0aGVtIHVubGVzcyB5b3UgYXJlIGF3YXJlIG9mIHRoZSByaXNrLgoKICBWdWUudXRpbCA9IHsKICAgIHdhcm46IHdhcm4sCiAgICBleHRlbmQ6IGV4dGVuZCwKICAgIG1lcmdlT3B0aW9uczogbWVyZ2VPcHRpb25zLAogICAgZGVmaW5lUmVhY3RpdmU6IGRlZmluZVJlYWN0aXZlCiAgfTsKICBWdWUuc2V0ID0gc2V0OwogIFZ1ZS5kZWxldGUgPSBkZWw7CiAgVnVlLm5leHRUaWNrID0gbmV4dFRpY2s7IC8vIDIuNiBleHBsaWNpdCBvYnNlcnZhYmxlIEFQSQoKICBWdWUub2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIG9ic2VydmUob2JqKTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgVnVlLm9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIEFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICAgIFZ1ZS5vcHRpb25zW3R5cGUgKyAncyddID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9KTsgLy8gdGhpcyBpcyB1c2VkIHRvIGlkZW50aWZ5IHRoZSAiYmFzZSIgY29uc3RydWN0b3IgdG8gZXh0ZW5kIGFsbCBwbGFpbi1vYmplY3QKICAvLyBjb21wb25lbnRzIHdpdGggaW4gV2VleCdzIG11bHRpLWluc3RhbmNlIHNjZW5hcmlvcy4KCiAgVnVlLm9wdGlvbnMuX2Jhc2UgPSBWdWU7CiAgZXh0ZW5kKFZ1ZS5vcHRpb25zLmNvbXBvbmVudHMsIGJ1aWx0SW5Db21wb25lbnRzKTsKICBpbml0VXNlKFZ1ZSk7CiAgaW5pdE1peGluKFZ1ZSk7CiAgaW5pdEV4dGVuZChWdWUpOwogIGluaXRBc3NldFJlZ2lzdGVycyhWdWUpOwp9Cgppbml0R2xvYmFsQVBJKFZ1ZSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJGlzU2VydmVyJywgewogIGdldDogaXNTZXJ2ZXJSZW5kZXJpbmcKfSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJHNzckNvbnRleHQnLCB7CiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgcmV0dXJuIHRoaXMuJHZub2RlICYmIHRoaXMuJHZub2RlLnNzckNvbnRleHQ7CiAgfQp9KTsgLy8gZXhwb3NlIEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0IGZvciBzc3IgcnVudGltZSBoZWxwZXIgaW5zdGFsbGF0aW9uCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLCAnRnVuY3Rpb25hbFJlbmRlckNvbnRleHQnLCB7CiAgdmFsdWU6IEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0Cn0pOwpWdWUudmVyc2lvbiA9IHZlcnNpb247IC8vIHRoZXNlIGFyZSByZXNlcnZlZCBmb3Igd2ViIGJlY2F1c2UgdGhleSBhcmUgZGlyZWN0bHkgY29tcGlsZWQgYXdheQovLyBkdXJpbmcgdGVtcGxhdGUgY29tcGlsYXRpb24KCnZhciBpc1Jlc2VydmVkQXR0ciA9IG1ha2VNYXAoJ3N0eWxlLGNsYXNzJyk7IC8vIGF0dHJpYnV0ZXMgdGhhdCBzaG91bGQgYmUgdXNpbmcgcHJvcHMgZm9yIGJpbmRpbmcKCnZhciBhY2NlcHRWYWx1ZSA9IG1ha2VNYXAoJ2lucHV0LHRleHRhcmVhLG9wdGlvbixzZWxlY3QscHJvZ3Jlc3MnKTsKCnZhciBtdXN0VXNlUHJvcCA9IGZ1bmN0aW9uICh0YWcsIHR5cGUsIGF0dHIpIHsKICByZXR1cm4gYXR0ciA9PT0gJ3ZhbHVlJyAmJiBhY2NlcHRWYWx1ZSh0YWcpICYmIHR5cGUgIT09ICdidXR0b24nIHx8IGF0dHIgPT09ICdzZWxlY3RlZCcgJiYgdGFnID09PSAnb3B0aW9uJyB8fCBhdHRyID09PSAnY2hlY2tlZCcgJiYgdGFnID09PSAnaW5wdXQnIHx8IGF0dHIgPT09ICdtdXRlZCcgJiYgdGFnID09PSAndmlkZW8nOwp9OwoKdmFyIGlzRW51bWVyYXRlZEF0dHIgPSBtYWtlTWFwKCdjb250ZW50ZWRpdGFibGUsZHJhZ2dhYmxlLHNwZWxsY2hlY2snKTsKdmFyIGlzVmFsaWRDb250ZW50RWRpdGFibGVWYWx1ZSA9IG1ha2VNYXAoJ2V2ZW50cyxjYXJldCx0eXBpbmcscGxhaW50ZXh0LW9ubHknKTsKCnZhciBjb252ZXJ0RW51bWVyYXRlZFZhbHVlID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICByZXR1cm4gaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkgfHwgdmFsdWUgPT09ICdmYWxzZScgPyAnZmFsc2UnIDogLy8gYWxsb3cgYXJiaXRyYXJ5IHN0cmluZyB2YWx1ZSBmb3IgY29udGVudGVkaXRhYmxlCiAga2V5ID09PSAnY29udGVudGVkaXRhYmxlJyAmJiBpc1ZhbGlkQ29udGVudEVkaXRhYmxlVmFsdWUodmFsdWUpID8gdmFsdWUgOiAndHJ1ZSc7Cn07Cgp2YXIgaXNCb29sZWFuQXR0ciA9IG1ha2VNYXAoJ2FsbG93ZnVsbHNjcmVlbixhc3luYyxhdXRvZm9jdXMsYXV0b3BsYXksY2hlY2tlZCxjb21wYWN0LGNvbnRyb2xzLGRlY2xhcmUsJyArICdkZWZhdWx0LGRlZmF1bHRjaGVja2VkLGRlZmF1bHRtdXRlZCxkZWZhdWx0c2VsZWN0ZWQsZGVmZXIsZGlzYWJsZWQsJyArICdlbmFibGVkLGZvcm1ub3ZhbGlkYXRlLGhpZGRlbixpbmRldGVybWluYXRlLGluZXJ0LGlzbWFwLGl0ZW1zY29wZSxsb29wLG11bHRpcGxlLCcgKyAnbXV0ZWQsbm9ocmVmLG5vcmVzaXplLG5vc2hhZGUsbm92YWxpZGF0ZSxub3dyYXAsb3BlbixwYXVzZW9uZXhpdCxyZWFkb25seSwnICsgJ3JlcXVpcmVkLHJldmVyc2VkLHNjb3BlZCxzZWFtbGVzcyxzZWxlY3RlZCxzb3J0YWJsZSwnICsgJ3RydWVzcGVlZCx0eXBlbXVzdG1hdGNoLHZpc2libGUnKTsKdmFyIHhsaW5rTlMgPSAnaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayc7Cgp2YXIgaXNYbGluayA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgcmV0dXJuIG5hbWUuY2hhckF0KDUpID09PSAnOicgJiYgbmFtZS5zbGljZSgwLCA1KSA9PT0gJ3hsaW5rJzsKfTsKCnZhciBnZXRYbGlua1Byb3AgPSBmdW5jdGlvbiAobmFtZSkgewogIHJldHVybiBpc1hsaW5rKG5hbWUpID8gbmFtZS5zbGljZSg2LCBuYW1lLmxlbmd0aCkgOiAnJzsKfTsKCnZhciBpc0ZhbHN5QXR0clZhbHVlID0gZnVuY3Rpb24gKHZhbCkgewogIHJldHVybiB2YWwgPT0gbnVsbCB8fCB2YWwgPT09IGZhbHNlOwp9OwoKZnVuY3Rpb24gZ2VuQ2xhc3NGb3JWbm9kZSh2bm9kZSkgewogIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICB2YXIgcGFyZW50Tm9kZSA9IHZub2RlOwogIHZhciBjaGlsZE5vZGUgPSB2bm9kZTsKCiAgd2hpbGUgKGlzRGVmKGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZSkpIHsKICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CgogICAgaWYgKGNoaWxkTm9kZSAmJiBjaGlsZE5vZGUuZGF0YSkgewogICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoY2hpbGROb2RlLmRhdGEsIGRhdGEpOwogICAgfQogIH0gLy8gQHRzLWV4cGVjdC1lcnJvciBwYXJlbnROb2RlLnBhcmVudCBub3QgVk5vZGVXaXRoRGF0YQoKCiAgd2hpbGUgKGlzRGVmKHBhcmVudE5vZGUgPSBwYXJlbnROb2RlLnBhcmVudCkpIHsKICAgIGlmIChwYXJlbnROb2RlICYmIHBhcmVudE5vZGUuZGF0YSkgewogICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoZGF0YSwgcGFyZW50Tm9kZS5kYXRhKTsKICAgIH0KICB9CgogIHJldHVybiByZW5kZXJDbGFzcyhkYXRhLnN0YXRpY0NsYXNzLCBkYXRhLmNsYXNzKTsKfQoKZnVuY3Rpb24gbWVyZ2VDbGFzc0RhdGEoY2hpbGQsIHBhcmVudCkgewogIHJldHVybiB7CiAgICBzdGF0aWNDbGFzczogY29uY2F0KGNoaWxkLnN0YXRpY0NsYXNzLCBwYXJlbnQuc3RhdGljQ2xhc3MpLAogICAgY2xhc3M6IGlzRGVmKGNoaWxkLmNsYXNzKSA/IFtjaGlsZC5jbGFzcywgcGFyZW50LmNsYXNzXSA6IHBhcmVudC5jbGFzcwogIH07Cn0KCmZ1bmN0aW9uIHJlbmRlckNsYXNzKHN0YXRpY0NsYXNzLCBkeW5hbWljQ2xhc3MpIHsKICBpZiAoaXNEZWYoc3RhdGljQ2xhc3MpIHx8IGlzRGVmKGR5bmFtaWNDbGFzcykpIHsKICAgIHJldHVybiBjb25jYXQoc3RhdGljQ2xhc3MsIHN0cmluZ2lmeUNsYXNzKGR5bmFtaWNDbGFzcykpOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCiAgcmV0dXJuICcnOwp9CgpmdW5jdGlvbiBjb25jYXQoYSwgYikgewogIHJldHVybiBhID8gYiA/IGEgKyAnICcgKyBiIDogYSA6IGIgfHwgJyc7Cn0KCmZ1bmN0aW9uIHN0cmluZ2lmeUNsYXNzKHZhbHVlKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICByZXR1cm4gc3RyaW5naWZ5QXJyYXkodmFsdWUpOwogIH0KCiAgaWYgKGlzT2JqZWN0KHZhbHVlKSkgewogICAgcmV0dXJuIHN0cmluZ2lmeU9iamVjdCh2YWx1ZSk7CiAgfQoKICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCiAgcmV0dXJuICcnOwp9CgpmdW5jdGlvbiBzdHJpbmdpZnlBcnJheSh2YWx1ZSkgewogIHZhciByZXMgPSAnJzsKICB2YXIgc3RyaW5naWZpZWQ7CgogIGZvciAodmFyIGkgPSAwLCBsID0gdmFsdWUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBpZiAoaXNEZWYoc3RyaW5naWZpZWQgPSBzdHJpbmdpZnlDbGFzcyh2YWx1ZVtpXSkpICYmIHN0cmluZ2lmaWVkICE9PSAnJykgewogICAgICBpZiAocmVzKSByZXMgKz0gJyAnOwogICAgICByZXMgKz0gc3RyaW5naWZpZWQ7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBzdHJpbmdpZnlPYmplY3QodmFsdWUpIHsKICB2YXIgcmVzID0gJyc7CgogIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgewogICAgaWYgKHZhbHVlW2tleV0pIHsKICAgICAgaWYgKHJlcykgcmVzICs9ICcgJzsKICAgICAgcmVzICs9IGtleTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KCnZhciBuYW1lc3BhY2VNYXAgPSB7CiAgc3ZnOiAnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLAogIG1hdGg6ICdodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MJwp9Owp2YXIgaXNIVE1MVGFnID0gbWFrZU1hcCgnaHRtbCxib2R5LGJhc2UsaGVhZCxsaW5rLG1ldGEsc3R5bGUsdGl0bGUsJyArICdhZGRyZXNzLGFydGljbGUsYXNpZGUsZm9vdGVyLGhlYWRlcixoMSxoMixoMyxoNCxoNSxoNixoZ3JvdXAsbmF2LHNlY3Rpb24sJyArICdkaXYsZGQsZGwsZHQsZmlnY2FwdGlvbixmaWd1cmUscGljdHVyZSxocixpbWcsbGksbWFpbixvbCxwLHByZSx1bCwnICsgJ2EsYixhYmJyLGJkaSxiZG8sYnIsY2l0ZSxjb2RlLGRhdGEsZGZuLGVtLGksa2JkLG1hcmsscSxycCxydCxydGMscnVieSwnICsgJ3Msc2FtcCxzbWFsbCxzcGFuLHN0cm9uZyxzdWIsc3VwLHRpbWUsdSx2YXIsd2JyLGFyZWEsYXVkaW8sbWFwLHRyYWNrLHZpZGVvLCcgKyAnZW1iZWQsb2JqZWN0LHBhcmFtLHNvdXJjZSxjYW52YXMsc2NyaXB0LG5vc2NyaXB0LGRlbCxpbnMsJyArICdjYXB0aW9uLGNvbCxjb2xncm91cCx0YWJsZSx0aGVhZCx0Ym9keSx0ZCx0aCx0ciwnICsgJ2J1dHRvbixkYXRhbGlzdCxmaWVsZHNldCxmb3JtLGlucHV0LGxhYmVsLGxlZ2VuZCxtZXRlcixvcHRncm91cCxvcHRpb24sJyArICdvdXRwdXQscHJvZ3Jlc3Msc2VsZWN0LHRleHRhcmVhLCcgKyAnZGV0YWlscyxkaWFsb2csbWVudSxtZW51aXRlbSxzdW1tYXJ5LCcgKyAnY29udGVudCxlbGVtZW50LHNoYWRvdyx0ZW1wbGF0ZSxibG9ja3F1b3RlLGlmcmFtZSx0Zm9vdCcpOyAvLyB0aGlzIG1hcCBpcyBpbnRlbnRpb25hbGx5IHNlbGVjdGl2ZSwgb25seSBjb3ZlcmluZyBTVkcgZWxlbWVudHMgdGhhdCBtYXkKLy8gY29udGFpbiBjaGlsZCBlbGVtZW50cy4KCnZhciBpc1NWRyA9IG1ha2VNYXAoJ3N2ZyxhbmltYXRlLGNpcmNsZSxjbGlwcGF0aCxjdXJzb3IsZGVmcyxkZXNjLGVsbGlwc2UsZmlsdGVyLGZvbnQtZmFjZSwnICsgJ2ZvcmVpZ25vYmplY3QsZyxnbHlwaCxpbWFnZSxsaW5lLG1hcmtlcixtYXNrLG1pc3NpbmctZ2x5cGgscGF0aCxwYXR0ZXJuLCcgKyAncG9seWdvbixwb2x5bGluZSxyZWN0LHN3aXRjaCxzeW1ib2wsdGV4dCx0ZXh0cGF0aCx0c3Bhbix1c2UsdmlldycsIHRydWUpOwoKdmFyIGlzUmVzZXJ2ZWRUYWcgPSBmdW5jdGlvbiAodGFnKSB7CiAgcmV0dXJuIGlzSFRNTFRhZyh0YWcpIHx8IGlzU1ZHKHRhZyk7Cn07CgpmdW5jdGlvbiBnZXRUYWdOYW1lc3BhY2UodGFnKSB7CiAgaWYgKGlzU1ZHKHRhZykpIHsKICAgIHJldHVybiAnc3ZnJzsKICB9IC8vIGJhc2ljIHN1cHBvcnQgZm9yIE1hdGhNTAogIC8vIG5vdGUgaXQgZG9lc24ndCBzdXBwb3J0IG90aGVyIE1hdGhNTCBlbGVtZW50cyBiZWluZyBjb21wb25lbnQgcm9vdHMKCgogIGlmICh0YWcgPT09ICdtYXRoJykgewogICAgcmV0dXJuICdtYXRoJzsKICB9Cn0KCnZhciB1bmtub3duRWxlbWVudENhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCmZ1bmN0aW9uIGlzVW5rbm93bkVsZW1lbnQodGFnKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFpbkJyb3dzZXIpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgaWYgKGlzUmVzZXJ2ZWRUYWcodGFnKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdGFnID0gdGFnLnRvTG93ZXJDYXNlKCk7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmICh1bmtub3duRWxlbWVudENhY2hlW3RhZ10gIT0gbnVsbCkgewogICAgcmV0dXJuIHVua25vd25FbGVtZW50Q2FjaGVbdGFnXTsKICB9CgogIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTsKCiAgaWYgKHRhZy5pbmRleE9mKCctJykgPiAtMSkgewogICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMjgyMTAzNjQvMTA3MDI0NAogICAgcmV0dXJuIHVua25vd25FbGVtZW50Q2FjaGVbdGFnXSA9IGVsLmNvbnN0cnVjdG9yID09PSB3aW5kb3cuSFRNTFVua25vd25FbGVtZW50IHx8IGVsLmNvbnN0cnVjdG9yID09PSB3aW5kb3cuSFRNTEVsZW1lbnQ7CiAgfSBlbHNlIHsKICAgIHJldHVybiB1bmtub3duRWxlbWVudENhY2hlW3RhZ10gPSAvSFRNTFVua25vd25FbGVtZW50Ly50ZXN0KGVsLnRvU3RyaW5nKCkpOwogIH0KfQoKdmFyIGlzVGV4dElucHV0VHlwZSA9IG1ha2VNYXAoJ3RleHQsbnVtYmVyLHBhc3N3b3JkLHNlYXJjaCxlbWFpbCx0ZWwsdXJsJyk7Ci8qKg0KICogUXVlcnkgYW4gZWxlbWVudCBzZWxlY3RvciBpZiBpdCdzIG5vdCBhbiBlbGVtZW50IGFscmVhZHkuDQogKi8KCmZ1bmN0aW9uIHF1ZXJ5KGVsKSB7CiAgaWYgKHR5cGVvZiBlbCA9PT0gJ3N0cmluZycpIHsKICAgIHZhciBzZWxlY3RlZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoZWwpOwoKICAgIGlmICghc2VsZWN0ZWQpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdDYW5ub3QgZmluZCBlbGVtZW50OiAnICsgZWwpOwogICAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICB9CgogICAgcmV0dXJuIHNlbGVjdGVkOwogIH0gZWxzZSB7CiAgICByZXR1cm4gZWw7CiAgfQp9CgpmdW5jdGlvbiBjcmVhdGVFbGVtZW50KHRhZ05hbWUsIHZub2RlKSB7CiAgdmFyIGVsbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7CgogIGlmICh0YWdOYW1lICE9PSAnc2VsZWN0JykgewogICAgcmV0dXJuIGVsbTsKICB9IC8vIGZhbHNlIG9yIG51bGwgd2lsbCByZW1vdmUgdGhlIGF0dHJpYnV0ZSBidXQgdW5kZWZpbmVkIHdpbGwgbm90CgoKICBpZiAodm5vZGUuZGF0YSAmJiB2bm9kZS5kYXRhLmF0dHJzICYmIHZub2RlLmRhdGEuYXR0cnMubXVsdGlwbGUgIT09IHVuZGVmaW5lZCkgewogICAgZWxtLnNldEF0dHJpYnV0ZSgnbXVsdGlwbGUnLCAnbXVsdGlwbGUnKTsKICB9CgogIHJldHVybiBlbG07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2UsIHRhZ05hbWUpIHsKICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZU1hcFtuYW1lc3BhY2VdLCB0YWdOYW1lKTsKfQoKZnVuY3Rpb24gY3JlYXRlVGV4dE5vZGUodGV4dCkgewogIHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKfQoKZnVuY3Rpb24gY3JlYXRlQ29tbWVudCh0ZXh0KSB7CiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQodGV4dCk7Cn0KCmZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnROb2RlLCBuZXdOb2RlLCByZWZlcmVuY2VOb2RlKSB7CiAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobmV3Tm9kZSwgcmVmZXJlbmNlTm9kZSk7Cn0KCmZ1bmN0aW9uIHJlbW92ZUNoaWxkKG5vZGUsIGNoaWxkKSB7CiAgbm9kZS5yZW1vdmVDaGlsZChjaGlsZCk7Cn0KCmZ1bmN0aW9uIGFwcGVuZENoaWxkKG5vZGUsIGNoaWxkKSB7CiAgbm9kZS5hcHBlbmRDaGlsZChjaGlsZCk7Cn0KCmZ1bmN0aW9uIHBhcmVudE5vZGUobm9kZSkgewogIHJldHVybiBub2RlLnBhcmVudE5vZGU7Cn0KCmZ1bmN0aW9uIG5leHRTaWJsaW5nKG5vZGUpIHsKICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKfQoKZnVuY3Rpb24gdGFnTmFtZShub2RlKSB7CiAgcmV0dXJuIG5vZGUudGFnTmFtZTsKfQoKZnVuY3Rpb24gc2V0VGV4dENvbnRlbnQobm9kZSwgdGV4dCkgewogIG5vZGUudGV4dENvbnRlbnQgPSB0ZXh0Owp9CgpmdW5jdGlvbiBzZXRTdHlsZVNjb3BlKG5vZGUsIHNjb3BlSWQpIHsKICBub2RlLnNldEF0dHJpYnV0ZShzY29wZUlkLCAnJyk7Cn0KCnZhciBub2RlT3BzID0gLyojX19QVVJFX18qL09iamVjdC5mcmVlemUoewogIF9fcHJvdG9fXzogbnVsbCwKICBjcmVhdGVFbGVtZW50OiBjcmVhdGVFbGVtZW50LAogIGNyZWF0ZUVsZW1lbnROUzogY3JlYXRlRWxlbWVudE5TLAogIGNyZWF0ZVRleHROb2RlOiBjcmVhdGVUZXh0Tm9kZSwKICBjcmVhdGVDb21tZW50OiBjcmVhdGVDb21tZW50LAogIGluc2VydEJlZm9yZTogaW5zZXJ0QmVmb3JlLAogIHJlbW92ZUNoaWxkOiByZW1vdmVDaGlsZCwKICBhcHBlbmRDaGlsZDogYXBwZW5kQ2hpbGQsCiAgcGFyZW50Tm9kZTogcGFyZW50Tm9kZSwKICBuZXh0U2libGluZzogbmV4dFNpYmxpbmcsCiAgdGFnTmFtZTogdGFnTmFtZSwKICBzZXRUZXh0Q29udGVudDogc2V0VGV4dENvbnRlbnQsCiAgc2V0U3R5bGVTY29wZTogc2V0U3R5bGVTY29wZQp9KTsKdmFyIHJlZiA9IHsKICBjcmVhdGU6IGZ1bmN0aW9uIChfLCB2bm9kZSkgewogICAgcmVnaXN0ZXJSZWYodm5vZGUpOwogIH0sCiAgdXBkYXRlOiBmdW5jdGlvbiAob2xkVm5vZGUsIHZub2RlKSB7CiAgICBpZiAob2xkVm5vZGUuZGF0YS5yZWYgIT09IHZub2RlLmRhdGEucmVmKSB7CiAgICAgIHJlZ2lzdGVyUmVmKG9sZFZub2RlLCB0cnVlKTsKICAgICAgcmVnaXN0ZXJSZWYodm5vZGUpOwogICAgfQogIH0sCiAgZGVzdHJveTogZnVuY3Rpb24gKHZub2RlKSB7CiAgICByZWdpc3RlclJlZih2bm9kZSwgdHJ1ZSk7CiAgfQp9OwoKZnVuY3Rpb24gcmVnaXN0ZXJSZWYodm5vZGUsIGlzUmVtb3ZhbCkgewogIHZhciByZWYgPSB2bm9kZS5kYXRhLnJlZjsKICBpZiAoIWlzRGVmKHJlZikpIHJldHVybjsKICB2YXIgdm0gPSB2bm9kZS5jb250ZXh0OwogIHZhciByZWZWYWx1ZSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlIHx8IHZub2RlLmVsbTsKICB2YXIgdmFsdWUgPSBpc1JlbW92YWwgPyBudWxsIDogcmVmVmFsdWU7CiAgdmFyICRyZWZzVmFsdWUgPSBpc1JlbW92YWwgPyB1bmRlZmluZWQgOiByZWZWYWx1ZTsKCiAgaWYgKGlzRnVuY3Rpb24ocmVmKSkgewogICAgaW52b2tlV2l0aEVycm9ySGFuZGxpbmcocmVmLCB2bSwgW3ZhbHVlXSwgdm0sICJ0ZW1wbGF0ZSByZWYgZnVuY3Rpb24iKTsKICAgIHJldHVybjsKICB9CgogIHZhciBpc0ZvciA9IHZub2RlLmRhdGEucmVmSW5Gb3I7CgogIHZhciBfaXNTdHJpbmcgPSB0eXBlb2YgcmVmID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgcmVmID09PSAnbnVtYmVyJzsKCiAgdmFyIF9pc1JlZiA9IGlzUmVmKHJlZik7CgogIHZhciByZWZzID0gdm0uJHJlZnM7CgogIGlmIChfaXNTdHJpbmcgfHwgX2lzUmVmKSB7CiAgICBpZiAoaXNGb3IpIHsKICAgICAgdmFyIGV4aXN0aW5nID0gX2lzU3RyaW5nID8gcmVmc1tyZWZdIDogcmVmLnZhbHVlOwoKICAgICAgaWYgKGlzUmVtb3ZhbCkgewogICAgICAgIGlzQXJyYXkoZXhpc3RpbmcpICYmIHJlbW92ZSQyKGV4aXN0aW5nLCByZWZWYWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFpc0FycmF5KGV4aXN0aW5nKSkgewogICAgICAgICAgaWYgKF9pc1N0cmluZykgewogICAgICAgICAgICByZWZzW3JlZl0gPSBbcmVmVmFsdWVdOwogICAgICAgICAgICBzZXRTZXR1cFJlZih2bSwgcmVmLCByZWZzW3JlZl0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVmLnZhbHVlID0gW3JlZlZhbHVlXTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFleGlzdGluZy5pbmNsdWRlcyhyZWZWYWx1ZSkpIHsKICAgICAgICAgIGV4aXN0aW5nLnB1c2gocmVmVmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChfaXNTdHJpbmcpIHsKICAgICAgaWYgKGlzUmVtb3ZhbCAmJiByZWZzW3JlZl0gIT09IHJlZlZhbHVlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICByZWZzW3JlZl0gPSAkcmVmc1ZhbHVlOwogICAgICBzZXRTZXR1cFJlZih2bSwgcmVmLCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKF9pc1JlZikgewogICAgICBpZiAoaXNSZW1vdmFsICYmIHJlZi52YWx1ZSAhPT0gcmVmVmFsdWUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHJlZi52YWx1ZSA9IHZhbHVlOwogICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHdhcm4oIkludmFsaWQgdGVtcGxhdGUgcmVmIHR5cGU6ICIuY29uY2F0KHR5cGVvZiByZWYpKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHNldFNldHVwUmVmKF9hLCBrZXksIHZhbCkgewogIHZhciBfc2V0dXBTdGF0ZSA9IF9hLl9zZXR1cFN0YXRlOwoKICBpZiAoX3NldHVwU3RhdGUgJiYgaGFzT3duKF9zZXR1cFN0YXRlLCBrZXkpKSB7CiAgICBpZiAoaXNSZWYoX3NldHVwU3RhdGVba2V5XSkpIHsKICAgICAgX3NldHVwU3RhdGVba2V5XS52YWx1ZSA9IHZhbDsKICAgIH0gZWxzZSB7CiAgICAgIF9zZXR1cFN0YXRlW2tleV0gPSB2YWw7CiAgICB9CiAgfQp9Ci8qKg0KICogVmlydHVhbCBET00gcGF0Y2hpbmcgYWxnb3JpdGhtIGJhc2VkIG9uIFNuYWJiZG9tIGJ5DQogKiBTaW1vbiBGcmlpcyBWaW5kdW0gKEBwYWxkZXBpbmQpDQogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UNCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9wYWxkZXBpbmQvc25hYmJkb20vYmxvYi9tYXN0ZXIvTElDRU5TRQ0KICoNCiAqIG1vZGlmaWVkIGJ5IEV2YW4gWW91IChAeXl4OTkwODAzKQ0KICoNCiAqIE5vdCB0eXBlLWNoZWNraW5nIHRoaXMgYmVjYXVzZSB0aGlzIGZpbGUgaXMgcGVyZi1jcml0aWNhbCBhbmQgdGhlIGNvc3QNCiAqIG9mIG1ha2luZyBmbG93IHVuZGVyc3RhbmQgaXQgaXMgbm90IHdvcnRoIGl0Lg0KICovCgoKdmFyIGVtcHR5Tm9kZSA9IG5ldyBWTm9kZSgnJywge30sIFtdKTsKdmFyIGhvb2tzID0gWydjcmVhdGUnLCAnYWN0aXZhdGUnLCAndXBkYXRlJywgJ3JlbW92ZScsICdkZXN0cm95J107CgpmdW5jdGlvbiBzYW1lVm5vZGUoYSwgYikgewogIHJldHVybiBhLmtleSA9PT0gYi5rZXkgJiYgYS5hc3luY0ZhY3RvcnkgPT09IGIuYXN5bmNGYWN0b3J5ICYmIChhLnRhZyA9PT0gYi50YWcgJiYgYS5pc0NvbW1lbnQgPT09IGIuaXNDb21tZW50ICYmIGlzRGVmKGEuZGF0YSkgPT09IGlzRGVmKGIuZGF0YSkgJiYgc2FtZUlucHV0VHlwZShhLCBiKSB8fCBpc1RydWUoYS5pc0FzeW5jUGxhY2Vob2xkZXIpICYmIGlzVW5kZWYoYi5hc3luY0ZhY3RvcnkuZXJyb3IpKTsKfQoKZnVuY3Rpb24gc2FtZUlucHV0VHlwZShhLCBiKSB7CiAgaWYgKGEudGFnICE9PSAnaW5wdXQnKSByZXR1cm4gdHJ1ZTsKICB2YXIgaTsKICB2YXIgdHlwZUEgPSBpc0RlZihpID0gYS5kYXRhKSAmJiBpc0RlZihpID0gaS5hdHRycykgJiYgaS50eXBlOwogIHZhciB0eXBlQiA9IGlzRGVmKGkgPSBiLmRhdGEpICYmIGlzRGVmKGkgPSBpLmF0dHJzKSAmJiBpLnR5cGU7CiAgcmV0dXJuIHR5cGVBID09PSB0eXBlQiB8fCBpc1RleHRJbnB1dFR5cGUodHlwZUEpICYmIGlzVGV4dElucHV0VHlwZSh0eXBlQik7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUtleVRvT2xkSWR4KGNoaWxkcmVuLCBiZWdpbklkeCwgZW5kSWR4KSB7CiAgdmFyIGksIGtleTsKICB2YXIgbWFwID0ge307CgogIGZvciAoaSA9IGJlZ2luSWR4OyBpIDw9IGVuZElkeDsgKytpKSB7CiAgICBrZXkgPSBjaGlsZHJlbltpXS5rZXk7CiAgICBpZiAoaXNEZWYoa2V5KSkgbWFwW2tleV0gPSBpOwogIH0KCiAgcmV0dXJuIG1hcDsKfQoKZnVuY3Rpb24gY3JlYXRlUGF0Y2hGdW5jdGlvbihiYWNrZW5kKSB7CiAgdmFyIGksIGo7CiAgdmFyIGNicyA9IHt9OwogIHZhciBtb2R1bGVzID0gYmFja2VuZC5tb2R1bGVzLAogICAgICBub2RlT3BzID0gYmFja2VuZC5ub2RlT3BzOwoKICBmb3IgKGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyArK2kpIHsKICAgIGNic1tob29rc1tpXV0gPSBbXTsKCiAgICBmb3IgKGogPSAwOyBqIDwgbW9kdWxlcy5sZW5ndGg7ICsraikgewogICAgICBpZiAoaXNEZWYobW9kdWxlc1tqXVtob29rc1tpXV0pKSB7CiAgICAgICAgY2JzW2hvb2tzW2ldXS5wdXNoKG1vZHVsZXNbal1baG9va3NbaV1dKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZW1wdHlOb2RlQXQoZWxtKSB7CiAgICByZXR1cm4gbmV3IFZOb2RlKG5vZGVPcHMudGFnTmFtZShlbG0pLnRvTG93ZXJDYXNlKCksIHt9LCBbXSwgdW5kZWZpbmVkLCBlbG0pOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlUm1DYihjaGlsZEVsbSwgbGlzdGVuZXJzKSB7CiAgICBmdW5jdGlvbiByZW1vdmUoKSB7CiAgICAgIGlmICgtLXJlbW92ZS5saXN0ZW5lcnMgPT09IDApIHsKICAgICAgICByZW1vdmVOb2RlKGNoaWxkRWxtKTsKICAgICAgfQogICAgfQoKICAgIHJlbW92ZS5saXN0ZW5lcnMgPSBsaXN0ZW5lcnM7CiAgICByZXR1cm4gcmVtb3ZlOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlTm9kZShlbCkgewogICAgdmFyIHBhcmVudCA9IG5vZGVPcHMucGFyZW50Tm9kZShlbCk7IC8vIGVsZW1lbnQgbWF5IGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQgZHVlIHRvIHYtaHRtbCAvIHYtdGV4dAoKICAgIGlmIChpc0RlZihwYXJlbnQpKSB7CiAgICAgIG5vZGVPcHMucmVtb3ZlQ2hpbGQocGFyZW50LCBlbCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1Vua25vd25FbGVtZW50KHZub2RlLCBpblZQcmUpIHsKICAgIHJldHVybiAhaW5WUHJlICYmICF2bm9kZS5ucyAmJiAhKGNvbmZpZy5pZ25vcmVkRWxlbWVudHMubGVuZ3RoICYmIGNvbmZpZy5pZ25vcmVkRWxlbWVudHMuc29tZShmdW5jdGlvbiAoaWdub3JlKSB7CiAgICAgIHJldHVybiBpc1JlZ0V4cChpZ25vcmUpID8gaWdub3JlLnRlc3Qodm5vZGUudGFnKSA6IGlnbm9yZSA9PT0gdm5vZGUudGFnOwogICAgfSkpICYmIGNvbmZpZy5pc1Vua25vd25FbGVtZW50KHZub2RlLnRhZyk7CiAgfQoKICB2YXIgY3JlYXRpbmdFbG1JblZQcmUgPSAwOwoKICBmdW5jdGlvbiBjcmVhdGVFbG0odm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0sIG5lc3RlZCwgb3duZXJBcnJheSwgaW5kZXgpIHsKICAgIGlmIChpc0RlZih2bm9kZS5lbG0pICYmIGlzRGVmKG93bmVyQXJyYXkpKSB7CiAgICAgIC8vIFRoaXMgdm5vZGUgd2FzIHVzZWQgaW4gYSBwcmV2aW91cyByZW5kZXIhCiAgICAgIC8vIG5vdyBpdCdzIHVzZWQgYXMgYSBuZXcgbm9kZSwgb3ZlcndyaXRpbmcgaXRzIGVsbSB3b3VsZCBjYXVzZQogICAgICAvLyBwb3RlbnRpYWwgcGF0Y2ggZXJyb3JzIGRvd24gdGhlIHJvYWQgd2hlbiBpdCdzIHVzZWQgYXMgYW4gaW5zZXJ0aW9uCiAgICAgIC8vIHJlZmVyZW5jZSBub2RlLiBJbnN0ZWFkLCB3ZSBjbG9uZSB0aGUgbm9kZSBvbi1kZW1hbmQgYmVmb3JlIGNyZWF0aW5nCiAgICAgIC8vIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgZm9yIGl0LgogICAgICB2bm9kZSA9IG93bmVyQXJyYXlbaW5kZXhdID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICB9CgogICAgdm5vZGUuaXNSb290SW5zZXJ0ID0gIW5lc3RlZDsgLy8gZm9yIHRyYW5zaXRpb24gZW50ZXIgY2hlY2sKCiAgICBpZiAoY3JlYXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgdmFyIGNoaWxkcmVuID0gdm5vZGUuY2hpbGRyZW47CiAgICB2YXIgdGFnID0gdm5vZGUudGFnOwoKICAgIGlmIChpc0RlZih0YWcpKSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wcmUpIHsKICAgICAgICAgIGNyZWF0aW5nRWxtSW5WUHJlKys7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNVbmtub3duRWxlbWVudCh2bm9kZSwgY3JlYXRpbmdFbG1JblZQcmUpKSB7CiAgICAgICAgICB3YXJuKCdVbmtub3duIGN1c3RvbSBlbGVtZW50OiA8JyArIHRhZyArICc+IC0gZGlkIHlvdSAnICsgJ3JlZ2lzdGVyIHRoZSBjb21wb25lbnQgY29ycmVjdGx5PyBGb3IgcmVjdXJzaXZlIGNvbXBvbmVudHMsICcgKyAnbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhlICJuYW1lIiBvcHRpb24uJywgdm5vZGUuY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CgogICAgICB2bm9kZS5lbG0gPSB2bm9kZS5ucyA/IG5vZGVPcHMuY3JlYXRlRWxlbWVudE5TKHZub2RlLm5zLCB0YWcpIDogbm9kZU9wcy5jcmVhdGVFbGVtZW50KHRhZywgdm5vZGUpOwogICAgICBzZXRTY29wZSh2bm9kZSk7CiAgICAgIGNyZWF0ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbiwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKCiAgICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICB9CgogICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBkYXRhICYmIGRhdGEucHJlKSB7CiAgICAgICAgY3JlYXRpbmdFbG1JblZQcmUtLTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc1RydWUodm5vZGUuaXNDb21tZW50KSkgewogICAgICB2bm9kZS5lbG0gPSBub2RlT3BzLmNyZWF0ZUNvbW1lbnQodm5vZGUudGV4dCk7CiAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgIH0gZWxzZSB7CiAgICAgIHZub2RlLmVsbSA9IG5vZGVPcHMuY3JlYXRlVGV4dE5vZGUodm5vZGUudGV4dCk7CiAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSkgewogICAgdmFyIGkgPSB2bm9kZS5kYXRhOwoKICAgIGlmIChpc0RlZihpKSkgewogICAgICB2YXIgaXNSZWFjdGl2YXRlZCA9IGlzRGVmKHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSAmJiBpLmtlZXBBbGl2ZTsKCiAgICAgIGlmIChpc0RlZihpID0gaS5ob29rKSAmJiBpc0RlZihpID0gaS5pbml0KSkgewogICAgICAgIGkodm5vZGUsIGZhbHNlCiAgICAgICAgLyogaHlkcmF0aW5nICovCiAgICAgICAgKTsKICAgICAgfSAvLyBhZnRlciBjYWxsaW5nIHRoZSBpbml0IGhvb2ssIGlmIHRoZSB2bm9kZSBpcyBhIGNoaWxkIGNvbXBvbmVudAogICAgICAvLyBpdCBzaG91bGQndmUgY3JlYXRlZCBhIGNoaWxkIGluc3RhbmNlIGFuZCBtb3VudGVkIGl0LiB0aGUgY2hpbGQKICAgICAgLy8gY29tcG9uZW50IGFsc28gaGFzIHNldCB0aGUgcGxhY2Vob2xkZXIgdm5vZGUncyBlbG0uCiAgICAgIC8vIGluIHRoYXQgY2FzZSB3ZSBjYW4ganVzdCByZXR1cm4gdGhlIGVsZW1lbnQgYW5kIGJlIGRvbmUuCgoKICAgICAgaWYgKGlzRGVmKHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSkgewogICAgICAgIGluaXRDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwoKICAgICAgICBpZiAoaXNUcnVlKGlzUmVhY3RpdmF0ZWQpKSB7CiAgICAgICAgICByZWFjdGl2YXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgIGlmIChpc0RlZih2bm9kZS5kYXRhLnBlbmRpbmdJbnNlcnQpKSB7CiAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoLmFwcGx5KGluc2VydGVkVm5vZGVRdWV1ZSwgdm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0KTsKICAgICAgdm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0ID0gbnVsbDsKICAgIH0KCiAgICB2bm9kZS5lbG0gPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZS4kZWw7CgogICAgaWYgKGlzUGF0Y2hhYmxlKHZub2RlKSkgewogICAgICBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgc2V0U2NvcGUodm5vZGUpOwogICAgfSBlbHNlIHsKICAgICAgLy8gZW1wdHkgY29tcG9uZW50IHJvb3QuCiAgICAgIC8vIHNraXAgYWxsIGVsZW1lbnQtcmVsYXRlZCBtb2R1bGVzIGV4Y2VwdCBmb3IgcmVmICgjMzQ1NSkKICAgICAgcmVnaXN0ZXJSZWYodm5vZGUpOyAvLyBtYWtlIHN1cmUgdG8gaW52b2tlIHRoZSBpbnNlcnQgaG9vawoKICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2godm5vZGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVhY3RpdmF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSkgewogICAgdmFyIGk7IC8vIGhhY2sgZm9yICM0MzM5OiBhIHJlYWN0aXZhdGVkIGNvbXBvbmVudCB3aXRoIGlubmVyIHRyYW5zaXRpb24KICAgIC8vIGRvZXMgbm90IHRyaWdnZXIgYmVjYXVzZSB0aGUgaW5uZXIgbm9kZSdzIGNyZWF0ZWQgaG9va3MgYXJlIG5vdCBjYWxsZWQKICAgIC8vIGFnYWluLiBJdCdzIG5vdCBpZGVhbCB0byBpbnZvbHZlIG1vZHVsZS1zcGVjaWZpYyBsb2dpYyBpbiBoZXJlIGJ1dAogICAgLy8gdGhlcmUgZG9lc24ndCBzZWVtIHRvIGJlIGEgYmV0dGVyIHdheSB0byBkbyBpdC4KCiAgICB2YXIgaW5uZXJOb2RlID0gdm5vZGU7CgogICAgd2hpbGUgKGlubmVyTm9kZS5jb21wb25lbnRJbnN0YW5jZSkgewogICAgICBpbm5lck5vZGUgPSBpbm5lck5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlOwoKICAgICAgaWYgKGlzRGVmKGkgPSBpbm5lck5vZGUuZGF0YSkgJiYgaXNEZWYoaSA9IGkudHJhbnNpdGlvbikpIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY2JzLmFjdGl2YXRlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjYnMuYWN0aXZhdGVbaV0oZW1wdHlOb2RlLCBpbm5lck5vZGUpOwogICAgICAgIH0KCiAgICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2goaW5uZXJOb2RlKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfSAvLyB1bmxpa2UgYSBuZXdseSBjcmVhdGVkIGNvbXBvbmVudCwKICAgIC8vIGEgcmVhY3RpdmF0ZWQga2VlcC1hbGl2ZSBjb21wb25lbnQgZG9lc24ndCBpbnNlcnQgaXRzZWxmCgoKICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICB9CgogIGZ1bmN0aW9uIGluc2VydChwYXJlbnQsIGVsbSwgcmVmKSB7CiAgICBpZiAoaXNEZWYocGFyZW50KSkgewogICAgICBpZiAoaXNEZWYocmVmKSkgewogICAgICAgIGlmIChub2RlT3BzLnBhcmVudE5vZGUocmVmKSA9PT0gcGFyZW50KSB7CiAgICAgICAgICBub2RlT3BzLmluc2VydEJlZm9yZShwYXJlbnQsIGVsbSwgcmVmKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZU9wcy5hcHBlbmRDaGlsZChwYXJlbnQsIGVsbSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbiwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBjaGVja0R1cGxpY2F0ZUtleXMoY2hpbGRyZW4pOwogICAgICB9CgogICAgICBmb3IgKHZhciBpXzEgPSAwOyBpXzEgPCBjaGlsZHJlbi5sZW5ndGg7ICsraV8xKSB7CiAgICAgICAgY3JlYXRlRWxtKGNoaWxkcmVuW2lfMV0sIGluc2VydGVkVm5vZGVRdWV1ZSwgdm5vZGUuZWxtLCBudWxsLCB0cnVlLCBjaGlsZHJlbiwgaV8xKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZSh2bm9kZS50ZXh0KSkgewogICAgICBub2RlT3BzLmFwcGVuZENoaWxkKHZub2RlLmVsbSwgbm9kZU9wcy5jcmVhdGVUZXh0Tm9kZShTdHJpbmcodm5vZGUudGV4dCkpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGlzUGF0Y2hhYmxlKHZub2RlKSB7CiAgICB3aGlsZSAodm5vZGUuY29tcG9uZW50SW5zdGFuY2UpIHsKICAgICAgdm5vZGUgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CiAgICB9CgogICAgcmV0dXJuIGlzRGVmKHZub2RlLnRhZyk7CiAgfQoKICBmdW5jdGlvbiBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBmb3IgKHZhciBpXzIgPSAwOyBpXzIgPCBjYnMuY3JlYXRlLmxlbmd0aDsgKytpXzIpIHsKICAgICAgY2JzLmNyZWF0ZVtpXzJdKGVtcHR5Tm9kZSwgdm5vZGUpOwogICAgfQoKICAgIGkgPSB2bm9kZS5kYXRhLmhvb2s7IC8vIFJldXNlIHZhcmlhYmxlCgogICAgaWYgKGlzRGVmKGkpKSB7CiAgICAgIGlmIChpc0RlZihpLmNyZWF0ZSkpIGkuY3JlYXRlKGVtcHR5Tm9kZSwgdm5vZGUpOwogICAgICBpZiAoaXNEZWYoaS5pbnNlcnQpKSBpbnNlcnRlZFZub2RlUXVldWUucHVzaCh2bm9kZSk7CiAgICB9CiAgfSAvLyBzZXQgc2NvcGUgaWQgYXR0cmlidXRlIGZvciBzY29wZWQgQ1NTLgogIC8vIHRoaXMgaXMgaW1wbGVtZW50ZWQgYXMgYSBzcGVjaWFsIGNhc2UgdG8gYXZvaWQgdGhlIG92ZXJoZWFkCiAgLy8gb2YgZ29pbmcgdGhyb3VnaCB0aGUgbm9ybWFsIGF0dHJpYnV0ZSBwYXRjaGluZyBwcm9jZXNzLgoKCiAgZnVuY3Rpb24gc2V0U2NvcGUodm5vZGUpIHsKICAgIHZhciBpOwoKICAgIGlmIChpc0RlZihpID0gdm5vZGUuZm5TY29wZUlkKSkgewogICAgICBub2RlT3BzLnNldFN0eWxlU2NvcGUodm5vZGUuZWxtLCBpKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBhbmNlc3RvciA9IHZub2RlOwoKICAgICAgd2hpbGUgKGFuY2VzdG9yKSB7CiAgICAgICAgaWYgKGlzRGVmKGkgPSBhbmNlc3Rvci5jb250ZXh0KSAmJiBpc0RlZihpID0gaS4kb3B0aW9ucy5fc2NvcGVJZCkpIHsKICAgICAgICAgIG5vZGVPcHMuc2V0U3R5bGVTY29wZSh2bm9kZS5lbG0sIGkpOwogICAgICAgIH0KCiAgICAgICAgYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnQ7CiAgICAgIH0KICAgIH0gLy8gZm9yIHNsb3QgY29udGVudCB0aGV5IHNob3VsZCBhbHNvIGdldCB0aGUgc2NvcGVJZCBmcm9tIHRoZSBob3N0IGluc3RhbmNlLgoKCiAgICBpZiAoaXNEZWYoaSA9IGFjdGl2ZUluc3RhbmNlKSAmJiBpICE9PSB2bm9kZS5jb250ZXh0ICYmIGkgIT09IHZub2RlLmZuQ29udGV4dCAmJiBpc0RlZihpID0gaS4kb3B0aW9ucy5fc2NvcGVJZCkpIHsKICAgICAgbm9kZU9wcy5zZXRTdHlsZVNjb3BlKHZub2RlLmVsbSwgaSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhZGRWbm9kZXMocGFyZW50RWxtLCByZWZFbG0sIHZub2Rlcywgc3RhcnRJZHgsIGVuZElkeCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBmb3IgKDsgc3RhcnRJZHggPD0gZW5kSWR4OyArK3N0YXJ0SWR4KSB7CiAgICAgIGNyZWF0ZUVsbSh2bm9kZXNbc3RhcnRJZHhdLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtLCBmYWxzZSwgdm5vZGVzLCBzdGFydElkeCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbnZva2VEZXN0cm95SG9vayh2bm9kZSkgewogICAgdmFyIGksIGo7CiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CgogICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5kZXN0cm95KSkgaSh2bm9kZSk7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgY2JzLmRlc3Ryb3kubGVuZ3RoOyArK2kpIGNicy5kZXN0cm95W2ldKHZub2RlKTsKICAgIH0KCiAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNoaWxkcmVuKSkgewogICAgICBmb3IgKGogPSAwOyBqIDwgdm5vZGUuY2hpbGRyZW4ubGVuZ3RoOyArK2opIHsKICAgICAgICBpbnZva2VEZXN0cm95SG9vayh2bm9kZS5jaGlsZHJlbltqXSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbW92ZVZub2Rlcyh2bm9kZXMsIHN0YXJ0SWR4LCBlbmRJZHgpIHsKICAgIGZvciAoOyBzdGFydElkeCA8PSBlbmRJZHg7ICsrc3RhcnRJZHgpIHsKICAgICAgdmFyIGNoID0gdm5vZGVzW3N0YXJ0SWR4XTsKCiAgICAgIGlmIChpc0RlZihjaCkpIHsKICAgICAgICBpZiAoaXNEZWYoY2gudGFnKSkgewogICAgICAgICAgcmVtb3ZlQW5kSW52b2tlUmVtb3ZlSG9vayhjaCk7CiAgICAgICAgICBpbnZva2VEZXN0cm95SG9vayhjaCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFRleHQgbm9kZQogICAgICAgICAgcmVtb3ZlTm9kZShjaC5lbG0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlQW5kSW52b2tlUmVtb3ZlSG9vayh2bm9kZSwgcm0pIHsKICAgIGlmIChpc0RlZihybSkgfHwgaXNEZWYodm5vZGUuZGF0YSkpIHsKICAgICAgdmFyIGlfMzsKICAgICAgdmFyIGxpc3RlbmVycyA9IGNicy5yZW1vdmUubGVuZ3RoICsgMTsKCiAgICAgIGlmIChpc0RlZihybSkpIHsKICAgICAgICAvLyB3ZSBoYXZlIGEgcmVjdXJzaXZlbHkgcGFzc2VkIGRvd24gcm0gY2FsbGJhY2sKICAgICAgICAvLyBpbmNyZWFzZSB0aGUgbGlzdGVuZXJzIGNvdW50CiAgICAgICAgcm0ubGlzdGVuZXJzICs9IGxpc3RlbmVyczsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBkaXJlY3RseSByZW1vdmluZwogICAgICAgIHJtID0gY3JlYXRlUm1DYih2bm9kZS5lbG0sIGxpc3RlbmVycyk7CiAgICAgIH0gLy8gcmVjdXJzaXZlbHkgaW52b2tlIGhvb2tzIG9uIGNoaWxkIGNvbXBvbmVudCByb290IG5vZGUKCgogICAgICBpZiAoaXNEZWYoaV8zID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UpICYmIGlzRGVmKGlfMyA9IGlfMy5fdm5vZGUpICYmIGlzRGVmKGlfMy5kYXRhKSkgewogICAgICAgIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2soaV8zLCBybSk7CiAgICAgIH0KCiAgICAgIGZvciAoaV8zID0gMDsgaV8zIDwgY2JzLnJlbW92ZS5sZW5ndGg7ICsraV8zKSB7CiAgICAgICAgY2JzLnJlbW92ZVtpXzNdKHZub2RlLCBybSk7CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZihpXzMgPSB2bm9kZS5kYXRhLmhvb2spICYmIGlzRGVmKGlfMyA9IGlfMy5yZW1vdmUpKSB7CiAgICAgICAgaV8zKHZub2RlLCBybSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm0oKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmVtb3ZlTm9kZSh2bm9kZS5lbG0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdXBkYXRlQ2hpbGRyZW4ocGFyZW50RWxtLCBvbGRDaCwgbmV3Q2gsIGluc2VydGVkVm5vZGVRdWV1ZSwgcmVtb3ZlT25seSkgewogICAgdmFyIG9sZFN0YXJ0SWR4ID0gMDsKICAgIHZhciBuZXdTdGFydElkeCA9IDA7CiAgICB2YXIgb2xkRW5kSWR4ID0gb2xkQ2gubGVuZ3RoIC0gMTsKICAgIHZhciBvbGRTdGFydFZub2RlID0gb2xkQ2hbMF07CiAgICB2YXIgb2xkRW5kVm5vZGUgPSBvbGRDaFtvbGRFbmRJZHhdOwogICAgdmFyIG5ld0VuZElkeCA9IG5ld0NoLmxlbmd0aCAtIDE7CiAgICB2YXIgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWzBdOwogICAgdmFyIG5ld0VuZFZub2RlID0gbmV3Q2hbbmV3RW5kSWR4XTsKICAgIHZhciBvbGRLZXlUb0lkeCwgaWR4SW5PbGQsIHZub2RlVG9Nb3ZlLCByZWZFbG07IC8vIHJlbW92ZU9ubHkgaXMgYSBzcGVjaWFsIGZsYWcgdXNlZCBvbmx5IGJ5IDx0cmFuc2l0aW9uLWdyb3VwPgogICAgLy8gdG8gZW5zdXJlIHJlbW92ZWQgZWxlbWVudHMgc3RheSBpbiBjb3JyZWN0IHJlbGF0aXZlIHBvc2l0aW9ucwogICAgLy8gZHVyaW5nIGxlYXZpbmcgdHJhbnNpdGlvbnMKCiAgICB2YXIgY2FuTW92ZSA9ICFyZW1vdmVPbmx5OwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGNoZWNrRHVwbGljYXRlS2V5cyhuZXdDaCk7CiAgICB9CgogICAgd2hpbGUgKG9sZFN0YXJ0SWR4IDw9IG9sZEVuZElkeCAmJiBuZXdTdGFydElkeCA8PSBuZXdFbmRJZHgpIHsKICAgICAgaWYgKGlzVW5kZWYob2xkU3RhcnRWbm9kZSkpIHsKICAgICAgICBvbGRTdGFydFZub2RlID0gb2xkQ2hbKytvbGRTdGFydElkeF07IC8vIFZub2RlIGhhcyBiZWVuIG1vdmVkIGxlZnQKICAgICAgfSBlbHNlIGlmIChpc1VuZGVmKG9sZEVuZFZub2RlKSkgewogICAgICAgIG9sZEVuZFZub2RlID0gb2xkQ2hbLS1vbGRFbmRJZHhdOwogICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRTdGFydFZub2RlLCBuZXdTdGFydFZub2RlKSkgewogICAgICAgIHBhdGNoVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgIG9sZFN0YXJ0Vm5vZGUgPSBvbGRDaFsrK29sZFN0YXJ0SWR4XTsKICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZEVuZFZub2RlLCBuZXdFbmRWbm9kZSkpIHsKICAgICAgICBwYXRjaFZub2RlKG9sZEVuZFZub2RlLCBuZXdFbmRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3RW5kSWR4KTsKICAgICAgICBvbGRFbmRWbm9kZSA9IG9sZENoWy0tb2xkRW5kSWR4XTsKICAgICAgICBuZXdFbmRWbm9kZSA9IG5ld0NoWy0tbmV3RW5kSWR4XTsKICAgICAgfSBlbHNlIGlmIChzYW1lVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3RW5kVm5vZGUpKSB7CiAgICAgICAgLy8gVm5vZGUgbW92ZWQgcmlnaHQKICAgICAgICBwYXRjaFZub2RlKG9sZFN0YXJ0Vm5vZGUsIG5ld0VuZFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG5ld0NoLCBuZXdFbmRJZHgpOwogICAgICAgIGNhbk1vdmUgJiYgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50RWxtLCBvbGRTdGFydFZub2RlLmVsbSwgbm9kZU9wcy5uZXh0U2libGluZyhvbGRFbmRWbm9kZS5lbG0pKTsKICAgICAgICBvbGRTdGFydFZub2RlID0gb2xkQ2hbKytvbGRTdGFydElkeF07CiAgICAgICAgbmV3RW5kVm5vZGUgPSBuZXdDaFstLW5ld0VuZElkeF07CiAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZEVuZFZub2RlLCBuZXdTdGFydFZub2RlKSkgewogICAgICAgIC8vIFZub2RlIG1vdmVkIGxlZnQKICAgICAgICBwYXRjaFZub2RlKG9sZEVuZFZub2RlLCBuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgY2FuTW92ZSAmJiBub2RlT3BzLmluc2VydEJlZm9yZShwYXJlbnRFbG0sIG9sZEVuZFZub2RlLmVsbSwgb2xkU3RhcnRWbm9kZS5lbG0pOwogICAgICAgIG9sZEVuZFZub2RlID0gb2xkQ2hbLS1vbGRFbmRJZHhdOwogICAgICAgIG5ld1N0YXJ0Vm5vZGUgPSBuZXdDaFsrK25ld1N0YXJ0SWR4XTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNVbmRlZihvbGRLZXlUb0lkeCkpIG9sZEtleVRvSWR4ID0gY3JlYXRlS2V5VG9PbGRJZHgob2xkQ2gsIG9sZFN0YXJ0SWR4LCBvbGRFbmRJZHgpOwogICAgICAgIGlkeEluT2xkID0gaXNEZWYobmV3U3RhcnRWbm9kZS5rZXkpID8gb2xkS2V5VG9JZHhbbmV3U3RhcnRWbm9kZS5rZXldIDogZmluZElkeEluT2xkKG5ld1N0YXJ0Vm5vZGUsIG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKCiAgICAgICAgaWYgKGlzVW5kZWYoaWR4SW5PbGQpKSB7CiAgICAgICAgICAvLyBOZXcgZWxlbWVudAogICAgICAgICAgY3JlYXRlRWxtKG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCBvbGRTdGFydFZub2RlLmVsbSwgZmFsc2UsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZub2RlVG9Nb3ZlID0gb2xkQ2hbaWR4SW5PbGRdOwoKICAgICAgICAgIGlmIChzYW1lVm5vZGUodm5vZGVUb01vdmUsIG5ld1N0YXJ0Vm5vZGUpKSB7CiAgICAgICAgICAgIHBhdGNoVm5vZGUodm5vZGVUb01vdmUsIG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld1N0YXJ0SWR4KTsKICAgICAgICAgICAgb2xkQ2hbaWR4SW5PbGRdID0gdW5kZWZpbmVkOwogICAgICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgdm5vZGVUb01vdmUuZWxtLCBvbGRTdGFydFZub2RlLmVsbSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBzYW1lIGtleSBidXQgZGlmZmVyZW50IGVsZW1lbnQuIHRyZWF0IGFzIG5ldyBlbGVtZW50CiAgICAgICAgICAgIGNyZWF0ZUVsbShuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIGZhbHNlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWysrbmV3U3RhcnRJZHhdOwogICAgICB9CiAgICB9CgogICAgaWYgKG9sZFN0YXJ0SWR4ID4gb2xkRW5kSWR4KSB7CiAgICAgIHJlZkVsbSA9IGlzVW5kZWYobmV3Q2hbbmV3RW5kSWR4ICsgMV0pID8gbnVsbCA6IG5ld0NoW25ld0VuZElkeCArIDFdLmVsbTsKICAgICAgYWRkVm5vZGVzKHBhcmVudEVsbSwgcmVmRWxtLCBuZXdDaCwgbmV3U3RhcnRJZHgsIG5ld0VuZElkeCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgIH0gZWxzZSBpZiAobmV3U3RhcnRJZHggPiBuZXdFbmRJZHgpIHsKICAgICAgcmVtb3ZlVm5vZGVzKG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNoZWNrRHVwbGljYXRlS2V5cyhjaGlsZHJlbikgewogICAgdmFyIHNlZW5LZXlzID0ge307CgogICAgZm9yICh2YXIgaV80ID0gMDsgaV80IDwgY2hpbGRyZW4ubGVuZ3RoOyBpXzQrKykgewogICAgICB2YXIgdm5vZGUgPSBjaGlsZHJlbltpXzRdOwogICAgICB2YXIga2V5ID0gdm5vZGUua2V5OwoKICAgICAgaWYgKGlzRGVmKGtleSkpIHsKICAgICAgICBpZiAoc2VlbktleXNba2V5XSkgewogICAgICAgICAgd2FybigiRHVwbGljYXRlIGtleXMgZGV0ZWN0ZWQ6ICciLmNvbmNhdChrZXksICInLiBUaGlzIG1heSBjYXVzZSBhbiB1cGRhdGUgZXJyb3IuIiksIHZub2RlLmNvbnRleHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWVuS2V5c1trZXldID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGZpbmRJZHhJbk9sZChub2RlLCBvbGRDaCwgc3RhcnQsIGVuZCkgewogICAgZm9yICh2YXIgaV81ID0gc3RhcnQ7IGlfNSA8IGVuZDsgaV81KyspIHsKICAgICAgdmFyIGMgPSBvbGRDaFtpXzVdOwogICAgICBpZiAoaXNEZWYoYykgJiYgc2FtZVZub2RlKG5vZGUsIGMpKSByZXR1cm4gaV81OwogICAgfQogIH0KCiAgZnVuY3Rpb24gcGF0Y2hWbm9kZShvbGRWbm9kZSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgb3duZXJBcnJheSwgaW5kZXgsIHJlbW92ZU9ubHkpIHsKICAgIGlmIChvbGRWbm9kZSA9PT0gdm5vZGUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChpc0RlZih2bm9kZS5lbG0pICYmIGlzRGVmKG93bmVyQXJyYXkpKSB7CiAgICAgIC8vIGNsb25lIHJldXNlZCB2bm9kZQogICAgICB2bm9kZSA9IG93bmVyQXJyYXlbaW5kZXhdID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICB9CgogICAgdmFyIGVsbSA9IHZub2RlLmVsbSA9IG9sZFZub2RlLmVsbTsKCiAgICBpZiAoaXNUcnVlKG9sZFZub2RlLmlzQXN5bmNQbGFjZWhvbGRlcikpIHsKICAgICAgaWYgKGlzRGVmKHZub2RlLmFzeW5jRmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgICAgICBoeWRyYXRlKG9sZFZub2RlLmVsbSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdm5vZGUuaXNBc3luY1BsYWNlaG9sZGVyID0gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuOwogICAgfSAvLyByZXVzZSBlbGVtZW50IGZvciBzdGF0aWMgdHJlZXMuCiAgICAvLyBub3RlIHdlIG9ubHkgZG8gdGhpcyBpZiB0aGUgdm5vZGUgaXMgY2xvbmVkIC0KICAgIC8vIGlmIHRoZSBuZXcgbm9kZSBpcyBub3QgY2xvbmVkIGl0IG1lYW5zIHRoZSByZW5kZXIgZnVuY3Rpb25zIGhhdmUgYmVlbgogICAgLy8gcmVzZXQgYnkgdGhlIGhvdC1yZWxvYWQtYXBpIGFuZCB3ZSBuZWVkIHRvIGRvIGEgcHJvcGVyIHJlLXJlbmRlci4KCgogICAgaWYgKGlzVHJ1ZSh2bm9kZS5pc1N0YXRpYykgJiYgaXNUcnVlKG9sZFZub2RlLmlzU3RhdGljKSAmJiB2bm9kZS5rZXkgPT09IG9sZFZub2RlLmtleSAmJiAoaXNUcnVlKHZub2RlLmlzQ2xvbmVkKSB8fCBpc1RydWUodm5vZGUuaXNPbmNlKSkpIHsKICAgICAgdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBvbGRWbm9kZS5jb21wb25lbnRJbnN0YW5jZTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBpOwogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwoKICAgIGlmIChpc0RlZihkYXRhKSAmJiBpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5wcmVwYXRjaCkpIHsKICAgICAgaShvbGRWbm9kZSwgdm5vZGUpOwogICAgfQoKICAgIHZhciBvbGRDaCA9IG9sZFZub2RlLmNoaWxkcmVuOwogICAgdmFyIGNoID0gdm5vZGUuY2hpbGRyZW47CgogICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzUGF0Y2hhYmxlKHZub2RlKSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgY2JzLnVwZGF0ZS5sZW5ndGg7ICsraSkgY2JzLnVwZGF0ZVtpXShvbGRWbm9kZSwgdm5vZGUpOwoKICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLnVwZGF0ZSkpIGkob2xkVm5vZGUsIHZub2RlKTsKICAgIH0KCiAgICBpZiAoaXNVbmRlZih2bm9kZS50ZXh0KSkgewogICAgICBpZiAoaXNEZWYob2xkQ2gpICYmIGlzRGVmKGNoKSkgewogICAgICAgIGlmIChvbGRDaCAhPT0gY2gpIHVwZGF0ZUNoaWxkcmVuKGVsbSwgb2xkQ2gsIGNoLCBpbnNlcnRlZFZub2RlUXVldWUsIHJlbW92ZU9ubHkpOwogICAgICB9IGVsc2UgaWYgKGlzRGVmKGNoKSkgewogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICBjaGVja0R1cGxpY2F0ZUtleXMoY2gpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRGVmKG9sZFZub2RlLnRleHQpKSBub2RlT3BzLnNldFRleHRDb250ZW50KGVsbSwgJycpOwogICAgICAgIGFkZFZub2RlcyhlbG0sIG51bGwsIGNoLCAwLCBjaC5sZW5ndGggLSAxLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICB9IGVsc2UgaWYgKGlzRGVmKG9sZENoKSkgewogICAgICAgIHJlbW92ZVZub2RlcyhvbGRDaCwgMCwgb2xkQ2gubGVuZ3RoIC0gMSk7CiAgICAgIH0gZWxzZSBpZiAoaXNEZWYob2xkVm5vZGUudGV4dCkpIHsKICAgICAgICBub2RlT3BzLnNldFRleHRDb250ZW50KGVsbSwgJycpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKG9sZFZub2RlLnRleHQgIT09IHZub2RlLnRleHQpIHsKICAgICAgbm9kZU9wcy5zZXRUZXh0Q29udGVudChlbG0sIHZub2RlLnRleHQpOwogICAgfQoKICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkucG9zdHBhdGNoKSkgaShvbGRWbm9kZSwgdm5vZGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgcXVldWUsIGluaXRpYWwpIHsKICAgIC8vIGRlbGF5IGluc2VydCBob29rcyBmb3IgY29tcG9uZW50IHJvb3Qgbm9kZXMsIGludm9rZSB0aGVtIGFmdGVyIHRoZQogICAgLy8gZWxlbWVudCBpcyByZWFsbHkgaW5zZXJ0ZWQKICAgIGlmIChpc1RydWUoaW5pdGlhbCkgJiYgaXNEZWYodm5vZGUucGFyZW50KSkgewogICAgICB2bm9kZS5wYXJlbnQuZGF0YS5wZW5kaW5nSW5zZXJ0ID0gcXVldWU7CiAgICB9IGVsc2UgewogICAgICBmb3IgKHZhciBpXzYgPSAwOyBpXzYgPCBxdWV1ZS5sZW5ndGg7ICsraV82KSB7CiAgICAgICAgcXVldWVbaV82XS5kYXRhLmhvb2suaW5zZXJ0KHF1ZXVlW2lfNl0pOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgaHlkcmF0aW9uQmFpbGVkID0gZmFsc2U7IC8vIGxpc3Qgb2YgbW9kdWxlcyB0aGF0IGNhbiBza2lwIGNyZWF0ZSBob29rIGR1cmluZyBoeWRyYXRpb24gYmVjYXVzZSB0aGV5CiAgLy8gYXJlIGFscmVhZHkgcmVuZGVyZWQgb24gdGhlIGNsaWVudCBvciBoYXMgbm8gbmVlZCBmb3IgaW5pdGlhbGl6YXRpb24KICAvLyBOb3RlOiBzdHlsZSBpcyBleGNsdWRlZCBiZWNhdXNlIGl0IHJlbGllcyBvbiBpbml0aWFsIGNsb25lIGZvciBmdXR1cmUKICAvLyBkZWVwIHVwZGF0ZXMgKCM3MDYzKS4KCiAgdmFyIGlzUmVuZGVyZWRNb2R1bGUgPSBtYWtlTWFwKCdhdHRycyxjbGFzcyxzdGF0aWNDbGFzcyxzdGF0aWNTdHlsZSxrZXknKTsgLy8gTm90ZTogdGhpcyBpcyBhIGJyb3dzZXItb25seSBmdW5jdGlvbiBzbyB3ZSBjYW4gYXNzdW1lIGVsbXMgYXJlIERPTSBub2Rlcy4KCiAgZnVuY3Rpb24gaHlkcmF0ZShlbG0sIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIGluVlByZSkgewogICAgdmFyIGk7CiAgICB2YXIgdGFnID0gdm5vZGUudGFnLAogICAgICAgIGRhdGEgPSB2bm9kZS5kYXRhLAogICAgICAgIGNoaWxkcmVuID0gdm5vZGUuY2hpbGRyZW47CiAgICBpblZQcmUgPSBpblZQcmUgfHwgZGF0YSAmJiBkYXRhLnByZTsKICAgIHZub2RlLmVsbSA9IGVsbTsKCiAgICBpZiAoaXNUcnVlKHZub2RlLmlzQ29tbWVudCkgJiYgaXNEZWYodm5vZGUuYXN5bmNGYWN0b3J5KSkgewogICAgICB2bm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIgPSB0cnVlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gLy8gYXNzZXJ0IG5vZGUgbWF0Y2gKCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKCFhc3NlcnROb2RlTWF0Y2goZWxtLCB2bm9kZSwgaW5WUHJlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkuaW5pdCkpIGkodm5vZGUsIHRydWUKICAgICAgLyogaHlkcmF0aW5nICovCiAgICAgICk7CgogICAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSkgewogICAgICAgIC8vIGNoaWxkIGNvbXBvbmVudC4gaXQgc2hvdWxkIGhhdmUgaHlkcmF0ZWQgaXRzIG93biB0cmVlLgogICAgICAgIGluaXRDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoaXNEZWYodGFnKSkgewogICAgICBpZiAoaXNEZWYoY2hpbGRyZW4pKSB7CiAgICAgICAgLy8gZW1wdHkgZWxlbWVudCwgYWxsb3cgY2xpZW50IHRvIHBpY2sgdXAgYW5kIHBvcHVsYXRlIGNoaWxkcmVuCiAgICAgICAgaWYgKCFlbG0uaGFzQ2hpbGROb2RlcygpKSB7CiAgICAgICAgICBjcmVhdGVDaGlsZHJlbih2bm9kZSwgY2hpbGRyZW4sIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIHYtaHRtbCBhbmQgZG9tUHJvcHM6IGlubmVySFRNTAogICAgICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhKSAmJiBpc0RlZihpID0gaS5kb21Qcm9wcykgJiYgaXNEZWYoaSA9IGkuaW5uZXJIVE1MKSkgewogICAgICAgICAgICBpZiAoaSAhPT0gZWxtLmlubmVySFRNTCkgewogICAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJyAmJiAhaHlkcmF0aW9uQmFpbGVkKSB7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25CYWlsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdQYXJlbnQ6ICcsIGVsbSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ3NlcnZlciBpbm5lckhUTUw6ICcsIGkpOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdjbGllbnQgaW5uZXJIVE1MOiAnLCBlbG0uaW5uZXJIVE1MKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gaXRlcmF0ZSBhbmQgY29tcGFyZSBjaGlsZHJlbiBsaXN0cwogICAgICAgICAgICB2YXIgY2hpbGRyZW5NYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjaGlsZE5vZGUgPSBlbG0uZmlyc3RDaGlsZDsKCiAgICAgICAgICAgIGZvciAodmFyIGlfNyA9IDA7IGlfNyA8IGNoaWxkcmVuLmxlbmd0aDsgaV83KyspIHsKICAgICAgICAgICAgICBpZiAoIWNoaWxkTm9kZSB8fCAhaHlkcmF0ZShjaGlsZE5vZGUsIGNoaWxkcmVuW2lfN10sIGluc2VydGVkVm5vZGVRdWV1ZSwgaW5WUHJlKSkgewogICAgICAgICAgICAgICAgY2hpbGRyZW5NYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBjaGlsZE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0gLy8gaWYgY2hpbGROb2RlIGlzIG5vdCBudWxsLCBpdCBtZWFucyB0aGUgYWN0dWFsIGNoaWxkTm9kZXMgbGlzdCBpcwogICAgICAgICAgICAvLyBsb25nZXIgdGhhbiB0aGUgdmlydHVhbCBjaGlsZHJlbiBsaXN0LgoKCiAgICAgICAgICAgIGlmICghY2hpbGRyZW5NYXRjaCB8fCBjaGlsZE5vZGUpIHsKICAgICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWh5ZHJhdGlvbkJhaWxlZCkgewogICAgICAgICAgICAgICAgaHlkcmF0aW9uQmFpbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignUGFyZW50OiAnLCBlbG0pOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdNaXNtYXRjaGluZyBjaGlsZE5vZGVzIHZzLiBWTm9kZXM6ICcsIGVsbS5jaGlsZE5vZGVzLCBjaGlsZHJlbik7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICAgIHZhciBmdWxsSW52b2tlID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICBpZiAoIWlzUmVuZGVyZWRNb2R1bGUoa2V5KSkgewogICAgICAgICAgICBmdWxsSW52b2tlID0gdHJ1ZTsKICAgICAgICAgICAgaW52b2tlQ3JlYXRlSG9va3Modm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCFmdWxsSW52b2tlICYmIGRhdGFbJ2NsYXNzJ10pIHsKICAgICAgICAgIC8vIGVuc3VyZSBjb2xsZWN0aW5nIGRlcHMgZm9yIGRlZXAgY2xhc3MgYmluZGluZ3MgZm9yIGZ1dHVyZSB1cGRhdGVzCiAgICAgICAgICB0cmF2ZXJzZShkYXRhWydjbGFzcyddKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZWxtLmRhdGEgIT09IHZub2RlLnRleHQpIHsKICAgICAgZWxtLmRhdGEgPSB2bm9kZS50ZXh0OwogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gYXNzZXJ0Tm9kZU1hdGNoKG5vZGUsIHZub2RlLCBpblZQcmUpIHsKICAgIGlmIChpc0RlZih2bm9kZS50YWcpKSB7CiAgICAgIHJldHVybiB2bm9kZS50YWcuaW5kZXhPZigndnVlLWNvbXBvbmVudCcpID09PSAwIHx8ICFpc1Vua25vd25FbGVtZW50KHZub2RlLCBpblZQcmUpICYmIHZub2RlLnRhZy50b0xvd2VyQ2FzZSgpID09PSAobm9kZS50YWdOYW1lICYmIG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSAodm5vZGUuaXNDb21tZW50ID8gOCA6IDMpOwogICAgfQogIH0KCiAgcmV0dXJuIGZ1bmN0aW9uIHBhdGNoKG9sZFZub2RlLCB2bm9kZSwgaHlkcmF0aW5nLCByZW1vdmVPbmx5KSB7CiAgICBpZiAoaXNVbmRlZih2bm9kZSkpIHsKICAgICAgaWYgKGlzRGVmKG9sZFZub2RlKSkgaW52b2tlRGVzdHJveUhvb2sob2xkVm5vZGUpOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGlzSW5pdGlhbFBhdGNoID0gZmFsc2U7CiAgICB2YXIgaW5zZXJ0ZWRWbm9kZVF1ZXVlID0gW107CgogICAgaWYgKGlzVW5kZWYob2xkVm5vZGUpKSB7CiAgICAgIC8vIGVtcHR5IG1vdW50IChsaWtlbHkgYXMgY29tcG9uZW50KSwgY3JlYXRlIG5ldyByb290IGVsZW1lbnQKICAgICAgaXNJbml0aWFsUGF0Y2ggPSB0cnVlOwogICAgICBjcmVhdGVFbG0odm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgaXNSZWFsRWxlbWVudCA9IGlzRGVmKG9sZFZub2RlLm5vZGVUeXBlKTsKCiAgICAgIGlmICghaXNSZWFsRWxlbWVudCAmJiBzYW1lVm5vZGUob2xkVm5vZGUsIHZub2RlKSkgewogICAgICAgIC8vIHBhdGNoIGV4aXN0aW5nIHJvb3Qgbm9kZQogICAgICAgIHBhdGNoVm5vZGUob2xkVm5vZGUsIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG51bGwsIG51bGwsIHJlbW92ZU9ubHkpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChpc1JlYWxFbGVtZW50KSB7CiAgICAgICAgICAvLyBtb3VudGluZyB0byBhIHJlYWwgZWxlbWVudAogICAgICAgICAgLy8gY2hlY2sgaWYgdGhpcyBpcyBzZXJ2ZXItcmVuZGVyZWQgY29udGVudCBhbmQgaWYgd2UgY2FuIHBlcmZvcm0KICAgICAgICAgIC8vIGEgc3VjY2Vzc2Z1bCBoeWRyYXRpb24uCiAgICAgICAgICBpZiAob2xkVm5vZGUubm9kZVR5cGUgPT09IDEgJiYgb2xkVm5vZGUuaGFzQXR0cmlidXRlKFNTUl9BVFRSKSkgewogICAgICAgICAgICBvbGRWbm9kZS5yZW1vdmVBdHRyaWJ1dGUoU1NSX0FUVFIpOwogICAgICAgICAgICBoeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpc1RydWUoaHlkcmF0aW5nKSkgewogICAgICAgICAgICBpZiAoaHlkcmF0ZShvbGRWbm9kZSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSkpIHsKICAgICAgICAgICAgICBpbnZva2VJbnNlcnRIb29rKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHRydWUpOwogICAgICAgICAgICAgIHJldHVybiBvbGRWbm9kZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICAgICAgd2FybignVGhlIGNsaWVudC1zaWRlIHJlbmRlcmVkIHZpcnR1YWwgRE9NIHRyZWUgaXMgbm90IG1hdGNoaW5nICcgKyAnc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSBpbmNvcnJlY3QgJyArICdIVE1MIG1hcmt1cCwgZm9yIGV4YW1wbGUgbmVzdGluZyBibG9jay1sZXZlbCBlbGVtZW50cyBpbnNpZGUgJyArICc8cD4sIG9yIG1pc3NpbmcgPHRib2R5Pi4gQmFpbGluZyBoeWRyYXRpb24gYW5kIHBlcmZvcm1pbmcgJyArICdmdWxsIGNsaWVudC1zaWRlIHJlbmRlci4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSAvLyBlaXRoZXIgbm90IHNlcnZlci1yZW5kZXJlZCwgb3IgaHlkcmF0aW9uIGZhaWxlZC4KICAgICAgICAgIC8vIGNyZWF0ZSBhbiBlbXB0eSBub2RlIGFuZCByZXBsYWNlIGl0CgoKICAgICAgICAgIG9sZFZub2RlID0gZW1wdHlOb2RlQXQob2xkVm5vZGUpOwogICAgICAgIH0gLy8gcmVwbGFjaW5nIGV4aXN0aW5nIGVsZW1lbnQKCgogICAgICAgIHZhciBvbGRFbG0gPSBvbGRWbm9kZS5lbG07CiAgICAgICAgdmFyIHBhcmVudEVsbSA9IG5vZGVPcHMucGFyZW50Tm9kZShvbGRFbG0pOyAvLyBjcmVhdGUgbmV3IG5vZGUKCiAgICAgICAgY3JlYXRlRWxtKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIC8vIGV4dHJlbWVseSByYXJlIGVkZ2UgY2FzZTogZG8gbm90IGluc2VydCBpZiBvbGQgZWxlbWVudCBpcyBpbiBhCiAgICAgICAgLy8gbGVhdmluZyB0cmFuc2l0aW9uLiBPbmx5IGhhcHBlbnMgd2hlbiBjb21iaW5pbmcgdHJhbnNpdGlvbiArCiAgICAgICAgLy8ga2VlcC1hbGl2ZSArIEhPQ3MuICgjNDU5MCkKICAgICAgICBvbGRFbG0uX2xlYXZlQ2IgPyBudWxsIDogcGFyZW50RWxtLCBub2RlT3BzLm5leHRTaWJsaW5nKG9sZEVsbSkpOyAvLyB1cGRhdGUgcGFyZW50IHBsYWNlaG9sZGVyIG5vZGUgZWxlbWVudCwgcmVjdXJzaXZlbHkKCiAgICAgICAgaWYgKGlzRGVmKHZub2RlLnBhcmVudCkpIHsKICAgICAgICAgIHZhciBhbmNlc3RvciA9IHZub2RlLnBhcmVudDsKICAgICAgICAgIHZhciBwYXRjaGFibGUgPSBpc1BhdGNoYWJsZSh2bm9kZSk7CgogICAgICAgICAgd2hpbGUgKGFuY2VzdG9yKSB7CiAgICAgICAgICAgIGZvciAodmFyIGlfOCA9IDA7IGlfOCA8IGNicy5kZXN0cm95Lmxlbmd0aDsgKytpXzgpIHsKICAgICAgICAgICAgICBjYnMuZGVzdHJveVtpXzhdKGFuY2VzdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYW5jZXN0b3IuZWxtID0gdm5vZGUuZWxtOwoKICAgICAgICAgICAgaWYgKHBhdGNoYWJsZSkgewogICAgICAgICAgICAgIGZvciAodmFyIGlfOSA9IDA7IGlfOSA8IGNicy5jcmVhdGUubGVuZ3RoOyArK2lfOSkgewogICAgICAgICAgICAgICAgY2JzLmNyZWF0ZVtpXzldKGVtcHR5Tm9kZSwgYW5jZXN0b3IpOwogICAgICAgICAgICAgIH0gLy8gIzY1MTMKICAgICAgICAgICAgICAvLyBpbnZva2UgaW5zZXJ0IGhvb2tzIHRoYXQgbWF5IGhhdmUgYmVlbiBtZXJnZWQgYnkgY3JlYXRlIGhvb2tzLgogICAgICAgICAgICAgIC8vIGUuZy4gZm9yIGRpcmVjdGl2ZXMgdGhhdCB1c2VzIHRoZSAiaW5zZXJ0ZWQiIGhvb2suCgoKICAgICAgICAgICAgICB2YXIgaW5zZXJ0XzEgPSBhbmNlc3Rvci5kYXRhLmhvb2suaW5zZXJ0OwoKICAgICAgICAgICAgICBpZiAoaW5zZXJ0XzEubWVyZ2VkKSB7CiAgICAgICAgICAgICAgICAvLyBzdGFydCBhdCBpbmRleCAxIHRvIGF2b2lkIHJlLWludm9raW5nIGNvbXBvbmVudCBtb3VudGVkIGhvb2sKICAgICAgICAgICAgICAgIGZvciAodmFyIGlfMTAgPSAxOyBpXzEwIDwgaW5zZXJ0XzEuZm5zLmxlbmd0aDsgaV8xMCsrKSB7CiAgICAgICAgICAgICAgICAgIGluc2VydF8xLmZuc1tpXzEwXSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWdpc3RlclJlZihhbmNlc3Rvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50OwogICAgICAgICAgfQogICAgICAgIH0gLy8gZGVzdHJveSBvbGQgbm9kZQoKCiAgICAgICAgaWYgKGlzRGVmKHBhcmVudEVsbSkpIHsKICAgICAgICAgIHJlbW92ZVZub2Rlcyhbb2xkVm5vZGVdLCAwLCAwKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRGVmKG9sZFZub2RlLnRhZykpIHsKICAgICAgICAgIGludm9rZURlc3Ryb3lIb29rKG9sZFZub2RlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpbnZva2VJbnNlcnRIb29rKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIGlzSW5pdGlhbFBhdGNoKTsKICAgIHJldHVybiB2bm9kZS5lbG07CiAgfTsKfQoKdmFyIGRpcmVjdGl2ZXMgPSB7CiAgY3JlYXRlOiB1cGRhdGVEaXJlY3RpdmVzLAogIHVwZGF0ZTogdXBkYXRlRGlyZWN0aXZlcywKICBkZXN0cm95OiBmdW5jdGlvbiB1bmJpbmREaXJlY3RpdmVzKHZub2RlKSB7CiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGVtcHR5Tm9kZSBpcyBub3QgVk5vZGVXaXRoRGF0YQogICAgdXBkYXRlRGlyZWN0aXZlcyh2bm9kZSwgZW1wdHlOb2RlKTsKICB9Cn07CgpmdW5jdGlvbiB1cGRhdGVEaXJlY3RpdmVzKG9sZFZub2RlLCB2bm9kZSkgewogIGlmIChvbGRWbm9kZS5kYXRhLmRpcmVjdGl2ZXMgfHwgdm5vZGUuZGF0YS5kaXJlY3RpdmVzKSB7CiAgICBfdXBkYXRlKG9sZFZub2RlLCB2bm9kZSk7CiAgfQp9CgpmdW5jdGlvbiBfdXBkYXRlKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBpc0NyZWF0ZSA9IG9sZFZub2RlID09PSBlbXB0eU5vZGU7CiAgdmFyIGlzRGVzdHJveSA9IHZub2RlID09PSBlbXB0eU5vZGU7CiAgdmFyIG9sZERpcnMgPSBub3JtYWxpemVEaXJlY3RpdmVzKG9sZFZub2RlLmRhdGEuZGlyZWN0aXZlcywgb2xkVm5vZGUuY29udGV4dCk7CiAgdmFyIG5ld0RpcnMgPSBub3JtYWxpemVEaXJlY3RpdmVzKHZub2RlLmRhdGEuZGlyZWN0aXZlcywgdm5vZGUuY29udGV4dCk7CiAgdmFyIGRpcnNXaXRoSW5zZXJ0ID0gW107CiAgdmFyIGRpcnNXaXRoUG9zdHBhdGNoID0gW107CiAgdmFyIGtleSwgb2xkRGlyLCBkaXI7CgogIGZvciAoa2V5IGluIG5ld0RpcnMpIHsKICAgIG9sZERpciA9IG9sZERpcnNba2V5XTsKICAgIGRpciA9IG5ld0RpcnNba2V5XTsKCiAgICBpZiAoIW9sZERpcikgewogICAgICAvLyBuZXcgZGlyZWN0aXZlLCBiaW5kCiAgICAgIGNhbGxIb29rKGRpciwgJ2JpbmQnLCB2bm9kZSwgb2xkVm5vZGUpOwoKICAgICAgaWYgKGRpci5kZWYgJiYgZGlyLmRlZi5pbnNlcnRlZCkgewogICAgICAgIGRpcnNXaXRoSW5zZXJ0LnB1c2goZGlyKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gZXhpc3RpbmcgZGlyZWN0aXZlLCB1cGRhdGUKICAgICAgZGlyLm9sZFZhbHVlID0gb2xkRGlyLnZhbHVlOwogICAgICBkaXIub2xkQXJnID0gb2xkRGlyLmFyZzsKICAgICAgY2FsbEhvb2soZGlyLCAndXBkYXRlJywgdm5vZGUsIG9sZFZub2RlKTsKCiAgICAgIGlmIChkaXIuZGVmICYmIGRpci5kZWYuY29tcG9uZW50VXBkYXRlZCkgewogICAgICAgIGRpcnNXaXRoUG9zdHBhdGNoLnB1c2goZGlyKTsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKGRpcnNXaXRoSW5zZXJ0Lmxlbmd0aCkgewogICAgdmFyIGNhbGxJbnNlcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlyc1dpdGhJbnNlcnQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjYWxsSG9vayhkaXJzV2l0aEluc2VydFtpXSwgJ2luc2VydGVkJywgdm5vZGUsIG9sZFZub2RlKTsKICAgICAgfQogICAgfTsKCiAgICBpZiAoaXNDcmVhdGUpIHsKICAgICAgbWVyZ2VWTm9kZUhvb2sodm5vZGUsICdpbnNlcnQnLCBjYWxsSW5zZXJ0KTsKICAgIH0gZWxzZSB7CiAgICAgIGNhbGxJbnNlcnQoKTsKICAgIH0KICB9CgogIGlmIChkaXJzV2l0aFBvc3RwYXRjaC5sZW5ndGgpIHsKICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAncG9zdHBhdGNoJywgZnVuY3Rpb24gKCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpcnNXaXRoUG9zdHBhdGNoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY2FsbEhvb2soZGlyc1dpdGhQb3N0cGF0Y2hbaV0sICdjb21wb25lbnRVcGRhdGVkJywgdm5vZGUsIG9sZFZub2RlKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBpZiAoIWlzQ3JlYXRlKSB7CiAgICBmb3IgKGtleSBpbiBvbGREaXJzKSB7CiAgICAgIGlmICghbmV3RGlyc1trZXldKSB7CiAgICAgICAgLy8gbm8gbG9uZ2VyIHByZXNlbnQsIHVuYmluZAogICAgICAgIGNhbGxIb29rKG9sZERpcnNba2V5XSwgJ3VuYmluZCcsIG9sZFZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KTsKICAgICAgfQogICAgfQogIH0KfQoKdmFyIGVtcHR5TW9kaWZpZXJzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCmZ1bmN0aW9uIG5vcm1hbGl6ZURpcmVjdGl2ZXMoZGlycywgdm0pIHsKICB2YXIgcmVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgaWYgKCFkaXJzKSB7CiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIHJldHVybiByZXM7CiAgfQoKICB2YXIgaSwgZGlyOwoKICBmb3IgKGkgPSAwOyBpIDwgZGlycy5sZW5ndGg7IGkrKykgewogICAgZGlyID0gZGlyc1tpXTsKCiAgICBpZiAoIWRpci5tb2RpZmllcnMpIHsKICAgICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICAgIGRpci5tb2RpZmllcnMgPSBlbXB0eU1vZGlmaWVyczsKICAgIH0KCiAgICByZXNbZ2V0UmF3RGlyTmFtZShkaXIpXSA9IGRpcjsKCiAgICBpZiAodm0uX3NldHVwU3RhdGUgJiYgdm0uX3NldHVwU3RhdGUuX19zZmMpIHsKICAgICAgdmFyIHNldHVwRGVmID0gZGlyLmRlZiB8fCByZXNvbHZlQXNzZXQodm0sICdfc2V0dXBTdGF0ZScsICd2LScgKyBkaXIubmFtZSk7CgogICAgICBpZiAodHlwZW9mIHNldHVwRGVmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgZGlyLmRlZiA9IHsKICAgICAgICAgIGJpbmQ6IHNldHVwRGVmLAogICAgICAgICAgdXBkYXRlOiBzZXR1cERlZgogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGlyLmRlZiA9IHNldHVwRGVmOwogICAgICB9CiAgICB9CgogICAgZGlyLmRlZiA9IGRpci5kZWYgfHwgcmVzb2x2ZUFzc2V0KHZtLiRvcHRpb25zLCAnZGlyZWN0aXZlcycsIGRpci5uYW1lLCB0cnVlKTsKICB9IC8vICRmbG93LWRpc2FibGUtbGluZQoKCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gZ2V0UmF3RGlyTmFtZShkaXIpIHsKICByZXR1cm4gZGlyLnJhd05hbWUgfHwgIiIuY29uY2F0KGRpci5uYW1lLCAiLiIpLmNvbmNhdChPYmplY3Qua2V5cyhkaXIubW9kaWZpZXJzIHx8IHt9KS5qb2luKCcuJykpOwp9CgpmdW5jdGlvbiBjYWxsSG9vayhkaXIsIGhvb2ssIHZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KSB7CiAgdmFyIGZuID0gZGlyLmRlZiAmJiBkaXIuZGVmW2hvb2tdOwoKICBpZiAoZm4pIHsKICAgIHRyeSB7CiAgICAgIGZuKHZub2RlLmVsbSwgZGlyLCB2bm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGhhbmRsZUVycm9yKGUsIHZub2RlLmNvbnRleHQsICJkaXJlY3RpdmUgIi5jb25jYXQoZGlyLm5hbWUsICIgIikuY29uY2F0KGhvb2ssICIgaG9vayIpKTsKICAgIH0KICB9Cn0KCnZhciBiYXNlTW9kdWxlcyA9IFtyZWYsIGRpcmVjdGl2ZXNdOwoKZnVuY3Rpb24gdXBkYXRlQXR0cnMob2xkVm5vZGUsIHZub2RlKSB7CiAgdmFyIG9wdHMgPSB2bm9kZS5jb21wb25lbnRPcHRpb25zOwoKICBpZiAoaXNEZWYob3B0cykgJiYgb3B0cy5DdG9yLm9wdGlvbnMuaW5oZXJpdEF0dHJzID09PSBmYWxzZSkgewogICAgcmV0dXJuOwogIH0KCiAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5hdHRycykgJiYgaXNVbmRlZih2bm9kZS5kYXRhLmF0dHJzKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGtleSwgY3VyLCBvbGQ7CiAgdmFyIGVsbSA9IHZub2RlLmVsbTsKICB2YXIgb2xkQXR0cnMgPSBvbGRWbm9kZS5kYXRhLmF0dHJzIHx8IHt9OwogIHZhciBhdHRycyA9IHZub2RlLmRhdGEuYXR0cnMgfHwge307IC8vIGNsb25lIG9ic2VydmVkIG9iamVjdHMsIGFzIHRoZSB1c2VyIHByb2JhYmx5IHdhbnRzIHRvIG11dGF0ZSBpdAoKICBpZiAoaXNEZWYoYXR0cnMuX19vYl9fKSB8fCBpc1RydWUoYXR0cnMuX3ZfYXR0cl9wcm94eSkpIHsKICAgIGF0dHJzID0gdm5vZGUuZGF0YS5hdHRycyA9IGV4dGVuZCh7fSwgYXR0cnMpOwogIH0KCiAgZm9yIChrZXkgaW4gYXR0cnMpIHsKICAgIGN1ciA9IGF0dHJzW2tleV07CiAgICBvbGQgPSBvbGRBdHRyc1trZXldOwoKICAgIGlmIChvbGQgIT09IGN1cikgewogICAgICBzZXRBdHRyKGVsbSwga2V5LCBjdXIsIHZub2RlLmRhdGEucHJlKTsKICAgIH0KICB9IC8vICM0MzkxOiBpbiBJRTksIHNldHRpbmcgdHlwZSBjYW4gcmVzZXQgdmFsdWUgZm9yIGlucHV0W3R5cGU9cmFkaW9dCiAgLy8gIzY2NjY6IElFL0VkZ2UgZm9yY2VzIHByb2dyZXNzIHZhbHVlIGRvd24gdG8gMSBiZWZvcmUgc2V0dGluZyBhIG1heAoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmICgoaXNJRSB8fCBpc0VkZ2UpICYmIGF0dHJzLnZhbHVlICE9PSBvbGRBdHRycy52YWx1ZSkgewogICAgc2V0QXR0cihlbG0sICd2YWx1ZScsIGF0dHJzLnZhbHVlKTsKICB9CgogIGZvciAoa2V5IGluIG9sZEF0dHJzKSB7CiAgICBpZiAoaXNVbmRlZihhdHRyc1trZXldKSkgewogICAgICBpZiAoaXNYbGluayhrZXkpKSB7CiAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZU5TKHhsaW5rTlMsIGdldFhsaW5rUHJvcChrZXkpKTsKICAgICAgfSBlbHNlIGlmICghaXNFbnVtZXJhdGVkQXR0cihrZXkpKSB7CiAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBzZXRBdHRyKGVsLCBrZXksIHZhbHVlLCBpc0luUHJlKSB7CiAgaWYgKGlzSW5QcmUgfHwgZWwudGFnTmFtZS5pbmRleE9mKCctJykgPiAtMSkgewogICAgYmFzZVNldEF0dHIoZWwsIGtleSwgdmFsdWUpOwogIH0gZWxzZSBpZiAoaXNCb29sZWFuQXR0cihrZXkpKSB7CiAgICAvLyBzZXQgYXR0cmlidXRlIGZvciBibGFuayB2YWx1ZQogICAgLy8gZS5nLiA8b3B0aW9uIGRpc2FibGVkPlNlbGVjdCBvbmU8L29wdGlvbj4KICAgIGlmIChpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSkgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHRlY2huaWNhbGx5IGFsbG93ZnVsbHNjcmVlbiBpcyBhIGJvb2xlYW4gYXR0cmlidXRlIGZvciA8aWZyYW1lPiwKICAgICAgLy8gYnV0IEZsYXNoIGV4cGVjdHMgYSB2YWx1ZSBvZiAidHJ1ZSIgd2hlbiB1c2VkIG9uIDxlbWJlZD4gdGFnCiAgICAgIHZhbHVlID0ga2V5ID09PSAnYWxsb3dmdWxsc2NyZWVuJyAmJiBlbC50YWdOYW1lID09PSAnRU1CRUQnID8gJ3RydWUnIDoga2V5OwogICAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgICB9CiAgfSBlbHNlIGlmIChpc0VudW1lcmF0ZWRBdHRyKGtleSkpIHsKICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIGNvbnZlcnRFbnVtZXJhdGVkVmFsdWUoa2V5LCB2YWx1ZSkpOwogIH0gZWxzZSBpZiAoaXNYbGluayhrZXkpKSB7CiAgICBpZiAoaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkpIHsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlTlMoeGxpbmtOUywgZ2V0WGxpbmtQcm9wKGtleSkpOwogICAgfSBlbHNlIHsKICAgICAgZWwuc2V0QXR0cmlidXRlTlMoeGxpbmtOUywga2V5LCB2YWx1ZSk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGJhc2VTZXRBdHRyKGVsLCBrZXksIHZhbHVlKTsKICB9Cn0KCmZ1bmN0aW9uIGJhc2VTZXRBdHRyKGVsLCBrZXksIHZhbHVlKSB7CiAgaWYgKGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpKSB7CiAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICB9IGVsc2UgewogICAgLy8gIzcxMzg6IElFMTAgJiAxMSBmaXJlcyBpbnB1dCBldmVudCB3aGVuIHNldHRpbmcgcGxhY2Vob2xkZXIgb24KICAgIC8vIDx0ZXh0YXJlYT4uLi4gYmxvY2sgdGhlIGZpcnN0IGlucHV0IGV2ZW50IGFuZCByZW1vdmUgdGhlIGJsb2NrZXIKICAgIC8vIGltbWVkaWF0ZWx5LgoKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzSUUgJiYgIWlzSUU5ICYmIGVsLnRhZ05hbWUgPT09ICdURVhUQVJFQScgJiYga2V5ID09PSAncGxhY2Vob2xkZXInICYmIHZhbHVlICE9PSAnJyAmJiAhZWwuX19pZXBoKSB7CiAgICAgIHZhciBibG9ja2VyXzEgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBibG9ja2VyXzEpOwogICAgICB9OwoKICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBibG9ja2VyXzEpOyAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKCiAgICAgIGVsLl9faWVwaCA9IHRydWU7CiAgICAgIC8qIElFIHBsYWNlaG9sZGVyIHBhdGNoZWQgKi8KICAgIH0KCiAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgfQp9Cgp2YXIgYXR0cnMgPSB7CiAgY3JlYXRlOiB1cGRhdGVBdHRycywKICB1cGRhdGU6IHVwZGF0ZUF0dHJzCn07CgpmdW5jdGlvbiB1cGRhdGVDbGFzcyhvbGRWbm9kZSwgdm5vZGUpIHsKICB2YXIgZWwgPSB2bm9kZS5lbG07CiAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogIHZhciBvbGREYXRhID0gb2xkVm5vZGUuZGF0YTsKCiAgaWYgKGlzVW5kZWYoZGF0YS5zdGF0aWNDbGFzcykgJiYgaXNVbmRlZihkYXRhLmNsYXNzKSAmJiAoaXNVbmRlZihvbGREYXRhKSB8fCBpc1VuZGVmKG9sZERhdGEuc3RhdGljQ2xhc3MpICYmIGlzVW5kZWYob2xkRGF0YS5jbGFzcykpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgY2xzID0gZ2VuQ2xhc3NGb3JWbm9kZSh2bm9kZSk7IC8vIGhhbmRsZSB0cmFuc2l0aW9uIGNsYXNzZXMKCiAgdmFyIHRyYW5zaXRpb25DbGFzcyA9IGVsLl90cmFuc2l0aW9uQ2xhc3NlczsKCiAgaWYgKGlzRGVmKHRyYW5zaXRpb25DbGFzcykpIHsKICAgIGNscyA9IGNvbmNhdChjbHMsIHN0cmluZ2lmeUNsYXNzKHRyYW5zaXRpb25DbGFzcykpOwogIH0gLy8gc2V0IHRoZSBjbGFzcwoKCiAgaWYgKGNscyAhPT0gZWwuX3ByZXZDbGFzcykgewogICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsIGNscyk7CiAgICBlbC5fcHJldkNsYXNzID0gY2xzOwogIH0KfQoKdmFyIGtsYXNzID0gewogIGNyZWF0ZTogdXBkYXRlQ2xhc3MsCiAgdXBkYXRlOiB1cGRhdGVDbGFzcwp9OyAvLyBpbiBzb21lIGNhc2VzLCB0aGUgZXZlbnQgdXNlZCBoYXMgdG8gYmUgZGV0ZXJtaW5lZCBhdCBydW50aW1lCi8vIHNvIHdlIHVzZWQgc29tZSByZXNlcnZlZCB0b2tlbnMgZHVyaW5nIGNvbXBpbGUuCgp2YXIgUkFOR0VfVE9LRU4gPSAnX19yJzsKdmFyIENIRUNLQk9YX1JBRElPX1RPS0VOID0gJ19fYyc7IC8vIG5vcm1hbGl6ZSB2LW1vZGVsIGV2ZW50IHRva2VucyB0aGF0IGNhbiBvbmx5IGJlIGRldGVybWluZWQgYXQgcnVudGltZS4KLy8gaXQncyBpbXBvcnRhbnQgdG8gcGxhY2UgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBpbiB0aGUgYXJyYXkgYmVjYXVzZQovLyB0aGUgd2hvbGUgcG9pbnQgaXMgZW5zdXJpbmcgdGhlIHYtbW9kZWwgY2FsbGJhY2sgZ2V0cyBjYWxsZWQgYmVmb3JlCi8vIHVzZXItYXR0YWNoZWQgaGFuZGxlcnMuCgpmdW5jdGlvbiBub3JtYWxpemVFdmVudHMob24pIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoaXNEZWYob25bUkFOR0VfVE9LRU5dKSkgewogICAgLy8gSUUgaW5wdXRbdHlwZT1yYW5nZV0gb25seSBzdXBwb3J0cyBgY2hhbmdlYCBldmVudAogICAgdmFyIGV2ZW50XzEgPSBpc0lFID8gJ2NoYW5nZScgOiAnaW5wdXQnOwogICAgb25bZXZlbnRfMV0gPSBbXS5jb25jYXQob25bUkFOR0VfVE9LRU5dLCBvbltldmVudF8xXSB8fCBbXSk7CiAgICBkZWxldGUgb25bUkFOR0VfVE9LRU5dOwogIH0gLy8gVGhpcyB3YXMgb3JpZ2luYWxseSBpbnRlbmRlZCB0byBmaXggIzQ1MjEgYnV0IG5vIGxvbmdlciBuZWNlc3NhcnkKICAvLyBhZnRlciAyLjUuIEtlZXBpbmcgaXQgZm9yIGJhY2t3YXJkcyBjb21wYXQgd2l0aCBnZW5lcmF0ZWQgY29kZSBmcm9tIDwgMi40CgogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgaWYgKGlzRGVmKG9uW0NIRUNLQk9YX1JBRElPX1RPS0VOXSkpIHsKICAgIG9uLmNoYW5nZSA9IFtdLmNvbmNhdChvbltDSEVDS0JPWF9SQURJT19UT0tFTl0sIG9uLmNoYW5nZSB8fCBbXSk7CiAgICBkZWxldGUgb25bQ0hFQ0tCT1hfUkFESU9fVE9LRU5dOwogIH0KfQoKdmFyIHRhcmdldDsKCmZ1bmN0aW9uIGNyZWF0ZU9uY2VIYW5kbGVyKGV2ZW50LCBoYW5kbGVyLCBjYXB0dXJlKSB7CiAgdmFyIF90YXJnZXQgPSB0YXJnZXQ7IC8vIHNhdmUgY3VycmVudCB0YXJnZXQgZWxlbWVudCBpbiBjbG9zdXJlCgogIHJldHVybiBmdW5jdGlvbiBvbmNlSGFuZGxlcigpIHsKICAgIHZhciByZXMgPSBoYW5kbGVyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CgogICAgaWYgKHJlcyAhPT0gbnVsbCkgewogICAgICByZW1vdmUoZXZlbnQsIG9uY2VIYW5kbGVyLCBjYXB0dXJlLCBfdGFyZ2V0KTsKICAgIH0KICB9Owp9IC8vICM5NDQ2OiBGaXJlZm94IDw9IDUzIChpbiBwYXJ0aWN1bGFyLCBFU1IgNTIpIGhhcyBpbmNvcnJlY3QgRXZlbnQudGltZVN0YW1wCi8vIGltcGxlbWVudGF0aW9uIGFuZCBkb2VzIG5vdCBmaXJlIG1pY3JvdGFza3MgaW4gYmV0d2VlbiBldmVudCBwcm9wYWdhdGlvbiwgc28KLy8gc2FmZSB0byBleGNsdWRlLgoKCnZhciB1c2VNaWNyb3Rhc2tGaXggPSBpc1VzaW5nTWljcm9UYXNrICYmICEoaXNGRiAmJiBOdW1iZXIoaXNGRlsxXSkgPD0gNTMpOwoKZnVuY3Rpb24gYWRkKG5hbWUsIGhhbmRsZXIsIGNhcHR1cmUsIHBhc3NpdmUpIHsKICAvLyBhc3luYyBlZGdlIGNhc2UgIzY1NjY6IGlubmVyIGNsaWNrIGV2ZW50IHRyaWdnZXJzIHBhdGNoLCBldmVudCBoYW5kbGVyCiAgLy8gYXR0YWNoZWQgdG8gb3V0ZXIgZWxlbWVudCBkdXJpbmcgcGF0Y2gsIGFuZCB0cmlnZ2VyZWQgYWdhaW4uIFRoaXMKICAvLyBoYXBwZW5zIGJlY2F1c2UgYnJvd3NlcnMgZmlyZSBtaWNyb3Rhc2sgdGlja3MgYmV0d2VlbiBldmVudCBwcm9wYWdhdGlvbi4KICAvLyB0aGUgc29sdXRpb24gaXMgc2ltcGxlOiB3ZSBzYXZlIHRoZSB0aW1lc3RhbXAgd2hlbiBhIGhhbmRsZXIgaXMgYXR0YWNoZWQsCiAgLy8gYW5kIHRoZSBoYW5kbGVyIHdvdWxkIG9ubHkgZmlyZSBpZiB0aGUgZXZlbnQgcGFzc2VkIHRvIGl0IHdhcyBmaXJlZAogIC8vIEFGVEVSIGl0IHdhcyBhdHRhY2hlZC4KICBpZiAodXNlTWljcm90YXNrRml4KSB7CiAgICB2YXIgYXR0YWNoZWRUaW1lc3RhbXBfMSA9IGN1cnJlbnRGbHVzaFRpbWVzdGFtcDsKICAgIHZhciBvcmlnaW5hbF8xID0gaGFuZGxlcjsgLy9AdHMtZXhwZWN0LWVycm9yCgogICAgaGFuZGxlciA9IG9yaWdpbmFsXzEuX3dyYXBwZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoIC8vIG5vIGJ1YmJsaW5nLCBzaG91bGQgYWx3YXlzIGZpcmUuCiAgICAgIC8vIHRoaXMgaXMganVzdCBhIHNhZmV0eSBuZXQgaW4gY2FzZSBldmVudC50aW1lU3RhbXAgaXMgdW5yZWxpYWJsZSBpbgogICAgICAvLyBjZXJ0YWluIHdlaXJkIGVudmlyb25tZW50cy4uLgogICAgICBlLnRhcmdldCA9PT0gZS5jdXJyZW50VGFyZ2V0IHx8IC8vIGV2ZW50IGlzIGZpcmVkIGFmdGVyIGhhbmRsZXIgYXR0YWNobWVudAogICAgICBlLnRpbWVTdGFtcCA+PSBhdHRhY2hlZFRpbWVzdGFtcF8xIHx8IC8vIGJhaWwgZm9yIGVudmlyb25tZW50cyB0aGF0IGhhdmUgYnVnZ3kgZXZlbnQudGltZVN0YW1wIGltcGxlbWVudGF0aW9ucwogICAgICAvLyAjOTQ2MiBpT1MgOSBidWc6IGV2ZW50LnRpbWVTdGFtcCBpcyAwIGFmdGVyIGhpc3RvcnkucHVzaFN0YXRlCiAgICAgIC8vICM5NjgxIFF0V2ViRW5naW5lIGV2ZW50LnRpbWVTdGFtcCBpcyBuZWdhdGl2ZSB2YWx1ZQogICAgICBlLnRpbWVTdGFtcCA8PSAwIHx8IC8vICM5NDQ4IGJhaWwgaWYgZXZlbnQgaXMgZmlyZWQgaW4gYW5vdGhlciBkb2N1bWVudCBpbiBhIG11bHRpLXBhZ2UKICAgICAgLy8gZWxlY3Ryb24vbncuanMgYXBwLCBzaW5jZSBldmVudC50aW1lU3RhbXAgd2lsbCBiZSB1c2luZyBhIGRpZmZlcmVudAogICAgICAvLyBzdGFydGluZyByZWZlcmVuY2UKICAgICAgZS50YXJnZXQub3duZXJEb2N1bWVudCAhPT0gZG9jdW1lbnQpIHsKICAgICAgICByZXR1cm4gb3JpZ2luYWxfMS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgaGFuZGxlciwgc3VwcG9ydHNQYXNzaXZlID8gewogICAgY2FwdHVyZTogY2FwdHVyZSwKICAgIHBhc3NpdmU6IHBhc3NpdmUKICB9IDogY2FwdHVyZSk7Cn0KCmZ1bmN0aW9uIHJlbW92ZShuYW1lLCBoYW5kbGVyLCBjYXB0dXJlLCBfdGFyZ2V0KSB7CiAgKF90YXJnZXQgfHwgdGFyZ2V0KS5yZW1vdmVFdmVudExpc3RlbmVyKG5hbWUsIC8vQHRzLWV4cGVjdC1lcnJvcgogIGhhbmRsZXIuX3dyYXBwZXIgfHwgaGFuZGxlciwgY2FwdHVyZSk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZURPTUxpc3RlbmVycyhvbGRWbm9kZSwgdm5vZGUpIHsKICBpZiAoaXNVbmRlZihvbGRWbm9kZS5kYXRhLm9uKSAmJiBpc1VuZGVmKHZub2RlLmRhdGEub24pKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgb24gPSB2bm9kZS5kYXRhLm9uIHx8IHt9OwogIHZhciBvbGRPbiA9IG9sZFZub2RlLmRhdGEub24gfHwge307IC8vIHZub2RlIGlzIGVtcHR5IHdoZW4gcmVtb3ZpbmcgYWxsIGxpc3RlbmVycywKICAvLyBhbmQgdXNlIG9sZCB2bm9kZSBkb20gZWxlbWVudAoKICB0YXJnZXQgPSB2bm9kZS5lbG0gfHwgb2xkVm5vZGUuZWxtOwogIG5vcm1hbGl6ZUV2ZW50cyhvbik7CiAgdXBkYXRlTGlzdGVuZXJzKG9uLCBvbGRPbiwgYWRkLCByZW1vdmUsIGNyZWF0ZU9uY2VIYW5kbGVyLCB2bm9kZS5jb250ZXh0KTsKICB0YXJnZXQgPSB1bmRlZmluZWQ7Cn0KCnZhciBldmVudHMgPSB7CiAgY3JlYXRlOiB1cGRhdGVET01MaXN0ZW5lcnMsCiAgdXBkYXRlOiB1cGRhdGVET01MaXN0ZW5lcnMsCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBlbXB0eU5vZGUgaGFzIGFjdHVhbGx5IGRhdGEKICBkZXN0cm95OiBmdW5jdGlvbiAodm5vZGUpIHsKICAgIHJldHVybiB1cGRhdGVET01MaXN0ZW5lcnModm5vZGUsIGVtcHR5Tm9kZSk7CiAgfQp9Owp2YXIgc3ZnQ29udGFpbmVyOwoKZnVuY3Rpb24gdXBkYXRlRE9NUHJvcHMob2xkVm5vZGUsIHZub2RlKSB7CiAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5kb21Qcm9wcykgJiYgaXNVbmRlZih2bm9kZS5kYXRhLmRvbVByb3BzKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGtleSwgY3VyOwogIHZhciBlbG0gPSB2bm9kZS5lbG07CiAgdmFyIG9sZFByb3BzID0gb2xkVm5vZGUuZGF0YS5kb21Qcm9wcyB8fCB7fTsKICB2YXIgcHJvcHMgPSB2bm9kZS5kYXRhLmRvbVByb3BzIHx8IHt9OyAvLyBjbG9uZSBvYnNlcnZlZCBvYmplY3RzLCBhcyB0aGUgdXNlciBwcm9iYWJseSB3YW50cyB0byBtdXRhdGUgaXQKCiAgaWYgKGlzRGVmKHByb3BzLl9fb2JfXykgfHwgaXNUcnVlKHByb3BzLl92X2F0dHJfcHJveHkpKSB7CiAgICBwcm9wcyA9IHZub2RlLmRhdGEuZG9tUHJvcHMgPSBleHRlbmQoe30sIHByb3BzKTsKICB9CgogIGZvciAoa2V5IGluIG9sZFByb3BzKSB7CiAgICBpZiAoIShrZXkgaW4gcHJvcHMpKSB7CiAgICAgIGVsbVtrZXldID0gJyc7CiAgICB9CiAgfQoKICBmb3IgKGtleSBpbiBwcm9wcykgewogICAgY3VyID0gcHJvcHNba2V5XTsgLy8gaWdub3JlIGNoaWxkcmVuIGlmIHRoZSBub2RlIGhhcyB0ZXh0Q29udGVudCBvciBpbm5lckhUTUwsCiAgICAvLyBhcyB0aGVzZSB3aWxsIHRocm93IGF3YXkgZXhpc3RpbmcgRE9NIG5vZGVzIGFuZCBjYXVzZSByZW1vdmFsIGVycm9ycwogICAgLy8gb24gc3Vic2VxdWVudCBwYXRjaGVzICgjMzM2MCkKCiAgICBpZiAoa2V5ID09PSAndGV4dENvbnRlbnQnIHx8IGtleSA9PT0gJ2lubmVySFRNTCcpIHsKICAgICAgaWYgKHZub2RlLmNoaWxkcmVuKSB2bm9kZS5jaGlsZHJlbi5sZW5ndGggPSAwOwogICAgICBpZiAoY3VyID09PSBvbGRQcm9wc1trZXldKSBjb250aW51ZTsgLy8gIzY2MDEgd29yayBhcm91bmQgQ2hyb21lIHZlcnNpb24gPD0gNTUgYnVnIHdoZXJlIHNpbmdsZSB0ZXh0Tm9kZQogICAgICAvLyByZXBsYWNlZCBieSBpbm5lckhUTUwvdGV4dENvbnRlbnQgcmV0YWlucyBpdHMgcGFyZW50Tm9kZSBwcm9wZXJ0eQoKICAgICAgaWYgKGVsbS5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIGVsbS5yZW1vdmVDaGlsZChlbG0uY2hpbGROb2Rlc1swXSk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoa2V5ID09PSAndmFsdWUnICYmIGVsbS50YWdOYW1lICE9PSAnUFJPR1JFU1MnKSB7CiAgICAgIC8vIHN0b3JlIHZhbHVlIGFzIF92YWx1ZSBhcyB3ZWxsIHNpbmNlCiAgICAgIC8vIG5vbi1zdHJpbmcgdmFsdWVzIHdpbGwgYmUgc3RyaW5naWZpZWQKICAgICAgZWxtLl92YWx1ZSA9IGN1cjsgLy8gYXZvaWQgcmVzZXR0aW5nIGN1cnNvciBwb3NpdGlvbiB3aGVuIHZhbHVlIGlzIHRoZSBzYW1lCgogICAgICB2YXIgc3RyQ3VyID0gaXNVbmRlZihjdXIpID8gJycgOiBTdHJpbmcoY3VyKTsKCiAgICAgIGlmIChzaG91bGRVcGRhdGVWYWx1ZShlbG0sIHN0ckN1cikpIHsKICAgICAgICBlbG0udmFsdWUgPSBzdHJDdXI7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnaW5uZXJIVE1MJyAmJiBpc1NWRyhlbG0udGFnTmFtZSkgJiYgaXNVbmRlZihlbG0uaW5uZXJIVE1MKSkgewogICAgICAvLyBJRSBkb2Vzbid0IHN1cHBvcnQgaW5uZXJIVE1MIGZvciBTVkcgZWxlbWVudHMKICAgICAgc3ZnQ29udGFpbmVyID0gc3ZnQ29udGFpbmVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBzdmdDb250YWluZXIuaW5uZXJIVE1MID0gIjxzdmc+Ii5jb25jYXQoY3VyLCAiPC9zdmc+Iik7CiAgICAgIHZhciBzdmcgPSBzdmdDb250YWluZXIuZmlyc3RDaGlsZDsKCiAgICAgIHdoaWxlIChlbG0uZmlyc3RDaGlsZCkgewogICAgICAgIGVsbS5yZW1vdmVDaGlsZChlbG0uZmlyc3RDaGlsZCk7CiAgICAgIH0KCiAgICAgIHdoaWxlIChzdmcuZmlyc3RDaGlsZCkgewogICAgICAgIGVsbS5hcHBlbmRDaGlsZChzdmcuZmlyc3RDaGlsZCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoIC8vIHNraXAgdGhlIHVwZGF0ZSBpZiBvbGQgYW5kIG5ldyBWRE9NIHN0YXRlIGlzIHRoZSBzYW1lLgogICAgLy8gYHZhbHVlYCBpcyBoYW5kbGVkIHNlcGFyYXRlbHkgYmVjYXVzZSB0aGUgRE9NIHZhbHVlIG1heSBiZSB0ZW1wb3JhcmlseQogICAgLy8gb3V0IG9mIHN5bmMgd2l0aCBWRE9NIHN0YXRlIGR1ZSB0byBmb2N1cywgY29tcG9zaXRpb24gYW5kIG1vZGlmaWVycy4KICAgIC8vIFRoaXMgICM0NTIxIGJ5IHNraXBwaW5nIHRoZSB1bm5lY2Vzc2FyeSBgY2hlY2tlZGAgdXBkYXRlLgogICAgY3VyICE9PSBvbGRQcm9wc1trZXldKSB7CiAgICAgIC8vIHNvbWUgcHJvcGVydHkgdXBkYXRlcyBjYW4gdGhyb3cKICAgICAgLy8gZS5nLiBgdmFsdWVgIG9uIDxwcm9ncmVzcz4gdy8gbm9uLWZpbml0ZSB2YWx1ZQogICAgICB0cnkgewogICAgICAgIGVsbVtrZXldID0gY3VyOwogICAgICB9IGNhdGNoIChlKSB7fQogICAgfQogIH0KfQoKZnVuY3Rpb24gc2hvdWxkVXBkYXRlVmFsdWUoZWxtLCBjaGVja1ZhbCkgewogIHJldHVybiAoLy9AdHMtZXhwZWN0LWVycm9yCiAgICAhZWxtLmNvbXBvc2luZyAmJiAoZWxtLnRhZ05hbWUgPT09ICdPUFRJT04nIHx8IGlzTm90SW5Gb2N1c0FuZERpcnR5KGVsbSwgY2hlY2tWYWwpIHx8IGlzRGlydHlXaXRoTW9kaWZpZXJzKGVsbSwgY2hlY2tWYWwpKQogICk7Cn0KCmZ1bmN0aW9uIGlzTm90SW5Gb2N1c0FuZERpcnR5KGVsbSwgY2hlY2tWYWwpIHsKICAvLyByZXR1cm4gdHJ1ZSB3aGVuIHRleHRib3ggKC5udW1iZXIgYW5kIC50cmltKSBsb3NlcyBmb2N1cyBhbmQgaXRzIHZhbHVlIGlzCiAgLy8gbm90IGVxdWFsIHRvIHRoZSB1cGRhdGVkIHZhbHVlCiAgdmFyIG5vdEluRm9jdXMgPSB0cnVlOyAvLyAjNjE1NwogIC8vIHdvcmsgYXJvdW5kIElFIGJ1ZyB3aGVuIGFjY2Vzc2luZyBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGluIGFuIGlmcmFtZQoKICB0cnkgewogICAgbm90SW5Gb2N1cyA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgIT09IGVsbTsKICB9IGNhdGNoIChlKSB7fQoKICByZXR1cm4gbm90SW5Gb2N1cyAmJiBlbG0udmFsdWUgIT09IGNoZWNrVmFsOwp9CgpmdW5jdGlvbiBpc0RpcnR5V2l0aE1vZGlmaWVycyhlbG0sIG5ld1ZhbCkgewogIHZhciB2YWx1ZSA9IGVsbS52YWx1ZTsKICB2YXIgbW9kaWZpZXJzID0gZWxtLl92TW9kaWZpZXJzOyAvLyBpbmplY3RlZCBieSB2LW1vZGVsIHJ1bnRpbWUKCiAgaWYgKGlzRGVmKG1vZGlmaWVycykpIHsKICAgIGlmIChtb2RpZmllcnMubnVtYmVyKSB7CiAgICAgIHJldHVybiB0b051bWJlcih2YWx1ZSkgIT09IHRvTnVtYmVyKG5ld1ZhbCk7CiAgICB9CgogICAgaWYgKG1vZGlmaWVycy50cmltKSB7CiAgICAgIHJldHVybiB2YWx1ZS50cmltKCkgIT09IG5ld1ZhbC50cmltKCk7CiAgICB9CiAgfQoKICByZXR1cm4gdmFsdWUgIT09IG5ld1ZhbDsKfQoKdmFyIGRvbVByb3BzID0gewogIGNyZWF0ZTogdXBkYXRlRE9NUHJvcHMsCiAgdXBkYXRlOiB1cGRhdGVET01Qcm9wcwp9Owp2YXIgcGFyc2VTdHlsZVRleHQgPSBjYWNoZWQoZnVuY3Rpb24gKGNzc1RleHQpIHsKICB2YXIgcmVzID0ge307CiAgdmFyIGxpc3REZWxpbWl0ZXIgPSAvOyg/IVteKF0qXCkpL2c7CiAgdmFyIHByb3BlcnR5RGVsaW1pdGVyID0gLzooLispLzsKICBjc3NUZXh0LnNwbGl0KGxpc3REZWxpbWl0ZXIpLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgIGlmIChpdGVtKSB7CiAgICAgIHZhciB0bXAgPSBpdGVtLnNwbGl0KHByb3BlcnR5RGVsaW1pdGVyKTsKICAgICAgdG1wLmxlbmd0aCA+IDEgJiYgKHJlc1t0bXBbMF0udHJpbSgpXSA9IHRtcFsxXS50cmltKCkpOwogICAgfQogIH0pOwogIHJldHVybiByZXM7Cn0pOyAvLyBtZXJnZSBzdGF0aWMgYW5kIGR5bmFtaWMgc3R5bGUgZGF0YSBvbiB0aGUgc2FtZSB2bm9kZQoKZnVuY3Rpb24gbm9ybWFsaXplU3R5bGVEYXRhKGRhdGEpIHsKICB2YXIgc3R5bGUgPSBub3JtYWxpemVTdHlsZUJpbmRpbmcoZGF0YS5zdHlsZSk7IC8vIHN0YXRpYyBzdHlsZSBpcyBwcmUtcHJvY2Vzc2VkIGludG8gYW4gb2JqZWN0IGR1cmluZyBjb21waWxhdGlvbgogIC8vIGFuZCBpcyBhbHdheXMgYSBmcmVzaCBvYmplY3QsIHNvIGl0J3Mgc2FmZSB0byBtZXJnZSBpbnRvIGl0CgogIHJldHVybiBkYXRhLnN0YXRpY1N0eWxlID8gZXh0ZW5kKGRhdGEuc3RhdGljU3R5bGUsIHN0eWxlKSA6IHN0eWxlOwp9IC8vIG5vcm1hbGl6ZSBwb3NzaWJsZSBhcnJheSAvIHN0cmluZyB2YWx1ZXMgaW50byBPYmplY3QKCgpmdW5jdGlvbiBub3JtYWxpemVTdHlsZUJpbmRpbmcoYmluZGluZ1N0eWxlKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYmluZGluZ1N0eWxlKSkgewogICAgcmV0dXJuIHRvT2JqZWN0KGJpbmRpbmdTdHlsZSk7CiAgfQoKICBpZiAodHlwZW9mIGJpbmRpbmdTdHlsZSA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBwYXJzZVN0eWxlVGV4dChiaW5kaW5nU3R5bGUpOwogIH0KCiAgcmV0dXJuIGJpbmRpbmdTdHlsZTsKfQovKioNCiAqIHBhcmVudCBjb21wb25lbnQgc3R5bGUgc2hvdWxkIGJlIGFmdGVyIGNoaWxkJ3MNCiAqIHNvIHRoYXQgcGFyZW50IGNvbXBvbmVudCdzIHN0eWxlIGNvdWxkIG92ZXJyaWRlIGl0DQogKi8KCgpmdW5jdGlvbiBnZXRTdHlsZSh2bm9kZSwgY2hlY2tDaGlsZCkgewogIHZhciByZXMgPSB7fTsKICB2YXIgc3R5bGVEYXRhOwoKICBpZiAoY2hlY2tDaGlsZCkgewogICAgdmFyIGNoaWxkTm9kZSA9IHZub2RlOwoKICAgIHdoaWxlIChjaGlsZE5vZGUuY29tcG9uZW50SW5zdGFuY2UpIHsKICAgICAgY2hpbGROb2RlID0gY2hpbGROb2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKCiAgICAgIGlmIChjaGlsZE5vZGUgJiYgY2hpbGROb2RlLmRhdGEgJiYgKHN0eWxlRGF0YSA9IG5vcm1hbGl6ZVN0eWxlRGF0YShjaGlsZE5vZGUuZGF0YSkpKSB7CiAgICAgICAgZXh0ZW5kKHJlcywgc3R5bGVEYXRhKTsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKHN0eWxlRGF0YSA9IG5vcm1hbGl6ZVN0eWxlRGF0YSh2bm9kZS5kYXRhKSkgewogICAgZXh0ZW5kKHJlcywgc3R5bGVEYXRhKTsKICB9CgogIHZhciBwYXJlbnROb2RlID0gdm5vZGU7IC8vIEB0cy1leHBlY3QtZXJyb3IgcGFyZW50Tm9kZS5wYXJlbnQgbm90IFZOb2RlV2l0aERhdGEKCiAgd2hpbGUgKHBhcmVudE5vZGUgPSBwYXJlbnROb2RlLnBhcmVudCkgewogICAgaWYgKHBhcmVudE5vZGUuZGF0YSAmJiAoc3R5bGVEYXRhID0gbm9ybWFsaXplU3R5bGVEYXRhKHBhcmVudE5vZGUuZGF0YSkpKSB7CiAgICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9Cgp2YXIgY3NzVmFyUkUgPSAvXi0tLzsKdmFyIGltcG9ydGFudFJFID0gL1xzKiFpbXBvcnRhbnQkLzsKCnZhciBzZXRQcm9wID0gZnVuY3Rpb24gKGVsLCBuYW1lLCB2YWwpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoY3NzVmFyUkUudGVzdChuYW1lKSkgewogICAgZWwuc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdmFsKTsKICB9IGVsc2UgaWYgKGltcG9ydGFudFJFLnRlc3QodmFsKSkgewogICAgZWwuc3R5bGUuc2V0UHJvcGVydHkoaHlwaGVuYXRlKG5hbWUpLCB2YWwucmVwbGFjZShpbXBvcnRhbnRSRSwgJycpLCAnaW1wb3J0YW50Jyk7CiAgfSBlbHNlIHsKICAgIHZhciBub3JtYWxpemVkTmFtZSA9IG5vcm1hbGl6ZShuYW1lKTsKCiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICAgIC8vIFN1cHBvcnQgdmFsdWVzIGFycmF5IGNyZWF0ZWQgYnkgYXV0b3ByZWZpeGVyLCBlLmcuCiAgICAgIC8vIHtkaXNwbGF5OiBbIi13ZWJraXQtYm94IiwgIi1tcy1mbGV4Ym94IiwgImZsZXgiXX0KICAgICAgLy8gU2V0IHRoZW0gb25lIGJ5IG9uZSwgYW5kIHRoZSBicm93c2VyIHdpbGwgb25seSBzZXQgdGhvc2UgaXQgY2FuIHJlY29nbml6ZQogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdmFsLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgZWwuc3R5bGVbbm9ybWFsaXplZE5hbWVdID0gdmFsW2ldOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZVtub3JtYWxpemVkTmFtZV0gPSB2YWw7CiAgICB9CiAgfQp9OwoKdmFyIHZlbmRvck5hbWVzID0gWydXZWJraXQnLCAnTW96JywgJ21zJ107CnZhciBlbXB0eVN0eWxlOwp2YXIgbm9ybWFsaXplID0gY2FjaGVkKGZ1bmN0aW9uIChwcm9wKSB7CiAgZW1wdHlTdHlsZSA9IGVtcHR5U3R5bGUgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jykuc3R5bGU7CiAgcHJvcCA9IGNhbWVsaXplKHByb3ApOwoKICBpZiAocHJvcCAhPT0gJ2ZpbHRlcicgJiYgcHJvcCBpbiBlbXB0eVN0eWxlKSB7CiAgICByZXR1cm4gcHJvcDsKICB9CgogIHZhciBjYXBOYW1lID0gcHJvcC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHByb3Auc2xpY2UoMSk7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgdmVuZG9yTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBuYW1lXzEgPSB2ZW5kb3JOYW1lc1tpXSArIGNhcE5hbWU7CgogICAgaWYgKG5hbWVfMSBpbiBlbXB0eVN0eWxlKSB7CiAgICAgIHJldHVybiBuYW1lXzE7CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIHVwZGF0ZVN0eWxlKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICB2YXIgb2xkRGF0YSA9IG9sZFZub2RlLmRhdGE7CgogIGlmIChpc1VuZGVmKGRhdGEuc3RhdGljU3R5bGUpICYmIGlzVW5kZWYoZGF0YS5zdHlsZSkgJiYgaXNVbmRlZihvbGREYXRhLnN0YXRpY1N0eWxlKSAmJiBpc1VuZGVmKG9sZERhdGEuc3R5bGUpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgY3VyLCBuYW1lOwogIHZhciBlbCA9IHZub2RlLmVsbTsKICB2YXIgb2xkU3RhdGljU3R5bGUgPSBvbGREYXRhLnN0YXRpY1N0eWxlOwogIHZhciBvbGRTdHlsZUJpbmRpbmcgPSBvbGREYXRhLm5vcm1hbGl6ZWRTdHlsZSB8fCBvbGREYXRhLnN0eWxlIHx8IHt9OyAvLyBpZiBzdGF0aWMgc3R5bGUgZXhpc3RzLCBzdHlsZWJpbmRpbmcgYWxyZWFkeSBtZXJnZWQgaW50byBpdCB3aGVuIGRvaW5nIG5vcm1hbGl6ZVN0eWxlRGF0YQoKICB2YXIgb2xkU3R5bGUgPSBvbGRTdGF0aWNTdHlsZSB8fCBvbGRTdHlsZUJpbmRpbmc7CiAgdmFyIHN0eWxlID0gbm9ybWFsaXplU3R5bGVCaW5kaW5nKHZub2RlLmRhdGEuc3R5bGUpIHx8IHt9OyAvLyBzdG9yZSBub3JtYWxpemVkIHN0eWxlIHVuZGVyIGEgZGlmZmVyZW50IGtleSBmb3IgbmV4dCBkaWZmCiAgLy8gbWFrZSBzdXJlIHRvIGNsb25lIGl0IGlmIGl0J3MgcmVhY3RpdmUsIHNpbmNlIHRoZSB1c2VyIGxpa2VseSB3YW50cwogIC8vIHRvIG11dGF0ZSBpdC4KCiAgdm5vZGUuZGF0YS5ub3JtYWxpemVkU3R5bGUgPSBpc0RlZihzdHlsZS5fX29iX18pID8gZXh0ZW5kKHt9LCBzdHlsZSkgOiBzdHlsZTsKICB2YXIgbmV3U3R5bGUgPSBnZXRTdHlsZSh2bm9kZSwgdHJ1ZSk7CgogIGZvciAobmFtZSBpbiBvbGRTdHlsZSkgewogICAgaWYgKGlzVW5kZWYobmV3U3R5bGVbbmFtZV0pKSB7CiAgICAgIHNldFByb3AoZWwsIG5hbWUsICcnKTsKICAgIH0KICB9CgogIGZvciAobmFtZSBpbiBuZXdTdHlsZSkgewogICAgY3VyID0gbmV3U3R5bGVbbmFtZV07CgogICAgaWYgKGN1ciAhPT0gb2xkU3R5bGVbbmFtZV0pIHsKICAgICAgLy8gaWU5IHNldHRpbmcgdG8gbnVsbCBoYXMgbm8gZWZmZWN0LCBtdXN0IHVzZSBlbXB0eSBzdHJpbmcKICAgICAgc2V0UHJvcChlbCwgbmFtZSwgY3VyID09IG51bGwgPyAnJyA6IGN1cik7CiAgICB9CiAgfQp9Cgp2YXIgc3R5bGUgPSB7CiAgY3JlYXRlOiB1cGRhdGVTdHlsZSwKICB1cGRhdGU6IHVwZGF0ZVN0eWxlCn07CnZhciB3aGl0ZXNwYWNlUkUgPSAvXHMrLzsKLyoqDQogKiBBZGQgY2xhc3Mgd2l0aCBjb21wYXRpYmlsaXR5IGZvciBTVkcgc2luY2UgY2xhc3NMaXN0IGlzIG5vdCBzdXBwb3J0ZWQgb24NCiAqIFNWRyBlbGVtZW50cyBpbiBJRQ0KICovCgpmdW5jdGlvbiBhZGRDbGFzcyhlbCwgY2xzKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFjbHMgfHwgIShjbHMgPSBjbHMudHJpbSgpKSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgaWYgKGNscy5pbmRleE9mKCcgJykgPiAtMSkgewogICAgICBjbHMuc3BsaXQod2hpdGVzcGFjZVJFKS5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgcmV0dXJuIGVsLmNsYXNzTGlzdC5hZGQoYyk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NMaXN0LmFkZChjbHMpOwogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgY3VyID0gIiAiLmNvbmNhdChlbC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycsICIgIik7CgogICAgaWYgKGN1ci5pbmRleE9mKCcgJyArIGNscyArICcgJykgPCAwKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAoY3VyICsgY2xzKS50cmltKCkpOwogICAgfQogIH0KfQovKioNCiAqIFJlbW92ZSBjbGFzcyB3aXRoIGNvbXBhdGliaWxpdHkgZm9yIFNWRyBzaW5jZSBjbGFzc0xpc3QgaXMgbm90IHN1cHBvcnRlZCBvbg0KICogU1ZHIGVsZW1lbnRzIGluIElFDQogKi8KCgpmdW5jdGlvbiByZW1vdmVDbGFzcyhlbCwgY2xzKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFjbHMgfHwgIShjbHMgPSBjbHMudHJpbSgpKSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgaWYgKGNscy5pbmRleE9mKCcgJykgPiAtMSkgewogICAgICBjbHMuc3BsaXQod2hpdGVzcGFjZVJFKS5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgcmV0dXJuIGVsLmNsYXNzTGlzdC5yZW1vdmUoYyk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjbHMpOwogICAgfQoKICAgIGlmICghZWwuY2xhc3NMaXN0Lmxlbmd0aCkgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2NsYXNzJyk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBjdXIgPSAiICIuY29uY2F0KGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJywgIiAiKTsKICAgIHZhciB0YXIgPSAnICcgKyBjbHMgKyAnICc7CgogICAgd2hpbGUgKGN1ci5pbmRleE9mKHRhcikgPj0gMCkgewogICAgICBjdXIgPSBjdXIucmVwbGFjZSh0YXIsICcgJyk7CiAgICB9CgogICAgY3VyID0gY3VyLnRyaW0oKTsKCiAgICBpZiAoY3VyKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjdXIpOwogICAgfSBlbHNlIHsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCdjbGFzcycpOwogICAgfQogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZVRyYW5zaXRpb24oZGVmKSB7CiAgaWYgKCFkZWYpIHsKICAgIHJldHVybjsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCgogIGlmICh0eXBlb2YgZGVmID09PSAnb2JqZWN0JykgewogICAgdmFyIHJlcyA9IHt9OwoKICAgIGlmIChkZWYuY3NzICE9PSBmYWxzZSkgewogICAgICBleHRlbmQocmVzLCBhdXRvQ3NzVHJhbnNpdGlvbihkZWYubmFtZSB8fCAndicpKTsKICAgIH0KCiAgICBleHRlbmQocmVzLCBkZWYpOwogICAgcmV0dXJuIHJlczsKICB9IGVsc2UgaWYgKHR5cGVvZiBkZWYgPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gYXV0b0Nzc1RyYW5zaXRpb24oZGVmKTsKICB9Cn0KCnZhciBhdXRvQ3NzVHJhbnNpdGlvbiA9IGNhY2hlZChmdW5jdGlvbiAobmFtZSkgewogIHJldHVybiB7CiAgICBlbnRlckNsYXNzOiAiIi5jb25jYXQobmFtZSwgIi1lbnRlciIpLAogICAgZW50ZXJUb0NsYXNzOiAiIi5jb25jYXQobmFtZSwgIi1lbnRlci10byIpLAogICAgZW50ZXJBY3RpdmVDbGFzczogIiIuY29uY2F0KG5hbWUsICItZW50ZXItYWN0aXZlIiksCiAgICBsZWF2ZUNsYXNzOiAiIi5jb25jYXQobmFtZSwgIi1sZWF2ZSIpLAogICAgbGVhdmVUb0NsYXNzOiAiIi5jb25jYXQobmFtZSwgIi1sZWF2ZS10byIpLAogICAgbGVhdmVBY3RpdmVDbGFzczogIiIuY29uY2F0KG5hbWUsICItbGVhdmUtYWN0aXZlIikKICB9Owp9KTsKdmFyIGhhc1RyYW5zaXRpb24gPSBpbkJyb3dzZXIgJiYgIWlzSUU5Owp2YXIgVFJBTlNJVElPTiA9ICd0cmFuc2l0aW9uJzsKdmFyIEFOSU1BVElPTiA9ICdhbmltYXRpb24nOyAvLyBUcmFuc2l0aW9uIHByb3BlcnR5L2V2ZW50IHNuaWZmaW5nCgp2YXIgdHJhbnNpdGlvblByb3AgPSAndHJhbnNpdGlvbic7CnZhciB0cmFuc2l0aW9uRW5kRXZlbnQgPSAndHJhbnNpdGlvbmVuZCc7CnZhciBhbmltYXRpb25Qcm9wID0gJ2FuaW1hdGlvbic7CnZhciBhbmltYXRpb25FbmRFdmVudCA9ICdhbmltYXRpb25lbmQnOwoKaWYgKGhhc1RyYW5zaXRpb24pIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAod2luZG93Lm9udHJhbnNpdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdHRyYW5zaXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgdHJhbnNpdGlvblByb3AgPSAnV2Via2l0VHJhbnNpdGlvbic7CiAgICB0cmFuc2l0aW9uRW5kRXZlbnQgPSAnd2Via2l0VHJhbnNpdGlvbkVuZCc7CiAgfQoKICBpZiAod2luZG93Lm9uYW5pbWF0aW9uZW5kID09PSB1bmRlZmluZWQgJiYgd2luZG93Lm9ud2Via2l0YW5pbWF0aW9uZW5kICE9PSB1bmRlZmluZWQpIHsKICAgIGFuaW1hdGlvblByb3AgPSAnV2Via2l0QW5pbWF0aW9uJzsKICAgIGFuaW1hdGlvbkVuZEV2ZW50ID0gJ3dlYmtpdEFuaW1hdGlvbkVuZCc7CiAgfQp9IC8vIGJpbmRpbmcgdG8gd2luZG93IGlzIG5lY2Vzc2FyeSB0byBtYWtlIGhvdCByZWxvYWQgd29yayBpbiBJRSBpbiBzdHJpY3QgbW9kZQoKCnZhciByYWYgPSBpbkJyb3dzZXIgPyB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS5iaW5kKHdpbmRvdykgOiBzZXRUaW1lb3V0IDoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KZnVuY3Rpb24gKAovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwpmbikgewogIHJldHVybiBmbigpOwp9OwoKZnVuY3Rpb24gbmV4dEZyYW1lKGZuKSB7CiAgcmFmKGZ1bmN0aW9uICgpIHsKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgIHJhZihmbik7CiAgfSk7Cn0KCmZ1bmN0aW9uIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgY2xzKSB7CiAgdmFyIHRyYW5zaXRpb25DbGFzc2VzID0gZWwuX3RyYW5zaXRpb25DbGFzc2VzIHx8IChlbC5fdHJhbnNpdGlvbkNsYXNzZXMgPSBbXSk7CgogIGlmICh0cmFuc2l0aW9uQ2xhc3Nlcy5pbmRleE9mKGNscykgPCAwKSB7CiAgICB0cmFuc2l0aW9uQ2xhc3Nlcy5wdXNoKGNscyk7CiAgICBhZGRDbGFzcyhlbCwgY2xzKTsKICB9Cn0KCmZ1bmN0aW9uIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgY2xzKSB7CiAgaWYgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcykgewogICAgcmVtb3ZlJDIoZWwuX3RyYW5zaXRpb25DbGFzc2VzLCBjbHMpOwogIH0KCiAgcmVtb3ZlQ2xhc3MoZWwsIGNscyk7Cn0KCmZ1bmN0aW9uIHdoZW5UcmFuc2l0aW9uRW5kcyhlbCwgZXhwZWN0ZWRUeXBlLCBjYikgewogIHZhciBfYSA9IGdldFRyYW5zaXRpb25JbmZvKGVsLCBleHBlY3RlZFR5cGUpLAogICAgICB0eXBlID0gX2EudHlwZSwKICAgICAgdGltZW91dCA9IF9hLnRpbWVvdXQsCiAgICAgIHByb3BDb3VudCA9IF9hLnByb3BDb3VudDsKCiAgaWYgKCF0eXBlKSByZXR1cm4gY2IoKTsKICB2YXIgZXZlbnQgPSB0eXBlID09PSBUUkFOU0lUSU9OID8gdHJhbnNpdGlvbkVuZEV2ZW50IDogYW5pbWF0aW9uRW5kRXZlbnQ7CiAgdmFyIGVuZGVkID0gMDsKCiAgdmFyIGVuZCA9IGZ1bmN0aW9uICgpIHsKICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIG9uRW5kKTsKICAgIGNiKCk7CiAgfTsKCiAgdmFyIG9uRW5kID0gZnVuY3Rpb24gKGUpIHsKICAgIGlmIChlLnRhcmdldCA9PT0gZWwpIHsKICAgICAgaWYgKCsrZW5kZWQgPj0gcHJvcENvdW50KSB7CiAgICAgICAgZW5kKCk7CiAgICAgIH0KICAgIH0KICB9OwoKICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgIGlmIChlbmRlZCA8IHByb3BDb3VudCkgewogICAgICBlbmQoKTsKICAgIH0KICB9LCB0aW1lb3V0ICsgMSk7CiAgZWwuYWRkRXZlbnRMaXN0ZW5lcihldmVudCwgb25FbmQpOwp9Cgp2YXIgdHJhbnNmb3JtUkUgPSAvXGIodHJhbnNmb3JtfGFsbCkoLHwkKS87CgpmdW5jdGlvbiBnZXRUcmFuc2l0aW9uSW5mbyhlbCwgZXhwZWN0ZWRUeXBlKSB7CiAgdmFyIHN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKTsgLy8gSlNET00gbWF5IHJldHVybiB1bmRlZmluZWQgZm9yIHRyYW5zaXRpb24gcHJvcGVydGllcwoKICB2YXIgdHJhbnNpdGlvbkRlbGF5cyA9IChzdHlsZXNbdHJhbnNpdGlvblByb3AgKyAnRGVsYXknXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbnMgPSAoc3R5bGVzW3RyYW5zaXRpb25Qcm9wICsgJ0R1cmF0aW9uJ10gfHwgJycpLnNwbGl0KCcsICcpOwogIHZhciB0cmFuc2l0aW9uVGltZW91dCA9IGdldFRpbWVvdXQodHJhbnNpdGlvbkRlbGF5cywgdHJhbnNpdGlvbkR1cmF0aW9ucyk7CiAgdmFyIGFuaW1hdGlvbkRlbGF5cyA9IChzdHlsZXNbYW5pbWF0aW9uUHJvcCArICdEZWxheSddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICB2YXIgYW5pbWF0aW9uRHVyYXRpb25zID0gKHN0eWxlc1thbmltYXRpb25Qcm9wICsgJ0R1cmF0aW9uJ10gfHwgJycpLnNwbGl0KCcsICcpOwogIHZhciBhbmltYXRpb25UaW1lb3V0ID0gZ2V0VGltZW91dChhbmltYXRpb25EZWxheXMsIGFuaW1hdGlvbkR1cmF0aW9ucyk7CiAgdmFyIHR5cGU7CiAgdmFyIHRpbWVvdXQgPSAwOwogIHZhciBwcm9wQ291bnQgPSAwOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAoZXhwZWN0ZWRUeXBlID09PSBUUkFOU0lUSU9OKSB7CiAgICBpZiAodHJhbnNpdGlvblRpbWVvdXQgPiAwKSB7CiAgICAgIHR5cGUgPSBUUkFOU0lUSU9OOwogICAgICB0aW1lb3V0ID0gdHJhbnNpdGlvblRpbWVvdXQ7CiAgICAgIHByb3BDb3VudCA9IHRyYW5zaXRpb25EdXJhdGlvbnMubGVuZ3RoOwogICAgfQogIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSBBTklNQVRJT04pIHsKICAgIGlmIChhbmltYXRpb25UaW1lb3V0ID4gMCkgewogICAgICB0eXBlID0gQU5JTUFUSU9OOwogICAgICB0aW1lb3V0ID0gYW5pbWF0aW9uVGltZW91dDsKICAgICAgcHJvcENvdW50ID0gYW5pbWF0aW9uRHVyYXRpb25zLmxlbmd0aDsKICAgIH0KICB9IGVsc2UgewogICAgdGltZW91dCA9IE1hdGgubWF4KHRyYW5zaXRpb25UaW1lb3V0LCBhbmltYXRpb25UaW1lb3V0KTsKICAgIHR5cGUgPSB0aW1lb3V0ID4gMCA/IHRyYW5zaXRpb25UaW1lb3V0ID4gYW5pbWF0aW9uVGltZW91dCA/IFRSQU5TSVRJT04gOiBBTklNQVRJT04gOiBudWxsOwogICAgcHJvcENvdW50ID0gdHlwZSA/IHR5cGUgPT09IFRSQU5TSVRJT04gPyB0cmFuc2l0aW9uRHVyYXRpb25zLmxlbmd0aCA6IGFuaW1hdGlvbkR1cmF0aW9ucy5sZW5ndGggOiAwOwogIH0KCiAgdmFyIGhhc1RyYW5zZm9ybSA9IHR5cGUgPT09IFRSQU5TSVRJT04gJiYgdHJhbnNmb3JtUkUudGVzdChzdHlsZXNbdHJhbnNpdGlvblByb3AgKyAnUHJvcGVydHknXSk7CiAgcmV0dXJuIHsKICAgIHR5cGU6IHR5cGUsCiAgICB0aW1lb3V0OiB0aW1lb3V0LAogICAgcHJvcENvdW50OiBwcm9wQ291bnQsCiAgICBoYXNUcmFuc2Zvcm06IGhhc1RyYW5zZm9ybQogIH07Cn0KCmZ1bmN0aW9uIGdldFRpbWVvdXQoZGVsYXlzLCBkdXJhdGlvbnMpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIHdoaWxlIChkZWxheXMubGVuZ3RoIDwgZHVyYXRpb25zLmxlbmd0aCkgewogICAgZGVsYXlzID0gZGVsYXlzLmNvbmNhdChkZWxheXMpOwogIH0KCiAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KG51bGwsIGR1cmF0aW9ucy5tYXAoZnVuY3Rpb24gKGQsIGkpIHsKICAgIHJldHVybiB0b01zKGQpICsgdG9NcyhkZWxheXNbaV0pOwogIH0pKTsKfSAvLyBPbGQgdmVyc2lvbnMgb2YgQ2hyb21pdW0gKGJlbG93IDYxLjAuMzE2My4xMDApIGZvcm1hdHMgZmxvYXRpbmcgcG9pbnRlciBudW1iZXJzCi8vIGluIGEgbG9jYWxlLWRlcGVuZGVudCB3YXksIHVzaW5nIGEgY29tbWEgaW5zdGVhZCBvZiBhIGRvdC4KLy8gSWYgY29tbWEgaXMgbm90IHJlcGxhY2VkIHdpdGggYSBkb3QsIHRoZSBpbnB1dCB3aWxsIGJlIHJvdW5kZWQgZG93biAoaS5lLiBhY3RpbmcKLy8gYXMgYSBmbG9vciBmdW5jdGlvbikgY2F1c2luZyB1bmV4cGVjdGVkIGJlaGF2aW9ycwoKCmZ1bmN0aW9uIHRvTXMocykgewogIHJldHVybiBOdW1iZXIocy5zbGljZSgwLCAtMSkucmVwbGFjZSgnLCcsICcuJykpICogMTAwMDsKfQoKZnVuY3Rpb24gZW50ZXIodm5vZGUsIHRvZ2dsZURpc3BsYXkpIHsKICB2YXIgZWwgPSB2bm9kZS5lbG07IC8vIGNhbGwgbGVhdmUgY2FsbGJhY2sgbm93CgogIGlmIChpc0RlZihlbC5fbGVhdmVDYikpIHsKICAgIGVsLl9sZWF2ZUNiLmNhbmNlbGxlZCA9IHRydWU7CgogICAgZWwuX2xlYXZlQ2IoKTsKICB9CgogIHZhciBkYXRhID0gcmVzb2x2ZVRyYW5zaXRpb24odm5vZGUuZGF0YS50cmFuc2l0aW9uKTsKCiAgaWYgKGlzVW5kZWYoZGF0YSkpIHsKICAgIHJldHVybjsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICBpZiAoaXNEZWYoZWwuX2VudGVyQ2IpIHx8IGVsLm5vZGVUeXBlICE9PSAxKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgY3NzID0gZGF0YS5jc3MsCiAgICAgIHR5cGUgPSBkYXRhLnR5cGUsCiAgICAgIGVudGVyQ2xhc3MgPSBkYXRhLmVudGVyQ2xhc3MsCiAgICAgIGVudGVyVG9DbGFzcyA9IGRhdGEuZW50ZXJUb0NsYXNzLAogICAgICBlbnRlckFjdGl2ZUNsYXNzID0gZGF0YS5lbnRlckFjdGl2ZUNsYXNzLAogICAgICBhcHBlYXJDbGFzcyA9IGRhdGEuYXBwZWFyQ2xhc3MsCiAgICAgIGFwcGVhclRvQ2xhc3MgPSBkYXRhLmFwcGVhclRvQ2xhc3MsCiAgICAgIGFwcGVhckFjdGl2ZUNsYXNzID0gZGF0YS5hcHBlYXJBY3RpdmVDbGFzcywKICAgICAgYmVmb3JlRW50ZXIgPSBkYXRhLmJlZm9yZUVudGVyLAogICAgICBlbnRlciA9IGRhdGEuZW50ZXIsCiAgICAgIGFmdGVyRW50ZXIgPSBkYXRhLmFmdGVyRW50ZXIsCiAgICAgIGVudGVyQ2FuY2VsbGVkID0gZGF0YS5lbnRlckNhbmNlbGxlZCwKICAgICAgYmVmb3JlQXBwZWFyID0gZGF0YS5iZWZvcmVBcHBlYXIsCiAgICAgIGFwcGVhciA9IGRhdGEuYXBwZWFyLAogICAgICBhZnRlckFwcGVhciA9IGRhdGEuYWZ0ZXJBcHBlYXIsCiAgICAgIGFwcGVhckNhbmNlbGxlZCA9IGRhdGEuYXBwZWFyQ2FuY2VsbGVkLAogICAgICBkdXJhdGlvbiA9IGRhdGEuZHVyYXRpb247IC8vIGFjdGl2ZUluc3RhbmNlIHdpbGwgYWx3YXlzIGJlIHRoZSA8dHJhbnNpdGlvbj4gY29tcG9uZW50IG1hbmFnaW5nIHRoaXMKICAvLyB0cmFuc2l0aW9uLiBPbmUgZWRnZSBjYXNlIHRvIGNoZWNrIGlzIHdoZW4gdGhlIDx0cmFuc2l0aW9uPiBpcyBwbGFjZWQKICAvLyBhcyB0aGUgcm9vdCBub2RlIG9mIGEgY2hpbGQgY29tcG9uZW50LiBJbiB0aGF0IGNhc2Ugd2UgbmVlZCB0byBjaGVjawogIC8vIDx0cmFuc2l0aW9uPidzIHBhcmVudCBmb3IgYXBwZWFyIGNoZWNrLgoKICB2YXIgY29udGV4dCA9IGFjdGl2ZUluc3RhbmNlOwogIHZhciB0cmFuc2l0aW9uTm9kZSA9IGFjdGl2ZUluc3RhbmNlLiR2bm9kZTsKCiAgd2hpbGUgKHRyYW5zaXRpb25Ob2RlICYmIHRyYW5zaXRpb25Ob2RlLnBhcmVudCkgewogICAgY29udGV4dCA9IHRyYW5zaXRpb25Ob2RlLmNvbnRleHQ7CiAgICB0cmFuc2l0aW9uTm9kZSA9IHRyYW5zaXRpb25Ob2RlLnBhcmVudDsKICB9CgogIHZhciBpc0FwcGVhciA9ICFjb250ZXh0Ll9pc01vdW50ZWQgfHwgIXZub2RlLmlzUm9vdEluc2VydDsKCiAgaWYgKGlzQXBwZWFyICYmICFhcHBlYXIgJiYgYXBwZWFyICE9PSAnJykgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHN0YXJ0Q2xhc3MgPSBpc0FwcGVhciAmJiBhcHBlYXJDbGFzcyA/IGFwcGVhckNsYXNzIDogZW50ZXJDbGFzczsKICB2YXIgYWN0aXZlQ2xhc3MgPSBpc0FwcGVhciAmJiBhcHBlYXJBY3RpdmVDbGFzcyA/IGFwcGVhckFjdGl2ZUNsYXNzIDogZW50ZXJBY3RpdmVDbGFzczsKICB2YXIgdG9DbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhclRvQ2xhc3MgPyBhcHBlYXJUb0NsYXNzIDogZW50ZXJUb0NsYXNzOwogIHZhciBiZWZvcmVFbnRlckhvb2sgPSBpc0FwcGVhciA/IGJlZm9yZUFwcGVhciB8fCBiZWZvcmVFbnRlciA6IGJlZm9yZUVudGVyOwogIHZhciBlbnRlckhvb2sgPSBpc0FwcGVhciA/IGlzRnVuY3Rpb24oYXBwZWFyKSA/IGFwcGVhciA6IGVudGVyIDogZW50ZXI7CiAgdmFyIGFmdGVyRW50ZXJIb29rID0gaXNBcHBlYXIgPyBhZnRlckFwcGVhciB8fCBhZnRlckVudGVyIDogYWZ0ZXJFbnRlcjsKICB2YXIgZW50ZXJDYW5jZWxsZWRIb29rID0gaXNBcHBlYXIgPyBhcHBlYXJDYW5jZWxsZWQgfHwgZW50ZXJDYW5jZWxsZWQgOiBlbnRlckNhbmNlbGxlZDsKICB2YXIgZXhwbGljaXRFbnRlckR1cmF0aW9uID0gdG9OdW1iZXIoaXNPYmplY3QoZHVyYXRpb24pID8gZHVyYXRpb24uZW50ZXIgOiBkdXJhdGlvbik7CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGV4cGxpY2l0RW50ZXJEdXJhdGlvbiAhPSBudWxsKSB7CiAgICBjaGVja0R1cmF0aW9uKGV4cGxpY2l0RW50ZXJEdXJhdGlvbiwgJ2VudGVyJywgdm5vZGUpOwogIH0KCiAgdmFyIGV4cGVjdHNDU1MgPSBjc3MgIT09IGZhbHNlICYmICFpc0lFOTsKICB2YXIgdXNlcldhbnRzQ29udHJvbCA9IGdldEhvb2tBcmd1bWVudHNMZW5ndGgoZW50ZXJIb29rKTsKICB2YXIgY2IgPSBlbC5fZW50ZXJDYiA9IG9uY2UoZnVuY3Rpb24gKCkgewogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCB0b0NsYXNzKTsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBhY3RpdmVDbGFzcyk7CiAgICB9IC8vIEB0cy1leHBlY3QtZXJyb3IKCgogICAgaWYgKGNiLmNhbmNlbGxlZCkgewogICAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgc3RhcnRDbGFzcyk7CiAgICAgIH0KCiAgICAgIGVudGVyQ2FuY2VsbGVkSG9vayAmJiBlbnRlckNhbmNlbGxlZEhvb2soZWwpOwogICAgfSBlbHNlIHsKICAgICAgYWZ0ZXJFbnRlckhvb2sgJiYgYWZ0ZXJFbnRlckhvb2soZWwpOwogICAgfQoKICAgIGVsLl9lbnRlckNiID0gbnVsbDsKICB9KTsKCiAgaWYgKCF2bm9kZS5kYXRhLnNob3cpIHsKICAgIC8vIHJlbW92ZSBwZW5kaW5nIGxlYXZlIGVsZW1lbnQgb24gZW50ZXIgYnkgaW5qZWN0aW5nIGFuIGluc2VydCBob29rCiAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ2luc2VydCcsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHBhcmVudCA9IGVsLnBhcmVudE5vZGU7CiAgICAgIHZhciBwZW5kaW5nTm9kZSA9IHBhcmVudCAmJiBwYXJlbnQuX3BlbmRpbmcgJiYgcGFyZW50Ll9wZW5kaW5nW3Zub2RlLmtleV07CgogICAgICBpZiAocGVuZGluZ05vZGUgJiYgcGVuZGluZ05vZGUudGFnID09PSB2bm9kZS50YWcgJiYgcGVuZGluZ05vZGUuZWxtLl9sZWF2ZUNiKSB7CiAgICAgICAgcGVuZGluZ05vZGUuZWxtLl9sZWF2ZUNiKCk7CiAgICAgIH0KCiAgICAgIGVudGVySG9vayAmJiBlbnRlckhvb2soZWwsIGNiKTsKICAgIH0pOwogIH0gLy8gc3RhcnQgZW50ZXIgdHJhbnNpdGlvbgoKCiAgYmVmb3JlRW50ZXJIb29rICYmIGJlZm9yZUVudGVySG9vayhlbCk7CgogIGlmIChleHBlY3RzQ1NTKSB7CiAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIHN0YXJ0Q2xhc3MpOwogICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBhY3RpdmVDbGFzcyk7CiAgICBuZXh0RnJhbWUoZnVuY3Rpb24gKCkgewogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIHN0YXJ0Q2xhc3MpOyAvLyBAdHMtZXhwZWN0LWVycm9yCgogICAgICBpZiAoIWNiLmNhbmNlbGxlZCkgewogICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgdG9DbGFzcyk7CgogICAgICAgIGlmICghdXNlcldhbnRzQ29udHJvbCkgewogICAgICAgICAgaWYgKGlzVmFsaWREdXJhdGlvbihleHBsaWNpdEVudGVyRHVyYXRpb24pKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoY2IsIGV4cGxpY2l0RW50ZXJEdXJhdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIHR5cGUsIGNiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KCiAgaWYgKHZub2RlLmRhdGEuc2hvdykgewogICAgdG9nZ2xlRGlzcGxheSAmJiB0b2dnbGVEaXNwbGF5KCk7CiAgICBlbnRlckhvb2sgJiYgZW50ZXJIb29rKGVsLCBjYik7CiAgfQoKICBpZiAoIWV4cGVjdHNDU1MgJiYgIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgIGNiKCk7CiAgfQp9CgpmdW5jdGlvbiBsZWF2ZSh2bm9kZSwgcm0pIHsKICB2YXIgZWwgPSB2bm9kZS5lbG07IC8vIGNhbGwgZW50ZXIgY2FsbGJhY2sgbm93CgogIGlmIChpc0RlZihlbC5fZW50ZXJDYikpIHsKICAgIGVsLl9lbnRlckNiLmNhbmNlbGxlZCA9IHRydWU7CgogICAgZWwuX2VudGVyQ2IoKTsKICB9CgogIHZhciBkYXRhID0gcmVzb2x2ZVRyYW5zaXRpb24odm5vZGUuZGF0YS50cmFuc2l0aW9uKTsKCiAgaWYgKGlzVW5kZWYoZGF0YSkgfHwgZWwubm9kZVR5cGUgIT09IDEpIHsKICAgIHJldHVybiBybSgpOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmIChpc0RlZihlbC5fbGVhdmVDYikpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBjc3MgPSBkYXRhLmNzcywKICAgICAgdHlwZSA9IGRhdGEudHlwZSwKICAgICAgbGVhdmVDbGFzcyA9IGRhdGEubGVhdmVDbGFzcywKICAgICAgbGVhdmVUb0NsYXNzID0gZGF0YS5sZWF2ZVRvQ2xhc3MsCiAgICAgIGxlYXZlQWN0aXZlQ2xhc3MgPSBkYXRhLmxlYXZlQWN0aXZlQ2xhc3MsCiAgICAgIGJlZm9yZUxlYXZlID0gZGF0YS5iZWZvcmVMZWF2ZSwKICAgICAgbGVhdmUgPSBkYXRhLmxlYXZlLAogICAgICBhZnRlckxlYXZlID0gZGF0YS5hZnRlckxlYXZlLAogICAgICBsZWF2ZUNhbmNlbGxlZCA9IGRhdGEubGVhdmVDYW5jZWxsZWQsCiAgICAgIGRlbGF5TGVhdmUgPSBkYXRhLmRlbGF5TGVhdmUsCiAgICAgIGR1cmF0aW9uID0gZGF0YS5kdXJhdGlvbjsKICB2YXIgZXhwZWN0c0NTUyA9IGNzcyAhPT0gZmFsc2UgJiYgIWlzSUU5OwogIHZhciB1c2VyV2FudHNDb250cm9sID0gZ2V0SG9va0FyZ3VtZW50c0xlbmd0aChsZWF2ZSk7CiAgdmFyIGV4cGxpY2l0TGVhdmVEdXJhdGlvbiA9IHRvTnVtYmVyKGlzT2JqZWN0KGR1cmF0aW9uKSA/IGR1cmF0aW9uLmxlYXZlIDogZHVyYXRpb24pOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBpc0RlZihleHBsaWNpdExlYXZlRHVyYXRpb24pKSB7CiAgICBjaGVja0R1cmF0aW9uKGV4cGxpY2l0TGVhdmVEdXJhdGlvbiwgJ2xlYXZlJywgdm5vZGUpOwogIH0KCiAgdmFyIGNiID0gZWwuX2xlYXZlQ2IgPSBvbmNlKGZ1bmN0aW9uICgpIHsKICAgIGlmIChlbC5wYXJlbnROb2RlICYmIGVsLnBhcmVudE5vZGUuX3BlbmRpbmcpIHsKICAgICAgZWwucGFyZW50Tm9kZS5fcGVuZGluZ1t2bm9kZS5rZXldID0gbnVsbDsKICAgIH0KCiAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVBY3RpdmVDbGFzcyk7CiAgICB9IC8vIEB0cy1leHBlY3QtZXJyb3IKCgogICAgaWYgKGNiLmNhbmNlbGxlZCkgewogICAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVDbGFzcyk7CiAgICAgIH0KCiAgICAgIGxlYXZlQ2FuY2VsbGVkICYmIGxlYXZlQ2FuY2VsbGVkKGVsKTsKICAgIH0gZWxzZSB7CiAgICAgIHJtKCk7CiAgICAgIGFmdGVyTGVhdmUgJiYgYWZ0ZXJMZWF2ZShlbCk7CiAgICB9CgogICAgZWwuX2xlYXZlQ2IgPSBudWxsOwogIH0pOwoKICBpZiAoZGVsYXlMZWF2ZSkgewogICAgZGVsYXlMZWF2ZShwZXJmb3JtTGVhdmUpOwogIH0gZWxzZSB7CiAgICBwZXJmb3JtTGVhdmUoKTsKICB9CgogIGZ1bmN0aW9uIHBlcmZvcm1MZWF2ZSgpIHsKICAgIC8vIHRoZSBkZWxheWVkIGxlYXZlIG1heSBoYXZlIGFscmVhZHkgYmVlbiBjYW5jZWxsZWQKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgIGlmIChjYi5jYW5jZWxsZWQpIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyByZWNvcmQgbGVhdmluZyBlbGVtZW50CgoKICAgIGlmICghdm5vZGUuZGF0YS5zaG93ICYmIGVsLnBhcmVudE5vZGUpIHsKICAgICAgKGVsLnBhcmVudE5vZGUuX3BlbmRpbmcgfHwgKGVsLnBhcmVudE5vZGUuX3BlbmRpbmcgPSB7fSkpW3Zub2RlLmtleV0gPSB2bm9kZTsKICAgIH0KCiAgICBiZWZvcmVMZWF2ZSAmJiBiZWZvcmVMZWF2ZShlbCk7CgogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUNsYXNzKTsKICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUFjdGl2ZUNsYXNzKTsKICAgICAgbmV4dEZyYW1lKGZ1bmN0aW9uICgpIHsKICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOyAvLyBAdHMtZXhwZWN0LWVycm9yCgogICAgICAgIGlmICghY2IuY2FuY2VsbGVkKSB7CiAgICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7CgogICAgICAgICAgaWYgKCF1c2VyV2FudHNDb250cm9sKSB7CiAgICAgICAgICAgIGlmIChpc1ZhbGlkRHVyYXRpb24oZXhwbGljaXRMZWF2ZUR1cmF0aW9uKSkgewogICAgICAgICAgICAgIHNldFRpbWVvdXQoY2IsIGV4cGxpY2l0TGVhdmVEdXJhdGlvbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBjYik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIGxlYXZlICYmIGxlYXZlKGVsLCBjYik7CgogICAgaWYgKCFleHBlY3RzQ1NTICYmICF1c2VyV2FudHNDb250cm9sKSB7CiAgICAgIGNiKCk7CiAgICB9CiAgfQp9IC8vIG9ubHkgdXNlZCBpbiBkZXYgbW9kZQoKCmZ1bmN0aW9uIGNoZWNrRHVyYXRpb24odmFsLCBuYW1lLCB2bm9kZSkgewogIGlmICh0eXBlb2YgdmFsICE9PSAnbnVtYmVyJykgewogICAgd2FybigiPHRyYW5zaXRpb24+IGV4cGxpY2l0ICIuY29uY2F0KG5hbWUsICIgZHVyYXRpb24gaXMgbm90IGEgdmFsaWQgbnVtYmVyIC0gIikgKyAiZ290ICIuY29uY2F0KEpTT04uc3RyaW5naWZ5KHZhbCksICIuIiksIHZub2RlLmNvbnRleHQpOwogIH0gZWxzZSBpZiAoaXNOYU4odmFsKSkgewogICAgd2FybigiPHRyYW5zaXRpb24+IGV4cGxpY2l0ICIuY29uY2F0KG5hbWUsICIgZHVyYXRpb24gaXMgTmFOIC0gIikgKyAndGhlIGR1cmF0aW9uIGV4cHJlc3Npb24gbWlnaHQgYmUgaW5jb3JyZWN0LicsIHZub2RlLmNvbnRleHQpOwogIH0KfQoKZnVuY3Rpb24gaXNWYWxpZER1cmF0aW9uKHZhbCkgewogIHJldHVybiB0eXBlb2YgdmFsID09PSAnbnVtYmVyJyAmJiAhaXNOYU4odmFsKTsKfQovKioNCiAqIE5vcm1hbGl6ZSBhIHRyYW5zaXRpb24gaG9vaydzIGFyZ3VtZW50IGxlbmd0aC4gVGhlIGhvb2sgbWF5IGJlOg0KICogLSBhIG1lcmdlZCBob29rIChpbnZva2VyKSB3aXRoIHRoZSBvcmlnaW5hbCBpbiAuZm5zDQogKiAtIGEgd3JhcHBlZCBjb21wb25lbnQgbWV0aG9kIChjaGVjayAuX2xlbmd0aCkNCiAqIC0gYSBwbGFpbiBmdW5jdGlvbiAoLmxlbmd0aCkNCiAqLwoKCmZ1bmN0aW9uIGdldEhvb2tBcmd1bWVudHNMZW5ndGgoZm4pIHsKICBpZiAoaXNVbmRlZihmbikpIHsKICAgIHJldHVybiBmYWxzZTsKICB9IC8vIEB0cy1leHBlY3QtZXJyb3IKCgogIHZhciBpbnZva2VyRm5zID0gZm4uZm5zOwoKICBpZiAoaXNEZWYoaW52b2tlckZucykpIHsKICAgIC8vIGludm9rZXIKICAgIHJldHVybiBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKEFycmF5LmlzQXJyYXkoaW52b2tlckZucykgPyBpbnZva2VyRm5zWzBdIDogaW52b2tlckZucyk7CiAgfSBlbHNlIHsKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgIHJldHVybiAoZm4uX2xlbmd0aCB8fCBmbi5sZW5ndGgpID4gMTsKICB9Cn0KCmZ1bmN0aW9uIF9lbnRlcihfLCB2bm9kZSkgewogIGlmICh2bm9kZS5kYXRhLnNob3cgIT09IHRydWUpIHsKICAgIGVudGVyKHZub2RlKTsKICB9Cn0KCnZhciB0cmFuc2l0aW9uID0gaW5Ccm93c2VyID8gewogIGNyZWF0ZTogX2VudGVyLAogIGFjdGl2YXRlOiBfZW50ZXIsCiAgcmVtb3ZlOiBmdW5jdGlvbiAodm5vZGUsIHJtKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgaWYgKHZub2RlLmRhdGEuc2hvdyAhPT0gdHJ1ZSkgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yCiAgICAgIGxlYXZlKHZub2RlLCBybSk7CiAgICB9IGVsc2UgewogICAgICBybSgpOwogICAgfQogIH0KfSA6IHt9Owp2YXIgcGxhdGZvcm1Nb2R1bGVzID0gW2F0dHJzLCBrbGFzcywgZXZlbnRzLCBkb21Qcm9wcywgc3R5bGUsIHRyYW5zaXRpb25dOyAvLyB0aGUgZGlyZWN0aXZlIG1vZHVsZSBzaG91bGQgYmUgYXBwbGllZCBsYXN0LCBhZnRlciBhbGwKLy8gYnVpbHQtaW4gbW9kdWxlcyBoYXZlIGJlZW4gYXBwbGllZC4KCnZhciBtb2R1bGVzID0gcGxhdGZvcm1Nb2R1bGVzLmNvbmNhdChiYXNlTW9kdWxlcyk7CnZhciBwYXRjaCA9IGNyZWF0ZVBhdGNoRnVuY3Rpb24oewogIG5vZGVPcHM6IG5vZGVPcHMsCiAgbW9kdWxlczogbW9kdWxlcwp9KTsKLyoqDQogKiBOb3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgbGlrZSBhdHRhY2hpbmcNCiAqIHByb3BlcnRpZXMgdG8gRWxlbWVudHMuDQogKi8KCi8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKaWYgKGlzSUU5KSB7CiAgLy8gaHR0cDovL3d3dy5tYXR0czQxMS5jb20vcG9zdC9pbnRlcm5ldC1leHBsb3Jlci05LW9uaW5wdXQvCiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKCkgewogICAgdmFyIGVsID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsgLy8gQHRzLWV4cGVjdC1lcnJvcgoKICAgIGlmIChlbCAmJiBlbC52bW9kZWwpIHsKICAgICAgdHJpZ2dlcihlbCwgJ2lucHV0Jyk7CiAgICB9CiAgfSk7Cn0KCnZhciBkaXJlY3RpdmUgPSB7CiAgaW5zZXJ0ZWQ6IGZ1bmN0aW9uIChlbCwgYmluZGluZywgdm5vZGUsIG9sZFZub2RlKSB7CiAgICBpZiAodm5vZGUudGFnID09PSAnc2VsZWN0JykgewogICAgICAvLyAjNjkwMwogICAgICBpZiAob2xkVm5vZGUuZWxtICYmICFvbGRWbm9kZS5lbG0uX3ZPcHRpb25zKSB7CiAgICAgICAgbWVyZ2VWTm9kZUhvb2sodm5vZGUsICdwb3N0cGF0Y2gnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkaXJlY3RpdmUuY29tcG9uZW50VXBkYXRlZChlbCwgYmluZGluZywgdm5vZGUpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bm9kZS5jb250ZXh0KTsKICAgICAgfQoKICAgICAgZWwuX3ZPcHRpb25zID0gW10ubWFwLmNhbGwoZWwub3B0aW9ucywgZ2V0VmFsdWUpOwogICAgfSBlbHNlIGlmICh2bm9kZS50YWcgPT09ICd0ZXh0YXJlYScgfHwgaXNUZXh0SW5wdXRUeXBlKGVsLnR5cGUpKSB7CiAgICAgIGVsLl92TW9kaWZpZXJzID0gYmluZGluZy5tb2RpZmllcnM7CgogICAgICBpZiAoIWJpbmRpbmcubW9kaWZpZXJzLmxhenkpIHsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjb21wb3NpdGlvbnN0YXJ0Jywgb25Db21wb3NpdGlvblN0YXJ0KTsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjb21wb3NpdGlvbmVuZCcsIG9uQ29tcG9zaXRpb25FbmQpOyAvLyBTYWZhcmkgPCAxMC4yICYgVUlXZWJWaWV3IGRvZXNuJ3QgZmlyZSBjb21wb3NpdGlvbmVuZCB3aGVuCiAgICAgICAgLy8gc3dpdGNoaW5nIGZvY3VzIGJlZm9yZSBjb25maXJtaW5nIGNvbXBvc2l0aW9uIGNob2ljZQogICAgICAgIC8vIHRoaXMgYWxzbyBmaXhlcyB0aGUgaXNzdWUgd2hlcmUgc29tZSBicm93c2VycyBlLmcuIGlPUyBDaHJvbWUKICAgICAgICAvLyBmaXJlcyAiY2hhbmdlIiBpbnN0ZWFkIG9mICJpbnB1dCIgb24gYXV0b2NvbXBsZXRlLgoKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBvbkNvbXBvc2l0aW9uRW5kKTsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICAgICAgaWYgKGlzSUU5KSB7CiAgICAgICAgICBlbC52bW9kZWwgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sCiAgY29tcG9uZW50VXBkYXRlZDogZnVuY3Rpb24gKGVsLCBiaW5kaW5nLCB2bm9kZSkgewogICAgaWYgKHZub2RlLnRhZyA9PT0gJ3NlbGVjdCcpIHsKICAgICAgc2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZub2RlLmNvbnRleHQpOyAvLyBpbiBjYXNlIHRoZSBvcHRpb25zIHJlbmRlcmVkIGJ5IHYtZm9yIGhhdmUgY2hhbmdlZCwKICAgICAgLy8gaXQncyBwb3NzaWJsZSB0aGF0IHRoZSB2YWx1ZSBpcyBvdXQtb2Ytc3luYyB3aXRoIHRoZSByZW5kZXJlZCBvcHRpb25zLgogICAgICAvLyBkZXRlY3Qgc3VjaCBjYXNlcyBhbmQgZmlsdGVyIG91dCB2YWx1ZXMgdGhhdCBubyBsb25nZXIgaGFzIGEgbWF0Y2hpbmcKICAgICAgLy8gb3B0aW9uIGluIHRoZSBET00uCgogICAgICB2YXIgcHJldk9wdGlvbnNfMSA9IGVsLl92T3B0aW9uczsKICAgICAgdmFyIGN1ck9wdGlvbnNfMSA9IGVsLl92T3B0aW9ucyA9IFtdLm1hcC5jYWxsKGVsLm9wdGlvbnMsIGdldFZhbHVlKTsKCiAgICAgIGlmIChjdXJPcHRpb25zXzEuc29tZShmdW5jdGlvbiAobywgaSkgewogICAgICAgIHJldHVybiAhbG9vc2VFcXVhbChvLCBwcmV2T3B0aW9uc18xW2ldKTsKICAgICAgfSkpIHsKICAgICAgICAvLyB0cmlnZ2VyIGNoYW5nZSBldmVudCBpZgogICAgICAgIC8vIG5vIG1hdGNoaW5nIG9wdGlvbiBmb3VuZCBmb3IgYXQgbGVhc3Qgb25lIHZhbHVlCiAgICAgICAgdmFyIG5lZWRSZXNldCA9IGVsLm11bHRpcGxlID8gYmluZGluZy52YWx1ZS5zb21lKGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICByZXR1cm4gaGFzTm9NYXRjaGluZ09wdGlvbih2LCBjdXJPcHRpb25zXzEpOwogICAgICAgIH0pIDogYmluZGluZy52YWx1ZSAhPT0gYmluZGluZy5vbGRWYWx1ZSAmJiBoYXNOb01hdGNoaW5nT3B0aW9uKGJpbmRpbmcudmFsdWUsIGN1ck9wdGlvbnNfMSk7CgogICAgICAgIGlmIChuZWVkUmVzZXQpIHsKICAgICAgICAgIHRyaWdnZXIoZWwsICdjaGFuZ2UnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn07CgpmdW5jdGlvbiBzZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm0pIHsKICBhY3R1YWxseVNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bSk7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChpc0lFIHx8IGlzRWRnZSkgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGFjdHVhbGx5U2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKTsKICAgIH0sIDApOwogIH0KfQoKZnVuY3Rpb24gYWN0dWFsbHlTZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm0pIHsKICB2YXIgdmFsdWUgPSBiaW5kaW5nLnZhbHVlOwogIHZhciBpc011bHRpcGxlID0gZWwubXVsdGlwbGU7CgogIGlmIChpc011bHRpcGxlICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCI8c2VsZWN0IG11bHRpcGxlIHYtbW9kZWw9XCIiLmNvbmNhdChiaW5kaW5nLmV4cHJlc3Npb24sICJcIj4gIikgKyAiZXhwZWN0cyBhbiBBcnJheSB2YWx1ZSBmb3IgaXRzIGJpbmRpbmcsIGJ1dCBnb3QgIi5jb25jYXQoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKS5zbGljZSg4LCAtMSkpLCB2bSk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgc2VsZWN0ZWQsIG9wdGlvbjsKCiAgZm9yICh2YXIgaSA9IDAsIGwgPSBlbC5vcHRpb25zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgb3B0aW9uID0gZWwub3B0aW9uc1tpXTsKCiAgICBpZiAoaXNNdWx0aXBsZSkgewogICAgICBzZWxlY3RlZCA9IGxvb3NlSW5kZXhPZih2YWx1ZSwgZ2V0VmFsdWUob3B0aW9uKSkgPiAtMTsKCiAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQgIT09IHNlbGVjdGVkKSB7CiAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gc2VsZWN0ZWQ7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChsb29zZUVxdWFsKGdldFZhbHVlKG9wdGlvbiksIHZhbHVlKSkgewogICAgICAgIGlmIChlbC5zZWxlY3RlZEluZGV4ICE9PSBpKSB7CiAgICAgICAgICBlbC5zZWxlY3RlZEluZGV4ID0gaTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKCFpc011bHRpcGxlKSB7CiAgICBlbC5zZWxlY3RlZEluZGV4ID0gLTE7CiAgfQp9CgpmdW5jdGlvbiBoYXNOb01hdGNoaW5nT3B0aW9uKHZhbHVlLCBvcHRpb25zKSB7CiAgcmV0dXJuIG9wdGlvbnMuZXZlcnkoZnVuY3Rpb24gKG8pIHsKICAgIHJldHVybiAhbG9vc2VFcXVhbChvLCB2YWx1ZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldFZhbHVlKG9wdGlvbikgewogIHJldHVybiAnX3ZhbHVlJyBpbiBvcHRpb24gPyBvcHRpb24uX3ZhbHVlIDogb3B0aW9uLnZhbHVlOwp9CgpmdW5jdGlvbiBvbkNvbXBvc2l0aW9uU3RhcnQoZSkgewogIGUudGFyZ2V0LmNvbXBvc2luZyA9IHRydWU7Cn0KCmZ1bmN0aW9uIG9uQ29tcG9zaXRpb25FbmQoZSkgewogIC8vIHByZXZlbnQgdHJpZ2dlcmluZyBhbiBpbnB1dCBldmVudCBmb3Igbm8gcmVhc29uCiAgaWYgKCFlLnRhcmdldC5jb21wb3NpbmcpIHJldHVybjsKICBlLnRhcmdldC5jb21wb3NpbmcgPSBmYWxzZTsKICB0cmlnZ2VyKGUudGFyZ2V0LCAnaW5wdXQnKTsKfQoKZnVuY3Rpb24gdHJpZ2dlcihlbCwgdHlwZSkgewogIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICBlLmluaXRFdmVudCh0eXBlLCB0cnVlLCB0cnVlKTsKICBlbC5kaXNwYXRjaEV2ZW50KGUpOwp9IC8vIHJlY3Vyc2l2ZWx5IHNlYXJjaCBmb3IgcG9zc2libGUgdHJhbnNpdGlvbiBkZWZpbmVkIGluc2lkZSB0aGUgY29tcG9uZW50IHJvb3QKCgpmdW5jdGlvbiBsb2NhdGVOb2RlKHZub2RlKSB7CiAgLy8gQHRzLWV4cGVjdC1lcnJvcgogIHJldHVybiB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSAmJiAoIXZub2RlLmRhdGEgfHwgIXZub2RlLmRhdGEudHJhbnNpdGlvbikgPyBsb2NhdGVOb2RlKHZub2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZSkgOiB2bm9kZTsKfQoKdmFyIHNob3cgPSB7CiAgYmluZDogZnVuY3Rpb24gKGVsLCBfYSwgdm5vZGUpIHsKICAgIHZhciB2YWx1ZSA9IF9hLnZhbHVlOwogICAgdm5vZGUgPSBsb2NhdGVOb2RlKHZub2RlKTsKICAgIHZhciB0cmFuc2l0aW9uID0gdm5vZGUuZGF0YSAmJiB2bm9kZS5kYXRhLnRyYW5zaXRpb247CiAgICB2YXIgb3JpZ2luYWxEaXNwbGF5ID0gZWwuX192T3JpZ2luYWxEaXNwbGF5ID0gZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnID8gJycgOiBlbC5zdHlsZS5kaXNwbGF5OwoKICAgIGlmICh2YWx1ZSAmJiB0cmFuc2l0aW9uKSB7CiAgICAgIHZub2RlLmRhdGEuc2hvdyA9IHRydWU7CiAgICAgIGVudGVyKHZub2RlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IG9yaWdpbmFsRGlzcGxheTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gdmFsdWUgPyBvcmlnaW5hbERpc3BsYXkgOiAnbm9uZSc7CiAgICB9CiAgfSwKICB1cGRhdGU6IGZ1bmN0aW9uIChlbCwgX2EsIHZub2RlKSB7CiAgICB2YXIgdmFsdWUgPSBfYS52YWx1ZSwKICAgICAgICBvbGRWYWx1ZSA9IF9hLm9sZFZhbHVlOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKCF2YWx1ZSA9PT0gIW9sZFZhbHVlKSByZXR1cm47CiAgICB2bm9kZSA9IGxvY2F0ZU5vZGUodm5vZGUpOwogICAgdmFyIHRyYW5zaXRpb24gPSB2bm9kZS5kYXRhICYmIHZub2RlLmRhdGEudHJhbnNpdGlvbjsKCiAgICBpZiAodHJhbnNpdGlvbikgewogICAgICB2bm9kZS5kYXRhLnNob3cgPSB0cnVlOwoKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgZW50ZXIodm5vZGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBlbC5fX3ZPcmlnaW5hbERpc3BsYXk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGVhdmUodm5vZGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSB2YWx1ZSA/IGVsLl9fdk9yaWdpbmFsRGlzcGxheSA6ICdub25lJzsKICAgIH0KICB9LAogIHVuYmluZDogZnVuY3Rpb24gKGVsLCBiaW5kaW5nLCB2bm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSkgewogICAgaWYgKCFpc0Rlc3Ryb3kpIHsKICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IGVsLl9fdk9yaWdpbmFsRGlzcGxheTsKICAgIH0KICB9Cn07CnZhciBwbGF0Zm9ybURpcmVjdGl2ZXMgPSB7CiAgbW9kZWw6IGRpcmVjdGl2ZSwKICBzaG93OiBzaG93Cn07IC8vIFByb3ZpZGVzIHRyYW5zaXRpb24gc3VwcG9ydCBmb3IgYSBzaW5nbGUgZWxlbWVudC9jb21wb25lbnQuCgp2YXIgdHJhbnNpdGlvblByb3BzID0gewogIG5hbWU6IFN0cmluZywKICBhcHBlYXI6IEJvb2xlYW4sCiAgY3NzOiBCb29sZWFuLAogIG1vZGU6IFN0cmluZywKICB0eXBlOiBTdHJpbmcsCiAgZW50ZXJDbGFzczogU3RyaW5nLAogIGxlYXZlQ2xhc3M6IFN0cmluZywKICBlbnRlclRvQ2xhc3M6IFN0cmluZywKICBsZWF2ZVRvQ2xhc3M6IFN0cmluZywKICBlbnRlckFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgbGVhdmVBY3RpdmVDbGFzczogU3RyaW5nLAogIGFwcGVhckNsYXNzOiBTdHJpbmcsCiAgYXBwZWFyQWN0aXZlQ2xhc3M6IFN0cmluZywKICBhcHBlYXJUb0NsYXNzOiBTdHJpbmcsCiAgZHVyYXRpb246IFtOdW1iZXIsIFN0cmluZywgT2JqZWN0XQp9OyAvLyBpbiBjYXNlIHRoZSBjaGlsZCBpcyBhbHNvIGFuIGFic3RyYWN0IGNvbXBvbmVudCwgZS5nLiA8a2VlcC1hbGl2ZT4KLy8gd2Ugd2FudCB0byByZWN1cnNpdmVseSByZXRyaWV2ZSB0aGUgcmVhbCBjb21wb25lbnQgdG8gYmUgcmVuZGVyZWQKCmZ1bmN0aW9uIGdldFJlYWxDaGlsZCh2bm9kZSkgewogIHZhciBjb21wT3B0aW9ucyA9IHZub2RlICYmIHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CgogIGlmIChjb21wT3B0aW9ucyAmJiBjb21wT3B0aW9ucy5DdG9yLm9wdGlvbnMuYWJzdHJhY3QpIHsKICAgIHJldHVybiBnZXRSZWFsQ2hpbGQoZ2V0Rmlyc3RDb21wb25lbnRDaGlsZChjb21wT3B0aW9ucy5jaGlsZHJlbikpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gdm5vZGU7CiAgfQp9CgpmdW5jdGlvbiBleHRyYWN0VHJhbnNpdGlvbkRhdGEoY29tcCkgewogIHZhciBkYXRhID0ge307CiAgdmFyIG9wdGlvbnMgPSBjb21wLiRvcHRpb25zOyAvLyBwcm9wcwoKICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucy5wcm9wc0RhdGEpIHsKICAgIGRhdGFba2V5XSA9IGNvbXBba2V5XTsKICB9IC8vIGV2ZW50cy4KICAvLyBleHRyYWN0IGxpc3RlbmVycyBhbmQgcGFzcyB0aGVtIGRpcmVjdGx5IHRvIHRoZSB0cmFuc2l0aW9uIG1ldGhvZHMKCgogIHZhciBsaXN0ZW5lcnMgPSBvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CgogIGZvciAodmFyIGtleSBpbiBsaXN0ZW5lcnMpIHsKICAgIGRhdGFbY2FtZWxpemUoa2V5KV0gPSBsaXN0ZW5lcnNba2V5XTsKICB9CgogIHJldHVybiBkYXRhOwp9CgpmdW5jdGlvbiBwbGFjZWhvbGRlcihoLCByYXdDaGlsZCkgewogIC8vIEB0cy1leHBlY3QtZXJyb3IKICBpZiAoL1xkLWtlZXAtYWxpdmUkLy50ZXN0KHJhd0NoaWxkLnRhZykpIHsKICAgIHJldHVybiBoKCdrZWVwLWFsaXZlJywgewogICAgICBwcm9wczogcmF3Q2hpbGQuY29tcG9uZW50T3B0aW9ucy5wcm9wc0RhdGEKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gaGFzUGFyZW50VHJhbnNpdGlvbih2bm9kZSkgewogIHdoaWxlICh2bm9kZSA9IHZub2RlLnBhcmVudCkgewogICAgaWYgKHZub2RlLmRhdGEudHJhbnNpdGlvbikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGlzU2FtZUNoaWxkKGNoaWxkLCBvbGRDaGlsZCkgewogIHJldHVybiBvbGRDaGlsZC5rZXkgPT09IGNoaWxkLmtleSAmJiBvbGRDaGlsZC50YWcgPT09IGNoaWxkLnRhZzsKfQoKdmFyIGlzTm90VGV4dE5vZGUgPSBmdW5jdGlvbiAoYykgewogIHJldHVybiBjLnRhZyB8fCBpc0FzeW5jUGxhY2Vob2xkZXIoYyk7Cn07Cgp2YXIgaXNWU2hvd0RpcmVjdGl2ZSA9IGZ1bmN0aW9uIChkKSB7CiAgcmV0dXJuIGQubmFtZSA9PT0gJ3Nob3cnOwp9OwoKdmFyIFRyYW5zaXRpb24gPSB7CiAgbmFtZTogJ3RyYW5zaXRpb24nLAogIHByb3BzOiB0cmFuc2l0aW9uUHJvcHMsCiAgYWJzdHJhY3Q6IHRydWUsCiAgcmVuZGVyOiBmdW5jdGlvbiAoaCkgewogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLiRzbG90cy5kZWZhdWx0OwoKICAgIGlmICghY2hpbGRyZW4pIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyBmaWx0ZXIgb3V0IHRleHQgbm9kZXMgKHBvc3NpYmxlIHdoaXRlc3BhY2VzKQoKCiAgICBjaGlsZHJlbiA9IGNoaWxkcmVuLmZpbHRlcihpc05vdFRleHROb2RlKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgIGlmICghY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gd2FybiBtdWx0aXBsZSBlbGVtZW50cwoKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgIHdhcm4oJzx0cmFuc2l0aW9uPiBjYW4gb25seSBiZSB1c2VkIG9uIGEgc2luZ2xlIGVsZW1lbnQuIFVzZSAnICsgJzx0cmFuc2l0aW9uLWdyb3VwPiBmb3IgbGlzdHMuJywgdGhpcy4kcGFyZW50KTsKICAgIH0KCiAgICB2YXIgbW9kZSA9IHRoaXMubW9kZTsgLy8gd2FybiBpbnZhbGlkIG1vZGUKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBtb2RlICYmIG1vZGUgIT09ICdpbi1vdXQnICYmIG1vZGUgIT09ICdvdXQtaW4nKSB7CiAgICAgIHdhcm4oJ2ludmFsaWQgPHRyYW5zaXRpb24+IG1vZGU6ICcgKyBtb2RlLCB0aGlzLiRwYXJlbnQpOwogICAgfQoKICAgIHZhciByYXdDaGlsZCA9IGNoaWxkcmVuWzBdOyAvLyBpZiB0aGlzIGlzIGEgY29tcG9uZW50IHJvb3Qgbm9kZSBhbmQgdGhlIGNvbXBvbmVudCdzCiAgICAvLyBwYXJlbnQgY29udGFpbmVyIG5vZGUgYWxzbyBoYXMgdHJhbnNpdGlvbiwgc2tpcC4KCiAgICBpZiAoaGFzUGFyZW50VHJhbnNpdGlvbih0aGlzLiR2bm9kZSkpIHsKICAgICAgcmV0dXJuIHJhd0NoaWxkOwogICAgfSAvLyBhcHBseSB0cmFuc2l0aW9uIGRhdGEgdG8gY2hpbGQKICAgIC8vIHVzZSBnZXRSZWFsQ2hpbGQoKSB0byBpZ25vcmUgYWJzdHJhY3QgY29tcG9uZW50cyBlLmcuIGtlZXAtYWxpdmUKCgogICAgdmFyIGNoaWxkID0gZ2V0UmVhbENoaWxkKHJhd0NoaWxkKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgIGlmICghY2hpbGQpIHsKICAgICAgcmV0dXJuIHJhd0NoaWxkOwogICAgfQoKICAgIGlmICh0aGlzLl9sZWF2aW5nKSB7CiAgICAgIHJldHVybiBwbGFjZWhvbGRlcihoLCByYXdDaGlsZCk7CiAgICB9IC8vIGVuc3VyZSBhIGtleSB0aGF0IGlzIHVuaXF1ZSB0byB0aGUgdm5vZGUgdHlwZSBhbmQgdG8gdGhpcyB0cmFuc2l0aW9uCiAgICAvLyBjb21wb25lbnQgaW5zdGFuY2UuIFRoaXMga2V5IHdpbGwgYmUgdXNlZCB0byByZW1vdmUgcGVuZGluZyBsZWF2aW5nIG5vZGVzCiAgICAvLyBkdXJpbmcgZW50ZXJpbmcuCgoKICAgIHZhciBpZCA9ICJfX3RyYW5zaXRpb24tIi5jb25jYXQodGhpcy5fdWlkLCAiLSIpOwogICAgY2hpbGQua2V5ID0gY2hpbGQua2V5ID09IG51bGwgPyBjaGlsZC5pc0NvbW1lbnQgPyBpZCArICdjb21tZW50JyA6IGlkICsgY2hpbGQudGFnIDogaXNQcmltaXRpdmUoY2hpbGQua2V5KSA/IFN0cmluZyhjaGlsZC5rZXkpLmluZGV4T2YoaWQpID09PSAwID8gY2hpbGQua2V5IDogaWQgKyBjaGlsZC5rZXkgOiBjaGlsZC5rZXk7CiAgICB2YXIgZGF0YSA9IChjaGlsZC5kYXRhIHx8IChjaGlsZC5kYXRhID0ge30pKS50cmFuc2l0aW9uID0gZXh0cmFjdFRyYW5zaXRpb25EYXRhKHRoaXMpOwogICAgdmFyIG9sZFJhd0NoaWxkID0gdGhpcy5fdm5vZGU7CiAgICB2YXIgb2xkQ2hpbGQgPSBnZXRSZWFsQ2hpbGQob2xkUmF3Q2hpbGQpOyAvLyBtYXJrIHYtc2hvdwogICAgLy8gc28gdGhhdCB0aGUgdHJhbnNpdGlvbiBtb2R1bGUgY2FuIGhhbmQgb3ZlciB0aGUgY29udHJvbCB0byB0aGUgZGlyZWN0aXZlCgogICAgaWYgKGNoaWxkLmRhdGEuZGlyZWN0aXZlcyAmJiBjaGlsZC5kYXRhLmRpcmVjdGl2ZXMuc29tZShpc1ZTaG93RGlyZWN0aXZlKSkgewogICAgICBjaGlsZC5kYXRhLnNob3cgPSB0cnVlOwogICAgfQoKICAgIGlmIChvbGRDaGlsZCAmJiBvbGRDaGlsZC5kYXRhICYmICFpc1NhbWVDaGlsZChjaGlsZCwgb2xkQ2hpbGQpICYmICFpc0FzeW5jUGxhY2Vob2xkZXIob2xkQ2hpbGQpICYmIC8vICM2Njg3IGNvbXBvbmVudCByb290IGlzIGEgY29tbWVudCBub2RlCiAgICAhKG9sZENoaWxkLmNvbXBvbmVudEluc3RhbmNlICYmIG9sZENoaWxkLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZS5pc0NvbW1lbnQpKSB7CiAgICAgIC8vIHJlcGxhY2Ugb2xkIGNoaWxkIHRyYW5zaXRpb24gZGF0YSB3aXRoIGZyZXNoIG9uZQogICAgICAvLyBpbXBvcnRhbnQgZm9yIGR5bmFtaWMgdHJhbnNpdGlvbnMhCiAgICAgIHZhciBvbGREYXRhID0gb2xkQ2hpbGQuZGF0YS50cmFuc2l0aW9uID0gZXh0ZW5kKHt9LCBkYXRhKTsgLy8gaGFuZGxlIHRyYW5zaXRpb24gbW9kZQoKICAgICAgaWYgKG1vZGUgPT09ICdvdXQtaW4nKSB7CiAgICAgICAgLy8gcmV0dXJuIHBsYWNlaG9sZGVyIG5vZGUgYW5kIHF1ZXVlIHVwZGF0ZSB3aGVuIGxlYXZlIGZpbmlzaGVzCiAgICAgICAgdGhpcy5fbGVhdmluZyA9IHRydWU7CiAgICAgICAgbWVyZ2VWTm9kZUhvb2sob2xkRGF0YSwgJ2FmdGVyTGVhdmUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpcy5fbGVhdmluZyA9IGZhbHNlOwoKICAgICAgICAgIF90aGlzLiRmb3JjZVVwZGF0ZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBwbGFjZWhvbGRlcihoLCByYXdDaGlsZCk7CiAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2luLW91dCcpIHsKICAgICAgICBpZiAoaXNBc3luY1BsYWNlaG9sZGVyKGNoaWxkKSkgewogICAgICAgICAgcmV0dXJuIG9sZFJhd0NoaWxkOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlbGF5ZWRMZWF2ZV8xOwoKICAgICAgICB2YXIgcGVyZm9ybUxlYXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZGVsYXllZExlYXZlXzEoKTsKICAgICAgICB9OwoKICAgICAgICBtZXJnZVZOb2RlSG9vayhkYXRhLCAnYWZ0ZXJFbnRlcicsIHBlcmZvcm1MZWF2ZSk7CiAgICAgICAgbWVyZ2VWTm9kZUhvb2soZGF0YSwgJ2VudGVyQ2FuY2VsbGVkJywgcGVyZm9ybUxlYXZlKTsKICAgICAgICBtZXJnZVZOb2RlSG9vayhvbGREYXRhLCAnZGVsYXlMZWF2ZScsIGZ1bmN0aW9uIChsZWF2ZSkgewogICAgICAgICAgZGVsYXllZExlYXZlXzEgPSBsZWF2ZTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByYXdDaGlsZDsKICB9Cn07IC8vIFByb3ZpZGVzIHRyYW5zaXRpb24gc3VwcG9ydCBmb3IgbGlzdCBpdGVtcy4KCnZhciBwcm9wcyA9IGV4dGVuZCh7CiAgdGFnOiBTdHJpbmcsCiAgbW92ZUNsYXNzOiBTdHJpbmcKfSwgdHJhbnNpdGlvblByb3BzKTsKZGVsZXRlIHByb3BzLm1vZGU7CnZhciBUcmFuc2l0aW9uR3JvdXAgPSB7CiAgcHJvcHM6IHByb3BzLAogIGJlZm9yZU1vdW50OiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHZhciB1cGRhdGUgPSB0aGlzLl91cGRhdGU7CgogICAgdGhpcy5fdXBkYXRlID0gZnVuY3Rpb24gKHZub2RlLCBoeWRyYXRpbmcpIHsKICAgICAgdmFyIHJlc3RvcmVBY3RpdmVJbnN0YW5jZSA9IHNldEFjdGl2ZUluc3RhbmNlKF90aGlzKTsgLy8gZm9yY2UgcmVtb3ZpbmcgcGFzcwoKICAgICAgX3RoaXMuX19wYXRjaF9fKF90aGlzLl92bm9kZSwgX3RoaXMua2VwdCwgZmFsc2UsIC8vIGh5ZHJhdGluZwogICAgICB0cnVlIC8vIHJlbW92ZU9ubHkgKCFpbXBvcnRhbnQsIGF2b2lkcyB1bm5lY2Vzc2FyeSBtb3ZlcykKICAgICAgKTsKCiAgICAgIF90aGlzLl92bm9kZSA9IF90aGlzLmtlcHQ7CiAgICAgIHJlc3RvcmVBY3RpdmVJbnN0YW5jZSgpOwogICAgICB1cGRhdGUuY2FsbChfdGhpcywgdm5vZGUsIGh5ZHJhdGluZyk7CiAgICB9OwogIH0sCiAgcmVuZGVyOiBmdW5jdGlvbiAoaCkgewogICAgdmFyIHRhZyA9IHRoaXMudGFnIHx8IHRoaXMuJHZub2RlLmRhdGEudGFnIHx8ICdzcGFuJzsKICAgIHZhciBtYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdmFyIHByZXZDaGlsZHJlbiA9IHRoaXMucHJldkNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbjsKICAgIHZhciByYXdDaGlsZHJlbiA9IHRoaXMuJHNsb3RzLmRlZmF1bHQgfHwgW107CiAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuID0gW107CiAgICB2YXIgdHJhbnNpdGlvbkRhdGEgPSBleHRyYWN0VHJhbnNpdGlvbkRhdGEodGhpcyk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYXdDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICB2YXIgYyA9IHJhd0NoaWxkcmVuW2ldOwoKICAgICAgaWYgKGMudGFnKSB7CiAgICAgICAgaWYgKGMua2V5ICE9IG51bGwgJiYgU3RyaW5nKGMua2V5KS5pbmRleE9mKCdfX3ZsaXN0JykgIT09IDApIHsKICAgICAgICAgIGNoaWxkcmVuLnB1c2goYyk7CiAgICAgICAgICBtYXBbYy5rZXldID0gYzsKICAgICAgICAgIChjLmRhdGEgfHwgKGMuZGF0YSA9IHt9KSkudHJhbnNpdGlvbiA9IHRyYW5zaXRpb25EYXRhOwogICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgdmFyIG9wdHMgPSBjLmNvbXBvbmVudE9wdGlvbnM7CiAgICAgICAgICB2YXIgbmFtZV8xID0gb3B0cyA/IGdldENvbXBvbmVudE5hbWUob3B0cy5DdG9yLm9wdGlvbnMpIHx8IG9wdHMudGFnIHx8ICcnIDogYy50YWc7CiAgICAgICAgICB3YXJuKCI8dHJhbnNpdGlvbi1ncm91cD4gY2hpbGRyZW4gbXVzdCBiZSBrZXllZDogPCIuY29uY2F0KG5hbWVfMSwgIj4iKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHByZXZDaGlsZHJlbikgewogICAgICB2YXIga2VwdCA9IFtdOwogICAgICB2YXIgcmVtb3ZlZCA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmV2Q2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgYyA9IHByZXZDaGlsZHJlbltpXTsKICAgICAgICBjLmRhdGEudHJhbnNpdGlvbiA9IHRyYW5zaXRpb25EYXRhOyAvLyBAdHMtZXhwZWN0LWVycm9yIC5nZXRCb3VuZGluZ0NsaWVudFJlY3QgaXMgbm90IHR5cGVkIGluIE5vZGUKCiAgICAgICAgYy5kYXRhLnBvcyA9IGMuZWxtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKICAgICAgICBpZiAobWFwW2Mua2V5XSkgewogICAgICAgICAga2VwdC5wdXNoKGMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZW1vdmVkLnB1c2goYyk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmtlcHQgPSBoKHRhZywgbnVsbCwga2VwdCk7CiAgICAgIHRoaXMucmVtb3ZlZCA9IHJlbW92ZWQ7CiAgICB9CgogICAgcmV0dXJuIGgodGFnLCBudWxsLCBjaGlsZHJlbik7CiAgfSwKICB1cGRhdGVkOiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLnByZXZDaGlsZHJlbjsKICAgIHZhciBtb3ZlQ2xhc3MgPSB0aGlzLm1vdmVDbGFzcyB8fCAodGhpcy5uYW1lIHx8ICd2JykgKyAnLW1vdmUnOwoKICAgIGlmICghY2hpbGRyZW4ubGVuZ3RoIHx8ICF0aGlzLmhhc01vdmUoY2hpbGRyZW5bMF0uZWxtLCBtb3ZlQ2xhc3MpKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gd2UgZGl2aWRlIHRoZSB3b3JrIGludG8gdGhyZWUgbG9vcHMgdG8gYXZvaWQgbWl4aW5nIERPTSByZWFkcyBhbmQgd3JpdGVzCiAgICAvLyBpbiBlYWNoIGl0ZXJhdGlvbiAtIHdoaWNoIGhlbHBzIHByZXZlbnQgbGF5b3V0IHRocmFzaGluZy4KCgogICAgY2hpbGRyZW4uZm9yRWFjaChjYWxsUGVuZGluZ0Nicyk7CiAgICBjaGlsZHJlbi5mb3JFYWNoKHJlY29yZFBvc2l0aW9uKTsKICAgIGNoaWxkcmVuLmZvckVhY2goYXBwbHlUcmFuc2xhdGlvbik7IC8vIGZvcmNlIHJlZmxvdyB0byBwdXQgZXZlcnl0aGluZyBpbiBwb3NpdGlvbgogICAgLy8gYXNzaWduIHRvIHRoaXMgdG8gYXZvaWQgYmVpbmcgcmVtb3ZlZCBpbiB0cmVlLXNoYWtpbmcKICAgIC8vICRmbG93LWRpc2FibGUtbGluZQoKICAgIHRoaXMuX3JlZmxvdyA9IGRvY3VtZW50LmJvZHkub2Zmc2V0SGVpZ2h0OwogICAgY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbiAoYykgewogICAgICBpZiAoYy5kYXRhLm1vdmVkKSB7CiAgICAgICAgdmFyIGVsXzEgPSBjLmVsbTsKICAgICAgICB2YXIgcyA9IGVsXzEuc3R5bGU7CiAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsXzEsIG1vdmVDbGFzcyk7CiAgICAgICAgcy50cmFuc2Zvcm0gPSBzLldlYmtpdFRyYW5zZm9ybSA9IHMudHJhbnNpdGlvbkR1cmF0aW9uID0gJyc7CiAgICAgICAgZWxfMS5hZGRFdmVudExpc3RlbmVyKHRyYW5zaXRpb25FbmRFdmVudCwgZWxfMS5fbW92ZUNiID0gZnVuY3Rpb24gY2IoZSkgewogICAgICAgICAgaWYgKGUgJiYgZS50YXJnZXQgIT09IGVsXzEpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghZSB8fCAvdHJhbnNmb3JtJC8udGVzdChlLnByb3BlcnR5TmFtZSkpIHsKICAgICAgICAgICAgZWxfMS5yZW1vdmVFdmVudExpc3RlbmVyKHRyYW5zaXRpb25FbmRFdmVudCwgY2IpOwogICAgICAgICAgICBlbF8xLl9tb3ZlQ2IgPSBudWxsOwogICAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWxfMSwgbW92ZUNsYXNzKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfSwKICBtZXRob2RzOiB7CiAgICBoYXNNb3ZlOiBmdW5jdGlvbiAoZWwsIG1vdmVDbGFzcykgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKCFoYXNUcmFuc2l0aW9uKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgICAgIGlmICh0aGlzLl9oYXNNb3ZlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2hhc01vdmU7CiAgICAgIH0gLy8gRGV0ZWN0IHdoZXRoZXIgYW4gZWxlbWVudCB3aXRoIHRoZSBtb3ZlIGNsYXNzIGFwcGxpZWQgaGFzCiAgICAgIC8vIENTUyB0cmFuc2l0aW9ucy4gU2luY2UgdGhlIGVsZW1lbnQgbWF5IGJlIGluc2lkZSBhbiBlbnRlcmluZwogICAgICAvLyB0cmFuc2l0aW9uIGF0IHRoaXMgdmVyeSBtb21lbnQsIHdlIG1ha2UgYSBjbG9uZSBvZiBpdCBhbmQgcmVtb3ZlCiAgICAgIC8vIGFsbCBvdGhlciB0cmFuc2l0aW9uIGNsYXNzZXMgYXBwbGllZCB0byBlbnN1cmUgb25seSB0aGUgbW92ZSBjbGFzcwogICAgICAvLyBpcyBhcHBsaWVkLgoKCiAgICAgIHZhciBjbG9uZSA9IGVsLmNsb25lTm9kZSgpOwoKICAgICAgaWYgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcykgewogICAgICAgIGVsLl90cmFuc2l0aW9uQ2xhc3Nlcy5mb3JFYWNoKGZ1bmN0aW9uIChjbHMpIHsKICAgICAgICAgIHJlbW92ZUNsYXNzKGNsb25lLCBjbHMpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBhZGRDbGFzcyhjbG9uZSwgbW92ZUNsYXNzKTsKICAgICAgY2xvbmUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgdGhpcy4kZWwuYXBwZW5kQ2hpbGQoY2xvbmUpOwogICAgICB2YXIgaW5mbyA9IGdldFRyYW5zaXRpb25JbmZvKGNsb25lKTsKICAgICAgdGhpcy4kZWwucmVtb3ZlQ2hpbGQoY2xvbmUpOwogICAgICByZXR1cm4gdGhpcy5faGFzTW92ZSA9IGluZm8uaGFzVHJhbnNmb3JtOwogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGNhbGxQZW5kaW5nQ2JzKGMpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoYy5lbG0uX21vdmVDYikgewogICAgYy5lbG0uX21vdmVDYigpOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmIChjLmVsbS5fZW50ZXJDYikgewogICAgYy5lbG0uX2VudGVyQ2IoKTsKICB9Cn0KCmZ1bmN0aW9uIHJlY29yZFBvc2l0aW9uKGMpIHsKICBjLmRhdGEubmV3UG9zID0gYy5lbG0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7Cn0KCmZ1bmN0aW9uIGFwcGx5VHJhbnNsYXRpb24oYykgewogIHZhciBvbGRQb3MgPSBjLmRhdGEucG9zOwogIHZhciBuZXdQb3MgPSBjLmRhdGEubmV3UG9zOwogIHZhciBkeCA9IG9sZFBvcy5sZWZ0IC0gbmV3UG9zLmxlZnQ7CiAgdmFyIGR5ID0gb2xkUG9zLnRvcCAtIG5ld1Bvcy50b3A7CgogIGlmIChkeCB8fCBkeSkgewogICAgYy5kYXRhLm1vdmVkID0gdHJ1ZTsKICAgIHZhciBzID0gYy5lbG0uc3R5bGU7CiAgICBzLnRyYW5zZm9ybSA9IHMuV2Via2l0VHJhbnNmb3JtID0gInRyYW5zbGF0ZSgiLmNvbmNhdChkeCwgInB4LCIpLmNvbmNhdChkeSwgInB4KSIpOwogICAgcy50cmFuc2l0aW9uRHVyYXRpb24gPSAnMHMnOwogIH0KfQoKdmFyIHBsYXRmb3JtQ29tcG9uZW50cyA9IHsKICBUcmFuc2l0aW9uOiBUcmFuc2l0aW9uLAogIFRyYW5zaXRpb25Hcm91cDogVHJhbnNpdGlvbkdyb3VwCn07IC8vIGluc3RhbGwgcGxhdGZvcm0gc3BlY2lmaWMgdXRpbHMKClZ1ZS5jb25maWcubXVzdFVzZVByb3AgPSBtdXN0VXNlUHJvcDsKVnVlLmNvbmZpZy5pc1Jlc2VydmVkVGFnID0gaXNSZXNlcnZlZFRhZzsKVnVlLmNvbmZpZy5pc1Jlc2VydmVkQXR0ciA9IGlzUmVzZXJ2ZWRBdHRyOwpWdWUuY29uZmlnLmdldFRhZ05hbWVzcGFjZSA9IGdldFRhZ05hbWVzcGFjZTsKVnVlLmNvbmZpZy5pc1Vua25vd25FbGVtZW50ID0gaXNVbmtub3duRWxlbWVudDsgLy8gaW5zdGFsbCBwbGF0Zm9ybSBydW50aW1lIGRpcmVjdGl2ZXMgJiBjb21wb25lbnRzCgpleHRlbmQoVnVlLm9wdGlvbnMuZGlyZWN0aXZlcywgcGxhdGZvcm1EaXJlY3RpdmVzKTsKZXh0ZW5kKFZ1ZS5vcHRpb25zLmNvbXBvbmVudHMsIHBsYXRmb3JtQ29tcG9uZW50cyk7IC8vIGluc3RhbGwgcGxhdGZvcm0gcGF0Y2ggZnVuY3Rpb24KClZ1ZS5wcm90b3R5cGUuX19wYXRjaF9fID0gaW5Ccm93c2VyID8gcGF0Y2ggOiBub29wOyAvLyBwdWJsaWMgbW91bnQgbWV0aG9kCgpWdWUucHJvdG90eXBlLiRtb3VudCA9IGZ1bmN0aW9uIChlbCwgaHlkcmF0aW5nKSB7CiAgZWwgPSBlbCAmJiBpbkJyb3dzZXIgPyBxdWVyeShlbCkgOiB1bmRlZmluZWQ7CiAgcmV0dXJuIG1vdW50Q29tcG9uZW50KHRoaXMsIGVsLCBoeWRyYXRpbmcpOwp9OyAvLyBkZXZ0b29scyBnbG9iYWwgaG9vawoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCgppZiAoaW5Ccm93c2VyKSB7CiAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICBpZiAoY29uZmlnLmRldnRvb2xzKSB7CiAgICAgIGlmIChkZXZ0b29scykgewogICAgICAgIGRldnRvb2xzLmVtaXQoJ2luaXQnLCBWdWUpOwogICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0JykgewogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgICAgICBjb25zb2xlW2NvbnNvbGUuaW5mbyA/ICdpbmZvJyA6ICdsb2cnXSgnRG93bmxvYWQgdGhlIFZ1ZSBEZXZ0b29scyBleHRlbnNpb24gZm9yIGEgYmV0dGVyIGRldmVsb3BtZW50IGV4cGVyaWVuY2U6XG4nICsgJ2h0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWUtZGV2dG9vbHMnKTsKICAgICAgfQogICAgfQoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAndGVzdCcgJiYgY29uZmlnLnByb2R1Y3Rpb25UaXAgIT09IGZhbHNlICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yCiAgICAgIGNvbnNvbGVbY29uc29sZS5pbmZvID8gJ2luZm8nIDogJ2xvZyddKCJZb3UgYXJlIHJ1bm5pbmcgVnVlIGluIGRldmVsb3BtZW50IG1vZGUuXG4iICsgIk1ha2Ugc3VyZSB0byB0dXJuIG9uIHByb2R1Y3Rpb24gbW9kZSB3aGVuIGRlcGxveWluZyBmb3IgcHJvZHVjdGlvbi5cbiIgKyAiU2VlIG1vcmUgdGlwcyBhdCBodHRwczovL3Z1ZWpzLm9yZy9ndWlkZS9kZXBsb3ltZW50Lmh0bWwiKTsKICAgIH0KICB9LCAwKTsKfQoKZXhwb3J0IHsgRWZmZWN0U2NvcGUsIGNvbXB1dGVkLCBjdXN0b21SZWYsIFZ1ZSBhcyBkZWZhdWx0LCBkZWZpbmVBc3luY0NvbXBvbmVudCwgZGVmaW5lQ29tcG9uZW50LCBkZWwsIGVmZmVjdFNjb3BlLCBnZXRDdXJyZW50SW5zdGFuY2UsIGdldEN1cnJlbnRTY29wZSwgaCwgaW5qZWN0LCBpc1Byb3h5LCBpc1JlYWN0aXZlLCBpc1JlYWRvbmx5LCBpc1JlZiwgaXNTaGFsbG93LCBtYXJrUmF3LCBtZXJnZURlZmF1bHRzLCBuZXh0VGljaywgb25BY3RpdmF0ZWQsIG9uQmVmb3JlTW91bnQsIG9uQmVmb3JlVW5tb3VudCwgb25CZWZvcmVVcGRhdGUsIG9uRGVhY3RpdmF0ZWQsIG9uRXJyb3JDYXB0dXJlZCwgb25Nb3VudGVkLCBvblJlbmRlclRyYWNrZWQsIG9uUmVuZGVyVHJpZ2dlcmVkLCBvblNjb3BlRGlzcG9zZSwgb25TZXJ2ZXJQcmVmZXRjaCwgb25Vbm1vdW50ZWQsIG9uVXBkYXRlZCwgcHJvdmlkZSwgcHJveHlSZWZzLCByZWFjdGl2ZSwgcmVhZG9ubHksIHJlZiQxIGFzIHJlZiwgc2V0LCBzaGFsbG93UmVhY3RpdmUsIHNoYWxsb3dSZWFkb25seSwgc2hhbGxvd1JlZiwgdG9SYXcsIHRvUmVmLCB0b1JlZnMsIHRyaWdnZXJSZWYsIHVucmVmLCB1c2VBdHRycywgdXNlQ3NzTW9kdWxlLCB1c2VDc3NWYXJzLCB1c2VMaXN0ZW5lcnMsIHVzZVNsb3RzLCB2ZXJzaW9uLCB3YXRjaCwgd2F0Y2hFZmZlY3QsIHdhdGNoUG9zdEVmZmVjdCwgd2F0Y2hTeW5jRWZmZWN0IH07"},null]}